<!DOCTYPE html>
<html lang="zh-cn"><head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Kratos æ˜¯bilibiliå¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚
 åå­—æ¥æºäº:ã€Šæˆ˜ç¥ã€‹æ¸¸æˆä»¥å¸Œè…Šç¥è¯ä¸ºèƒŒæ™¯ï¼Œè®²è¿°ç”±å‡¡äººæˆä¸ºæˆ˜ç¥çš„å¥æ‰˜æ–¯ï¼ˆKratosï¼‰æˆä¸ºæˆ˜ç¥å¹¶å±•å¼€å¼‘ç¥å± æ€çš„å†’é™©å†ç¨‹ã€‚
 å¥½ï¼å¼€å§‹å§ï¼
å°æç¤ºï¼šé˜…è¯»æºç æ—¶è¯·ä¿æŒæ¸…é†’ã€‚
é¦–å…ˆæ˜¯æŒ‰ç…§Kratos tool ç”Ÿäº§çš„å·¥ç¨‹ç›®å½•ã€‚
â”œâ”€â”€ CHANGELOG.md â”œâ”€â”€ OWNERS â”œâ”€â”€ README.md â”œâ”€â”€ api # apiç›®å½•ä¸ºå¯¹å¤–ä¿ç•™çš„protoæ–‡ä»¶åŠç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.bm.go â”‚ â”œâ”€â”€ api.pb.go # é€šè¿‡go generateç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.proto â”‚ â””â”€â”€ client.go â”œâ”€â”€ cmd â”‚ â””â”€â”€ main.go # cmdç›®å½•ä¸ºmainæ‰€åœ¨ â”œâ”€â”€ configs # configsä¸ºé…ç½®æ–‡ä»¶ç›®å½• â”‚ â”œâ”€â”€ application.toml # åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸€äº›ä¸šåŠ¡å¼€å…³å¦‚ï¼šuseABtest = true â”‚ â”œâ”€â”€ db.toml # dbç›¸å…³é…ç½® â”‚ â”œâ”€â”€ grpc.toml # grpcç›¸å…³é…ç½® â”‚ â”œâ”€â”€ http.toml # httpç›¸å…³é…ç½® â”‚ â”œâ”€â”€ memcache.'><title>Kratos åˆå§‹åŒ–æµç¨‹æºç è§£æ</title>
    
    <link rel='canonical' href='https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Kratos åˆå§‹åŒ–æµç¨‹æºç è§£æ'>
<meta property='og:description' content='Kratos æ˜¯bilibiliå¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚
 åå­—æ¥æºäº:ã€Šæˆ˜ç¥ã€‹æ¸¸æˆä»¥å¸Œè…Šç¥è¯ä¸ºèƒŒæ™¯ï¼Œè®²è¿°ç”±å‡¡äººæˆä¸ºæˆ˜ç¥çš„å¥æ‰˜æ–¯ï¼ˆKratosï¼‰æˆä¸ºæˆ˜ç¥å¹¶å±•å¼€å¼‘ç¥å± æ€çš„å†’é™©å†ç¨‹ã€‚
 å¥½ï¼å¼€å§‹å§ï¼
å°æç¤ºï¼šé˜…è¯»æºç æ—¶è¯·ä¿æŒæ¸…é†’ã€‚
é¦–å…ˆæ˜¯æŒ‰ç…§Kratos tool ç”Ÿäº§çš„å·¥ç¨‹ç›®å½•ã€‚
â”œâ”€â”€ CHANGELOG.md â”œâ”€â”€ OWNERS â”œâ”€â”€ README.md â”œâ”€â”€ api # apiç›®å½•ä¸ºå¯¹å¤–ä¿ç•™çš„protoæ–‡ä»¶åŠç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.bm.go â”‚ â”œâ”€â”€ api.pb.go # é€šè¿‡go generateç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.proto â”‚ â””â”€â”€ client.go â”œâ”€â”€ cmd â”‚ â””â”€â”€ main.go # cmdç›®å½•ä¸ºmainæ‰€åœ¨ â”œâ”€â”€ configs # configsä¸ºé…ç½®æ–‡ä»¶ç›®å½• â”‚ â”œâ”€â”€ application.toml # åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸€äº›ä¸šåŠ¡å¼€å…³å¦‚ï¼šuseABtest = true â”‚ â”œâ”€â”€ db.toml # dbç›¸å…³é…ç½® â”‚ â”œâ”€â”€ grpc.toml # grpcç›¸å…³é…ç½® â”‚ â”œâ”€â”€ http.toml # httpç›¸å…³é…ç½® â”‚ â”œâ”€â”€ memcache.'>
<meta property='og:url' content='https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>
<meta property='og:site_name' content='SDTTTTT&#39;s Smelly fish Rotten shrimp ğŸ““'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='microservice' /><meta property='article:tag' content='Source code analysis' /><meta property='article:published_time' content='2020-03-31T20:17:28&#43;08:00'/><meta property='article:modified_time' content='2020-03-31T20:17:28&#43;08:00'/>
<meta name="twitter:title" content="Kratos åˆå§‹åŒ–æµç¨‹æºç è§£æ">
<meta name="twitter:description" content="Kratos æ˜¯bilibiliå¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚
 åå­—æ¥æºäº:ã€Šæˆ˜ç¥ã€‹æ¸¸æˆä»¥å¸Œè…Šç¥è¯ä¸ºèƒŒæ™¯ï¼Œè®²è¿°ç”±å‡¡äººæˆä¸ºæˆ˜ç¥çš„å¥æ‰˜æ–¯ï¼ˆKratosï¼‰æˆä¸ºæˆ˜ç¥å¹¶å±•å¼€å¼‘ç¥å± æ€çš„å†’é™©å†ç¨‹ã€‚
 å¥½ï¼å¼€å§‹å§ï¼
å°æç¤ºï¼šé˜…è¯»æºç æ—¶è¯·ä¿æŒæ¸…é†’ã€‚
é¦–å…ˆæ˜¯æŒ‰ç…§Kratos tool ç”Ÿäº§çš„å·¥ç¨‹ç›®å½•ã€‚
â”œâ”€â”€ CHANGELOG.md â”œâ”€â”€ OWNERS â”œâ”€â”€ README.md â”œâ”€â”€ api # apiç›®å½•ä¸ºå¯¹å¤–ä¿ç•™çš„protoæ–‡ä»¶åŠç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.bm.go â”‚ â”œâ”€â”€ api.pb.go # é€šè¿‡go generateç”Ÿæˆçš„pb.goæ–‡ä»¶ â”‚ â”œâ”€â”€ api.proto â”‚ â””â”€â”€ client.go â”œâ”€â”€ cmd â”‚ â””â”€â”€ main.go # cmdç›®å½•ä¸ºmainæ‰€åœ¨ â”œâ”€â”€ configs # configsä¸ºé…ç½®æ–‡ä»¶ç›®å½• â”‚ â”œâ”€â”€ application.toml # åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸€äº›ä¸šåŠ¡å¼€å…³å¦‚ï¼šuseABtest = true â”‚ â”œâ”€â”€ db.toml # dbç›¸å…³é…ç½® â”‚ â”œâ”€â”€ grpc.toml # grpcç›¸å…³é…ç½® â”‚ â”œâ”€â”€ http.toml # httpç›¸å…³é…ç½® â”‚ â”œâ”€â”€ memcache."></head><body class="">
        <div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                

                
                    
                    <img src="/img/wolaopo_huaa9cfa37fb7c13295de7156385ad8dbe_251770_300x300_resize_box_2.png" width="300"
                        height="300" class="site-logo" loading="lazy" alt="Avatar">
                

                <span class="emoji">ğŸ¥</span>
            </figure>
        
        <h1 class="site-name"><a href="https://sdttttt.github.io/">SDTTTTT&#39;s Smelly fish Rotten shrimp ğŸ““</a></h1>
        <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='https://sdttttt.github.io/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='https://sdttttt.github.io/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='https://sdttttt.github.io/archives'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
    </ol>
</aside>
            <main class="main full-width">
    <div id="article-toolbar">
        <a href="https://sdttttt.github.io/" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



            <span>Back</span>
        </a>
    </div>

    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Kratos åˆå§‹åŒ–æµç¨‹æºç è§£æ</a>
    </h2>

    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Mar 31, 2020</time>
    </footer></div>
</header>

    <section class="article-content">
    <p><strong>Kratos</strong> æ˜¯bilibiliå¼€æºçš„ä¸€å¥—Goå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ã€‚</p>
<blockquote>
<p>åå­—æ¥æºäº:ã€Šæˆ˜ç¥ã€‹æ¸¸æˆä»¥å¸Œè…Šç¥è¯ä¸ºèƒŒæ™¯ï¼Œè®²è¿°ç”±å‡¡äººæˆä¸ºæˆ˜ç¥çš„å¥æ‰˜æ–¯ï¼ˆKratosï¼‰æˆä¸ºæˆ˜ç¥å¹¶å±•å¼€å¼‘ç¥å± æ€çš„å†’é™©å†ç¨‹ã€‚</p>
</blockquote>
<p>å¥½ï¼å¼€å§‹å§ï¼</p>
<p><em>å°æç¤ºï¼šé˜…è¯»æºç æ—¶è¯·ä¿æŒæ¸…é†’ã€‚</em></p>
<p>é¦–å…ˆæ˜¯æŒ‰ç…§Kratos tool ç”Ÿäº§çš„å·¥ç¨‹ç›®å½•ã€‚</p>
<pre><code>â”œâ”€â”€ CHANGELOG.md 
â”œâ”€â”€ OWNERS
â”œâ”€â”€ README.md
â”œâ”€â”€ api                     # apiç›®å½•ä¸ºå¯¹å¤–ä¿ç•™çš„protoæ–‡ä»¶åŠç”Ÿæˆçš„pb.goæ–‡ä»¶
â”‚   â”œâ”€â”€ api.bm.go
â”‚   â”œâ”€â”€ api.pb.go           # é€šè¿‡go generateç”Ÿæˆçš„pb.goæ–‡ä»¶
â”‚   â”œâ”€â”€ api.proto
â”‚   â””â”€â”€ client.go
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ main.go             # cmdç›®å½•ä¸ºmainæ‰€åœ¨
â”œâ”€â”€ configs                 # configsä¸ºé…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ application.toml    # åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸€äº›ä¸šåŠ¡å¼€å…³å¦‚ï¼šuseABtest = true
â”‚   â”œâ”€â”€ db.toml             # dbç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ grpc.toml           # grpcç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ http.toml           # httpç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ memcache.toml       # memcacheç›¸å…³é…ç½®
â”‚   â””â”€â”€ redis.toml          # redisç›¸å…³é…ç½®
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ internal                # internalä¸ºé¡¹ç›®å†…éƒ¨åŒ…ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ç›®å½•ï¼š
â”‚   â”œâ”€â”€ dao                 # daoå±‚ï¼Œç”¨äºæ•°æ®åº“ã€cacheã€MQã€ä¾èµ–æŸä¸šåŠ¡grpc|httpç­‰èµ„æºè®¿é—®
â”‚   â”‚   â”œâ”€â”€ dao.bts.go
â”‚   â”‚   â”œâ”€â”€ dao.go
â”‚   â”‚   â”œâ”€â”€ db.go
â”‚   â”‚   â”œâ”€â”€ mc.cache.go
â”‚   â”‚   â”œâ”€â”€ mc.go
â”‚   â”‚   â””â”€â”€ redis.go
â”‚   â”œâ”€â”€ di                  # ä¾èµ–æ³¨å…¥å±‚ é‡‡ç”¨wireé™æ€åˆ†æä¾èµ–
â”‚   â”‚   â”œâ”€â”€ app.go
â”‚   â”‚   â”œâ”€â”€ wire.go         # wire å£°æ˜
â”‚   â”‚   â””â”€â”€ wire_gen.go     # go generate ç”Ÿæˆçš„ä»£ç 
â”‚   â”œâ”€â”€ model               # modelå±‚ï¼Œç”¨äºå£°æ˜ä¸šåŠ¡ç»“æ„ä½“
â”‚   â”‚   â””â”€â”€ model.go
â”‚   â”œâ”€â”€ server              # serverå±‚ï¼Œç”¨äºåˆå§‹åŒ–grpcå’Œhttp server
â”‚   â”‚   â”œâ”€â”€ grpc            # grpcå±‚ï¼Œç”¨äºåˆå§‹åŒ–grpc serverå’Œå®šä¹‰method
â”‚   â”‚   â”‚   â””â”€â”€ server.go
â”‚   â”‚   â””â”€â”€ http            # httpå±‚ï¼Œç”¨äºåˆå§‹åŒ–http serverå’Œå£°æ˜handler
â”‚   â”‚       â””â”€â”€ server.go
â”‚   â””â”€â”€ service             # serviceå±‚ï¼Œç”¨äºä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä¸”ä¸ºæ–¹ä¾¿httpå’Œgrpcå…±ç”¨æ–¹æ³•ï¼Œå»ºè®®å…¥å‚å’Œå‡ºå‚ä¿æŒgrpcé£æ ¼ï¼Œä¸”ä½¿ç”¨pbæ–‡ä»¶ç”Ÿæˆä»£ç 
â”‚       â””â”€â”€ service.go
â””â”€â”€ test                    # æµ‹è¯•èµ„æºå±‚ ç”¨äºå­˜æ”¾æµ‹è¯•ç›¸å…³èµ„æºæ•°æ® å¦‚docker-composeé…ç½® æ•°æ®åº“åˆå§‹åŒ–è¯­å¥ç­‰
    â””â”€â”€ docker-compose.yaml
</code></pre><h2 id="entry">Entry</h2>
<p>å…¥å£åœ¨<code>cmd/main.go</code>ä¸‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå‚æ•°è§£æ
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="c1">// debug flag: log.dir={path}
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo start&#34;</span><span class="p">)</span>
	<span class="c1">// -conf å‚æ•°çš„è§£æ
</span><span class="c1"></span>    <span class="nx">paladin</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
	<span class="c1">// è¿™é‡Œæ˜¯ `æ·±å‘çš„å…¥å£`
</span><span class="c1"></span>	<span class="c1">// ä¸€ä¼šåˆ†æ
</span><span class="c1"></span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">closeFunc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">di</span><span class="p">.</span><span class="nf">InitApp</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// os.Signal æ˜¯ä¸€ä¸ªç³»ç»Ÿä¿¡å·æ¥æ”¶channel
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// syscall éƒ½æ˜¯ä¸€äº›ç³»ç»Ÿä¿¡å·
</span><span class="c1"></span>	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
        <span class="c1">// ä¸€æ—¦æœ‰ä¿¡å·è¿›æ¥äº†ï¼Œçœ‹ä¸‹é¢çš„ä»£ç é€»è¾‘ï¼Œå…«æˆæ˜¯å…³é—­è¿™ä¸ªåº”ç”¨ã€‚
</span><span class="c1"></span>		<span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;get a signal %s&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
		<span class="k">switch</span> <span class="nx">s</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">:</span>
			<span class="nf">closeFunc</span><span class="p">()</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo exit&#34;</span><span class="p">)</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">:</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h2 id="initializer">Initializer</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å»çœ‹<code>di.InitApp()</code>é‡Œåšäº†ä»€ä¹ˆã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡<code>github.com/google/wire</code>æ¥ç”Ÿæˆ.</p>
<p>å¦‚æœä½ ä¸çŸ¥é“<code>wire</code>å¯ä»¥å‚è€ƒä¸‹é¢çš„å®˜æ–¹åŸè¯ï¼š</p>
<blockquote>
<p>Wire is a code generation tool that automates connecting components using dependency injection. Dependencies between components are represented in Wire as function parameters, encouraging explicit initialization instead of global variables. Because Wire operates without runtime state or reflection, code written to be used with Wire is useful even for hand-written initialization.</p>
</blockquote>
<blockquote>
<p>ç®€å•æ¥è¯´å°±æ˜¯Golangçš„ä¾èµ–æ³¨å…¥ä»£ç ç”Ÿæˆå™¨, å®ƒä¸ä½¿ç”¨åå°„.ç”±Googleæä¾›.</p>
</blockquote>
<p>ä¸è¿‡<code>Wire</code>ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹, æˆ‘ä»¬æ¥ç€å›åˆ°<code>di.InitApp()</code>å»ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Injectors from wire.go:
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">InitApp</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="kd">func</span><span class="p">(),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// åŸºæœ¬ä¸Šå°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸ªå®ä¾‹ï¼Œå’Œå–„åå®ƒä»¬çš„å‡½æ•°
</span><span class="c1"></span>    <span class="c1">// å¦‚æœé€”ä¸­åˆ›å»ºå‡ºé—®é¢˜å°±å…¨ä½“ä¸‹è‘¬ï¼ˆè§¦å‘å–„åå‡½æ•°ï¼‰.
</span><span class="c1"></span>
	<span class="c1">// Rediså®ä¾‹ï¼Œå–„åå‡½æ•°
</span><span class="c1"></span>	<span class="nx">redis</span><span class="p">,</span> <span class="nx">cleanup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewRedis</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// memcacheå®ä¾‹ï¼Œå–„åå‡½æ•°
</span><span class="c1"></span>	<span class="nx">memcache</span><span class="p">,</span> <span class="nx">cleanup2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewMC</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// çœ‹èµ·æ¥åªæ”¯æŒMySQLï¼Œå–„åå‡½æ•°
</span><span class="c1"></span>	<span class="nx">db</span><span class="p">,</span> <span class="nx">cleanup3</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewDB</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// æŠŠä¸Šé¢æ‰€æœ‰çš„æ¨¡å‹å¯¹è±¡åšä¸€ä¸ªDAOå±‚å°è£…
</span><span class="c1"></span>	<span class="nx">daoDao</span><span class="p">,</span> <span class="nx">cleanup4</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">redis</span><span class="p">,</span> <span class="nx">memcache</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

    <span class="c1">// è¿™ä¸ªæ˜¯ä¸ªé‡ç‚¹ï¼Œ`service`æ˜¯ä½ çš„gRPCæœåŠ¡.
</span><span class="c1"></span>	<span class="c1">// ä¸€ä¼šæˆ‘ä»¬å»åˆ†æä»–
</span><span class="c1"></span>	<span class="nx">serviceService</span><span class="p">,</span> <span class="nx">cleanup5</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">daoDao</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

    <span class="c1">// æœ‰äººä¼šå¥½å¥‡Kratosæ˜¯æ€ä¹ˆæŠŠgRPCå’ŒGinèåˆåœ¨ä¸€èµ·çš„
</span><span class="c1"></span>    <span class="c1">//ï¼ˆæ²¡é”™Bilibiliçš„webæ¡†æ¶æ˜¯Gin, ä¸è¿‡è¿™ä¸ªGinçš„ä¸€éƒ¨åˆ†æ ¸å¿ƒä»£ç å·²ç»è¢«é­”æ”¹è¿‡äº†ï¼Œ åœ¨Engineåˆå§‹åŒ–çš„æ—¶å€™ä¼šå¤šåŠ å…¥ä¸€ä¸ªé“¾è·¯è¿½è¸ªçš„Middleware, è¿˜æœ‰ä¸€å †è·¯ç”±...ï¼‰
</span><span class="c1"></span>    <span class="c1">// ç§˜å¯†å°±åœ¨è¿™é‡Œï¼Œç­‰ä¼šæˆ‘ä»¬å†çœ‹
</span><span class="c1"></span>	<span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// gRPCçš„åˆå§‹åŒ–çš„å¸¸è§„æ“ä½œ
</span><span class="c1"></span>	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// æŠŠä¸Šé¢çš„æœåŠ¡ï¼Œengine,gRPCæœåŠ¡,æ•´ä¸€å—
</span><span class="c1"></span>	<span class="c1">// å–„åå‡½æ•°
</span><span class="c1"></span>	<span class="c1">// åé¢ç¨å¾®åˆ†æä¸€ä¸‹
</span><span class="c1"></span>	<span class="nx">app</span><span class="p">,</span> <span class="nx">cleanup6</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">,</span> <span class="nx">engine</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// ä½ å¯ä»¥èµ°äº†.
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">app</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">cleanup6</span><span class="p">()</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">//ä»¥ä¸Šä»£ç å…¨æ˜¯è‡ªåŠ¨ç”Ÿæˆï¼Œå†—ä½™å¾ˆæ­£å¸¸
</span></code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹<code>serviceService</code>æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿.<em>(è¿™æ˜¯ä»€ä¹ˆé­”é¬¼å‘½å)</em></p>
<p>è¿›åˆ°<code>Service.New(dao)</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="c1">// Service service.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// é…ç½®æ–‡ä»¶æ˜ å°„çš„Map (è¿™ä¸ªå‘½åå°±nmç¦»è°±)
</span><span class="c1"></span>    <span class="nx">ac</span>  <span class="o">*</span><span class="nx">paladin</span><span class="p">.</span><span class="nx">Map</span>
    <span class="c1">// å­—é¢æ„æ€
</span><span class="c1"></span>	<span class="nx">dao</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">Dao</span>
<span class="p">}</span>

<span class="c1">// New new a service and return.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">d</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">Dao</span><span class="p">)</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">cf</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åˆå§‹åŒ–ï½ï½ï½
</span><span class="c1"></span>	<span class="nx">s</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Service</span><span class="p">{</span>
		<span class="nx">ac</span><span class="p">:</span>  <span class="o">&amp;</span><span class="nx">paladin</span><span class="p">.</span><span class="nx">TOML</span><span class="p">{},</span>
		<span class="nx">dao</span><span class="p">:</span> <span class="nx">d</span><span class="p">,</span>
	<span class="p">}</span>
    <span class="c1">// ä¸€ä¸ªå…³é—­çš„é’©å­
</span><span class="c1"></span>    <span class="nx">cf</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Close</span>

	<span class="c1">// çƒ­åŠ è½½ application.toml é…ç½®æ–‡ä»¶
</span><span class="c1"></span>	<span class="c1">// åŸç†æ˜¯ä½¿ç”¨fsnotifyç›‘å¬æ–‡ä»¶å˜æ›´
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">paladin</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="s">&#34;application.toml&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ac</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// -------------- ä¸‹é¢éƒ½æ˜¯ä½ çš„gRPCä¸šåŠ¡é€»è¾‘-------------
</span><span class="c1"></span>
<span class="c1">// SayHello grpc demo func.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hello %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// SayHelloURL bm demo func.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloResp</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloResp</span><span class="p">{</span>
		<span class="nx">Content</span><span class="p">:</span> <span class="s">&#34;hello &#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hello url %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// Ping ping the resource.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">e</span> <span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dao</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Close close the resource.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{}</span>
</code></pre></div><p>å“‡å“¦ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ï¼Œ<code>Service</code>æ˜¯ç”±ä¸€äº›<code>gRPC</code>æ–¹æ³•ï¼Œé…ç½®é¡¹ï¼Œæ¨¡å‹å±‚ç»„æˆçš„ã€‚</p>
<p>å¥½ï¼Œä¹˜èƒœè¿½å‡»æˆ‘ä»¬å†çœ‹ä¸€çœ‹<code>engine, err := http.New(serviceService)</code>åšäº†ä»€ä¹ˆã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">svc</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">DemoServer</span>

<span class="c1">// New new a bm server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">s</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">DemoServer</span><span class="p">)</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">cfg</span> <span class="nx">bm</span><span class="p">.</span><span class="nx">ServerConfig</span>
		<span class="nx">ct</span>  <span class="nx">paladin</span><span class="p">.</span><span class="nx">TOML</span>
	<span class="p">)</span>
	<span class="c1">// è¯»å–ä½ çš„é…ç½®æ–‡ä»¶
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">paladin</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;http.toml&#34;</span><span class="p">).</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ct</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">// å¾—åˆ°http.tomlçš„Serverå­—æ®µ
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ct</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Server&#34;</span><span class="p">).</span><span class="nf">UnmarshalTOML</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">svc</span> <span class="p">=</span> <span class="nx">s</span>

	<span class="c1">// åšä¸€ä¸ªæ–° engine 
</span><span class="c1"></span>	<span class="c1">// (engine æ˜¯ Gin é‡Œçš„æ¨¡å—ï¼Œè¿™é‡Œæˆ‘å°±ä¸åˆ†æGinçš„æºç äº†)
</span><span class="c1"></span>	<span class="nx">engine</span> <span class="p">=</span> <span class="nx">bm</span><span class="p">.</span><span class="nf">DefaultServer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">)</span>

	<span class="c1">// å°†gRPCæœåŠ¡æ³¨å†Œåˆ°engine, è¿™ä¸ªä»£ç æ³¨å†Œä»£ç æ˜¯bmè‡ªå·±ç”Ÿæˆçš„
</span><span class="c1"></span>	<span class="c1">// ä¸€ä¼šæˆ‘ä»¬åˆ†æ
</span><span class="c1"></span>	<span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterDemoBMServer</span><span class="p">(</span><span class="nx">engine</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

	<span class="c1">// æŠŠä½ çš„è·¯ç”±æè¿›å»
</span><span class="c1"></span>	<span class="nf">initRouter</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span>

	<span class="c1">// å¼€å§‹è·‘
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// è·¯ç”±åœ¨è¿™é‡Œç™»è®°ï¼
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">initRouter</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ping</span><span class="p">)</span>
	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/kratos-demo&#34;</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nx">g</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/start&#34;</span><span class="p">,</span> <span class="nx">howToStart</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;ping error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">AbortWithStatus</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusServiceUnavailable</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// example for http request handler.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">howToStart</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">k</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">model</span><span class="p">.</span><span class="nx">Kratos</span><span class="p">{</span>
		<span class="nx">Hello</span><span class="p">:</span> <span class="s">&#34;Golang å¤§æ³•å¥½ !!!æˆ‘å¥½ä½ ä¸ªå¤´ï¼&#34;</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><p>å¦‚æœä½ ä½¿ç”¨è¿‡<code>gin</code>è¿™ä¸ªwebæ¡†æ¶, ä¸Šé¢çš„ä»£ç ä½ ä¸€å®šå¾ˆç†Ÿæ‚‰ï¼Œå¯¹å§ï¼Ÿ
<code>bm</code>å°±æ˜¯<code>gin</code>ï¼Œåªæ˜¯éƒ¨åˆ†ä»£ç è¢«Bilibilié­”æ”¹äº†ï¼Œæ•´ä½“æ¶æ„æ˜¯ä¸å˜çš„ã€‚</p>
<p>OKï¼Œæˆ‘ä»¬çœ‹çœ‹<code>RegisterDemoBMServer</code>é‡Œåšäº†ä»€ä¹ˆ.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DemoBMServer is the server API for Demo service.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DemoBMServer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">HelloResp</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// æˆ‘ä»¬å†™çš„gRPCæœåŠ¡
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">DemoSvc</span> <span class="nx">DemoBMServer</span>
<span class="c1">// ------------------------------------------------
</span><span class="c1"></span>
<span class="c1">// æˆ‘ä»¬ä»”ç»†åˆ†æè¿™äº›æ–¹æ³•ä¸éš¾å‘ç°
</span><span class="c1">// ä»–ä»¬éƒ½ä¼šè°ƒç”¨ `BindWith` å’Œå¯¹åº”çš„gRPCæ–¹æ³•
</span><span class="c1"></span>
<span class="c1">// å…ˆä½¿ç”¨BindWith: å°†requestä¸­çš„`Body` è½¬åŒ–ä¸ºgoä¸­çš„ `struct`
</span><span class="c1">// ç„¶åä½¿ç”¨gRPCæ–¹æ³•å¤„ç†è¯·æ±‚æ•°æ®
</span><span class="c1">// æœ€åè¿”å›
</span><span class="c1"></span>
<span class="c1">// æœ¬è´¨å°±æ˜¯é€šè¿‡httpè°ƒç”¨gRPCæœåŠ¡
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">demoPing</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">demoSayHello</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HelloReq</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">demoSayHelloURL</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HelloReq</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">//-------------------------------------
</span><span class="c1"></span>
<span class="c1">// RegisterDemoBMServer Register the blademaster route
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterDemoBMServer</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">server</span> <span class="nx">DemoBMServer</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// server æ˜¯æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„gRPCæœåŠ¡
</span><span class="c1"></span>	<span class="nx">DemoSvc</span> <span class="p">=</span> <span class="nx">server</span>
	
	<span class="c1">// å°†ä¸€äº›æ–¹æ³•æ³¨å†Œåˆ°è·¯ç”±é‡Œå» 
</span><span class="c1"></span>	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/demo.service.v1.Demo/Ping&#34;</span><span class="p">,</span> <span class="nx">demoPing</span><span class="p">)</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/demo.service.v1.Demo/SayHello&#34;</span><span class="p">,</span> <span class="nx">demoSayHello</span><span class="p">)</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/kratos-demo/say_hello&#34;</span><span class="p">,</span> <span class="nx">demoSayHelloURL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>å“‡ï¼ŒåŸæ¥åªæ˜¯æŠŠä¸€äº›gRPCçš„æœåŠ¡ç»‘å®šåˆ°<code>gin</code>çš„è·¯ç”±é‡Œäº†å‘€ã€‚
å€Ÿç”¨<code>gin</code>æ¥è°ƒç”¨gRPC.</p>
<p><code>grpc.New()</code>å°±ä¸åˆ†æäº†ã€‚</p>
<p>ç„¶åæ˜¯<code>AppNew()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//go:generate kratos tool wire
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">App</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">svc</span>  <span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span>
	<span class="nx">http</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span>
	<span class="nx">grpc</span> <span class="o">*</span><span class="nx">warden</span><span class="p">.</span><span class="nx">Server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewApp</span><span class="p">(</span><span class="nx">svc</span> <span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">g</span> <span class="o">*</span><span class="nx">warden</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="nx">closeFunc</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">app</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">App</span><span class="p">{</span>
		<span class="nx">svc</span><span class="p">:</span>  <span class="nx">svc</span><span class="p">,</span>
		<span class="nx">http</span><span class="p">:</span> <span class="nx">h</span><span class="p">,</span>
		<span class="nx">grpc</span><span class="p">:</span> <span class="nx">g</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// ä¸€ä¸ªå…³é—­contextçš„å›è°ƒ
</span><span class="c1"></span>	<span class="nx">closeFunc</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">35</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;grpcSrv.Shutdown error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;httpSrv.Shutdown error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nf">cancel</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>
</code></pre></div><p>åˆ°è¿™é‡Œåˆå§‹åŒ–æ˜¯ç»“æŸäº†ã€‚</p>
<h1 id="summary">Summary</h1>
<p><code>kratos</code>çš„åˆå§‹åŒ–æµç¨‹:</p>
<ul>
<li>è¯»å–é…ç½®æ–‡ä»¶</li>
<li>å®ä¾‹åŒ–Daoå±‚</li>
<li>å®ä¾‹åŒ–gRPCæœåŠ¡</li>
<li>å®ä¾‹åŒ–ginçš„engine</li>
<li>æ³¨å†ŒgPRCåˆ°engine</li>
<li>å¯åŠ¨engine</li>
<li>å¯åŠ¨gRPCæœåŠ¡ç«¯</li>
<li>è·å¾—æ•´ä¸ªç¨‹åºå…³é—­çš„å›è°ƒ</li>
</ul>
<p>æˆ‘åˆ†å¾—åº”è¯¥è¿˜æ˜¯æ¯”è¾ƒç»†çš„ã€‚</p>
<p>åé¢åº”è¯¥è¿˜ä¼šåˆ†æ<code>warden</code>ï¼Œå®ƒæ˜¯<code>Kratos</code>åœ¨<code>grpc</code>åŸç‰ˆä¸Šçš„ä¸€ä¸ªå°è£…ç‰ˆæœ¬ã€‚</p>
<p>æºœäº†æºœäº†&hellip;</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="https://sdttttt.github.io/tags/microservice/">microservice</a>
        
            <a href="https://sdttttt.github.io/tags/source-code-analysis/">Source code analysis</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>

    
</article>

    <aside class="widget related-contents--wrapper">
    
    
</aside>

    
        
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>
    var gitalk = new Gitalk({
  clientID: '747ab8530477531c3d25',
  clientSecret: 'af2cc18e4c27998636a6a3c82af0064f38574170',
  repo: 'sdttttt.github.io',
  owner: 'sdttttt',
  admin: ['sdttttt'],
  id: location.pathname,      
  distractionFreeMode: true  
})

gitalk.render('gitalk-container')
</script>

    

    <footer class="site-footer">

</footer>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" style="display:none">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<link rel="stylesheet" href="/css/highlight/light.min.css" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="/css/highlight/dark.min.css" media="(prefers-color-scheme: dark)">

    </body>
</html>
