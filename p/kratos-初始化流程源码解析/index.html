<!DOCTYPE html>
<html lang="zh-cn"><head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Kratos 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。
 名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。
 好！开始吧！
小提示：阅读源码时请保持清醒。
首先是按照Kratos tool 生产的工程目录。
├── CHANGELOG.md ├── OWNERS ├── README.md ├── api # api目录为对外保留的proto文件及生成的pb.go文件 │ ├── api.bm.go │ ├── api.pb.go # 通过go generate生成的pb.go文件 │ ├── api.proto │ └── client.go ├── cmd │ └── main.go # cmd目录为main所在 ├── configs # configs为配置文件目录 │ ├── application.toml # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true │ ├── db.toml # db相关配置 │ ├── grpc.toml # grpc相关配置 │ ├── http.toml # http相关配置 │ ├── memcache.'><title>Kratos 初始化流程源码解析</title>
    
    <link rel='canonical' href='https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Kratos 初始化流程源码解析'>
<meta property='og:description' content='Kratos 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。
 名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。
 好！开始吧！
小提示：阅读源码时请保持清醒。
首先是按照Kratos tool 生产的工程目录。
├── CHANGELOG.md ├── OWNERS ├── README.md ├── api # api目录为对外保留的proto文件及生成的pb.go文件 │ ├── api.bm.go │ ├── api.pb.go # 通过go generate生成的pb.go文件 │ ├── api.proto │ └── client.go ├── cmd │ └── main.go # cmd目录为main所在 ├── configs # configs为配置文件目录 │ ├── application.toml # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true │ ├── db.toml # db相关配置 │ ├── grpc.toml # grpc相关配置 │ ├── http.toml # http相关配置 │ ├── memcache.'>
<meta property='og:url' content='https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/'>
<meta property='og:site_name' content='SDTTTTT&#39;s Smelly fish Rotten shrimp 📓'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='microservice' /><meta property='article:tag' content='Source code analysis' /><meta property='article:published_time' content='2020-03-31T20:17:28&#43;08:00'/><meta property='article:modified_time' content='2020-03-31T20:17:28&#43;08:00'/>
<meta name="twitter:title" content="Kratos 初始化流程源码解析">
<meta name="twitter:description" content="Kratos 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。
 名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。
 好！开始吧！
小提示：阅读源码时请保持清醒。
首先是按照Kratos tool 生产的工程目录。
├── CHANGELOG.md ├── OWNERS ├── README.md ├── api # api目录为对外保留的proto文件及生成的pb.go文件 │ ├── api.bm.go │ ├── api.pb.go # 通过go generate生成的pb.go文件 │ ├── api.proto │ └── client.go ├── cmd │ └── main.go # cmd目录为main所在 ├── configs # configs为配置文件目录 │ ├── application.toml # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true │ ├── db.toml # db相关配置 │ ├── grpc.toml # grpc相关配置 │ ├── http.toml # http相关配置 │ ├── memcache."></head><body class="">
        <div class="container flex on-phone--column align-items--flex-start extended article-page with-toolbar">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                

                
                    
                    <img src="/img/wolaopo_huaa9cfa37fb7c13295de7156385ad8dbe_251770_300x300_resize_box_2.png" width="300"
                        height="300" class="site-logo" loading="lazy" alt="Avatar">
                

                <span class="emoji">🍥</span>
            </figure>
        
        <h1 class="site-name"><a href="https://sdttttt.github.io/">SDTTTTT&#39;s Smelly fish Rotten shrimp 📓</a></h1>
        <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='https://sdttttt.github.io/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='https://sdttttt.github.io/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='https://sdttttt.github.io/archives'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
    </ol>
</aside>
            <main class="main full-width">
    <div id="article-toolbar">
        <a href="https://sdttttt.github.io/" class="back-home">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



            <span>Back</span>
        </a>
    </div>

    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="https://sdttttt.github.io/p/kratos-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Kratos 初始化流程源码解析</a>
    </h2>

    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Mar 31, 2020</time>
    </footer></div>
</header>

    <section class="article-content">
    <p><strong>Kratos</strong> 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。</p>
<blockquote>
<p>名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。</p>
</blockquote>
<p>好！开始吧！</p>
<p><em>小提示：阅读源码时请保持清醒。</em></p>
<p>首先是按照Kratos tool 生产的工程目录。</p>
<pre><code>├── CHANGELOG.md 
├── OWNERS
├── README.md
├── api                     # api目录为对外保留的proto文件及生成的pb.go文件
│   ├── api.bm.go
│   ├── api.pb.go           # 通过go generate生成的pb.go文件
│   ├── api.proto
│   └── client.go
├── cmd
│   └── main.go             # cmd目录为main所在
├── configs                 # configs为配置文件目录
│   ├── application.toml    # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true
│   ├── db.toml             # db相关配置
│   ├── grpc.toml           # grpc相关配置
│   ├── http.toml           # http相关配置
│   ├── memcache.toml       # memcache相关配置
│   └── redis.toml          # redis相关配置
├── go.mod
├── go.sum
└── internal                # internal为项目内部包，包括以下目录：
│   ├── dao                 # dao层，用于数据库、cache、MQ、依赖某业务grpc|http等资源访问
│   │   ├── dao.bts.go
│   │   ├── dao.go
│   │   ├── db.go
│   │   ├── mc.cache.go
│   │   ├── mc.go
│   │   └── redis.go
│   ├── di                  # 依赖注入层 采用wire静态分析依赖
│   │   ├── app.go
│   │   ├── wire.go         # wire 声明
│   │   └── wire_gen.go     # go generate 生成的代码
│   ├── model               # model层，用于声明业务结构体
│   │   └── model.go
│   ├── server              # server层，用于初始化grpc和http server
│   │   ├── grpc            # grpc层，用于初始化grpc server和定义method
│   │   │   └── server.go
│   │   └── http            # http层，用于初始化http server和声明handler
│   │       └── server.go
│   └── service             # service层，用于业务逻辑处理，且为方便http和grpc共用方法，建议入参和出参保持grpc风格，且使用pb文件生成代码
│       └── service.go
└── test                    # 测试资源层 用于存放测试相关资源数据 如docker-compose配置 数据库初始化语句等
    └── docker-compose.yaml
</code></pre><h2 id="entry">Entry</h2>
<p>入口在<code>cmd/main.go</code>下，我们进去看看。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 没什么好说的，参数解析
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="c1">// debug flag: log.dir={path}
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo start&#34;</span><span class="p">)</span>
	<span class="c1">// -conf 参数的解析
</span><span class="c1"></span>    <span class="nx">paladin</span><span class="p">.</span><span class="nf">Init</span><span class="p">()</span>
	<span class="c1">// 这里是 `深坑的入口`
</span><span class="c1"></span>	<span class="c1">// 一会分析
</span><span class="c1"></span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">closeFunc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">di</span><span class="p">.</span><span class="nf">InitApp</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// os.Signal 是一个系统信号接收channel
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// syscall 都是一些系统信号
</span><span class="c1"></span>	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
        <span class="c1">// 一旦有信号进来了，看下面的代码逻辑，八成是关闭这个应用。
</span><span class="c1"></span>		<span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;get a signal %s&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
		<span class="k">switch</span> <span class="nx">s</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">:</span>
			<span class="nf">closeFunc</span><span class="p">()</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo exit&#34;</span><span class="p">)</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">:</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></div><h2 id="initializer">Initializer</h2>
<p>接下来我们去看<code>di.InitApp()</code>里做了什么。</p>
<p>这个方法是通过<code>github.com/google/wire</code>来生成.</p>
<p>如果你不知道<code>wire</code>可以参考下面的官方原话：</p>
<blockquote>
<p>Wire is a code generation tool that automates connecting components using dependency injection. Dependencies between components are represented in Wire as function parameters, encouraging explicit initialization instead of global variables. Because Wire operates without runtime state or reflection, code written to be used with Wire is useful even for hand-written initialization.</p>
</blockquote>
<blockquote>
<p>简单来说就是Golang的依赖注入代码生成器, 它不使用反射.由Google提供.</p>
</blockquote>
<p>不过<code>Wire</code>不是我们的重点, 我们接着回到<code>di.InitApp()</code>去。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Injectors from wire.go:
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">InitApp</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="kd">func</span><span class="p">(),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 基本上就是创建一个个实例，和善后它们的函数
</span><span class="c1"></span>    <span class="c1">// 如果途中创建出问题就全体下葬（触发善后函数）.
</span><span class="c1"></span>
	<span class="c1">// Redis实例，善后函数
</span><span class="c1"></span>	<span class="nx">redis</span><span class="p">,</span> <span class="nx">cleanup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewRedis</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// memcache实例，善后函数
</span><span class="c1"></span>	<span class="nx">memcache</span><span class="p">,</span> <span class="nx">cleanup2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewMC</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 看起来只支持MySQL，善后函数
</span><span class="c1"></span>	<span class="nx">db</span><span class="p">,</span> <span class="nx">cleanup3</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewDB</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

	<span class="c1">// 把上面所有的模型对象做一个DAO层封装
</span><span class="c1"></span>	<span class="nx">daoDao</span><span class="p">,</span> <span class="nx">cleanup4</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">redis</span><span class="p">,</span> <span class="nx">memcache</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

    <span class="c1">// 这个是个重点，`service`是你的gRPC服务.
</span><span class="c1"></span>	<span class="c1">// 一会我们去分析他
</span><span class="c1"></span>	<span class="nx">serviceService</span><span class="p">,</span> <span class="nx">cleanup5</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">daoDao</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>

    <span class="c1">// 有人会好奇Kratos是怎么把gRPC和Gin融合在一起的
</span><span class="c1"></span>    <span class="c1">//（没错Bilibili的web框架是Gin, 不过这个Gin的一部分核心代码已经被魔改过了， 在Engine初始化的时候会多加入一个链路追踪的Middleware, 还有一堆路由...）
</span><span class="c1"></span>    <span class="c1">// 秘密就在这里，等会我们再看
</span><span class="c1"></span>	<span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// gRPC的初始化的常规操作
</span><span class="c1"></span>	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// 把上面的服务，engine,gRPC服务,整一块
</span><span class="c1"></span>	<span class="c1">// 善后函数
</span><span class="c1"></span>	<span class="c1">// 后面稍微分析一下
</span><span class="c1"></span>	<span class="nx">app</span><span class="p">,</span> <span class="nx">cleanup6</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">,</span> <span class="nx">engine</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    
    <span class="c1">// 你可以走了.
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">app</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nf">cleanup6</span><span class="p">()</span>
		<span class="nf">cleanup5</span><span class="p">()</span>
		<span class="nf">cleanup4</span><span class="p">()</span>
		<span class="nf">cleanup3</span><span class="p">()</span>
		<span class="nf">cleanup2</span><span class="p">()</span>
		<span class="nf">cleanup</span><span class="p">()</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">//以上代码全是自动生成，冗余很正常
</span></code></pre></div><p>接下来我们首先看看<code>serviceService</code>是个什么东西.<em>(这是什么魔鬼命名)</em></p>
<p>进到<code>Service.New(dao)</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="c1">// Service service.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// 配置文件映射的Map (这个命名就nm离谱)
</span><span class="c1"></span>    <span class="nx">ac</span>  <span class="o">*</span><span class="nx">paladin</span><span class="p">.</span><span class="nx">Map</span>
    <span class="c1">// 字面意思
</span><span class="c1"></span>	<span class="nx">dao</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">Dao</span>
<span class="p">}</span>

<span class="c1">// New new a service and return.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">d</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">Dao</span><span class="p">)</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">cf</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 初始化～～～
</span><span class="c1"></span>	<span class="nx">s</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Service</span><span class="p">{</span>
		<span class="nx">ac</span><span class="p">:</span>  <span class="o">&amp;</span><span class="nx">paladin</span><span class="p">.</span><span class="nx">TOML</span><span class="p">{},</span>
		<span class="nx">dao</span><span class="p">:</span> <span class="nx">d</span><span class="p">,</span>
	<span class="p">}</span>
    <span class="c1">// 一个关闭的钩子
</span><span class="c1"></span>    <span class="nx">cf</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Close</span>

	<span class="c1">// 热加载 application.toml 配置文件
</span><span class="c1"></span>	<span class="c1">// 原理是使用fsnotify监听文件变更
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">paladin</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="s">&#34;application.toml&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ac</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// -------------- 下面都是你的gRPC业务逻辑-------------
</span><span class="c1"></span>
<span class="c1">// SayHello grpc demo func.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hello %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// SayHelloURL bm demo func.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">reply</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloResp</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloResp</span><span class="p">{</span>
		<span class="nx">Content</span><span class="p">:</span> <span class="s">&#34;hello &#34;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;hello url %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// Ping ping the resource.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">e</span> <span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">empty</span><span class="p">.</span><span class="nx">Empty</span><span class="p">{},</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dao</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Close close the resource.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="p">{}</span>
</code></pre></div><p>哇哦，现在我们知道了，<code>Service</code>是由一些<code>gRPC</code>方法，配置项，模型层组成的。</p>
<p>好，乘胜追击我们再看一看<code>engine, err := http.New(serviceService)</code>做了什么。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">svc</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">DemoServer</span>

<span class="c1">// New new a bm server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">s</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">DemoServer</span><span class="p">)</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">cfg</span> <span class="nx">bm</span><span class="p">.</span><span class="nx">ServerConfig</span>
		<span class="nx">ct</span>  <span class="nx">paladin</span><span class="p">.</span><span class="nx">TOML</span>
	<span class="p">)</span>
	<span class="c1">// 读取你的配置文件
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">paladin</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;http.toml&#34;</span><span class="p">).</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ct</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">// 得到http.toml的Server字段
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ct</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Server&#34;</span><span class="p">).</span><span class="nf">UnmarshalTOML</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">svc</span> <span class="p">=</span> <span class="nx">s</span>

	<span class="c1">// 做一个新 engine 
</span><span class="c1"></span>	<span class="c1">// (engine 是 Gin 里的模块，这里我就不分析Gin的源码了)
</span><span class="c1"></span>	<span class="nx">engine</span> <span class="p">=</span> <span class="nx">bm</span><span class="p">.</span><span class="nf">DefaultServer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">)</span>

	<span class="c1">// 将gRPC服务注册到engine, 这个代码注册代码是bm自己生成的
</span><span class="c1"></span>	<span class="c1">// 一会我们分析
</span><span class="c1"></span>	<span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterDemoBMServer</span><span class="p">(</span><span class="nx">engine</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

	<span class="c1">// 把你的路由搞进去
</span><span class="c1"></span>	<span class="nf">initRouter</span><span class="p">(</span><span class="nx">engine</span><span class="p">)</span>

	<span class="c1">// 开始跑
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="c1">// 路由在这里登记！
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">initRouter</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ping</span><span class="p">)</span>
	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/kratos-demo&#34;</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="nx">g</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/start&#34;</span><span class="p">,</span> <span class="nx">howToStart</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;ping error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nf">AbortWithStatus</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusServiceUnavailable</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// example for http request handler.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">howToStart</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">k</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">model</span><span class="p">.</span><span class="nx">Kratos</span><span class="p">{</span>
		<span class="nx">Hello</span><span class="p">:</span> <span class="s">&#34;Golang 大法好 !!!我好你个头！&#34;</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><p>如果你使用过<code>gin</code>这个web框架, 上面的代码你一定很熟悉，对吧？
<code>bm</code>就是<code>gin</code>，只是部分代码被Bilibili魔改了，整体架构是不变的。</p>
<p>OK，我们看看<code>RegisterDemoBMServer</code>里做了什么.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// DemoBMServer is the server API for Demo service.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DemoBMServer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Ping</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nf">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

	<span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">HelloReq</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">HelloResp</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 我们写的gRPC服务
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">DemoSvc</span> <span class="nx">DemoBMServer</span>
<span class="c1">// ------------------------------------------------
</span><span class="c1"></span>
<span class="c1">// 我们仔细分析这些方法不难发现
</span><span class="c1">// 他们都会调用 `BindWith` 和对应的gRPC方法
</span><span class="c1"></span>
<span class="c1">// 先使用BindWith: 将request中的`Body` 转化为go中的 `struct`
</span><span class="c1">// 然后使用gRPC方法处理请求数据
</span><span class="c1">// 最后返回
</span><span class="c1"></span>
<span class="c1">// 本质就是通过http调用gRPC服务
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">demoPing</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">google_protobuf1</span><span class="p">.</span><span class="nx">Empty</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">demoSayHello</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HelloReq</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">demoSayHelloURL</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">HelloReq</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BindWith</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nf">Default</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">DemoSvc</span><span class="p">.</span><span class="nf">SayHelloURL</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">//-------------------------------------
</span><span class="c1"></span>
<span class="c1">// RegisterDemoBMServer Register the blademaster route
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterDemoBMServer</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">server</span> <span class="nx">DemoBMServer</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// server 是我们之前编写的gRPC服务
</span><span class="c1"></span>	<span class="nx">DemoSvc</span> <span class="p">=</span> <span class="nx">server</span>
	
	<span class="c1">// 将一些方法注册到路由里去 
</span><span class="c1"></span>	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/demo.service.v1.Demo/Ping&#34;</span><span class="p">,</span> <span class="nx">demoPing</span><span class="p">)</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/demo.service.v1.Demo/SayHello&#34;</span><span class="p">,</span> <span class="nx">demoSayHello</span><span class="p">)</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/kratos-demo/say_hello&#34;</span><span class="p">,</span> <span class="nx">demoSayHelloURL</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>哇，原来只是把一些gRPC的服务绑定到<code>gin</code>的路由里了呀。
借用<code>gin</code>来调用gRPC.</p>
<p><code>grpc.New()</code>就不分析了。</p>
<p>然后是<code>AppNew()</code></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//go:generate kratos tool wire
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">App</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">svc</span>  <span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span>
	<span class="nx">http</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span>
	<span class="nx">grpc</span> <span class="o">*</span><span class="nx">warden</span><span class="p">.</span><span class="nx">Server</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewApp</span><span class="p">(</span><span class="nx">svc</span> <span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">bm</span><span class="p">.</span><span class="nx">Engine</span><span class="p">,</span> <span class="nx">g</span> <span class="o">*</span><span class="nx">warden</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="nx">closeFunc</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">app</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">App</span><span class="p">{</span>
		<span class="nx">svc</span><span class="p">:</span>  <span class="nx">svc</span><span class="p">,</span>
		<span class="nx">http</span><span class="p">:</span> <span class="nx">h</span><span class="p">,</span>
		<span class="nx">grpc</span><span class="p">:</span> <span class="nx">g</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// 一个关闭context的回调
</span><span class="c1"></span>	<span class="nx">closeFunc</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">35</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;grpcSrv.Shutdown error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;httpSrv.Shutdown error(%v)&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nf">cancel</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>
</code></pre></div><p>到这里初始化是结束了。</p>
<h1 id="summary">Summary</h1>
<p><code>kratos</code>的初始化流程:</p>
<ul>
<li>读取配置文件</li>
<li>实例化Dao层</li>
<li>实例化gRPC服务</li>
<li>实例化gin的engine</li>
<li>注册gPRC到engine</li>
<li>启动engine</li>
<li>启动gRPC服务端</li>
<li>获得整个程序关闭的回调</li>
</ul>
<p>我分得应该还是比较细的。</p>
<p>后面应该还会分析<code>warden</code>，它是<code>Kratos</code>在<code>grpc</code>原版上的一个封装版本。</p>
<p>溜了溜了&hellip;</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="https://sdttttt.github.io/tags/microservice/">microservice</a>
        
            <a href="https://sdttttt.github.io/tags/source-code-analysis/">Source code analysis</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>

    
</article>

    <aside class="widget related-contents--wrapper">
    
    
</aside>

    
        
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>
    var gitalk = new Gitalk({
  clientID: '747ab8530477531c3d25',
  clientSecret: 'af2cc18e4c27998636a6a3c82af0064f38574170',
  repo: 'sdttttt.github.io',
  owner: 'sdttttt',
  admin: ['sdttttt'],
  id: location.pathname,      
  distractionFreeMode: true  
})

gitalk.render('gitalk-container')
</script>

    

    <footer class="site-footer">

</footer>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true" style="display:none">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<link rel="stylesheet" href="/css/highlight/light.min.css" media="(prefers-color-scheme: light)">
<link rel="stylesheet" href="/css/highlight/dark.min.css" media="(prefers-color-scheme: dark)">

    </body>
</html>
