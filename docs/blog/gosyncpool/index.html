<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="dark"><title>GoSyncPool | SDTTTTT</title><link rel=stylesheet href=/sass/main.min.12754930aaca2409561861a9f13c52153f073ef96d63061a9a330c250f392fcb.css></head><body class=dark><nav class=navbar><div class=container><div class=flex><div><a class=brand href=/>SDTTTTT</a></div><div class=flex><button id=dark-mode-button></button></div></div></div></nav><main><div class=container><article><header class=article-header><div class=thumb><div><h1>GoSyncPool</h1><div class=post-meta><div>By sdttttt on <time>September 03, 2020</time></div><div class=tags><a href=/tags/golang/>Golang</a></div></div></div></div></header></article><div class=article-post><p>今天在看Sentinel-golang源码的时候发现sentinel在内部使用了sync.Pool该结构体.看到Sync和Pool的我第一反应想到应该是线程池之类的东西.在实际看过原理之后发现并不是这样的.</p><hr><p>sync.Pool 的目的是为了利用对象的复用来减小GC压力.但是开销比较高.要斟酌使用.</p><p>Pool和golang的GMP协程模型的关系比较大.
sync.Pool对每一个P(系统线程)都分配了一个本地池.</p><p>本地池中有2个属性，分别是private和share。
private只能被当前P访问，share可以被不同的P访问.</p><p>在执行Get or Put的时候.会对应当前执行P的本地池.</p><h4 id=get>Get</h4><ol><li>尝试从本地P对应的那个本地池中获取一个对象值, 并从本地池冲删除该值。</li><li>如果获取失败，那么从共享池中获取, 并从共享队列中删除该值。</li><li>如果获取失败，那么从其他P的共享池中偷一个过来，并删除共享池中的该值(p.getSlow())。</li><li>如果仍然失败，那么直接通过New()分配一个返回值，注意这个分配的值不会被放入池中。New()返回用户注册的New函数的值，如果用户未注册New，那么返回nil。</li></ol><h4 id=put>Put</h4><ol><li>如果放入的值为空，直接return.</li><li>检查当前goroutine的是否设置对象池私有值，如果没有则将x赋值给其私有成员，并将x设置为nil。</li><li>如果当前goroutine私有值已经被设置，那么将该值追加到共享列表。</li></ol></div></div><div class=container><nav class="flex container suggested"><a rel=prev href=/blog/btree/ title="Previous post (older)"><span>Previous</span>
B Tree</a>
<a rel=next href=/blog/mybatissourcecode/ title="Next post (newer)"><span>Next</span>
MyBatis 源码分析</a></nav></div></main></main><footer class="footer flex"><section class=container><nav class=footer-links></nav></section><script async src=/js/features.min.f77830aff4bfb7a756b9ef68388f40d2187cb0046d41790785074eb8cd054cc3.js data-enable-footnotes=true></script></footer></body></html>