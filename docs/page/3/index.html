<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#000" />
    <title>
        
             
                SDTTTTT 
             
            &middot; Lorem ipsum dolor sit amet, consectetur adipiscing elit.
        
    </title>

    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
        integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    
    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed:wght@300&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="">
    
    
    <meta name="description" content="Lorem ipsum dolor sit amet, consectetur adipiscing elit.">
    

    
    <meta name="author" content="Sdttttt"></head>
<body>
        <div class="container"><div id="navbar" class="pure-menu pure-menu-open pure-menu-horizontal pure-menu-scrollable">
    <a href="/" class="pure-menu-heading">
         
            SDTTTTT 
         
    </a>
    <ul class="pure-menu-list">
        <li class="pure-menu-item">
            <a href="/posts" class="pure-menu-link">
                <i class="fa fa-archive"></i>
                Articles
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/tags" class="pure-menu-link">
                <i class="fas fa-comments"></i>
                Categories
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/about" class="pure-menu-link">
                <i class="fas fa-smile"></i>
                About
            </a>
        </li>
    </ul>
    <ul class="pure-menu-list pull-right">
        
        <li class="pure-menu-item">
            <a href="https://github.com/sdttttt" title="Github" class="pure-menu-link">
                <i class="fab fa-github"></i>
                <span class="hide">Github</span>
            </a>
        </li>
        
        
        <li class="pure-menu-item">
            <a href="http://twitter.com/shiina38092638" title="@pravin" class="pure-menu-link">
                <i class="fab fa-twitter-square"></i>
                <span class="hide">Twitter</span>
            </a>
        </li>
        
        
        
        
        <li class="pure-menu-item">
            <a href="https://www.facebook.com/sdzzzzz" title="Facebook" class="pure-menu-link">
                <i class="fab fa-facebook"></i>
                <span class="hide">Facebook</span>
            </a>
        </li>
        
        <li class="pure-menu-item">
            <a href="/posts/index.xml" title="Atom Feed" class="pure-menu-link">
                <i class="fas fa-rss-square"></i>
                <span class="hide">RSS Feed</span>
            </a>
        </li>
    </ul>
</div>
<div class="pure-u-1">
    <div class="pad">
    </div>
</div>
<div class="pure-g">

<div id="content" class="pure-u-1 pure-u-md-3-4 pure-u-sm-1">
    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-02">April 2, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/onlyhub/">只需要服务中心</a></h1>
    <div class="tags">
        
        
        <a href="/tags/microservice" class="pure-button">microservice</a>
        
    </div>
    <p>目前，市面上以及出现了各种各样的适用于微服务(下面简称ms)的注册中心，配合其使用的还有各种ms框架，例如Alibaba的<code>Dubbo</code>。</p>
<p>微服务能通过分解服务粒度，然后针对特定服务进行性能扩展，来达到高性能的目的。</p>
<p>其中服务中心负责服务的注册和生命周期管理，<code>Dubbo</code>之类的微服务框架则对服务的注册, 负载均衡，服务鉴权, 服务调用等一系列操作做封装，供用户调用.</p>
<p>使得用户不用去关心微服务的实现细节。</p>
<hr>
<p>我的想法相反，或许能让服务中心做更多的事。</p>
<p>我们可以从头，去设计一个服务中心：</p>
<ul>
<li>只管理服务名和服务地址。</li>
<li>消费端索取服务时，则由服务中心来做负载均衡和一些额外的工作，直接给出服务提供方地址。</li>
</ul>
<p>其他的功能可以按照现有的服务注册中心来设计。</p>
<p>关于微服务的调用，则由服务注册中心提供一个微服务库，来供我们调用，或者由用户自己实现。这个架构下，就不需要<code>Dubbo</code>之类的RPC框架。</p>
<p>优点：模块减少，开发可能会成本减少。</p>
<p>缺点：需要服务中心来提供微服务调用库。（而且服务中心处理的东西变多了，不知道性能会有多少影响）</p>
<p>目前小生已经搞了一个类似这中服务注册中心的Demo，可以参考。</p>
<p><a href="https://github.com/sdttttt/go-tds">https://github.com/sdttttt/go-tds</a></p>
<p>（这只是一个我突发的灵感罢了，其实挺荒唐的。）</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-03-31">March 31, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/kratos/">Kratos 初始化流程源码解析</a></h1>
    <div class="tags">
        
        
        <a href="/tags/microservice" class="pure-button">microservice</a>
        
        
        <a href="/tags/source-code-analysis" class="pure-button">Source code analysis</a>
        
    </div>
    <p><strong>Kratos</strong> 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。</p>
<blockquote>
<p>名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。</p>
</blockquote>
<p>好！开始吧！</p>
<p><em>小提示：阅读源码时请保持清醒。</em></p>
<p>首先是按照Kratos tool 生产的工程目录。</p>
<pre><code>├── CHANGELOG.md 
├── OWNERS
├── README.md
├── api                     # api目录为对外保留的proto文件及生成的pb.go文件
│   ├── api.bm.go
│   ├── api.pb.go           # 通过go generate生成的pb.go文件
│   ├── api.proto
│   └── client.go
├── cmd
│   └── main.go             # cmd目录为main所在
├── configs                 # configs为配置文件目录
│   ├── application.toml    # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true
│   ├── db.toml             # db相关配置
│   ├── grpc.toml           # grpc相关配置
│   ├── http.toml           # http相关配置
│   ├── memcache.toml       # memcache相关配置
│   └── redis.toml          # redis相关配置
├── go.mod
├── go.sum
└── internal                # internal为项目内部包，包括以下目录：
│   ├── dao                 # dao层，用于数据库、cache、MQ、依赖某业务grpc|http等资源访问
│   │   ├── dao.bts.go
│   │   ├── dao.go
│   │   ├── db.go
│   │   ├── mc.cache.go
│   │   ├── mc.go
│   │   └── redis.go
│   ├── di                  # 依赖注入层 采用wire静态分析依赖
│   │   ├── app.go
│   │   ├── wire.go         # wire 声明
│   │   └── wire_gen.go     # go generate 生成的代码
│   ├── model               # model层，用于声明业务结构体
│   │   └── model.go
│   ├── server              # server层，用于初始化grpc和http server
│   │   ├── grpc            # grpc层，用于初始化grpc server和定义method
│   │   │   └── server.go
│   │   └── http            # http层，用于初始化http server和声明handler
│   │       └── server.go
│   └── service             # service层，用于业务逻辑处理，且为方便http和grpc共用方法，建议入参和出参保持grpc风格，且使用pb文件生成代码
│       └── service.go
└── test                    # 测试资源层 用于存放测试相关资源数据 如docker-compose配置 数据库初始化语句等
    └── docker-compose.yaml
</code></pre><h2 id="entry">Entry</h2>
<p>入口在<code>cmd/main.go</code>下，我们进去看看。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// 没什么好说的，参数解析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Init</span>(<span style="color:#66d9ef">nil</span>) <span style="color:#75715e">// debug flag: log.dir={path}
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;kratos-demo start&#34;</span>)
	<span style="color:#75715e">// -conf 参数的解析
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#75715e">// 这里是 `深坑的入口`
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 一会分析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">closeFunc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">di</span>.<span style="color:#a6e22e">InitApp</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
    }
    <span style="color:#75715e">// os.Signal 是一个系统信号接收channel
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>, <span style="color:#ae81ff">1</span>)
    <span style="color:#75715e">// syscall 都是一些系统信号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGHUP</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGQUIT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>)
	<span style="color:#66d9ef">for</span> {
        <span style="color:#75715e">// 一旦有信号进来了，看下面的代码逻辑，八成是关闭这个应用。
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;get a signal %s&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">String</span>())
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">s</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGQUIT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>:
			<span style="color:#a6e22e">closeFunc</span>()
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;kratos-demo exit&#34;</span>)
			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
			<span style="color:#66d9ef">return</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGHUP</span>:
		<span style="color:#66d9ef">default</span>:
			<span style="color:#66d9ef">return</span>
		}
	}
}

</code></pre></div><h2 id="initializer">Initializer</h2>
<p>接下来我们去看<code>di.InitApp()</code>里做了什么。</p>
<p>这个方法是通过<code>github.com/google/wire</code>来生成.</p>
<p>如果你不知道<code>wire</code>可以参考下面的官方原话：</p>
<blockquote>
<p>Wire is a code generation tool that automates connecting components using dependency injection. Dependencies between components are represented in Wire as function parameters, encouraging explicit initialization instead of global variables. Because Wire operates without runtime state or reflection, code written to be used with Wire is useful even for hand-written initialization.</p>
</blockquote>
<blockquote>
<p>简单来说就是Golang的依赖注入代码生成器, 它不使用反射.由Google提供.</p>
</blockquote>
<p>不过<code>Wire</code>不是我们的重点, 我们接着回到<code>di.InitApp()</code>去。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Injectors from wire.go:
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">InitApp</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">App</span>, <span style="color:#66d9ef">func</span>(), <span style="color:#66d9ef">error</span>) {

    <span style="color:#75715e">// 基本上就是创建一个个实例，和善后它们的函数
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 如果途中创建出问题就全体下葬（触发善后函数）.
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// Redis实例，善后函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">redis</span>, <span style="color:#a6e22e">cleanup</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">NewRedis</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// memcache实例，善后函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memcache</span>, <span style="color:#a6e22e">cleanup2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">NewMC</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// 看起来只支持MySQL，善后函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">cleanup3</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">NewDB</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// 把上面所有的模型对象做一个DAO层封装
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">daoDao</span>, <span style="color:#a6e22e">cleanup4</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">redis</span>, <span style="color:#a6e22e">memcache</span>, <span style="color:#a6e22e">db</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">// 这个是个重点，`service`是你的gRPC服务.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 一会我们去分析他
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">serviceService</span>, <span style="color:#a6e22e">cleanup5</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">daoDao</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup4</span>()
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">// 有人会好奇Kratos是怎么把gRPC和Gin融合在一起的
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//（没错Bilibili的web框架是Gin, 不过这个Gin的一部分核心代码已经被魔改过了， 在Engine初始化的时候会多加入一个链路追踪的Middleware, 还有一堆路由...）
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 秘密就在这里，等会我们再看
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">engine</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">serviceService</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup5</span>()
		<span style="color:#a6e22e">cleanup4</span>()
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    
    <span style="color:#75715e">// gRPC的初始化的常规操作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">serviceService</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup5</span>()
		<span style="color:#a6e22e">cleanup4</span>()
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    
    <span style="color:#75715e">// 把上面的服务，engine,gRPC服务,整一块
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 善后函数
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 后面稍微分析一下
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">app</span>, <span style="color:#a6e22e">cleanup6</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewApp</span>(<span style="color:#a6e22e">serviceService</span>, <span style="color:#a6e22e">engine</span>, <span style="color:#a6e22e">server</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cleanup5</span>()
		<span style="color:#a6e22e">cleanup4</span>()
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
    
    <span style="color:#75715e">// 你可以走了.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">app</span>, <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">cleanup6</span>()
		<span style="color:#a6e22e">cleanup5</span>()
		<span style="color:#a6e22e">cleanup4</span>()
		<span style="color:#a6e22e">cleanup3</span>()
		<span style="color:#a6e22e">cleanup2</span>()
		<span style="color:#a6e22e">cleanup</span>()
	}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//以上代码全是自动生成，冗余很正常
</span></code></pre></div><p>接下来我们首先看看<code>serviceService</code>是个什么东西.<em>(这是什么魔鬼命名)</em></p>
<p>进到<code>Service.New(dao)</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#75715e">// Service service.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Service</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#75715e">// 配置文件映射的Map (这个命名就nm离谱)
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ac</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">Map</span>
    <span style="color:#75715e">// 字面意思
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dao</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">Dao</span>
}

<span style="color:#75715e">// New new a service and return.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">d</span> <span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">Dao</span>) (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Service</span>, <span style="color:#a6e22e">cf</span> <span style="color:#66d9ef">func</span>(), <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// 初始化～～～
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Service</span>{
		<span style="color:#a6e22e">ac</span>:  <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">TOML</span>{},
		<span style="color:#a6e22e">dao</span>: <span style="color:#a6e22e">d</span>,
	}
    <span style="color:#75715e">// 一个关闭的钩子
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cf</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Close</span>

	<span style="color:#75715e">// 热加载 application.toml 配置文件
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 原理是使用fsnotify监听文件变更
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">Watch</span>(<span style="color:#e6db74">&#34;application.toml&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ac</span>)
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// -------------- 下面都是你的gRPC业务逻辑-------------
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// SayHello grpc demo func.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloReq</span>) (<span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">reply</span> = new(<span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;hello %s&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// SayHelloURL bm demo func.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">SayHelloURL</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloReq</span>) (<span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">reply</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HelloResp</span>{
		<span style="color:#a6e22e">Content</span>: <span style="color:#e6db74">&#34;hello &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>,
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;hello url %s&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// Ping ping the resource.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">empty</span>.<span style="color:#a6e22e">Empty</span>{}, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">dao</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>)
}

<span style="color:#75715e">// Close close the resource.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">Close</span>() {}
</code></pre></div><p>哇哦，现在我们知道了，<code>Service</code>是由一些<code>gRPC</code>方法，配置项，模型层组成的。</p>
<p>好，乘胜追击我们再看一看<code>engine, err := http.New(serviceService)</code>做了什么。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">svc</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">DemoServer</span>

<span style="color:#75715e">// New new a bm server.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">DemoServer</span>) (<span style="color:#a6e22e">engine</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Engine</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">var</span> (
		<span style="color:#a6e22e">cfg</span> <span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">ServerConfig</span>
		<span style="color:#a6e22e">ct</span>  <span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">TOML</span>
	)
	<span style="color:#75715e">// 读取你的配置文件
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">paladin</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;http.toml&#34;</span>).<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ct</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">// 得到http.toml的Server字段
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ct</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Server&#34;</span>).<span style="color:#a6e22e">UnmarshalTOML</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cfg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">svc</span> = <span style="color:#a6e22e">s</span>

	<span style="color:#75715e">// 做一个新 engine 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// (engine 是 Gin 里的模块，这里我就不分析Gin的源码了)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">engine</span> = <span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">DefaultServer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cfg</span>)

	<span style="color:#75715e">// 将gRPC服务注册到engine, 这个代码注册代码是bm自己生成的
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 一会我们分析
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RegisterDemoBMServer</span>(<span style="color:#a6e22e">engine</span>, <span style="color:#a6e22e">s</span>)

	<span style="color:#75715e">// 把你的路由搞进去
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">initRouter</span>(<span style="color:#a6e22e">engine</span>)

	<span style="color:#75715e">// 开始跑
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">engine</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">// 路由在这里登记！
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initRouter</span>(<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Engine</span>) {
	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ping</span>)
	<span style="color:#a6e22e">g</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Group</span>(<span style="color:#e6db74">&#34;/kratos-demo&#34;</span>)
	{
		<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/start&#34;</span>, <span style="color:#a6e22e">howToStart</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ping</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#66d9ef">nil</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;ping error(%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">AbortWithStatus</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusServiceUnavailable</span>)
	}
}

<span style="color:#75715e">// example for http request handler.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">howToStart</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Kratos</span>{
		<span style="color:#a6e22e">Hello</span>: <span style="color:#e6db74">&#34;Golang 大法好 !!!我好你个头！&#34;</span>,
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">k</span>, <span style="color:#66d9ef">nil</span>)
}

</code></pre></div><p>如果你使用过<code>gin</code>这个web框架, 上面的代码你一定很熟悉，对吧？
<code>bm</code>就是<code>gin</code>，只是部分代码被Bilibili魔改了，整体架构是不变的。</p>
<p>OK，我们看看<code>RegisterDemoBMServer</code>里做了什么.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// DemoBMServer is the server API for Demo service.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DemoBMServer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">google_protobuf1</span>.<span style="color:#a6e22e">Empty</span>) (<span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">google_protobuf1</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)

	<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReq</span>) (<span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">google_protobuf1</span>.<span style="color:#a6e22e">Empty</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)

	<span style="color:#a6e22e">SayHelloURL</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloReq</span>) (<span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// 我们写的gRPC服务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DemoSvc</span> <span style="color:#a6e22e">DemoBMServer</span>
<span style="color:#75715e">// ------------------------------------------------
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 我们仔细分析这些方法不难发现
</span><span style="color:#75715e">// 他们都会调用 `BindWith` 和对应的gRPC方法
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 先使用BindWith: 将request中的`Body` 转化为go中的 `struct`
</span><span style="color:#75715e">// 然后使用gRPC方法处理请求数据
</span><span style="color:#75715e">// 最后返回
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 本质就是通过http调用gRPC服务
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoPing</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">google_protobuf1</span>.<span style="color:#a6e22e">Empty</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindWith</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">binding</span>.<span style="color:#a6e22e">Default</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Method</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>))); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DemoSvc</span>.<span style="color:#a6e22e">Ping</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoSayHello</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">HelloReq</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindWith</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">binding</span>.<span style="color:#a6e22e">Default</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Method</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>))); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DemoSvc</span>.<span style="color:#a6e22e">SayHello</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">demoSayHelloURL</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">HelloReq</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">BindWith</span>(<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">binding</span>.<span style="color:#a6e22e">Default</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Method</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>))); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">DemoSvc</span>.<span style="color:#a6e22e">SayHelloURL</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">p</span>)
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>)
}
<span style="color:#75715e">//-------------------------------------
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// RegisterDemoBMServer Register the blademaster route
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RegisterDemoBMServer</span>(<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Engine</span>, <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">DemoBMServer</span>) {
	<span style="color:#75715e">// server 是我们之前编写的gRPC服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DemoSvc</span> = <span style="color:#a6e22e">server</span>
	
	<span style="color:#75715e">// 将一些方法注册到路由里去 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/demo.service.v1.Demo/Ping&#34;</span>, <span style="color:#a6e22e">demoPing</span>)
	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/demo.service.v1.Demo/SayHello&#34;</span>, <span style="color:#a6e22e">demoSayHello</span>)
	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/kratos-demo/say_hello&#34;</span>, <span style="color:#a6e22e">demoSayHelloURL</span>)
}
</code></pre></div><p>哇，原来只是把一些gRPC的服务绑定到<code>gin</code>的路由里了呀。
借用<code>gin</code>来调用gRPC.</p>
<p><code>grpc.New()</code>就不分析了。</p>
<p>然后是<code>AppNew()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//go:generate kratos tool wire
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">App</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">svc</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Service</span>
	<span style="color:#a6e22e">http</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Engine</span>
	<span style="color:#a6e22e">grpc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">warden</span>.<span style="color:#a6e22e">Server</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewApp</span>(<span style="color:#a6e22e">svc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Service</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bm</span>.<span style="color:#a6e22e">Engine</span>, <span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">warden</span>.<span style="color:#a6e22e">Server</span>) (<span style="color:#a6e22e">app</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">App</span>, <span style="color:#a6e22e">closeFunc</span> <span style="color:#66d9ef">func</span>(), <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">app</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">App</span>{
		<span style="color:#a6e22e">svc</span>:  <span style="color:#a6e22e">svc</span>,
		<span style="color:#a6e22e">http</span>: <span style="color:#a6e22e">h</span>,
		<span style="color:#a6e22e">grpc</span>: <span style="color:#a6e22e">g</span>,
	}

	<span style="color:#75715e">// 一个关闭context的回调
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">closeFunc</span> = <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">35</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">Shutdown</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;grpcSrv.Shutdown error(%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Shutdown</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;httpSrv.Shutdown error(%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">cancel</span>()
	}
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><p>到这里初始化是结束了。</p>
<h1 id="summary">Summary</h1>
<p><code>kratos</code>的初始化流程:</p>
<ul>
<li>读取配置文件</li>
<li>实例化Dao层</li>
<li>实例化gRPC服务</li>
<li>实例化gin的engine</li>
<li>注册gPRC到engine</li>
<li>启动engine</li>
<li>启动gRPC服务端</li>
<li>获得整个程序关闭的回调</li>
</ul>
<p>我分得应该还是比较细的。</p>
<p>后面应该还会分析<code>warden</code>，它是<code>Kratos</code>在<code>grpc</code>原版上的一个封装版本。</p>
<p>溜了溜了&hellip;</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-03-30">March 30, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/protubuf/">Protubuf 原理</a></h1>
    <div class="tags">
        
        
        <a href="/tags/protobuf" class="pure-button">protobuf</a>
        
    </div>
    <p>protobuf的message中有很多字段,每个字段的格式为:
修饰符 字段类型 字段名 = 域号;
在序列化时,protobuf按照TLV的格式序列化每一个字段,T即Tag,也叫Key;V是该字段对应的值v
省略。
序列化后的Value是按原样保存到字符串或者文件中,Key按照一定的转换条件保存起来,序列化后的
message中字段后面的域号与字段类型来转换。转换公式如下:</p>
<blockquote>
<p>(field_number &laquo; 3) | wire_type</p>
</blockquote>
<p>wire_type与类型的对应关系表:</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>wire_type</th>
<th>meaning</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Vaint</td>
<td>int32、int64、uint32、uint64、sint32、sint64、bool、enum</td>
</tr>
<tr>
<td>1</td>
<td>64-bit</td>
<td>fixed、sfixed64、double</td>
</tr>
<tr>
<td>2</td>
<td>Length-delimi</td>
<td>string、bytes、embedded、messages、packed repeated fields</td>
</tr>
<tr>
<td>3</td>
<td>Start group</td>
<td>Groups(deprecated)</td>
</tr>
<tr>
<td>4</td>
<td>End group</td>
<td>Groups(deprecated)</td>
</tr>
<tr>
<td>5</td>
<td>32-bit</td>
<td>fixed32、sfixed32、float</td>
</tr>
</tbody>
</table>
<blockquote>
<p>　As you can see, each field in the message definition has a unique numbered tag. These tags are used to identify your fields in the message binary format, and should not be changed once your message type is in use. Note that tags with values in the range 1 through 15 take one byte to encode. Tags in the range 16 through 2047 take two bytes. So you should reserve the tags 1 through 15 for very frequently occurring message elements. Remember to leave some room for frequently occurring elements that might be added in the future.</p>
</blockquote>
<p>上面一段话是来自Google Protobuf Documents，上面有几个信息需要注意的地方：
protobuf协议使用二进制格式表示Key字段；对value而言，不同的类型采用的编码方式也不同，如果是整型，采用二进制表示；如果是字符，会直接原样写入文件或者字符串（即不编码）。由于刚开始接触protobuf协议，我也在学习中，下面我会给出一个例子，对于其他一些类型的编码方式，可以仿照这个例子自己实验一下。
<strong>（这个例子主要是讲述Key的编码方式）</strong></p>
<p>上面说过，对于message中的每一个域，都对应一个域号。protobuf规定：</p>
<ul>
<li>如果域号在[1，15]范围内，会使用一个字节表示Key；</li>
<li>如果域号大于等于16，会使用两个字节表示Key；</li>
</ul>
<p>Key编码过后，该字节的第一个比特位表示之后的一个字节是否与当前这个字节有关:</p>
<ul>
<li>如果第一个比特位为1，表示有关，即连续两个字节都是Key的编码；</li>
<li>如果第一个比特位为0，表示Key的编码只有当前一个字节，后面的字节是Length或者Value；</li>
</ul>
<blockquote>
<p>结合公式 （field_number &laquo; 3）| wire_type ，如果域号大于等于16，两个字节共16位，去掉移位的3位，去掉两个字节中第一个比特位，总共16个比特位只有16-5==11个比特位用来表示Key，所以Key的域号要小于2^11== 2048</p>
</blockquote>
<h2 id="protobuf-example">Protobuf Example</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-proto" data-lang="proto"><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Person</span> {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">string</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">required</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">required</span> addr <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">required</span> test <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>使用protoc编译后，生成两个文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">protoc -I<span style="color:#f92672">=</span>. –cpp_out<span style="color:#f92672">=</span>. person.proto
</code></pre></div><p>建立一个Person对象: 属性为</p>
<pre><code>id = 111

name = China

addr = Asia

test = ttttt

# 打印出序列化后的结果为：

'\n\003\061\061\061\022\005China\032\004\Asia\302\005ttttt'

</code></pre><p>‘\n’是id字段的Key，后面的\003（八进制）表示id字段的值长度为3</p>
<p><strong>key的域号不超过15的序列化解析：</strong></p>
<p>因为id字段的域号为1，是小于15的，所以id字段的Key序列化要占1个字节的空间，00000001左移3位变成 00001000，因为string的wire_type值是2，所以00001000再或上2，变成00001010，就是十进制的10，即字符’\n’。下面的字段如果域号不超过15，解析同id字段。
后面连续3个’\61’（八进制）即字符’1’；
同样\022\005是name字段的key和value长度，后面是name字段的值；
\032\004是addr字段的key和value长度；</p>
<p>最后，\302&gt;\005是test字段的Key和Value长度；</p>
<p><strong>key的域号大于15的序列化解析：</strong></p>
<p>由于CSDN编辑器不支持CSS格式，没有办法标记下面的解析内容的颜色，只有放一个图片上去了 ^_^;
下面图片中的\76就是\302后面的‘&gt;’字符的八进制表示，\302与&gt;共同组成最后一个字段的Key的表示（因为最后一个字段test的域号1000大于15，所以需要占两个字节表示Key）</p>
<p><img src="../../protobuf_1.jpg" alt=""></p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-03-11">March 11, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/github_actions/">Github Actions</a></h1>
    <div class="tags">
        
    </div>
    <h2 id="github-actions-上传-releases">Github Actions 上传 Releases</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">name</span>: release

<span style="color:#75715e"># https://help.github.com/en/articles/workflow-syntax-for-github-actions#on</span>
<span style="color:#66d9ef">on</span>:
  <span style="color:#66d9ef">push</span>:
    <span style="color:#66d9ef">tags</span>:
      - <span style="color:#e6db74">&#39;*&#39;</span>

<span style="color:#66d9ef">jobs</span>:
  <span style="color:#66d9ef">build</span>:
    <span style="color:#66d9ef">runs-on</span>: ubuntu-latest
    <span style="color:#66d9ef">steps</span>:
    - <span style="color:#66d9ef">uses</span>: actions/checkout@v1
    - <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;find env&#34;</span>
      <span style="color:#66d9ef">run</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">        set | grep GITHUB_ | grep -v GITHUB_TOKEN</span>
        zip -r pkg.zip <span style="color:#75715e">*.md</span>
    - <span style="color:#66d9ef">uses</span>: xresloader/upload-to-github-release@v1
      <span style="color:#66d9ef">env</span>:
        <span style="color:#66d9ef">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
      <span style="color:#66d9ef">with</span>:
        <span style="color:#66d9ef">file</span>: <span style="color:#e6db74">&#34;*.md;*.zip&#34;</span>
        <span style="color:#66d9ef">tags</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">draft</span>: <span style="color:#66d9ef">false</span>
        <span style="color:#66d9ef">prerelease</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">overwrite</span>: <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">verbose</span>: <span style="color:#66d9ef">true</span>
</code></pre></div>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/appveyor/">Appveyor</a></h1>
    <div class="tags">
        
        
        <a href="/tags/cicd" class="pure-button">CICD</a>
        
    </div>
    <p>Appveyor 也是一款线上 CICD 工具。</p>
<p>Support Contexts:</p>
<ul>
<li>Windows (Default)</li>
<li>Ubuntu</li>
<li>MacOS</li>
</ul>
<p>Support Languages:</p>
<ul>
<li>Node.js</li>
<li>io.js</li>
<li>Xamarin</li>
<li>Python</li>
<li>Ruby</li>
<li>C++</li>
<li>Go</li>
</ul>
<h2 id="ruby">Ruby</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
<span style="color:#66d9ef">version</span>: <span style="color:#ae81ff">1.0</span>.{build}-{branch}

<span style="color:#66d9ef">skip_commits</span>:
  <span style="color:#66d9ef">files</span>:
    - <span style="color:#e6db74">&#39;azure-pipelines.yml&#39;</span>
    - <span style="color:#e6db74">&#39;README.md&#39;</span>

<span style="color:#66d9ef">install</span>:
  - set PATH=C:\Ruby26-x64\bin;%PATH%
  - bundle install

<span style="color:#66d9ef">build</span>: off

<span style="color:#66d9ef">before_test</span>:
  - ruby -v
  - gem -v
  - bundle -v

<span style="color:#66d9ef">test_script</span>:
  - rails db:migrate RAILS_ENV=test

</code></pre></div><h2 id="appveyoryml-reference">Appveyor.yml Reference</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">
<span style="color:#75715e"># Notes:</span>
<span style="color:#75715e">#   - Minimal appveyor.yml file is an empty file. All sections are optional.</span>
<span style="color:#75715e">#   - Indent each level of configuration with 2 spaces. Do not use tabs!</span>
<span style="color:#75715e">#   - All section names are case-sensitive.</span>
<span style="color:#75715e">#   - Section names should be unique on each level.</span>

<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#      general configuration      #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># version format</span>
<span style="color:#66d9ef">version</span>: <span style="color:#ae81ff">1.0</span>.{build}

<span style="color:#75715e"># you can use {branch} name in version format too</span>
<span style="color:#75715e"># version: 1.0.{build}-{branch}</span>

<span style="color:#75715e"># branches to build</span>
<span style="color:#66d9ef">branches</span>:
  <span style="color:#75715e"># whitelist</span>
  <span style="color:#66d9ef">only</span>:
    - master
    - production

  <span style="color:#75715e"># blacklist</span>
  <span style="color:#66d9ef">except</span>:
    - gh-pages

<span style="color:#75715e"># Do not build on tags (GitHub, Bitbucket, GitLab, Gitea)</span>
<span style="color:#66d9ef">skip_tags</span>: <span style="color:#66d9ef">true</span>

<span style="color:#75715e"># Start builds on tags only (GitHub, BitBucket, GitLab, Gitea)</span>
<span style="color:#66d9ef">skip_non_tags</span>: <span style="color:#66d9ef">true</span>

<span style="color:#75715e"># Skipping commits with particular message or from specific user</span>
<span style="color:#66d9ef">skip_commits</span>:
  <span style="color:#66d9ef">message</span>: /Created.<span style="color:#75715e">*\.(png|jpg|jpeg|bmp|gif)/</span>      <span style="color:#75715e"># Regex for matching commit message</span>
  <span style="color:#66d9ef">author</span>: John                                      <span style="color:#75715e"># Commit author&#39;s username, name, email or regexp maching one of these.</span>

<span style="color:#75715e"># Including commits with particular message or from specific user</span>
<span style="color:#66d9ef">only_commits</span>:
  <span style="color:#66d9ef">message</span>: /build/                <span style="color:#75715e"># Start a new build if message contains &#39;build&#39;</span>
  <span style="color:#66d9ef">author</span>: jack@company.com        <span style="color:#75715e"># Start a new build for commit of user with email jack@company.com</span>

<span style="color:#75715e"># Skipping commits affecting specific files (GitHub only). More details here: /docs/appveyor-yml</span>
<span style="color:#75715e">#skip_commits:</span>
<span style="color:#75715e">#  files:</span>
<span style="color:#75715e">#    - docs/*</span>
<span style="color:#75715e">#    - &#39;**/*.html&#39;</span>

<span style="color:#75715e"># Including commits affecting specific files (GitHub only). More details here: /docs/appveyor-yml</span>
<span style="color:#75715e">#only_commits:</span>
<span style="color:#75715e">#  files:</span>
<span style="color:#75715e">#    - Project-A/</span>
<span style="color:#75715e">#    - Project-B/</span>

<span style="color:#75715e"># Do not build feature branch with open Pull Requests</span>
<span style="color:#66d9ef">skip_branch_with_pr</span>: <span style="color:#66d9ef">true</span>

<span style="color:#75715e"># Maximum number of concurrent jobs for the project</span>
<span style="color:#66d9ef">max_jobs</span>: <span style="color:#ae81ff">1</span>

<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#    environment configuration    #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># Build worker image (VM template)</span>
<span style="color:#66d9ef">image</span>: Visual Studio <span style="color:#ae81ff">2015</span>

<span style="color:#75715e"># scripts that are called at very beginning, before repo cloning</span>
<span style="color:#66d9ef">init</span>:
  - git config --global core.autocrlf input

<span style="color:#75715e"># clone directory</span>
<span style="color:#66d9ef">clone_folder</span>: c:\projects\myproject

<span style="color:#75715e"># fetch repository as zip archive</span>
<span style="color:#66d9ef">shallow_clone</span>: <span style="color:#66d9ef">true</span>                 <span style="color:#75715e"># default is &#34;false&#34;</span>

<span style="color:#75715e"># set clone depth</span>
<span style="color:#66d9ef">clone_depth</span>: <span style="color:#ae81ff">5</span>                      <span style="color:#75715e"># clone entire repository history if not defined</span>

<span style="color:#75715e"># setting up etc\hosts file</span>
<span style="color:#66d9ef">hosts</span>:
  <span style="color:#66d9ef">queue-server</span>: <span style="color:#ae81ff">127.0.0.1</span>
  <span style="color:#66d9ef">db.server.com</span>: <span style="color:#ae81ff">127.0.0.2</span>

<span style="color:#75715e"># environment variables</span>
<span style="color:#66d9ef">environment</span>:
  <span style="color:#66d9ef">my_var1</span>: value1
  <span style="color:#66d9ef">my_var2</span>: value2
  <span style="color:#75715e"># this is how to set encrypted variable. Go to &#34;Settings&#34; -&gt; &#34;Encrypt YAML&#34; page in account menu to encrypt data.</span>
  <span style="color:#66d9ef">my_secure_var1</span>:
    <span style="color:#66d9ef">secure</span>: FW3tJ3fMncxvs58/ifSP7w==

<span style="color:#75715e"># environment:</span>
<span style="color:#75715e">#  global:</span>
<span style="color:#75715e">#    connection_string: server=12;password=13;</span>
<span style="color:#75715e">#    service_url: https://127.0.0.1:8090</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  matrix:</span>
<span style="color:#75715e">#  - db: mysql</span>
<span style="color:#75715e">#    provider: mysql</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  - db: mssql</span>
<span style="color:#75715e">#    provider: mssql</span>
<span style="color:#75715e">#    password:</span>
<span style="color:#75715e">#      secure: $#(JFDA)jQ@#$</span>

<span style="color:#75715e"># this is how to allow failing jobs in the matrix</span>
<span style="color:#66d9ef">matrix</span>:
  <span style="color:#66d9ef">fast_finish</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># set this flag to immediately finish build once one of the jobs fails.</span>
  <span style="color:#66d9ef">allow_failures</span>:
    - <span style="color:#66d9ef">platform</span>: x86
      <span style="color:#66d9ef">configuration</span>: Debug
    - <span style="color:#66d9ef">platform</span>: x64
      <span style="color:#66d9ef">configuration</span>: Release

<span style="color:#75715e"># exclude configuration from the matrix. Works similarly to &#39;allow_failures&#39; but build not even being started for excluded combination.</span>
  <span style="color:#66d9ef">exclude</span>:
    - <span style="color:#66d9ef">platform</span>: x86
      <span style="color:#66d9ef">configuration</span>: Debug

<span style="color:#75715e"># build cache to preserve files/folders between builds</span>
<span style="color:#66d9ef">cache</span>:
  - packages -&gt; <span style="color:#75715e">**\packages.config</span>  <span style="color:#75715e"># preserve &#34;packages&#34; directory in the root of build folder but will reset it if packages.config is modified</span>
  - projectA\libs
  - node_modules                    <span style="color:#75715e"># local npm modules</span>
  - <span style="color:#e6db74">&#39;%LocalAppData%\NuGet\Cache&#39;</span>    <span style="color:#75715e"># NuGet &lt; v3</span>
  - <span style="color:#e6db74">&#39;%LocalAppData%\NuGet\v3-cache&#39;</span> <span style="color:#75715e"># NuGet v3</span>

<span style="color:#75715e"># enable service required for build/tests</span>
<span style="color:#66d9ef">services</span>:
  - mssql2014           <span style="color:#75715e"># start SQL Server 2014 Express</span>
  - mssql2014rs         <span style="color:#75715e"># start SQL Server 2014 Express and Reporting Services</span>
  - mssql2012sp1        <span style="color:#75715e"># start SQL Server 2012 SP1 Express</span>
  - mssql2012sp1rs      <span style="color:#75715e"># start SQL Server 2012 SP1 Express and Reporting Services</span>
  - mssql2008r2sp2      <span style="color:#75715e"># start SQL Server 2008 R2 SP2 Express</span>
  - mssql2008r2sp2rs    <span style="color:#75715e"># start SQL Server 2008 R2 SP2 Express and Reporting Services</span>
  - mysql               <span style="color:#75715e"># start MySQL 5.6 service</span>
  - postgresql          <span style="color:#75715e"># start PostgreSQL 9.5 service</span>
  - iis                 <span style="color:#75715e"># start IIS</span>
  - msmq                <span style="color:#75715e"># start Queuing services</span>
  - mongodb             <span style="color:#75715e"># start MongoDB</span>

<span style="color:#75715e"># scripts that run after cloning repository</span>
<span style="color:#66d9ef">install</span>:
  <span style="color:#75715e"># by default, all script lines are interpreted as batch</span>
  - echo This is batch
  <span style="color:#75715e"># to run script as a PowerShell command prepend it with ps:</span>
  - <span style="color:#66d9ef">ps</span>: Write-Host <span style="color:#e6db74">&#39;This is PowerShell&#39;</span>
  <span style="color:#75715e"># batch commands start from cmd:</span>
  - <span style="color:#66d9ef">cmd</span>: echo This is batch again
  - <span style="color:#66d9ef">cmd</span>: set MY_VAR=<span style="color:#ae81ff">12345</span>

<span style="color:#75715e"># enable patching of AssemblyInfo.* files</span>
<span style="color:#66d9ef">assembly_info</span>:
  <span style="color:#66d9ef">patch</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">file</span>: AssemblyInfo.*
  <span style="color:#66d9ef">assembly_version</span>: <span style="color:#e6db74">&#34;2.2.{build}&#34;</span>
  <span style="color:#66d9ef">assembly_file_version</span>: <span style="color:#e6db74">&#34;{version}&#34;</span>
  <span style="color:#66d9ef">assembly_informational_version</span>: <span style="color:#e6db74">&#34;{version}&#34;</span>


<span style="color:#75715e"># Automatically register private account and/or project AppVeyor NuGet feeds.</span>
<span style="color:#66d9ef">nuget</span>:
  <span style="color:#66d9ef">account_feed</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">project_feed</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">disable_publish_on_pr</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># disable publishing of .nupkg artifacts to account/project feeds for pull request builds</span>
  <span style="color:#66d9ef">publish_wap_octopus</span>: <span style="color:#66d9ef">true</span>       <span style="color:#75715e"># disable publishing of Octopus Deploy .nupkg artifacts to account/project feeds</span>

<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#       build configuration       #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># build platform, i.e. x86, x64, Any CPU. This setting is optional.</span>
<span style="color:#66d9ef">platform</span>: Any CPU

<span style="color:#75715e"># to add several platforms to build matrix:</span>
<span style="color:#75715e">#platform:</span>
<span style="color:#75715e">#  - x86</span>
<span style="color:#75715e">#  - Any CPU</span>

<span style="color:#75715e"># build Configuration, i.e. Debug, Release, etc.</span>
<span style="color:#66d9ef">configuration</span>: Release

<span style="color:#75715e"># to add several configurations to build matrix:</span>
<span style="color:#75715e">#configuration:</span>
<span style="color:#75715e">#  - Debug</span>
<span style="color:#75715e">#  - Release</span>

<span style="color:#75715e"># Build settings, not to be confused with &#34;before_build&#34; and &#34;after_build&#34;.</span>
<span style="color:#75715e"># &#34;project&#34; is relative to the original build directory and not influenced by directory changes in &#34;before_build&#34;.</span>
<span style="color:#66d9ef">build</span>:
  <span style="color:#66d9ef">parallel</span>: <span style="color:#66d9ef">true</span>                  <span style="color:#75715e"># enable MSBuild parallel builds</span>
  <span style="color:#66d9ef">project</span>: MyTestAzureCS.sln      <span style="color:#75715e"># path to Visual Studio solution or project</span>
  <span style="color:#66d9ef">publish_wap</span>: <span style="color:#66d9ef">true</span>               <span style="color:#75715e"># package Web Application Projects (WAP) for Web Deploy</span>
  <span style="color:#66d9ef">publish_wap_xcopy</span>: <span style="color:#66d9ef">true</span>         <span style="color:#75715e"># package Web Application Projects (WAP) for XCopy deployment</span>
  <span style="color:#66d9ef">publish_wap_beanstalk</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># Package Web Applications for AWS Elastic Beanstalk deployment</span>
  <span style="color:#66d9ef">publish_wap_octopus</span>: <span style="color:#66d9ef">true</span>       <span style="color:#75715e"># Package Web Applications for Octopus deployment</span>
  <span style="color:#66d9ef">publish_azure_webjob</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># Package Azure WebJobs for Zip Push deployment</span>
  <span style="color:#66d9ef">publish_azure</span>: <span style="color:#66d9ef">true</span>             <span style="color:#75715e"># package Azure Cloud Service projects and push to artifacts</span>
  <span style="color:#66d9ef">publish_aspnet_core</span>: <span style="color:#66d9ef">true</span>       <span style="color:#75715e"># Package ASP.NET Core projects</span>
  <span style="color:#66d9ef">publish_core_console</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># Package .NET Core console projects</span>
  <span style="color:#66d9ef">publish_nuget</span>: <span style="color:#66d9ef">true</span>             <span style="color:#75715e"># package projects with .nuspec files and push to artifacts</span>
  <span style="color:#66d9ef">publish_nuget_symbols</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># generate and publish NuGet symbol packages</span>
  <span style="color:#66d9ef">include_nuget_references</span>: <span style="color:#66d9ef">true</span>  <span style="color:#75715e"># add -IncludeReferencedProjects option while packaging NuGet artifacts</span>

  <span style="color:#75715e"># MSBuild verbosity level</span>
  <span style="color:#66d9ef">verbosity</span>: quiet|minimal|normal|detailed


<span style="color:#75715e"># scripts to run before build</span>
<span style="color:#66d9ef">before_build</span>:

<span style="color:#75715e"># to run your custom scripts instead of automatic MSBuild</span>
<span style="color:#66d9ef">build_script</span>:

<span style="color:#75715e"># scripts to run after build (working directory and environment changes are persisted from the previous steps)</span>
<span style="color:#66d9ef">after_build</span>:

<span style="color:#75715e"># scripts to run *after* solution is built and *before* automatic packaging occurs (web apps, NuGet packages, Azure Cloud Services)</span>
<span style="color:#66d9ef">before_package</span>:

<span style="color:#75715e"># to disable automatic builds</span>
<span style="color:#75715e">#build: off</span>

<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#       tests configuration       #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># to run tests against only selected assemblies and/or categories</span>
<span style="color:#66d9ef">test</span>:
  <span style="color:#66d9ef">assemblies</span>:
    <span style="color:#66d9ef">only</span>:
      - asm1.dll
      - asm2.dll

  <span style="color:#66d9ef">categories</span>:
    <span style="color:#66d9ef">only</span>:
      - UI
      - E2E

<span style="color:#75715e"># to run tests against all except selected assemblies and/or categories</span>
<span style="color:#75715e">#test:</span>
<span style="color:#75715e">#  assemblies:</span>
<span style="color:#75715e">#    except:</span>
<span style="color:#75715e">#      - asm1.dll</span>
<span style="color:#75715e">#      - asm2.dll</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e">#  categories:</span>
<span style="color:#75715e">#    except:</span>
<span style="color:#75715e">#      - UI</span>
<span style="color:#75715e">#      - E2E</span>

<span style="color:#75715e"># to run tests from different categories as separate jobs in parallel</span>
<span style="color:#75715e">#test:</span>
<span style="color:#75715e">#  categories:</span>
<span style="color:#75715e">#    - A            # A category common for all jobs</span>
<span style="color:#75715e">#    - [UI]         # 1st job</span>
<span style="color:#75715e">#    - [DAL, BL]    # 2nd job</span>

<span style="color:#75715e"># scripts to run before tests (working directory and environment changes are persisted from the previous steps such as &#34;before_build&#34;)</span>
<span style="color:#66d9ef">before_test</span>:
  - echo script1
  - <span style="color:#66d9ef">ps</span>: Write-Host <span style="color:#e6db74">&#34;script1&#34;</span>

<span style="color:#75715e"># to run your custom scripts instead of automatic tests</span>
<span style="color:#66d9ef">test_script</span>:
  - echo This is my custom test script

<span style="color:#75715e"># scripts to run after tests</span>
<span style="color:#66d9ef">after_test</span>:

<span style="color:#75715e"># to disable automatic tests</span>
<span style="color:#75715e">#test: off</span>


<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#      artifacts configuration    #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#66d9ef">artifacts</span>:

  <span style="color:#75715e"># pushing a single file</span>
  - <span style="color:#66d9ef">path</span>: test.zip

  <span style="color:#75715e"># pushing a single file with environment variable in path and &#34;Deployment name&#34; specified</span>
  - <span style="color:#66d9ef">path</span>: MyProject\bin\$(configuration)
    <span style="color:#66d9ef">name</span>: myapp

  <span style="color:#75715e"># pushing entire folder as a zip archive</span>
  - <span style="color:#66d9ef">path</span>: logs

  <span style="color:#75715e"># pushing all *.nupkg files in build directory recursively</span>
  - <span style="color:#66d9ef">path</span>: <span style="color:#e6db74">&#39;**\*.nupkg&#39;</span>


<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#     deployment configuration    #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># providers: Local, FTP, WebDeploy, AzureCS, AzureBlob, S3, NuGet, Environment</span>
<span style="color:#75715e"># provider names are case-sensitive!</span>
<span style="color:#66d9ef">deploy</span>:

    <span style="color:#75715e"># FTP deployment provider settings</span>
  - <span style="color:#66d9ef">provider</span>: FTP
    <span style="color:#66d9ef">protocol</span>: ftp|ftps|sftp
    <span style="color:#66d9ef">host</span>: ftp.myserver.com
    <span style="color:#66d9ef">username</span>: admin
    <span style="color:#66d9ef">password</span>:
      <span style="color:#66d9ef">secure</span>: eYKZKFkkEvFYWX6NfjZIVw==
    <span style="color:#66d9ef">folder</span>:
    <span style="color:#66d9ef">application</span>:
    <span style="color:#66d9ef">active_mode</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">beta</span>: <span style="color:#66d9ef">true</span>      <span style="color:#75715e"># enable alternative FTP library for &#39;ftp&#39; and &#39;ftps&#39; modes</span>
    <span style="color:#66d9ef">debug</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># show complete FTP log</span>

    <span style="color:#75715e"># Amazon S3 deployment provider settings</span>
  - <span style="color:#66d9ef">provider</span>: S3
    <span style="color:#66d9ef">access_key_id</span>:
      <span style="color:#66d9ef">secure</span>: ABcd==
    <span style="color:#66d9ef">secret_access_key</span>:
      <span style="color:#66d9ef">secure</span>: ABcd==
    <span style="color:#66d9ef">bucket</span>: my_bucket
    <span style="color:#66d9ef">folder</span>:
    <span style="color:#66d9ef">artifact</span>:
    <span style="color:#66d9ef">set_public</span>: <span style="color:#66d9ef">false</span>

    <span style="color:#75715e"># Azure Blob storage deployment provider settings</span>
  - <span style="color:#66d9ef">provider</span>: AzureBlob
    <span style="color:#66d9ef">storage_account_name</span>:
      <span style="color:#66d9ef">secure</span>: ABcd==
    <span style="color:#66d9ef">storage_access_key</span>:
      <span style="color:#66d9ef">secure</span>: ABcd==
    <span style="color:#66d9ef">container</span>: my_container
    <span style="color:#66d9ef">folder</span>:
    <span style="color:#66d9ef">artifact</span>:

    <span style="color:#75715e"># Web Deploy deployment provider settings</span>
  - <span style="color:#66d9ef">provider</span>: WebDeploy
    <span style="color:#66d9ef">server</span>: http://www.deploy.com/myendpoint
    <span style="color:#66d9ef">website</span>: mywebsite
    <span style="color:#66d9ef">username</span>: user
    <span style="color:#66d9ef">password</span>:
      <span style="color:#66d9ef">secure</span>: eYKZKFkkEvFYWX6NfjZIVw==
    <span style="color:#66d9ef">ntlm</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">remove_files</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">app_offline</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">do_not_use_checksum</span>: <span style="color:#66d9ef">true</span>           <span style="color:#75715e"># do not use check sum for comparing source and destination files. By default checksums are used.</span>
    <span style="color:#66d9ef">sync_retry_attempts</span>: <span style="color:#ae81ff">2</span>              <span style="color:#75715e"># sync attempts, max</span>
    <span style="color:#66d9ef">sync_retry_interval</span>: <span style="color:#ae81ff">2000</span>           <span style="color:#75715e"># timeout between sync attempts, milliseconds</span>
    <span style="color:#66d9ef">aspnet_core</span>: <span style="color:#66d9ef">true</span>                   <span style="color:#75715e"># artifact zip contains ASP.NET Core application</span>
    <span style="color:#66d9ef">aspnet_core_force_restart</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># poke app&#39;s web.config before deploy to force application restart</span>
    <span style="color:#66d9ef">skip_dirs</span>: \\App_Data
    <span style="color:#66d9ef">skip_files</span>: web.config
    <span style="color:#66d9ef">on</span>:
      <span style="color:#66d9ef">branch</span>: release
      <span style="color:#66d9ef">platform</span>: x86
      <span style="color:#66d9ef">configuration</span>: debug

    <span style="color:#75715e"># Deploying to Azure Cloud Service</span>
  - <span style="color:#66d9ef">provider</span>: AzureCS
    <span style="color:#66d9ef">subscription_id</span>:
      <span style="color:#66d9ef">secure</span>: fjZIVw==
    <span style="color:#66d9ef">subscription_certificate</span>:
      <span style="color:#66d9ef">secure</span>: eYKZKFkkEv...FYWX6NfjZIVw==
    <span style="color:#66d9ef">storage_account_name</span>: my_storage
    <span style="color:#66d9ef">storage_access_key</span>:
      <span style="color:#66d9ef">secure</span>: ABcd==
    <span style="color:#66d9ef">service</span>: my_service
    <span style="color:#66d9ef">slot</span>: Production
    <span style="color:#66d9ef">target_profile</span>: Cloud
    <span style="color:#66d9ef">artifact</span>: MyPackage.cspkg

    <span style="color:#75715e"># Deploying to NuGet feed</span>
  - <span style="color:#66d9ef">provider</span>: NuGet
    <span style="color:#66d9ef">server</span>: https://my.nuget.server/feed
    <span style="color:#66d9ef">api_key</span>:
      <span style="color:#66d9ef">secure</span>: FYWX6NfjZIVw==
    <span style="color:#66d9ef">skip_symbols</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">symbol_server</span>: https://your.symbol.server/feed
    <span style="color:#66d9ef">artifact</span>: MyPackage.nupkg

    <span style="color:#75715e"># Deploy to GitHub Releases</span>
  - <span style="color:#66d9ef">provider</span>: GitHub
    <span style="color:#66d9ef">artifact</span>: /.<span style="color:#75715e">*\.nupkg/</span>           <span style="color:#75715e"># upload all NuGet packages to release assets</span>
    <span style="color:#66d9ef">draft</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">prerelease</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">on</span>:
      <span style="color:#66d9ef">branch</span>: master                <span style="color:#75715e"># release from master branch only</span>
      <span style="color:#66d9ef">APPVEYOR_REPO_TAG</span>: <span style="color:#66d9ef">true</span>       <span style="color:#75715e"># deploy on tag push only</span>

    <span style="color:#75715e"># Deploying to a named environment</span>
  - <span style="color:#66d9ef">provider</span>: Environment
    <span style="color:#66d9ef">name</span>: staging
    <span style="color:#66d9ef">on</span>:
      <span style="color:#66d9ef">branch</span>: staging
      <span style="color:#66d9ef">env_var1</span>: value1
      <span style="color:#66d9ef">env_var2</span>: value2

<span style="color:#75715e"># scripts to run before deployment</span>
<span style="color:#66d9ef">before_deploy</span>:

<span style="color:#75715e"># scripts to run after deployment</span>
<span style="color:#66d9ef">after_deploy</span>:

<span style="color:#75715e"># to run your custom scripts instead of provider deployments</span>
<span style="color:#66d9ef">deploy_script</span>:

<span style="color:#75715e"># to disable deployment</span>
<span style="color:#75715e">#deploy: off</span>

<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#        global handlers          #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#75715e"># on successful build</span>
<span style="color:#66d9ef">on_success</span>:
  - do something

<span style="color:#75715e"># on build failure</span>
<span style="color:#66d9ef">on_failure</span>:
  - do something

<span style="color:#75715e"># after build failure or success</span>
<span style="color:#66d9ef">on_finish</span>:
  - do something


<span style="color:#75715e">#---------------------------------#</span>
<span style="color:#75715e">#         notifications           #</span>
<span style="color:#75715e">#---------------------------------#</span>

<span style="color:#66d9ef">notifications</span>:

  <span style="color:#75715e"># Email</span>
  - <span style="color:#66d9ef">provider</span>: Email
    <span style="color:#66d9ef">to</span>:
      - user1@email.com
      - user2@email.com
    <span style="color:#66d9ef">subject</span>: <span style="color:#e6db74">&#39;Build {{status}}&#39;</span>                  <span style="color:#75715e"># optional</span>
    <span style="color:#66d9ef">message</span>: <span style="color:#e6db74">&#34;{{message}}, {{commitId}}, ...&#34;</span>    <span style="color:#75715e"># optional</span>
    <span style="color:#66d9ef">on_build_status_changed</span>: <span style="color:#66d9ef">true</span>

  <span style="color:#75715e"># HipChat</span>
  - <span style="color:#66d9ef">provider</span>: HipChat
    <span style="color:#66d9ef">auth_token</span>:
      <span style="color:#66d9ef">secure</span>: RbOnSMSFKYzxzFRrxM1+XA==
    <span style="color:#66d9ef">room</span>: ProjectA
    <span style="color:#66d9ef">template</span>: <span style="color:#e6db74">&#34;{message}, {commitId}, ...&#34;</span>

  <span style="color:#75715e"># Slack</span>
  - <span style="color:#66d9ef">provider</span>: Slack
    <span style="color:#66d9ef">incoming_webhook</span>: http://incoming-webhook-url

  <span style="color:#75715e"># ...or using auth token</span>

  - <span style="color:#66d9ef">provider</span>: Slack
    <span style="color:#66d9ef">auth_token</span>:
      <span style="color:#66d9ef">secure</span>: kBl9BlxvRMr9liHmnBs14A==
    <span style="color:#66d9ef">channel</span>: development
    <span style="color:#66d9ef">template</span>: <span style="color:#e6db74">&#34;{message}, {commitId}, ...&#34;</span>

  <span style="color:#75715e"># Campfire</span>
  - <span style="color:#66d9ef">provider</span>: Campfire
    <span style="color:#66d9ef">account</span>: appveyor
    <span style="color:#66d9ef">auth_token</span>:
      <span style="color:#66d9ef">secure</span>: RifLRG8Vfyol+sNhj9u2JA==
    <span style="color:#66d9ef">room</span>: ProjectA
    <span style="color:#66d9ef">template</span>: <span style="color:#e6db74">&#34;{message}, {commitId}, ...&#34;</span>

  <span style="color:#75715e"># Webhook</span>
  - <span style="color:#66d9ef">provider</span>: Webhook
    <span style="color:#66d9ef">url</span>: http://www.myhook2.com
    <span style="color:#66d9ef">headers</span>:
      <span style="color:#66d9ef">User-Agent</span>: myapp <span style="color:#ae81ff">1.0</span>
      <span style="color:#66d9ef">Authorization</span>:
        <span style="color:#66d9ef">secure</span>: GhD+5xhLz/tkYY6AO3fcfQ==
    <span style="color:#66d9ef">on_build_success</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">on_build_failure</span>: <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">on_build_status_changed</span>: <span style="color:#66d9ef">true</span>

</code></pre></div>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/azure_pipelines/">Azure Pipelines</a></h1>
    <div class="tags">
        
        
        <a href="/tags/cicd" class="pure-button">CICD</a>
        
    </div>
    <p>Azure Pipelines是一种云服务，可用于自动构建和测试您的代码项目并将其提供给其他用户。它几乎适用于任何语言或项目类型。</p>
<p>Azure Pipelines将持续集成（CI）和持续交付（CD）相结合，以持续不断地测试和构建您的代码并将其交付给任何目标。</p>
<p>Azure Pipelines 支持非常多的语言。</p>
<h4 id="price">Price</h4>
<p>如果使用公共项目，则Azure Pipelines是免费的。如果您使用私人项目，则每月可以免费运行多达1800分钟（30小时）的管道作业。了解有关基于并行作业定价的更多信息。</p>
<p>是不是非常的棒呢 o(<em>////▽////</em>)q</p>
<p><strong>请遵循以下基本步骤：</strong></p>
<ul>
<li>配置Azure Pipelines以使用您的Git存储库。</li>
<li>编辑azure-pipelines.yml文件以定义构建。</li>
<li>将您的代码推送到版本控制存储库。此操作将启动默认触发器以构建和部署，然后监视结果。</li>
</ul>
<h2 id="ruby">Ruby</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># Ruby</span>
<span style="color:#75715e"># Package your Ruby project.</span>
<span style="color:#75715e"># Add steps that install rails, analyze code, save build artifacts, deploy, and more:</span>
<span style="color:#75715e"># https://docs.microsoft.com/azure/devops/pipelines/languages/ruby</span>

<span style="color:#66d9ef">trigger</span>:
  <span style="color:#66d9ef">branches</span>:
    <span style="color:#75715e"># 只有以下分支提交才会触发CICD</span>
    <span style="color:#66d9ef">include</span>:
      - master
      - sdtttttt
      - CICD
      - depend*
  <span style="color:#66d9ef">paths</span>:
    <span style="color:#75715e"># 只有以下文件提交时不触发CICD</span>
    <span style="color:#66d9ef">exclude</span>:
      - README.md
      - appveyor.yml

<span style="color:#66d9ef">pool</span>:
  <span style="color:#66d9ef">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-18.04&#39;</span>

<span style="color:#66d9ef">steps</span>:
- <span style="color:#66d9ef">task</span>: UseRubyVersion@<span style="color:#ae81ff">0</span>
  <span style="color:#66d9ef">inputs</span>:
  <span style="color:#75715e"># 天杀的，微软提供的Ubuntu 镜像已经不支持 Ruby2.6.3</span>
    <span style="color:#66d9ef">versionSpec</span>: <span style="color:#e6db74">&#39;&gt;= 2.6.3&#39;</span>

<span style="color:#75715e"># Rails 内置数据库 SQLite3 需要依赖以下工具</span>
- <span style="color:#66d9ef">script</span>: sudo apt-get -yqq install libsqlite3-dev libpq-dev
  <span style="color:#66d9ef">displayName</span>: install sqlite3

- <span style="color:#66d9ef">script</span>: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    gem install bundler</span>
    bundle install --retry=<span style="color:#ae81ff">3</span> --jobs=<span style="color:#ae81ff">4</span>
  <span style="color:#66d9ef">displayName</span>: <span style="color:#e6db74">&#39;bundle install&#39;</span>

- <span style="color:#66d9ef">script</span>: bundle exec rake
  <span style="color:#66d9ef">displayName</span>: <span style="color:#e6db74">&#39;bundle exec rake&#39;</span>
</code></pre></div>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/rails_development/">Rails Development</a></h1>
    <div class="tags">
        
        
        <a href="/tags/rails" class="pure-button">Rails</a>
        
    </div>
    <h3 id="webpacker">Webpacker</h3>
<p>Rails 6版本开始依赖Webpacker，在运行之前必须先安装Webpacker这玩意。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rails webpacker:install
</code></pre></div><p>如果需要安装前端框架，请使用yarn来安装，这样部署的时候能享受到webpacker打包便利。</p>
<h3 id="production">production</h3>
<p>Rails 6 启动时需要一串Key作为加密的salt，key不能随意生成。
生成key时，请删除config下的credentials.enc.yml 和 master.key 文件。
然后运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rails credentials:edit
</code></pre></div><p>然后Rails访问静态资源，需要使用webpacker打包编译后的资产。
运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">rails assets:precompile
</code></pre></div><p>Rails 6 在生产环境下认为你使用 Apache 和 Nginx 缓存编译后的静态资产。如果你不使用他们，需要</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/environments/production.rb</span>
config<span style="color:#f92672">.</span>public_file_server<span style="color:#f92672">.</span>enabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</code></pre></div><p>记住，打包之后的js以及css统一叫application.js/css 在view页面引用时需要引用application这个名字。其他的会报错</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/ror_environment_config/">Rails ENV</a></h1>
    <div class="tags">
        
    </div>
    <h1 id="rails-env">Rails ENV</h1>
<p>环境配置参考 Ruby China 社区的 Wiki</p>
<h3 id="windows-10">Windows 10</h3>
<p>在 Windowns 10 的环境下和Linux上差不多，不过不需要RVM</p>
<ul>
<li>首先在Ruby官方网站下载好安装包</li>
<li>之后使用RubyChina提供的Source替换Gem的Source</li>
<li>之后使用Gem下载 Bundler 和 Rails</li>
<li>创建Rails项目运行即可</li>
</ul>
<p>有一个软件叫做 <code>RailsInstaller</code> 可以直接帮你省下1和3步也就是直接帮你安装好了Ruby和Rails还有Gem，bundler。
但是🙅我目前使用的Railsinstaller有点问题。他的Ruby版本是2.3，rails版本是5，rails5依赖的是 &gt;= 2.4版本的ruby，这就有问题了。我也没接着用这个软件了。</p>
<p>在rails6中加入了<code>Webpacker</code>的打包工具，运行之前需要先安装webpacker不然会报错。 <code>$ rails webpacker:install</code></p>
<p>注意在上面可能会有点问题，Gem创建Rails项目的时候会下载各种依赖，这些依赖有可能会在Windows的环境上出现问题，比如我遇到的 SQLite3,所以Ruby最好还是不要在Windowns上运行。</p>
<p>还有Rails 是要依赖 Yarn和 nodejs 最好是10版本以上</p>
<h2 id="development-note">Development Note</h2>
<p>花了很长时间去吧Rails和一些大前端的框架合二为一，最后以失败而告终。
Rails终究是个全栈式的Web框架，老老实实用简单的就行。</p>
<ul>
<li>Bootstrap Configuration</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># =&gt; 首先在 Gemfile 中加入</span>
gem <span style="color:#e6db74">&#39;bootstrap&#39;</span>, <span style="color:#e6db74">&#39;~&gt; 4.3.1&#39;</span>
gem <span style="color:#e6db74">&#39;jquery-rails&#39;</span>
</code></pre></div><p>之后将<code>app\assets\stylesheets\application.css</code> 改为 scss</p>
<p>删掉所有的东西包括注释</p>
<p>加入<code>@import &ldquo;bootstrap&rdquo;;</code></p>
<hr>
<h2 id="ruby-note-todo">Ruby Note Todo</h2>
<pre><code>Error running 'requirements_debian_libs_install g++ gcc autoconf automake bison libc6-dev libffi-dev libgdbm-dev libncurses5-dev libsqlite3-dev libtool libyaml-dev make pkg-config sqlite3 zlib1g-dev libgmp-dev libreadline-dev libssl-dev',
please read /home/sdttttt/.rvm/log/1573869340/package_install_g++_gcc_autoconf_automake_bison_libc6-dev_libffi-dev_libgdbm-dev_libncurses5-dev_libsqlite3-dev_libtool_libyaml-dev_make_pkg-config_sqlite3_zlib1g-dev_libgmp-dev_libreadline-dev_libssl-dev.log
Requirements installation failed with status: 100.
</code></pre><p>碰到这种错误不需要紧张，<code>rvm requirements</code> command 的原理就是会使用你系统的包管理工具去下载这些依赖，所以原因很简单，你的源里找不到这些依赖就会报出100的错误。
是Ubuntu的话下面我提供了源</p>
<pre><code>#添加阿里源
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
</code></pre>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/socks5/">Socks5</a></h1>
    <div class="tags">
        
        
        <a href="/tags/network-protocol" class="pure-button">network protocol</a>
        
    </div>
    <p>SOCKS 是一种网络传输协议，主要用于客户端与外网服务器之间通讯的中间传递，SOCKS 是&quot;SOCKetS&quot;的缩写。
SOCKS5 是 SOCKS4 的升级版，其主要多了鉴定、IPv6、UDP 支持。</p>
<p>SOCKS5 协议可以分为三个部分：</p>
<ul>
<li>(1) 协议版本及认证方式</li>
<li>(2) 根据认证方式执行对应的认证</li>
<li>(3) 请求信息</li>
</ul>
<h4 id="1协议版本及认证方式">（1）协议版本及认证方式</h4>
<p>创建与 SOCKS5 服务器的 TCP 连接后<strong>客户端</strong>需要先发送请求来协议版本及认证方式，</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>VER</th>
<th>NMETHODS</th>
<th>METHODS</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>1-255</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>VER 是 SOCKS 版本，这里应该是 0x05；</p>
</li>
<li>
<p>NMETHODS 是 METHODS 部分的长度；</p>
</li>
<li>
<p>METHODS 是客户端支持的认证方式列表，每个方法占 1 字节。当前的定义是：</p>
<ul>
<li>0x00 不需要认证</li>
<li>0x01 GSSAPI</li>
<li>0x02 用户名、密码认证</li>
<li>0x03 - 0x7F 由 IANA 分配（保留）</li>
<li>0x80 - 0xFE 为私人方法保留</li>
<li>0xFF 无可接受的方法</li>
</ul>
</li>
</ul>
<p><strong>服务器</strong>回复客户端可用方法：</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>VER</th>
<th>METHOD</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li>VER 是 SOCKS 版本，这里应该是 0x05；</li>
<li>METHOD 是服务端选中的方法。如果返回 0xFF 表示没有一个认证方法被选中，客户端需要关闭连接。</li>
</ul>
<p>代码实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ProtocolVersion</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">VER</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">NMETHODS</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">METHODS</span> []<span style="color:#66d9ef">uint8</span>
}


<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ProtocolVersion</span>) <span style="color:#a6e22e">handshake</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">255</span>)
    <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>] <span style="color:#75715e">//ReadByte reads and returns a single byte，第一个参数为socks的版本号
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NMETHODS</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>] <span style="color:#75715e">//nmethods是记录methods的长度的。nmethods的长度是1个字节
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> int(<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NMETHODS</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;协议错误, sNMETHODS不对&#34;</span>)
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">METHODS</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NMETHODS</span>] <span style="color:#75715e">//读取指定长度信息，读取正好len(buf)长度的字节。如果字节数不是指定长度，则返回错误信息和正确的字节数
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;该协议不是socks5协议&#34;</span>)
    }

    <span style="color:#75715e">//服务器回应客户端消息:
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//第一个参数表示版本号为5，即socks5协议，
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第二个参数表示服务端选中的认证方法，0即无需密码访问, 2表示需要用户名和密码进行验证。
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span>[]<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>}
    <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">resp</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h4 id="2根据认证方式执行对应的认证">（2）根据认证方式执行对应的认证</h4>
<p>SOCKS5 协议提供 5 种认证方式：</p>
<ul>
<li>0x00 不需要认证</li>
<li>0x01 GSSAPI</li>
<li>0x02 用户名、密码认证</li>
<li>0x03 - 0x7F 由 IANA 分配（保留）</li>
<li>0x80 - 0xFE 为私人方法保留</li>
</ul>
<p>这里就主要介绍用户名、密码认证。
在客户端、服务端协商使用用户名密码认证后，客户端发出用户名密码：</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>鉴定协议版本</th>
<th>用户名长度</th>
<th>用户名</th>
<th>密码长度</th>
<th>密码</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>动态</td>
<td>1</td>
<td>动态</td>
</tr>
</tbody>
</table>
<p>服务器鉴定后发出如下回应：</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>鉴定协议版本</th>
<th>鉴定状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>其中鉴定状态 0x00 表示成功，0x01 表示失败。</p>
<p>代码实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Socks5Auth</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">VER</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">ULEN</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">UNAME</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">PLEN</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">PASSWD</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Socks5Auth</span>) <span style="color:#a6e22e">authenticate</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">128</span>)
    <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span>{
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }

    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;该协议不是socks5协议&#34;</span>)
    }

    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ULEN</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>]
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">UNAME</span> = string(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>:<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ULEN</span>])
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">PLEN</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ULEN</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">PASSWD</span> = string(<span style="color:#a6e22e">b</span>[<span style="color:#a6e22e">n</span><span style="color:#f92672">-</span>int(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">PLEN</span>):<span style="color:#a6e22e">n</span>])
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">UNAME</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">PASSWD</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">username</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">UNAME</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">passwd</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">PASSWD</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;账号密码错误&#34;</span>)
    }

    <span style="color:#75715e">/**
</span><span style="color:#75715e">    回应客户端,响应客户端连接成功
</span><span style="color:#75715e">    The server verifies the supplied UNAME and PASSWD, and sends the
</span><span style="color:#75715e">    following response:
</span><span style="color:#75715e">                            +----+--------+
</span><span style="color:#75715e">                            |VER | STATUS |
</span><span style="color:#75715e">                            +----+--------+
</span><span style="color:#75715e">                            | 1  |   1    |
</span><span style="color:#75715e">                            +----+--------+
</span><span style="color:#75715e">    A STATUS field of X&#39;00&#39; indicates success. If the server returns a
</span><span style="color:#75715e">    `failure&#39; (STATUS value other than X&#39;00&#39;) status, it MUST close the
</span><span style="color:#75715e">    connection.
</span><span style="color:#75715e">    */</span>
	<span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x00</span>}
    <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">resp</span>)

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>但其实，现在大家都习惯自己采用加密流的方式进行加密，很少采用用户名密码的形式进行加密，后面章节会介绍一种对 SOCKS 的混淆加密方式。</p>
<h4 id="3请求信息">（3）请求信息</h4>
<p>认证结束后客户端就可以发送请求信息。如果认证方法有特殊封装要求，请求必须按照方法所定义的方式进行封装解密，其原始格式如下：</p>
<table class='pure-table pure-table-striped'>
<thead>
<tr>
<th>VER</th>
<th>CMD</th>
<th>RSV</th>
<th>ATYP</th>
<th>DST.ADDR</th>
<th>DST.PORT</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>0x00</td>
<td>1</td>
<td>动态</td>
<td>2</td>
</tr>
</tbody>
</table>
<ul>
<li>VER 是 SOCKS 版本，这里应该是 0x05；</li>
<li>CMD 是 SOCK 的命令码
<ul>
<li>0x01 表示 CONNECT 请求</li>
<li>0x02 表示 BIND 请求</li>
<li>0x03 表示 UDP 转发</li>
</ul>
</li>
<li>RSV 0x00，保留</li>
<li>ATYP DST.ADDR 类型</li>
<li>DST.ADDR 目的地址
<ul>
<li>0x01 IPv4 地址，DST.ADDR 部分 4 字节长度</li>
<li>0x03 域名，DST.ADDR 部分第一个字节为域名长度，DST.ADDR 剩余的内容为域名，没有\0 结尾。</li>
<li>0x04 IPv6 地址，16 个字节长度。</li>
</ul>
</li>
<li>DST.PORT 网络字节序表示的目的端口</li>
</ul>
<p>代码实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Socks5Resolution</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">VER</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">CMD</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">RSV</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">ATYP</span> <span style="color:#66d9ef">uint8</span>
    <span style="color:#a6e22e">DSTADDR</span> []<span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">DSTPORT</span> <span style="color:#66d9ef">uint16</span>
    <span style="color:#a6e22e">DSTDOMAIN</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">RAWADDR</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPAddr</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Socks5Resolution</span>) <span style="color:#a6e22e">lstRequest</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">128</span>)
    <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">n</span> &lt; <span style="color:#ae81ff">7</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;请求协议错误&#34;</span>)
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">VER</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;该协议不是socks5协议&#34;</span>)
    }

    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CMD</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">CMD</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;客户端请求类型不为代理连接, 其他功能暂时不支持.&#34;</span>)
    }
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RSV</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">2</span>] <span style="color:#75715e">//RSV保留字端，值长度为1个字节
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ATYP</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">3</span>]

    <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ATYP</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#75715e">//	IP V4 address: X&#39;01&#39;
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTADDR</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">4</span> : <span style="color:#ae81ff">4</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv4len</span>]
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span>:
        <span style="color:#75715e">//	DOMAINNAME: X&#39;03&#39;
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTDOMAIN</span> = string(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">5</span>:<span style="color:#a6e22e">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>])
        <span style="color:#a6e22e">ipAddr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveIPAddr</span>(<span style="color:#e6db74">&#34;ip&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTDOMAIN</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTADDR</span> = <span style="color:#a6e22e">ipAddr</span>.<span style="color:#a6e22e">IP</span>
    <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span>:
        <span style="color:#75715e">//	IP V6 address: X&#39;04&#39;
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTADDR</span> = <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">4</span> : <span style="color:#ae81ff">4</span><span style="color:#f92672">+</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IPv6len</span>]
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;IP地址错误&#34;</span>)
    }

    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTPORT</span> = <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(<span style="color:#a6e22e">b</span>[<span style="color:#a6e22e">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:<span style="color:#a6e22e">n</span>])
    <span style="color:#75715e">// DSTADDR全部换成IP地址，可以防止DNS污染和封杀
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">RAWADDR</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPAddr</span>{
		<span style="color:#a6e22e">IP</span>:   <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTADDR</span>,
		<span style="color:#a6e22e">Port</span>: int(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">DSTPORT</span>),
    }

    <span style="color:#75715e">/**
</span><span style="color:#75715e">    回应客户端,响应客户端连接成功
</span><span style="color:#75715e">        +----+-----+-------+------+----------+----------+
</span><span style="color:#75715e">        |VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
</span><span style="color:#75715e">        +----+-----+-------+------+----------+----------+
</span><span style="color:#75715e">        | 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
</span><span style="color:#75715e">        +----+-----+-------+------+----------+----------+
</span><span style="color:#75715e">    */</span>
	<span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>}
    <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">resp</span>)

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>


}
</code></pre></div><h4 id="4最后将信息进行转发即可">（4）最后将信息进行转发即可</h4>
<p>代码实现:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">    <span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>)
    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">2</span>)

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dstServer</span>.<span style="color:#a6e22e">Close</span>()
        <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">dstServer</span>, <span style="color:#a6e22e">client</span>)
    }()

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Close</span>()
        <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">dstServer</span>)
    }()

    <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</code></pre></div>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="0001-01-01">January 1, 0001</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/gudingdapei/">固定搭配</a></h1>
    <div class="tags">
        
    </div>
    <h2 id="接不定式而不接动名词作宾语的24个常用动词">接不定式（而不接动名词）作宾语的24个常用动词</h2>
<p>afford to do sth. 负担得起做某事</p>
<p>agree to do sth. 同意做某事</p>
<p>arrange to do sth.安排做某事</p>
<p>ask to do sth. 要求做某事</p>
<p>beg to do sth. 请求做某事</p>
<p>care to do sth. 想要做某事</p>
<p>choose to do sth. 决定做某事</p>
<p>decide to do sth. 决定做某事</p>
<p>demand to do sth. 要求做某事</p>
<p>determine to do sth. 决心做某事</p>
<p>expect to do sth. 期待做某事</p>
<p>fear to do sth. 害怕做某事</p>
<p>help to do sth. 帮助做某事</p>
<p>hope to do sth. 希望做某事</p>
<p>learn to do sth. 学习做某事</p>
<p>manage to do sth. 设法做某事</p>
<p>offer to do sth. 主动提出做某事</p>
<p>plan to do sth. 计划做某事</p>
<p>prepare to do sth. 准备做某事</p>
<p>pretend to do sth. 假装做某事</p>
<p>promise to do sth. 答应做某事</p>
<p>refuse to do sth. 拒绝做某事</p>
<p>want to do sth. 想要做某事</p>
<p>wish to do sth. 希望做某事</p>
<p>注：有些不及物动词后习惯上也接不定式，不接动名词：</p>
<p>aim to do sth. 打算做某事</p>
<p>fail to do sth. 未能做某事</p>
<p>long to do sth. 渴望做某事</p>
<p>happen to do sth. 碰巧做某事</p>
<p>hesitate to do sth. 犹豫做某事</p>
<p>struggle to do sth. 努力做某事</p>
<h2 id="接不定式作宾补的36个常用动词">接不定式作宾补的36个常用动词</h2>
<p>advise sb. to do sth. 建议某人做某事</p>
<p>allow sb. to do sth. 允许某人做某事</p>
<p>ask sb. to do sth.请（叫）某人做某事</p>
<p>bear sb. to do sth.忍受某人做某事</p>
<p>beg sb. to do sth. 请求某人做某事</p>
<p>cause sb. to do sth. 导致某人做某事</p>
<p>command sb. to do sth. 命令某人做某事</p>
<p>drive sb. to do sth .驱使某人做某事</p>
<p>elect sb. to do sth. 选举某人做某事</p>
<p>encourage sb. to do sth. 鼓励某人做某事</p>
<p>expect sb. to do sth. 期望某人做某事</p>
<p>forbid sb. to do sth. 禁止某人做某事</p>
<p>force sb. to do sth. 强迫某人做某事</p>
<p>get sb. to do sth. 使（要）某人做某事</p>
<p>hate sb. to do sth. 讨厌某人做某事</p>
<p>help sb. to do sth. 帮助某人做某事</p>
<p>intend sb. to do sth. 打算要某人做某事</p>
<p>invite sb. to do sth. 邀请某人做某事</p>
<p>leave sb. to do sth. 留下某人做某事</p>
<p>like sb. to do sth. 喜欢某人做某事</p>
<p>mean sb. to do sth. 打算要某人做某事</p>
<p>need sb. to do sth. 需要某人做某事</p>
<p>oblige sb. to do sth. 迫使某人做某事</p>
<p>order sb. to do sth. 命令某人做某事</p>
<p>permit sb. to do sth. 允许某人做某事</p>
<p>persuade sb. to do sth. 说服某人做某事</p>
<p>prefer sb. to do sth. 宁愿某人做某事</p>
<p>request sb. to do sth. 要求某人做某事</p>
<p>remind sb. to do sth. 提醒某人做某事</p>
<p>teach sb. to do sth .教某人做某事</p>
<p>tell sb. to do sth. 告诉某人做某事</p>
<p>train sb. to do sth. 训练某人做某事</p>
<p>trouble sb. to do sth. 麻烦某人做某事</p>
<p>want sb. to do sth. 想要某人做某事</p>
<p>warn sb. to do sth. 警告某人做某事</p>
<p>wish sb. to do sth. 希望某人做某事</p>
<p>注：不要受汉语意思的影响而误用以下动词句型：</p>
<p>汉语说：“害怕某人做某事”，但英语不说fear sb. to do sth.。</p>
<p>汉语说：“原谅某人做某事”，但英语不说excuse [forgive] sb. to do sth.。</p>
<p>汉语说：“拒绝某人做某事”，但英语不说refuse sb. to do sth.。</p>
<p>汉语说：“惩罚某人做某事”，但英语不说punish sb. to do sth.。</p>
<p>汉语说：“建议某人做某事”，但英语不说suggest [propose] sb. to do sth.。</p>
<p>汉语说：“赞成某人做某事”，但英语不说approve sb. to do sth.。</p>
<p>汉语说：“通知某人做某事”，但英语不说inform sb. to do sth.。</p>
<p>汉语说：“欢迎某人做某事”，但英语不说welcome sb. to do sth.。</p>
<p>汉语说：“坚持某人做某事”，但英语不说insist [persist] sb. to do sth.。</p>
<p>汉语说：“希望某人做某事”，但英语不说hope sb. to do sth.。</p>
<p>汉语说：“安排某人做某事”，但英语不说arrange sb. to do sth.。</p>
<p>汉语说：“要求某人做某事”，但英语不说demand sb. to do sth.。</p>
<p>汉语说：“感谢某人做某事”，但英语不说thank sb. to do sth.。</p>
<p>汉语说：“祝贺某人做某事”，但英语不说congratulate sb. to do sth.。</p>
<p>汉语说：“阻止某人做某事”，但英语不说prevent sb. to do sth.。</p>
<p>要表示以上意思，可换用其他表达：</p>
<p>汉语的“原谅某人做某事”，英语可说成excuse [forgive] sb. for doing sth.。</p>
<p>汉语的“希望某人做某事”，英语可说成wish sb. to do sth.。</p>
<p>汉语的“建议某人做某事”，英语可说成advise sb. to do sth.。</p>
<p>汉语的“安排某人做某事”，英语可说成arrange for sb. to do sth.。</p>
<p>汉语的“要求某人做某事”，英语可说成demand of sb. to do sth.。</p>
<p>汉语的“感谢某人做某事”，英语可说成thank sb. for doing sth.。</p>
<p>汉语的“祝贺某人做某事”，英语可说成congratulate sb. on doing sth.。</p>
<p>汉语的“阻止某人做某事”，英语可说成prevent sb. from doing sth.。</p>
<h2 id="接动名词不接不定式作宾语的34个常用动词">接动名词（不接不定式）作宾语的34个常用动词</h2>
<p>admit doing sth. 承认做某事                    advise doing sth. 建议做某事</p>
<p>allow doing sth. 允许做某事                     appreciate doing sth. 感激做某事</p>
<p>avoid doing sth. 避免做某事                     consider doing sth. 考虑做某事</p>
<p>delay doing sth. 推迟做某事                     deny doing sth. 否认做某事</p>
<p>discuss doing sth. 讨论做某事                   dislike doing sth. 不喜欢做某事</p>
<p>enjoy doing sth. 喜爱做某事                     escape doing sth. 逃脱做某事</p>
<p>excuse doing sth. 原谅做某事                    fancy doing sth. 设想做某事</p>
<p>finish doing sth. 完成做某事                      forbid doing sth. 禁止做某事</p>
<p>forgive doing sth. 原谅做某事                    give up doing sth. 放弃做某事</p>
<p>imagine doing sth. 想象做某事                   keep doing sth. 保持做某事</p>
<p>mention doing sth. 提及做某事                   mind doing sth. 介意做某事</p>
<p>miss doing sth. 错过做某事                        pardon doing sth. 原谅做某事</p>
<p>permit doing sth. 允许做某事                      practice doing sth. 练习做某事</p>
<p>prevent doing sth. 阻止做某事                     prohibit doing sth. 禁止做某事</p>
<p>put off doing sth. 推迟做某事                      report doing sth. 报告做某事</p>
<p>risk doing sth. 冒险做某事                         stop doing sth. 停止做某事</p>
<p>suggest doing sth. 建议做某事                     understand doing sth. 理解做某事</p>
<h2 id="接现在分词作宾补的20个常用动词">接现在分词作宾补的20个常用动词</h2>
<p>bring sb. doing sth.引起某人做某事    catch sb. doing sth. 碰上（撞上）某人做某事</p>
<p>discover sb. doing sth. 发现某人做某事   feel sb. doing sth. 感觉某人做某事</p>
<p>find sb. doing sth. 碰上（撞上）某人做某事  get sb. doing sth. 使某人做某事</p>
<p>have sb. doing sth. 使某人做某事             hear sb. doing sth. 听见某人做某事</p>
<p>keep sb. doing sth. 使某人不停地做某事    listen to sb. doing sth. 听某人做某事</p>
<p>look at sb. doing sth. 看着某人做某事        notice sb. doing sth. 注意到某人做某事</p>
<p>observe sb. doing sth. 观察某人做某事      prevent sb. doing sth. 阻止某人做某事</p>
<p>see sb. doing sth. 看见某人做某事            send sb. doing sth.使某人（突然）做某事</p>
<p>set sb. doing sth. 使（引起）某人做某事     start sb. doing sth. 使某人开始做某事</p>
<p>stop sb. doing sth. 阻止某人做某事           watch sb. doing sth. 观五、接动词原形作宾补的11个常用动词</p>
<p>feel sb. do sth. 感觉某人做某事                                have sb. do sth. 使某人做某事</p>
<p>hear sb. do sth. 听见某人做某事             let sb. do sth.让某人做某事</p>
<p>listen to sb. do sth. 听着某人做某事        look at sb. do sth. 看着某人做某事</p>
<p>make sb. do sth. 使某人做某事              notice sb. do sth. 注意某人做某事</p>
<p>observe sb. do sth. 观察某人做某事         see sb. do sth. 看见某人做某事</p>
<p>watch sb. do sth. 观察某人做某事</p>
<p>察某人做某事</p>
<h2 id="接不定式或动名词作宾语意思相同的12个动词">接不定式或动名词作宾语意思相同的12个动词</h2>
<p>like to do sth / like doing sth. 喜欢做某事</p>
<p>love to do sth / love doing sth. 喜欢做某事</p>
<p>hate to do sth / hate doing sth. 憎恨做某事</p>
<p>prefer to do sth / prefer doing sth. 宁可做某事</p>
<p>begin to do sth / begin doing sth. 开始做某事</p>
<p>start to do sth / start doing sth. 开始做某事</p>
<p>continue to do sth / continue doing sth. 继续做某事</p>
<p>can’t bear to do sth / can’t bear doing sth. 不能忍受做某事</p>
<p>bother to do sth / bother doing sth. 麻烦做某事</p>
<p>intend to do sth / intend doing sth.想要做某事</p>
<p>attempt to do sth / attempt doing sth. 试图做某事</p>
<p>cease to do sth / cease doing sth. 停止做某事</p>
<h2 id="接不定式或动名词作宾语意思不同的7个动词">接不定式或动名词作宾语意思不同的7个动词</h2>
<p>(1) remember to do sth. 记住要做某事                        remember doing sth. 记住曾做过某事</p>
<p>(2) forget to do sth. 忘记要做某事                         forget doing sth. 忘记曾做过某事</p>
<p>(3) regret to do sth. 后悔（遗憾）要做某事         regret doing sth. 后悔（遗憾）曾做过某事</p>
<p>(4) try to do sth. 设法要做某事                                try doing sth. 做某事试试看有何效果</p>
<p>(5) mean to do sth. 打算做某事                                mean doing sth. 意味着做某事</p>
<p>(6) can’t help to do sth. 不能帮助做某事                 can’t help doing sth. 禁不住做某事</p>
<p>(7) go on to do sth. 做完某事后接着做另一事         go on doing sth. 继续做一直在做的事</p>
<p>注：stop to do sth. 与stop doing sth.也不同，前者指停下来去做某事，后者指停止正在做的事，但stop to do sth. 中的不定式不是宾语，是目的状语。</p>
<h2 id="可接双宾语的38个常用动词">可接双宾语的38个常用动词</h2>
<p>(1) 双宾语易位时需借助介词to的常用动词</p>
<p>award sb. sth. = award sth. to sb. 颁奖给某人</p>
<p>bring sb. sth. = bring sth. to sb. 把某物带给某人</p>
<p>hand sb. sth. =hand sth. to sb. 把某物递给某人</p>
<p>lend sb. sth. = lend sth. to sb. 把某物借给某人</p>
<p>mail sb. sth. = mail sth. to sb. 把某物寄给某人</p>
<p>offer sb. sth. = offer sth. to sb. 将某物给某人</p>
<p>owe sb. sth. = owe sth. to sb. 欠某人某物</p>
<p>pass sb. sth. = pass sth. to sb. 把某物递给某人</p>
<p>pay sb. sth. = pay sth. to sb. 付给某人某物（钱）</p>
<p>post sb. sth. = post sth. to sb. 把某物寄给某人</p>
<p>read sb. sth. = read sth. to sb. 把某物读给某人听</p>
<p>return sb. sth. = return sth. to sb. 把某物还给某人</p>
<p>send sb. sth. = send sth. to sb. 把某物送给某人</p>
<p>sell sb. sth. = sell sth. to sb. 把某物卖给某人</p>
<p>serve sb. sth. = serve sth. to sb. 拿某物招待某人</p>
<p>show sb. sth. = show sth. to sb. 拿某物给某人看</p>
<p>take sb. sth. = take sth. to sb. 把某物拿给某人</p>
<p>teach sb. sth. = teach sth. to sb. 教某人某物</p>
<p>tell sb. sth. = tell sth. to sb. 告诉某人某情况</p>
<p>throw sb. sth. = throw sth. to sb. 把某物扔给某人</p>
<p>write sb. sth. = write sth. to sb. 给某人写信</p>
<p>(2) 双宾语易位时需借助介词for的常用动词</p>
<p>book sb. sth. = book sth. for sb. 为某人预定某物</p>
<p>buy sb. sth. = buy sth. for sb. 为某人买某物</p>
<p>choose sb. sth. = choose sth. for sb. 为某人选某物</p>
<p>cook sb. sth. = cook sth. for sb. 为某人煮某物</p>
<p>draw sb. sth. = draw sth. for sb. 为某人画某物</p>
<p>fetch sb. sth. = fetch sth. for sb. 为某人去取某物</p>
<p>find sb. sth. = find sth. for sb. 为某人找到某物</p>
<p>fix sb. sth. = fix sth. for sb. 为某人准备某物</p>
<p>get sb. sth. = get sth. for sb. 为某人拿来某物</p>
<p>make sb. sth. = make sth. for sb. 为某人做某物</p>
<p>order sb. sth. = order sth. for sb. 为某人订购某物</p>
<p>pick sb. sth. = pick sth. for sb. 为某人采摘某物</p>
<p>prepare sb. sth. = prepare sth. for sb. 为某人准备某物</p>
<p>save sb. sth. = save sth. for sb. 为某人留某物</p>
<p>sing sb. sth. = sing sth. for sb. 为某人唱某物（歌）</p>
<p>spare sb. sth. = spare sth. for sb. 为某人让出某物</p>
<p>steal sb. sth. = steal sth. for sb. 为某人偷某物</p>
<p>注：有的动词后接的双宾语易位时，既可用介词to引出间接宾语，也可用介词for引出间接宾语，含义相同，如bring，play等：</p>
<p>Bring me today’s paper. = Bring today’s paper to [for] me. 把今天的报纸拿给我。</p>
<p>He played us the record he had just bought. = He played the record he had just bought for [to] us. 他放了他
刚买的唱片给我们听。</p>
<p>有的动词后接的双宾语易位时，即可用介词to引出间接宾语，也可用介词for引出间接宾语，含义不同，如leave等：</p>
<p>They left me no food. = They left no food for me. 他们没给我留一点食物。</p>
<p>My uncle left me a large fortune. = My uncle left a large fortune to me.</p>
<p>我叔叔死后留下一大笔财产给我。</p>
<p>而有的动词后接双宾语时，既不能用介词to引出间接宾语，也不能用介词for引出间接宾语，如allow, ask, cause, charge, cost, 
forgive, refuse等：</p>
<p>He allows his son too much money. 他给他儿子的钱太多。</p>
<p>He asked me some questions. 他问了我一些问题。</p>
<p>This caused me much trouble. 着给我带来了许多麻烦。</p>
<p>He charged me five dollars for a cup of tea. 他一杯茶向我要了5美元。</p>
<p>His mistake cost him his job. 他的错误让他丢了工作。</p>
<p>I envy you your good luck. 我羡慕你的好运。</p>
<p>They forgave him his rudeness. 他们原谅了他的鲁莽。</p>
<p>He refused her nothing. 她要什么就给什么。</p>
<h2 id="可用于动词sbof-sth的8个常见动词">可用于“动词+sb+of sth”的8个常见动词</h2>
<p>accuse sb. of sth. 控告某人犯某事（罪），指责某人做某事</p>
<p>cheat sb. fo sth. 骗取某人某物</p>
<p>cure sb. of sth. 治好某人的病，改掉某人的坏习惯</p>
<p>inform sb. of sth. 通知某人某情况（事）</p>
<p>remind sb. of sth. 使某人想起某情况（事）</p>
<p>rid sb. of sth. 使某人摆脱某物</p>
<p>rob sb. of sth. 抢劫某人的某东西</p>
<p>warn sb. of sth. 警告某人有某情况</p>
<h2 id="可用于动词sbfor-doing-sth的8个常见动词">可用于“动词+sb+for doing sth”的8个常见动词</h2>
<p>blame sb. for doing sth. 指责某人做某事</p>
<p>criticize sb. for doing sth. 批评某人做某事</p>
<p>forgive sb. for doing sth. 原谅某人做某事</p>
<p>excuse sb. for doing sth. 原谅某人做某事</p>
<p>pardon sb. for doing sth. 原谅某人做某事</p>
<p>punish sb. for doing sth. 惩罚某人做某事</p>
<p>scold sb. for doing sth. 指责（责备）某人做某事</p>
<p>thank sb. for doing sth. 感谢某人做某事</p>
<h2 id="可用于动词sbinto-doing-sth的9个常见动词">可用于“动词+sb+into doing sth”的9个常见动词</h2>
<p>cheat sb. into doing sth. 欺骗某人做某事                trick sb. into doing sth. 欺骗某人做某事</p>
<p>food sb. into doing sth. 欺骗某人做某事                force sb. into doing sth. 迫使某人做某事</p>
<p>argue sb. into doing sth. 说服某人做某事                talk sb. into doing sth. 说服某人做某事</p>
<p>terrify sb. into doing sth. 威胁某人做某事                frighten sb. into doing sth. 吓唬某人做某事</p>
<p>persuade sb. into doing sth. 说服某人做某事</p>
<h2 id="容易误用作及物动词的9个不及物动词">容易误用作及物动词的9个不及物动词</h2>
<p>误：deal a problem                             正：deal with a problem 处理问题</p>
<p>误：depend sb.                                   正：depend on sb. 依靠（依赖）某人</p>
<p>误：insist doing sth.                           正：insist on doing sth. 坚持要做某事</p>
<p>误：knock the door                             正：knock on [at] the door 敲门</p>
<p>误：operate sb.                              正：operate on sb. 为某人做手术</p>
<p>误：participate sth.                          正：participate in sth. 参加某事</p>
<p>误：refer sth.                                 正：refer to sth. 查阅（参考)某物</p>
<p>误：rely sb. / sth.                            正：rely on sb. / sth. 依靠（依赖）某人（某物</p>
<p>误：reply a letter                             正：reply to a letter 回信</p>
<p>注：在某些其他用法中，以上有的动词也可能及物，如insist, reply等动词后可接宾语从句，operate表示“操作”、“管理”等时则及物。</p>
<h2 id="容易误用作不及物动词的8个及物动词">容易误用作不及物动词的8个及物动词</h2>
<p>误：serve for sb.                 正：serve sb. 为某人服务</p>
<p>误：marry with sb.              正：marry sb. 与某人结婚</p>
<p>误：discuss about sth.          正：discuss sth. 讨论某事</p>
<p>误：mention about sth.         正：mention sth. 提到某事</p>
<p>误：enter into a room           正：enter a room 进入房间</p>
<p>误：contact with sb.             正：contact sb. 与某人联系</p>
<p>误：equal to sth.                  正： equal sth. 等于某物</p>
<p>误：ring to sb.                    正：ring sb. 给某人打电话</p>
<p>注：有个别词在用于其他意义时，可以是不及物的，如enter into可以表示开始进入或从事某一状态或活动，或用于较抽象的概念。如：</p>
<p>The country entered into a state of war. 这个国家进入战争状态。</p>
<p>I can enter into your feelings at the loss of your father. 我理解你失去父亲后的心情。</p>
<p>The two old men entered into a long conversation. 两位老人开始长谈起来。</p>
<h2 id="17个常用be形容词about结构">17个常用“be+形容词+about”结构</h2>
<p>be angry about 为……生气                        be anxious about 为……担忧</p>
<p>be careful about 当心……                         be certain about 确信……</p>
<p>be curious about 对……好奇                      be disappointed about 对……失望</p>
<p>be excited about 对……感到兴奋                 be glad about 对……感到高兴</p>
<p>be happy about 为……感到高兴                   be hopeful about 对……抱有希望</p>
<p>be mad about 对……入迷                          be nervous about 为……感到不安</p>
<p>be particular about 对……讲究                    be sad about 为……而难过</p>
<p>be serious about 对……认真                      be sure about 对……有把握</p>
<p>be worried about 为……担忧</p>
<h2 id="10个常用be形容词at结构">10个常用“be+形容词+at”结构</h2>
<p>be angry at 为……生气                             be bad at 不善于……</p>
<p>be clever at 擅长于……                            be disappointed at 对……失望</p>
<p>be expert at 在……方面是内行                    be good at 善于……</p>
<p>be mad at 对……发怒                              be quick at 在……方面敏捷</p>
<p>be skilful at 在……方面熟练                        be slow at 在……方面迟钝</p>
<h2 id="18个常用be形容词for结构">18个常用“be+形容词+for”结构</h2>
<p>be anxious for 渴望                           be bad for 对……有害，对……不利</p>
<p>be bound for 前往                             be celebrated for 以……出名</p>
<p>be convenient for 对……方便，在……附近   be eager for渴望</p>
<p>be famous for 因……闻名                      be fit for 合适，适合</p>
<p>be good for 对……有益（方便）               be grateful for 感谢</p>
<p>be hungry for 渴望得到                        be late for 迟到</p>
<p>be necessary for 对……有必要                be ready for 为……准备好</p>
<p>be sorry for 因……抱歉                         be suitable for 对……合适（适宜）</p>
<p>be thankful for 因……而感激                   be well-known for以……出名</p>
<h2 id="6个常用be形容词from结构">6个常用“be+形容词+from”结构</h2>
<p>be absent from 缺席，不在                   be different from 与……不同</p>
<p>be far from 离……远，远远不                  be free from 没有，免受</p>
<p>be safe from 没有……的危险                  be tired from 因……而疲劳</p>
<h2 id="13个常用be形容词in结构">13个常用“be+形容词+in”结构</h2>
<p>be concerned in 与……有关                    be disappointed in 对（某人）感到失望</p>
<p>be engaged in 从事于，忙于                  be experienced in 在……方面有经验</p>
<p>be expert in 在……方面是行家                 be fortunate in 在……方面幸运</p>
<p>be honest in 在……方面诚实                   be interested in 对……感兴趣</p>
<p>be lack in 缺乏                                  be rich in 富于，在……方面富有</p>
<p>be skilful in 擅长于                             be successful in 在……方面成功</p>
<p>be weak in 在……方面不行</p>
<h2 id="18个常用be形容词of结构">18个常用“be+形容词+of”结构</h2>
<p>be afraid of 害怕                                 be ashamed of 为……感到羞愧</p>
<p>be aware of 意识到，知道                       be capable of 能够，可以</p>
<p>be careful of 小心，留心                         be certain of 确信，对……有把握</p>
<p>be fond of 喜欢                                    be free of 没有，摆脱</p>
<p>be full of 充满                                      be glad of 为……而高兴</p>
<p>be nervous of 害怕                                be proud of 为……自豪</p>
<p>be short of 缺乏                                   be shy of 不好意思</p>
<p>be sick of 对……厌倦                              be sure of 肯定，有把握</p>
<p>be tired of 对……厌烦                              be worthy of 只得，配得上</p>
<h2 id="20个常用be形容词to结构">20个常用“be+形容词+to”结构</h2>
<p>be accustomed to 习惯于                       be blind to 对……视而不见</p>
<p>be close to 靠近，接近                           be cruel to 对……残酷，对……无情</p>
<p>be devoted to 献身，专心于                    be equal to 等于，能胜任</p>
<p>be familiar to 为（某人）所熟悉                be harmful to 对……有危害</p>
<p>be important to 对……重要p;                  be open to 对……开放，易受到</p>
<p>be opposed to 反对，不赞成                    be opposite to 在……对面，和……相反</p>
<p>be polite to 对……有礼貌                        be related to 与……有关（是亲戚）</p>
<p>be respectful to 尊敬                          be rude to 对……无礼</p>
<p>be similar to 与……相似                        be true to 忠实于，信守</p>
<p>be used to 习惯于                               be useful to 对……有用</p>
<h2 id="16个常用be形容词with结构">16个常用“be+形容词+with”结构</h2>
<p>be angry with 对（某人）生气                  be bored with 对……厌烦</p>
<p>be busy with 忙于                                be careful with 小心</p>
<p>be concerned with 关于，与……有关           be content with 以……为满足</p>
<p>be delighted with 对……感到高兴               be disappointed with 对（某人）失望</p>
<p>be familiar with 熟悉，精通                     be honest with 对（某人）真诚</p>
<p>be ill with 患……病                                be patient with 对（某人）有耐心</p>
<p>be pleased with 对……满意（高兴）            be popular with 受……欢迎</p>
<p>be satisfied with 对……满意                     be strict with 对（某人）严格</p>
<h2 id="24个常用in其他词of结构">24个常用“in+其他词+of”结构</h2>
<p>in advance of 在……前面                       in aid of 帮助</p>
<p>in behalf of 为了，为了……的利益             in case of 如果，万一，以防</p>
<p>in celebration of 庆祝                          in charge of 负责，管理</p>
<p>in commemoration of 纪念，庆祝            in defence of 保卫</p>
<p>in explanation of 解释                          in face of 面对</p>
<p>in favour of 赞成，主张                         in front of 在……前面</p>
<p>in honor of 纪念，祝贺，欢迎                 in memory of 纪念</p>
<p>in need of 需要                                  in place of 代替</p>
<p>in possession of 拥有                          in praise of 称赞</p>
<p>in respect of 关于，就……而言                 in search of 寻找，搜找</p>
<p>in sight of 看得见，在看见……的地方         in spite of 虽然，尽管</p>
<p>in support of 为了支持（拥护）……           in view of 鉴于，考虑到</p>
<p>注：同时注意一下相似结构：</p>
<p>in exchange for 作为对……的交换             in preparation for 为……作准备</p>
<p>in return for 作为……的报答                   in reward for 作为……的报酬</p>
<p>in addition to 加之，除……之外               in answer to 回答，响应</p>
<p>in contrast to [with] 与……形成对比         in opposition to 与……相反，反对</p>
<p>in reply to 作为对……的回答（答复）         in response to 回答，响应</p>
<p>in [with] reference to 关于                   in [with] regard to 关于</p>
<h2 id="27个带to-doing-sth的常用结构">27个带to doing sth.的常用结构</h2>
<p>1．动词+介词to+动名词</p>
<p>(1) admit to doing sth. 承认做了某事</p>
<p>(2) apply to doing sth. 适用于做某事</p>
<p>(3) object to doing sth. 反对做某事</p>
<p>(4) see to doing sth. 负责做某事</p>
<p>(5) stick to doing sth. 坚持做某事</p>
<p>(6) take to doing sth. 喜欢上做某事，逐渐习惯做某事</p>
<p>2．动词+宾语+介词to+动名词</p>
<p>(1) apply oneself to doing sth. 专心致力于做某事</p>
<p>(2) devote sth. to doing sth. 把……献给做某事</p>
<p>(3) devote oneself to doing sth. 献身于做某事</p>
<p>(4) limit sth. to doing sth. 把……限制在做某事的范围内</p>
<p>(5) reduce sb. to doing sth. 使某人沦为做某事</p>
<p>3．动词+名词+介词to+动名词</p>
<p>(1) give one’s life to doing sth. 献身于做某事</p>
<p>(2) give one’s mind to doing sth. 专心做某事</p>
<p>(3) have a dislike to doing sth. 厌恶做某事</p>
<p>(4) have an eye to doing sth. 注意做某事</p>
<p>(5) have an objection to doing sth. 反对（反感）做某事</p>
<p>(6) pay attention to doing sth. 注意做某事</p>
<p>(7) set one’s mind to doing sth. 决心做某事</p>
<p>4．be+形容词+介词to+动名词</p>
<p>(1) be equal to doing sth. 等于做某事，能胜任做某事</p>
<p>(2) be used to doing sth. 习惯于做某事</p>
<p>(3) be opposed to doing sth. 反对做某事</p>
<p>(4) be reduced to doing sth. 使某人沦为做某事</p>
<p>(5) be devoted to doing sth. 把时间（钱，精力等）献给做某事</p>
<p>(6) be limited to doing sth. 把……限制在做某事的范围内</p>
<p>5．其他结构+介词to+动名词</p>
<p>(1) get down to doing sth. 开始做某事，认真处理某事</p>
<p>(2) look forward to doing sth. 盼望做某事</p>
<p>(3) What do you say to doing sth? 你认为做某事如何？</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pagination">
        
        <span class="pagination-item older">Older</span>
        

        
        <a class="pure-button pagination-item newer" href="/page/2/">Newer</a>
        
    </div>
</div>


                
<div id="sidebar" class="pure-u-1 pure-u-md-1-4 pure-u-sm-1">
    <div class="pad">
        <a name="about"></a>
        <h3>About Me</h3>
        <div style="text-align: center;">
            <img src="/me.png" alt="Sdttttt" class="pure-img" />
            <p><em>突如其来的变故使得本就不富裕的晦气小伙雪上加霜.</em></p>
        </div>

        <h3>Latest Articles</h3>
        <div class="pure-menu pure-menu-open">
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/btree/" class="pure-menu-link">B Tree<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/blogupgrade/" class="pure-menu-link">Blog Upgrade<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/thread_pool_executor/" class="pure-menu-link">Thread Pool Executor 运行细节<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/raft_impl/" class="pure-menu-link">Raft实现的思考<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/kanon/" class="pure-menu-link">Kanon<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/database_storage/" class="pure-menu-link">Database Storage<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/red-black-tree/" class="pure-menu-link">Red Black Tree<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/tree_rust/" class="pure-menu-link">Tree by Rust implement<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/stack_rust/" class="pure-menu-link">Stack by Rust implement<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/gfs/" class="pure-menu-link">GFS<br>
                        <small></small>
                    </a>
                </li>
                
            </ul>
        </div>

        <h3>Categories</h3>
        <div style="text-align:center" class="tags">
            
            
            <a href="/tags/data-structure" class="pure-button"> data-structure
                <small>(4)</small></a>
            
            
            
            <a href="/tags/penetration-test" class="pure-button"> penetration-test
                <small>(3)</small></a>
            
            
            
            <a href="/tags/assembly" class="pure-button"> assembly
                <small>(2)</small></a>
            
            
            
            <a href="/tags/blog" class="pure-button"> blog
                <small>(2)</small></a>
            
            
            
            <a href="/tags/cicd" class="pure-button"> cicd
                <small>(2)</small></a>
            
            
            
            <a href="/tags/design" class="pure-button"> design
                <small>(2)</small></a>
            
            
            
            <a href="/tags/microservice" class="pure-button"> microservice
                <small>(2)</small></a>
            
            
            
            <a href="/tags/rust" class="pure-button"> rust
                <small>(2)</small></a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </div> 
</div> 

                
            </div><div class="pure-g">
	<footer class="pure-u-1 pure-u-md-1 pure-u-sm-1">
		<p>This page and its contents are copyright &copy; 2020,
			<a href="">Sdttttt</a>.</p>
		<p><a href="https://github.com/pravin/hugo-theme-prav">Theme Prav</a> by <a href="https://cto.me.uk">Pravin
				Paratey</a></p>
	</footer>

	<script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"
		integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl"
		crossorigin="anonymous"></script>
</div></div></body>
</html>
