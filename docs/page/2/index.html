<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#000" />
    <title>
        
             
                SDTTTTT 
             
            &middot; Lorem ipsum dolor sit amet, consectetur adipiscing elit.
        
    </title>

    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css"
        integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    
    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans+Condensed:wght@300&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="">
    
    
    <meta name="description" content="Lorem ipsum dolor sit amet, consectetur adipiscing elit.">
    

    
    <meta name="author" content="Sdttttt"></head>
<body>
        <div class="container"><div id="navbar" class="pure-menu pure-menu-open pure-menu-horizontal pure-menu-scrollable">
    <a href="/" class="pure-menu-heading">
         
            SDTTTTT 
         
    </a>
    <ul class="pure-menu-list">
        <li class="pure-menu-item">
            <a href="/posts" class="pure-menu-link">
                <i class="fa fa-archive"></i>
                Articles
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/tags" class="pure-menu-link">
                <i class="fas fa-comments"></i>
                Categories
            </a>
        </li>
        <li class="pure-menu-item">
            <a href="/about" class="pure-menu-link">
                <i class="fas fa-smile"></i>
                About
            </a>
        </li>
    </ul>
    <ul class="pure-menu-list pull-right">
        
        <li class="pure-menu-item">
            <a href="https://github.com/sdttttt" title="Github" class="pure-menu-link">
                <i class="fab fa-github"></i>
                <span class="hide">Github</span>
            </a>
        </li>
        
        
        <li class="pure-menu-item">
            <a href="http://twitter.com/shiina38092638" title="@pravin" class="pure-menu-link">
                <i class="fab fa-twitter-square"></i>
                <span class="hide">Twitter</span>
            </a>
        </li>
        
        
        
        
        <li class="pure-menu-item">
            <a href="https://www.facebook.com/sdzzzzz" title="Facebook" class="pure-menu-link">
                <i class="fab fa-facebook"></i>
                <span class="hide">Facebook</span>
            </a>
        </li>
        
        <li class="pure-menu-item">
            <a href="/posts/index.xml" title="Atom Feed" class="pure-menu-link">
                <i class="fas fa-rss-square"></i>
                <span class="hide">RSS Feed</span>
            </a>
        </li>
    </ul>
</div>
<div class="pure-u-1">
    <div class="pad">
    </div>
</div>
<div class="pure-g">

<div id="content" class="pure-u-1 pure-u-md-3-4 pure-u-sm-1">
    

    <div class="pad">
<div class="date">
    <time pubdate="2020-05-09">May 9, 2020</time>
    <span class="author">by sdttttt</span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/gfs/">GFS</a></h1>
    <div class="tags">
        
    </div>
    <p>这是 <code>MIT 6.824</code> 课程<code>GFS</code>部分的一些总结.</p>
<p>GFS (Google File System) 是Google为了管理海量数据而开发的一个分布式文件系统.</p>
<p>直接进入正题.</p>
<p>在GFS中文件是以<code>Chunk</code>的形式存储。所谓的<code>Chunk</code>是一个储存块。一个Chunk的大小为64MB.一个文件会分为多个Chunk.储存在不同的服务器里。当然也会有2-3份<code>Chunk</code>的拷贝。</p>
<p>GFS中还存在一个<code>Master</code>，Master收集所有文件的metadata, 保存在一张表中。</p>
<p>下面简单的解释一下读操作的交互。</p>
<ul>
<li><code>Client</code>指定的文件名和字节偏移转换成文件的一个块索引（<code>Chunk Index</code>）。</li>
<li>给<code>Master</code>发送一个包含文件名和块索引的请求。</li>
<li>master回应对应的<code>Chunk Handle</code>(存储数据服务器以<code>Chunk Handle</code>标识<code>Chunk</code>)和副本的位置（多个副本）。</li>
<li><code>Client</code>以文件名和块索引为键缓存这些信息。（handle和副本的位置）</li>
<li><code>Client</code>向其中一个副本发送一个请求，很可能是最近的一个副本。请求指定了<code>Chunk Handle</code>和块内的一个字节区间。</li>
<li>除非缓存的信息不再有效（cache for a limited time）或文件被重新打开，否则以后对同一个块的读操作不再需要client和master间的交互。</li>
</ul>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-27">April 27, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/consistent_hash_algorithm/">一致性哈希算法</a></h1>
    <div class="tags">
        
        
        <a href="/tags/distrbuted-system" class="pure-button">distrbuted system</a>
        
    </div>
    <p>第一代分布式系统采用的是中心化的系统，对于存贮大量数据的分布式系统来说它的缺点就是<code>中央节点</code>成为了整个个分布式系统的<code>单点故障</code>.</p>
<p>第二代分布式系统，节点之间通行采用的是<code>广播</code>，每个节点都向自己相连的<code>所有节点</code>进行询问，被询问的节点如果不知道这个文件在哪里,就再次进行<code>广播</code>&hellip;&hellip;如此往复,直至找到所需文件。请求变多就意味着会产生<code>广播风暴</code>，这会严重占用带宽和系统资源。</p>
<p>第三代分布式系统开始采用<code>DHT</code>(Distrbuted Hash Table)，也就是<code>一致性HASH算法</code>.</p>
<h2 id="算法背景">算法背景</h2>
<p>一致性 HASH 算法在 1997 年由麻省理工学院的 Karger 等人在解决分布式 Cache 中提出的,设计目标是为了
解决因特网中的热点(Hot spot)问题,初衷和 CARP 十分类似。一致性 HASH 修正了 CARP 使用的简单哈希
算法带来的问题,使得 DHT 可以在 P2P 环境中真正得到应用。</p>
<p>但现在一致性 hash 算法在分布式系统中也得到了广泛应用,研究过 <code>memcached</code> 缓存数据库的人都知道,
<code>memcached</code> 服务器端本身不提供分布式 <code>Cache</code> 的一致性,而是由客户端来提供,具体在计算一致性 HASH 时采用如下步骤:</p>
<ul>
<li>
<p>首先求出 memcached 服务器(节点)的哈希值,并将其配置到 <code>0 ~ 2^32</code> 的圆(continuum)上。</p>
</li>
<li>
<p>然后采用同样的方法求出存储数据的键的哈希值,并映射到相同的圆上。</p>
</li>
<li>
<p>然后从数据映射到的位置开始顺时针查找,将数据保存到找到的第一个服务器上。如果超过 2^32 仍然找不到服务器,就会保存到第一台 memcached 服务器上。</p>
</li>
</ul>
<p><img src="/ConsistentHashAlgorithm/1.png" alt=""></p>
<p>从上图的状态中添加一台 memcached 服务器。余数分布式算法由于保存键的服务器会发生巨大变化	
而影响缓存的命中率,但<code>一致性Hashing</code> 中,只有在圆(continuum)上增加服务器的地点逆时针方向	
的第一台服务器上的键会受到影响。</p>
<h2 id="性质">性质</h2>
<p>因为考虑到整个系统的节点数量是动态的，每时每刻有新节点加入和旧节点的失效。	
在这类情况下依然要保证系统的可用性，这是值得思考的，尤其是在设计分布式缓存系统的时候。
如果不采用<code>一致性HASH算法</code>, 客户端在计算数据的 hash 时往往要重新计算(通常这个 Hash 算法和系统中的节点数量有关),
由于 Hash 值已经改变，所以很有可能找不到在整个系统中所对应的节点，导致不可用。所以<code>一致性HASH算法</code>，在分布式系统中十分重要。</p>
<p>良好的<code>一致性HASH算法</code>需要满足一下特点：</p>
<p><strong>平衡性(Balance)</strong></p>
<p>平衡性是指哈希的结果能够尽可能分布到所有的缓冲中去,这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。</p>
<p><strong>单调性(Monotonicity)</strong></p>
<p>单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中,又有新的缓冲区加入到系统中,那么哈 希的结果应能够保证原有已分配的内容可以被映射到新的缓冲区中去,而不会被映射到旧的缓冲集合中的 其他缓冲区。简单的哈希算法往往不能满足单调性的要求,如最简单的线性哈希:x = (ax + b) mod (P), 在上式中,P 表示全部缓冲的大小。不难看出,当缓冲大小发生变化时(从 P1 到 P2),原来所有的哈希结果 均会发生变化,从而不满足单调性的要求。哈希结果的变化意味着当缓冲空间发生变化时,所有的映射关 系需要在系统内全部更新。而在 P2P 系统内,缓冲的变化等价于 Peer 加入或退出系统,这一情况在 P2P 系 统中会频繁发生,因此会带来极大计算和传输负荷。单调性就是要求哈希算法能够应对这种情况。</p>
<p><strong>分散性(Spread)</strong></p>
<p>在分布式环境中,终端有可能看不到所有的缓冲,而是只能看到其中的一部分。当终端希望通过哈希过程 将内容映射到缓冲上时,由于不同终端所见的缓冲范围有可能不同,从而导致哈希的结果不一致,最终的 结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的,因为它导致相同内 容被存储到不同缓冲中去,降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈 希算法应能够尽量避免不一致的情况发生,也就是尽量降低分散性。</p>
<p><strong>负载(Load)</strong></p>
<p>负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区 中,那么对于一个特定的缓冲区而言,也可能被不同的用户映射为不同的内容。与分散性一样,这种情况 也是应当避免的,因此好的哈希算法应能够尽量降低缓冲的负荷。</p>
<p><strong>平滑性(Smoothness)</strong></p>
<p>平滑性是指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的。</p>
<h2 id="虚拟节点">虚拟节点</h2>
<p>假设在圆上<code>Node A</code>和<code>Node B</code>距离过近，按照以上的环形一致 HASH 算法就会发生两个节点所拥有的数据数量不一致的问题。</p>
<p><img src="/ConsistentHashAlgorithm/2.png" alt=""></p>
<p>为了解决这种数据倾斜问题，一致性哈希算法引入了虚拟节点机制，即对每一个服务节点计算<code>多个哈希</code>，每个计算结果位置都放置一个此<code>服务节点</code>，称为虚拟节点。具体做法可以在服务器 ip 或主机名的后面增加编号来实现。例如上面的情况，可以为每台服务器计算三个虚拟节点，于是可以分别计算 “Node A#1”、“Node A#2”、“Node A#3”、“Node B#1”、“Node B#2”、“Node B#3”的哈希值，于是形成六个虚拟节点：</p>
<p>同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到 Node A 上。这样就解决了服务节点少时数据倾斜的问题。在实际应用中，通常将虚拟节点数设置为 32 甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-12">April 12, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/file_upload/">File Upload</a></h1>
    <div class="tags">
        
        
        <a href="/tags/penetration-test" class="pure-button">penetration test</a>
        
    </div>
    <p>DVWA File upload 过关秘籍.</p>
<h3 id="low">LOW</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Upload&#39; ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &#34;hackable/uploads/&#34;;
    $target_path .= basename( $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ] );

    // Can we move the file to the upload folder?
    // 完全没做过滤.
    // 上传一个PHP文件也是可以的.
    if( !move_uploaded_file( $_FILES[ &#39;uploaded&#39; ][ &#39;tmp_name&#39; ], $target_path ) ) {
        // No
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
    else {
        // Yes!
        echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;{$target_path} succesfully uploaded!&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
    }
}
</code></pre></div><h3 id="medium">Medium</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Upload&#39; ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &#34;hackable/uploads/&#34;;
    $target_path .= basename( $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ] );

    // File information
    $uploaded_name = $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ];
    $uploaded_type = $_FILES[ &#39;uploaded&#39; ][ &#39;type&#39; ];
    $uploaded_size = $_FILES[ &#39;uploaded&#39; ][ &#39;size&#39; ];

    // Is it an image?
    // // 开始做了一些过滤

    // 下面是官方对$_FILES 函数的描述
    //  [name] =&gt; MyFile.txt (comes from the browser, so treat as tainted)
    //         [type] =&gt; text/plain  (not sure where it gets this from - assume the browser, so treat as tainted)
    //         [tmp_name] =&gt; /tmp/php/php1h4j1o (could be anywhere on your system, depending on your config        settings, but the user has no control, so this isn&#39;t tainted)
    //         [error] =&gt; UPLOAD_ERR_OK  (= 0)
    //         [size] =&gt; 123   (the size in bytes)
    
    // 其中对name和type的description的描述都是 `treat as tainted`(被污染的)
    // 这意味着它有可能会被修改 unsafe
    
    // 我们可以尝试上传一个PHP文件，使用一些拦截请求工具，修改即将发出的请求.
    // 来达到修改`name`中的后缀名和`type`中的媒体类型.
    if( ( $uploaded_type == &#34;image/jpeg&#34; || $uploaded_type == &#34;image/png&#34; ) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        ( $uploaded_size &lt; <span style="color:#f92672">100000</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Can</span> <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">move</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">upload</span> <span style="color:#a6e22e">folder</span><span style="color:#960050;background-color:#1e0010">?</span>
        <span style="color:#a6e22e">if</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">!</span><span style="color:#a6e22e">move_uploaded_file</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">_FILES</span><span style="color:#960050;background-color:#1e0010">[</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">uploaded</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#960050;background-color:#1e0010">][</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">tmp_name</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#960050;background-color:#1e0010">],</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">target_path</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">No</span>
            <span style="color:#a6e22e">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;&lt;</span><span style="color:#a6e22e">pre</span>&gt;Your image was not uploaded.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }
        else {
            // Yes!
            echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;{$target_path} succesfully uploaded!&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
        }
    }
    else {
        // Invalid file
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
}
</code></pre></div><h3 id="high">High</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Upload&#39; ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &#34;hackable/uploads/&#34;;
    $target_path .= basename( $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ] );

    // File information
    $uploaded_name = $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ];
        // jpg
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &#39;.&#39; ) + 1);
    
    // file size
    $uploaded_size = $_FILES[ &#39;uploaded&#39; ][ &#39;size&#39; ];
    
    // tmp_name 是临时副本的名字
    $uploaded_tmp  = $_FILES[ &#39;uploaded&#39; ][ &#39;tmp_name&#39; ];

    // Is it an image?
    // 和上面的比起来多个一个文件后缀名的判断.
    // strtolower 转小写
    // 扩展名只要满足jpeg,png或者jpg就行
    if( ( strtolower( $uploaded_ext ) == &#34;jpg&#34; || strtolower( $uploaded_ext ) == &#34;jpeg&#34; || strtolower( $uploaded_ext ) == &#34;png&#34; ) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        ( $uploaded_size &lt; <span style="color:#f92672">100000</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">getimagesize</span> <span style="color:#a6e22e">获取图像信息</span>
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">这个函数保证你穿的一定得是个图像</span>
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">可以用图片木马绕过</span>
        <span style="color:#a6e22e">getimagesize</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Can</span> <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">move</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">upload</span> <span style="color:#a6e22e">folder</span><span style="color:#960050;background-color:#1e0010">?</span>
        <span style="color:#a6e22e">if</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">!</span><span style="color:#a6e22e">move_uploaded_file</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">target_path</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">No</span>
            <span style="color:#a6e22e">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;&lt;</span><span style="color:#a6e22e">pre</span>&gt;Your image was not uploaded.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }
        else {
            // Yes!
            echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;{$target_path} succesfully uploaded!&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
        }
    }
    else {
        // Invalid file
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
}
</code></pre></div><h3 id="high-1">High</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Upload&#39; ] ) ) {
    // Where are we going to be writing to?
    $target_path  = DVWA_WEB_PAGE_TO_ROOT . &#34;hackable/uploads/&#34;;
    $target_path .= basename( $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ] );

    // File information
    $uploaded_name = $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ];
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &#39;.&#39; ) + 1);
    $uploaded_size = $_FILES[ &#39;uploaded&#39; ][ &#39;size&#39; ];
    $uploaded_tmp  = $_FILES[ &#39;uploaded&#39; ][ &#39;tmp_name&#39; ];

    // Is it an image?
    // 对比上面多验证了文件的后缀名
    if( ( strtolower( $uploaded_ext ) == &#34;jpg&#34; || strtolower( $uploaded_ext ) == &#34;jpeg&#34; || strtolower( $uploaded_ext ) == &#34;png&#34; ) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        ( $uploaded_size &lt; <span style="color:#f92672">100000</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>

        
       
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">函数会通过读取文件头</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">返回图片的长</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#a6e22e">宽等信息</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">如果没有相关的图片文件头</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">函数会报错</span>
        <span style="color:#a6e22e">getimagesize</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">可以看到</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">High级别的代码读取文件名中最后一个</span><span style="color:#960050;background-color:#1e0010">”.”</span><span style="color:#a6e22e">后的字符串</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">期望通过文件名来限制文件类型</span>
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">因此要求上传文件名形式必须是</span><span style="color:#960050;background-color:#1e0010">”*.</span><span style="color:#a6e22e">jpg</span><span style="color:#960050;background-color:#1e0010">”、”*.</span><span style="color:#a6e22e">jpeg</span><span style="color:#960050;background-color:#1e0010">”</span> <span style="color:#960050;background-color:#1e0010">、”*.</span><span style="color:#a6e22e">png</span><span style="color:#960050;background-color:#1e0010">”</span><span style="color:#a6e22e">之一</span>
        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">同时</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">getimagesize函数更是限制了上传文件的文件头必须为图像类型</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Can</span> <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">move</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">upload</span> <span style="color:#a6e22e">folder</span><span style="color:#960050;background-color:#1e0010">?</span>
        <span style="color:#a6e22e">if</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">!</span><span style="color:#a6e22e">move_uploaded_file</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">target_path</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">No</span>
            <span style="color:#a6e22e">echo</span> <span style="color:#960050;background-color:#1e0010">&#39;&lt;</span><span style="color:#a6e22e">pre</span>&gt;Your image was not uploaded.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }
        else {
            // Yes!
            echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;{$target_path} succesfully uploaded!&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
        }
    }
    else {
        // Invalid file
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
}
</code></pre></div><h3 id="impossible">Impossible</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Upload&#39; ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; );

    // File information
    $uploaded_name = $_FILES[ &#39;uploaded&#39; ][ &#39;name&#39; ];
    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, &#39;.&#39; ) + 1);
    $uploaded_size = $_FILES[ &#39;uploaded&#39; ][ &#39;size&#39; ];
    $uploaded_type = $_FILES[ &#39;uploaded&#39; ][ &#39;type&#39; ];
    $uploaded_tmp  = $_FILES[ &#39;uploaded&#39; ][ &#39;tmp_name&#39; ];

    // Where are we going to be writing to?
    $target_path   = DVWA_WEB_PAGE_TO_ROOT . &#39;hackable/uploads/&#39;;
    //$target_file   = basename( $uploaded_name, &#39;.&#39; . $uploaded_ext ) . &#39;-&#39;;

    // MD5 加密
    $target_file   =  md5( uniqid() . $uploaded_name ) . &#39;.&#39; . $uploaded_ext;
    $temp_file     = ( ( ini_get( &#39;upload_tmp_dir&#39; ) == &#39;&#39; ) ? ( sys_get_temp_dir() ) : ( ini_get( &#39;upload_tmp_dir&#39; ) ) );
    $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . &#39;.&#39; . $uploaded_ext;

    // Is it an image?
    if( ( strtolower( $uploaded_ext ) == &#39;jpg&#39; || strtolower( $uploaded_ext ) == &#39;jpeg&#39; || strtolower( $uploaded_ext ) == &#39;png&#39; ) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        ( $uploaded_size &lt; <span style="color:#f92672">100000</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        <span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_type </span><span style="color:#f92672">=</span><span style="color:#e6db74">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">image</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#a6e22e">jpeg</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#960050;background-color:#1e0010">||</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_type </span><span style="color:#f92672">=</span><span style="color:#e6db74">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">image</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#a6e22e">png</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span>
        <span style="color:#a6e22e">getimagesize</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Strip</span> <span style="color:#a6e22e">any</span> <span style="color:#a6e22e">metadata</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">re-encoding</span> <span style="color:#a6e22e">image</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#a6e22e">Note</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">php-Imagick</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">recommended</span> <span style="color:#a6e22e">over</span> <span style="color:#a6e22e">php-GD</span><span style="color:#960050;background-color:#1e0010">)</span>
        <span style="color:#a6e22e">if</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_type </span><span style="color:#f92672">=</span><span style="color:#e6db74">=</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">image</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#a6e22e">jpeg</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">img </span><span style="color:#f92672">=</span> <span style="color:#e6db74">imagecreatefromjpeg(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span> <span style="color:#960050;background-color:#1e0010">);</span>
            <span style="color:#a6e22e">imagejpeg</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">img</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">temp_file</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">100</span><span style="color:#960050;background-color:#1e0010">);</span>
        <span style="color:#960050;background-color:#1e0010">}</span>
        <span style="color:#a6e22e">else</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">img </span><span style="color:#f92672">=</span> <span style="color:#e6db74">imagecreatefrompng(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">uploaded_tmp</span> <span style="color:#960050;background-color:#1e0010">);</span>
            <span style="color:#a6e22e">imagepng</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">img</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">temp_file</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#a6e22e">9</span><span style="color:#960050;background-color:#1e0010">);</span>
        <span style="color:#960050;background-color:#1e0010">}</span>
        <span style="color:#a6e22e">imagedestroy</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">img</span> <span style="color:#960050;background-color:#1e0010">);</span>

        <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Can</span> <span style="color:#a6e22e">we</span> <span style="color:#a6e22e">move</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">web</span> <span style="color:#a6e22e">root</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">temp</span> <span style="color:#a6e22e">folder</span><span style="color:#960050;background-color:#1e0010">?</span>
        <span style="color:#a6e22e">if</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#a6e22e">rename</span><span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">temp_file</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">(</span> <span style="color:#a6e22e">getcwd</span><span style="color:#960050;background-color:#1e0010">()</span> <span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#a6e22e">DIRECTORY_SEPARATOR</span> <span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">target_path</span> <span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">target_file</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">{</span>
            <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Yes</span><span style="color:#960050;background-color:#1e0010">!</span>
            <span style="color:#a6e22e">echo</span> <span style="color:#960050;background-color:#1e0010">&#34;&lt;</span><span style="color:#a6e22e">pre</span>&gt;&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;${target_path}${target_file}&#39;</span>&gt;${target_file}&lt;/<span style="color:#f92672">a</span>&gt; succesfully uploaded!&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
        }
        else {
            // No
            echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }

        // Delete any temp files
        if( file_exists( $temp_file ) )
            unlink( $temp_file );
    }
    else {
        // Invalid file
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
}

// Generate Anti-CSRF token
generateSessionToken();
</code></pre></div><h3 id="extension">Extension</h3>
<p><strong>00%截断</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">$is_upload = false;
$msg = null;
if(isset($_POST[&#39;submit&#39;])){
    // 白名单
    $ext_arr = array(&#39;jpg&#39;,&#39;png&#39;,&#39;gif&#39;);
    $file_ext = substr($_FILES[&#39;upload_file&#39;][&#39;name&#39;],strrpos($_FILES[&#39;upload_file&#39;][&#39;name&#39;],&#34;.&#34;)+1);
    if(in_array($file_ext,$ext_arr)){
        $temp_file = $_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;];
        // 注意这个位置
        // 最后拼接的储存路径，是由用户提交上的数据来做为路径
        $img_path = $_POST[&#39;save_path&#39;].&#34;/&#34;.rand(10, 99).date(&#34;YmdHis&#34;).&#34;.&#34;.$file_ext;

        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = &#34;上传失败&#34;;
        }
    } else {
        $msg = &#34;只允许上传.jpg|.png|.gif类型文件！&#34;;
    }
}
</code></pre></div><p>代码采用的白名单校验，只允许上传图片格式，理论上这个上传是不好绕过的。</p>
<p>但是后面采用保存文件的时候，是路径拼接的形式，而路径又是从前端获取，所以我们可以在路径上做手脚。</p>
<p>如下上传，显示文件路径中有个空格，这并不是真正意义上的空格，而是%00截断后显示成的空格。</p>
<blockquote>
<p>在url中%00表示ascll码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束 (php版本要小于5.3.4，5.3.4及以上已经修复该问题)</p>
</blockquote>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-10">April 10, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/sql_injection_blind/">Sql Injection Blind</a></h1>
    <div class="tags">
        
        
        <a href="/tags/penetration-test" class="pure-button">penetration test</a>
        
    </div>
    <p>返回的结果集无法看到，只能通过一些页面显示或状态来判断。
像瞎子一样。</p>
<p>DVWA SQL Injection blind 过关秘籍.</p>
<h3 id="low">Low</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if(isset( $_GET[ &#39;Submit&#39; ])) {
    // Get input
    $id = $_GET[ &#39;id&#39; ];

    // Check database
    $getid  = &#34;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39;;&#34;;
    // 没有一点点防备
    // 尝试构造: (由于看不到结果集，所以脱裤子的语句是无效)
    // SELECT first_name, last_name FROM users WHERE user_id = &#39;0&#39; union select 1,2 # &#39;;
    // User ID exists in the database. &lt;<span style="color:#f92672">存在注入漏洞</span>&gt;
    // SELECT first_name, last_name FROM users WHERE user_id = &#39;0&#39; union select 1,if(length( database())=4,sleep(4),2) # &#39;;

    $result = mysql_query( $getid ); // Removed &#39;or die&#39; to suppress mysql errors

    // Get results
    $num = @mysql_numrows( $result ); // The &#39;@&#39; character suppresses errors
    if( $num &gt; 0 ) {
        // Feedback for end user
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID exists in the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
    else {
        // User wasn&#39;t found, so the page wasn&#39;t!
        header( $_SERVER[ &#39;SERVER_PROTOCOL&#39; ] . &#39; 404 Not Found&#39; );

        // Feedback for end user
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID is MISSING from the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }

    mysql_close();
}
</code></pre></div><h3 id="miedum">MIEDUM</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_POST[ &#39;Submit&#39; ]  ) ) {
    // Get input
    $id = $_POST[ &#39;id&#39; ];
    $id = mysql_real_escape_string( $id );

    // Check database
    $getid  = &#34;SELECT first_name, last_name FROM users WHERE user_id = $id;&#34;;
    // 尝试构造:
    // SELECT first_name, last_name FROM users WHERE user_id = 0 union select 1,2;
    // 以上判断存在注入漏洞
    // SELECT first_name, last_name FROM users WHERE user_id = 0 union select 1,if(length(database()) &gt; 4, sleep(3), 2)

    $result = mysql_query( $getid ); // Removed &#39;or die&#39; to suppress mysql errors

    // Get results
    $num = @mysql_numrows( $result ); // The &#39;@&#39; character suppresses errors
    if( $num &gt; 0 ) {
        // Feedback for end user
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID exists in the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }
    else {
        // Feedback for end user
        echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID is MISSING from the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
    }

    //mysql_close();
}
</code></pre></div><h3 id="high">High</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_SESSION[&#39;id&#39;])){
    // Get input
    $id = $_SESSION[ &#39;id&#39; ];

    // Check database
    $query  = &#34;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39; LIMIT 1;&#34;;
    // 没有新花样，只限制输出条目是无法拦住我们的
    // 尝试构造:
    // SELECT first_name, last_name FROM users WHERE user_id = &#39;0&#39; union select 1,if(length(database()) = 4, sleep(3), 2) # LIMIT 1;
    $result = mysql_query( $query ) or die( &#39;&lt;<span style="color:#f92672">pre</span>&gt;Something went wrong.&lt;/<span style="color:#f92672">pre</span>&gt;&#39; );

    // Get results
    $num = mysql_numrows( $result );
    $i   = 0;
    while( $i <span style="color:#960050;background-color:#1e0010">&lt;</span> $num ) {
        // Get values
        $first = mysql_result( $result, $i, &#34;first_name&#34; );
        $last  = mysql_result( $result, $i, &#34;last_name&#34; );

        // Feedback for end user
        echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;ID: {$id}&lt;<span style="color:#f92672">br</span> /&gt;First name: {$first}&lt;<span style="color:#f92672">br</span> /&gt;Surname: {$last}&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;

        // Increase loop count
        $i++;
    }

    mysql_close();
}
</code></pre></div><h3 id="high-1">High</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_GET[ &#39;Submit&#39; ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; );

    // Get input
    $id = $_GET[ &#39;id&#39; ];

    // Was a number entered?
    if(is_numeric( $id )) {
        // Check the database
        // PDO 无法注入
        $data = $db-&gt;prepare( &#39;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#39; );
        $data-&gt;bindParam( &#39;:id&#39;, $id, PDO::PARAM_INT );
        $data-&gt;execute();

        // Get results
        if( $data-&gt;rowCount() == 1 ) {
            // Feedback for end user
            echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID exists in the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }
        else {
            // User wasn&#39;t found, so the page wasn&#39;t!
            header( $_SERVER[ &#39;SERVER_PROTOCOL&#39; ] . &#39; 404 Not Found&#39; );

            // Feedback for end user
            echo &#39;&lt;<span style="color:#f92672">pre</span>&gt;User ID is MISSING from the database.&lt;/<span style="color:#f92672">pre</span>&gt;&#39;;
        }
    }
}

// Generate Anti-CSRF token
generateSessionToken();
</code></pre></div>
</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-10">April 10, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/sql_injection/">SQL Injection</a></h1>
    <div class="tags">
        
        
        <a href="/tags/penetration-test" class="pure-button">penetration test</a>
        
    </div>
    <p>DVWA SQL Injection 过关秘籍.</p>
<h3 id="low">LOW</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_REQUEST[ &#39;Submit&#39; ] ) ) {
    // Get input
    $id = $_REQUEST[ &#39;id&#39; ];

    // Check database
    $query  = &#34;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39;;&#34;;
    // 并没有做什么注入防护
    // 尝试构造：
    // select first_name, last_name from from users where user_id = &#39;1&#39; and 1=1;
    // select first_name, last_name from from users where user_id = &#39;1&#39; and 1=2;
    // select first_name, last_name from from users where user_id = &#39;1&#39; or 1=1;

    $result = mysql_query( $query ) or die( &#39;&lt;<span style="color:#f92672">pre</span>&gt;&#39; . mysql_error() . &#39;&lt;/<span style="color:#f92672">pre</span>&gt;&#39; );

    // Get results
    $num = mysql_numrows( $result );
    $i   = 0;
    while( $i <span style="color:#960050;background-color:#1e0010">&lt;</span> $num ) {
        // Get values
        $first = mysql_result( $result, $i, &#34;first_name&#34; );
        $last  = mysql_result( $result, $i, &#34;last_name&#34; );

        // Feedback for end user
        echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;ID: {$id}&lt;<span style="color:#f92672">br</span> /&gt;First name: {$first}&lt;<span style="color:#f92672">br</span> /&gt;Surname: {$last}&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;

        // Increase loop count
        $i++;
    }

    mysql_close();
}
</code></pre></div><h3 id="medium">Medium</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">if( isset( $_POST[ &#39;Submit&#39; ] ) ) {
    // Get input

    // 换成了Post 这也太普通了
    // 使用一些网络请求工具照样改，比如BurpSuite，PostMan，curl.
    $id = $_POST[ &#39;id&#39; ];
    $id = mysql_real_escape_string( $id );
    // mysql_real_escape_string 可以对以下字符进行转义
    // \x00, \n, \r, \, &#39;, &#34; 和 \x1a.
    // 值得注意的是 mysql_real_escape_string 函数所在的MYSQL扩展在
    // PHP 5.5.0 起已废弃，并在自 PHP 7.0.0 开始被移除。

    // Check database
    $query  = &#34;SELECT first_name, last_name FROM users WHERE user_id = $id;&#34;;
    // 尝试构造:
    // SELECT first_name, last_name FROM users WHERE user_id = 1 or 1=1;

    $result = mysql_query( $query ) or die( &#39;&lt;<span style="color:#f92672">pre</span>&gt;&#39; . mysql_error() . &#39;&lt;/<span style="color:#f92672">pre</span>&gt;&#39; );

    // Get results
    $num = mysql_numrows( $result );
    $i   = 0;
    while( $i <span style="color:#960050;background-color:#1e0010">&lt;</span> $num ) {
        // Display values
        $first = mysql_result( $result, $i, &#34;first_name&#34; );
        $last  = mysql_result( $result, $i, &#34;last_name&#34; );

        // Feedback for end user
        echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;ID: {$id}&lt;<span style="color:#f92672">br</span> /&gt;First name: {$first}&lt;<span style="color:#f92672">br</span> /&gt;Surname: {$last}&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;

        // Increase loop count
        $i++;
    }

    //mysql_close();
}

</code></pre></div><h3 id="high">High</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_SESSION [ &#39;id&#39; ] ) ) {
    // Get input
    $id = $_SESSION[ &#39;id&#39; ];

    // Check database
    // 看起来做了返回条目限制
    $query  = &#34;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39; LIMIT 1;&#34;;
    // 没什么套路
    // SELECT first_name, last_name FROM users WHERE user_id = &#39;1&#39; or 1=1 # &#39; LIMIT 1;

    $result = mysql_query( $query ) or die( &#39;&lt;<span style="color:#f92672">pre</span>&gt;Something went wrong.&lt;/<span style="color:#f92672">pre</span>&gt;&#39; );

    // Get results
    $num = mysql_numrows( $result );
    $i   = 0;
    while( $i <span style="color:#960050;background-color:#1e0010">&lt;</span> $num ) {
        // Get values
        $first = mysql_result( $result, $i, &#34;first_name&#34; );
        $last  = mysql_result( $result, $i, &#34;last_name&#34; );

        // Feedback for end user
        echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;ID: {$id}&lt;<span style="color:#f92672">br</span> /&gt;First name: {$first}&lt;<span style="color:#f92672">br</span> /&gt;Surname: {$last}&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;

        // Increase loop count
        $i++;
    }

    mysql_close();
}
</code></pre></div><h3 id="impossible">impossible</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PHP" data-lang="PHP">if( isset( $_GET[ &#39;Submit&#39; ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ &#39;user_token&#39; ], $_SESSION[ &#39;session_token&#39; ], &#39;index.php&#39; );

    // Get input
    $id = $_GET[ &#39;id&#39; ];

    // Was a number entered?
    if(is_numeric( $id )) {
        // Check the database
        // 这是！PDO!
        // PDO 是一种PHP中比较先进的面向对象形式的数据库访问技术
        // 不过即使是面向对象它还是事务脚本形式的。
        // 提供了防SQL注入的功能。
        $data = $db-&gt;prepare( &#39;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#39; );
        // 无法注入

        $data-&gt;bindParam( &#39;:id&#39;, $id, PDO::PARAM_INT );
        $data-&gt;execute();
        $row = $data-&gt;fetch();

        // Make sure only 1 result is returned
        if( $data-&gt;rowCount() == 1 ) {
            // Get values
            $first = $row[ &#39;first_name&#39; ];
            $last  = $row[ &#39;last_name&#39; ];

            // Feedback for end user
            echo &#34;&lt;<span style="color:#f92672">pre</span>&gt;ID: {$id}&lt;<span style="color:#f92672">br</span> /&gt;First name: {$first}&lt;<span style="color:#f92672">br</span> /&gt;Surname: {$last}&lt;/<span style="color:#f92672">pre</span>&gt;&#34;;
        }
    }
}

// Generate Anti-CSRF tsoken
generateSessionToken();
</code></pre></div><h2 id="extension">Extension</h2>
<p><strong>二次注入:</strong></p>
<p>网站有管理员<code>admin</code>.</p>
<p>一位恶意用户注册了<code>admin'#</code>用户.</p>
<p>恶意用户更新了自己的密码.</p>
<p>更新SQL:</p>
<blockquote>
<p>update from users 
set password = &lsquo;$password&rsquo; 
where 
username = &lsquo;$username&rsquo; and password &lsquo;$password&rsquo;</p>
</blockquote>
<p>替换为恶意用户写入的数据:</p>
<blockquote>
<p>update from users
set password = #{password}
where
username = &lsquo;admin&rsquo;#&rsquo; and password = &lsquo;$password&rsquo;</p>
</blockquote>
<p>注意<code>#</code> 后面的语句被注释掉了, 所以真正被执行的只有.</p>
<blockquote>
<p>update from users
set password = #{password}
where
username = &lsquo;admin&rsquo;</p>
</blockquote>
<p>恶意用户可以无视管理员<code>admin</code>的密码验证，直接修改密码。</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-06">April 6, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/library_and_framework/">The Framework a good design?</a></h1>
    <div class="tags">
        
        
        <a href="/tags/design" class="pure-button">Design</a>
        
    </div>
    <p>我第一次听到框架这个概念已经是在大学的时候了，当时我的老师和我提起。
一开始我非常不习惯在我不熟悉的上下文中编写程序的感觉。只能用四个字来形容<code>寸步难行</code>。</p>
<p>过了一段时间后，当你熟悉里这个框架提前为你所做的一切的时候，一切只能用四个字来形容<code>素巴拉细</code>（美妙）。</p>
<p>后来，我接触了各种形形色色的框架，从PHP到Java.</p>
<p>最让我惊叹的莫过于SpringBoot, 它几乎为你准备好了你所需要的一切，如果你需要其他的，也能非常容易的引入进来，
任何框架以及库都能和Spring完美的结合在一起。Spring的可扩展性是我见过所有框架中最棒的！（它的核心理念就是IOC），不得不赞叹Spring是应用层的完美产物。（Spring无法被其他语言模仿和Java的<code>万物对象</code>的理念有很大关系）</p>
<hr>
<p>曾经的软件工程师没有这样的待遇，他们往往是从头构建起他们的应用。
这使得成为软件工程师这一职业难以企及。</p>
<p>由于如今软件行业的变化，软件工程师们已经不能仅仅只在底层工作了，应用层的发展也突飞猛进。
各种软件架构的出现应接不暇。</p>
<p>框架最初是为了解决重复而复杂的工作而诞生出来的产物。
帮助我们不必再写重复的代码，只需要关心业务逻辑。</p>
<p>框架可以说是为了应用层的软件工程师而设计的。他们往往不会关心更细粒度的工作。他们只追求稳定的应用和企业架构。</p>
<p>To be continued&hellip;</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-06">April 6, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/sssp/">SS:SP鸡你太美存器</a></h1>
    <div class="tags">
        
        
        <a href="/tags/assembly" class="pure-button">assembly</a>
        
    </div>
    <p>如今的CPU都有提供栈机制，8086也不例外。</p>
<p>8086提供的最基本的两个指令就是<code>push</code> and <code>pop</code>.</p>
<pre><code>push ax ;将寄存器ax中的数据送入栈顶
pop ax ;将栈顶的数据送入ax
</code></pre><p>我们知道CS:IP寄存器存放了下一条指令的段地址和偏移地址，那么CPU是如何知道栈顶在哪呐？
显然也有两个寄存器专门存放栈顶的地址，那就是SS:SP寄存器，SS = 段地址， SP = 偏移地址</p>
<p>任意时刻，SS:SP都指向栈顶元素。<code>push</code>和<code>pop</code>指令执行时CPU将从SS和SP中获得栈顶的地址。</p>
<p><code>push</code> 有2步:</p>
<ul>
<li>SP -= 2 SS:SP指向栈顶前面的单元，以这个位置为新栈。</li>
<li>将AX中的内容送入 SS:SP 所指的位置.</li>
</ul>
<pre><code>10000H  |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______| 
        |_______| 
1000EH  |__23___| &lt;= SS:SP
1000FH  |__01___|
</code></pre><pre><code>10000H  |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______| &lt;= SS:SP: 换个位置
        |_______| 
1000EH  |__23___| 
1000FH  |__01___|
</code></pre><pre><code>10000H  |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|  ;来自ax寄存器的数据
        |__54___| &lt;= SS:SP: 换个位置
        |__11___| 
1000EH  |__23___| 
1000FH  |__01___|
</code></pre><hr>
<p>假设 10000H -&gt; 1000FH 这段空间是栈，那么栈空时，SS:SP在呐？</p>
<pre><code>10000H  |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______| 
1000EH  |_______| 
1000FH  |_______| &lt;= SS:SP: 我在这？
</code></pre><pre><code>10000H  |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______|
        |_______| 
1000EH  |_______| 
1000FH  |_______| 
10010H  |_______| &lt;= SS:SP: 其实爷在这里。
</code></pre><p>至于为什么只要想想 <code>SP -= 2</code> 你就知道了。</p>
<h1 id="关于爆栈">关于爆栈</h1>
<p>栈一旦爆了，SS:SP就会指到别的地方去。
这么一想CPU应该会知道栈顶在哪里。</p>
<p>每次<code>push</code>,<code>pop</code>都会检查栈顶和栈底的位置，保证栈不会超。这么一想美滋滋。</p>
<p>然而，8086CPU并没有做这样的设计。
它只知道栈顶在哪里。不知道栈有多大。</p>
<p>换个说法就是：<strong>只知道下一条指令在哪里，而不知道要处理的指令有多少条。</strong></p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-06">April 6, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/csip/">CSIP鸡你太美存器</a></h1>
    <div class="tags">
        
        
        <a href="/tags/assembly" class="pure-button">assembly</a>
        
    </div>
    <p>之前刚学的时候对这个玩意音响没那么深刻，现在再学，感觉很不一样了。</p>
<p>CS为代码段寄存器，IP为指令指针寄存器。
设CS = M, IP = N, 8086CPU将从 <code>M × 16 + N</code> 处读取指令并进行。</p>
<p>也可以这样表述： <strong>8086CPU中，任意时刻，CPU都会将CS:IP指向的内容做为执行指令.</strong></p>
<p>执行流程:</p>
<ul>
<li>初始状态: CS = 2000H, IP = 0000H</li>
<li>CS:IP 内容送入地址加法器，2000H × 16 + 0000H = 20000H</li>
<li>地址加法器计算出物理地址20000H后将结果送入输入输出电路.</li>
<li>输入输出电路将物理地址20000H送到地址总线。</li>
<li>内存将物理地址20000H上存放的机器指令X通过数据总线送入CPU.</li>
<li>输入输出电路将机器指令X送入指令缓冲器。</li>
<li>寄存器IP的值自动增加。</li>
<li>以此类推&hellip;</li>
</ul>
<hr>
<p>当8086CPU加点或者复位后，CS = FFFFH, IP = 0000H,也就是CPU清晨起床做的第一件事就是去执行FFFF0H内存单元中存放的机器指令。</p>
<h2 id="修改csip">修改CS:IP</h2>
<p><code>mov</code>指令能帮我们将值送入寄存器。但是，它不能用于修改CS:IP，原因很简单8086出于设计考量不允许。
能修改CS:IP的指令统称为<code>转移指令</code>（以后我们深入研究）,现在我学习第一个可以修改CS:IP寄存器的指令，<code>jmp</code>.</p>
<p>若想同时修改CS:IP寄存器,可以用<code>jmp 段地址, 偏移地址</code>的指令来完成。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">jmp</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">AE3</span>:<span style="color:#ae81ff">3</span> <span style="color:#75715e">;执行后: CS = 2AE3H IP = 0003H, CPU 将从这2AE33H 处读取指令
</span></code></pre></div><p>如果只想修改IP寄存器, 可以用<code>jmp 寄存器</code>的指令来完成.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">jmp</span> <span style="color:#66d9ef">ax</span>
</code></pre></div><p>类似, <code>mov IP, ax</code></p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-06">April 6, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/multiplexingio/">MultiplexingIO</a></h1>
    <div class="tags">
        
        
        <a href="/tags/unix" class="pure-button">unix</a>
        
    </div>
    <p>其实“I/O多路复用”这个坑爹翻译可能是这个概念在中文里面如此难理解的原因。所谓的I/O多路
复用在英文中其实叫 I/O multiplexing. 如果你搜索multiplexing啥意思,基本上都会出这个图:</p>
<p><img src="/multiplexIO/1.png" alt=""></p>
<p>于是大部分人都直接联想到&quot;一根网线,多个sock复用&rdquo; 这个概念,包括上面的几个回答, 其实不
管你用多进程还是I/O多路复用, 网线都只有一根好伐。<strong>多个Sock复用一根网线这个功能是在内核
+驱动层实现的.</strong></p>
<p><strong>重要的事情再说一遍: I/O multiplexing 这里面的 multiplexing 指的其实是在单个线程通过记
录跟踪每一个Sock(I/O流)的状态(对应空管塔里面的Fight progress strip槽)来同时管理多个I/O
流.</strong> 发明它的原因,是尽量多的提高服务器的吞吐能力。</p>
<p>是不是听起来好拗口,看个图就懂了.</p>
<p><img src="/multiplexIO/2.png" alt=""></p>
<p>在同一个线程里面, 通过拨开关的方式,来同时传输多个I/O流, (学过EE的人现在可以站出来义正
严辞说这个叫“时分复用”了)。</p>
<p>什么,你还没有搞懂 “一个请求到来了,nginx使用epoll接收请求的过程是怎样的”, 多看看这个
图就了解了。提醒下,ngnix会有很多链接进来, epoll会把他们都监视起来,然后像拨开关一样,
谁有数据就拨向谁,然后调用相应的代码处理。</p>
<hr>
<p>了解这个基本的概念以后,其他的就很好解释了。</p>
<p><strong>select, poll, epoll 都是I/O多路复用的具体的实现,之所以有这三个鬼存在,其实是他们出现是有
先后顺序的。</strong></p>
<p>I/O多路复用这个概念被提出来以后, select是第一个实现 (1983 左右在BSD里面实现的)。</p>
<p>select 被实现以后,很快就暴露出了很多问题。</p>
<ul>
<li>select 会修改传入的参数数组,这个对于一个需要调用很多次的函数,是非常不友好的。</li>
<li>select 如果任何一个sock(I/O stream)出现了数据,select 仅仅会返回,但是并不会告诉你是那
个sock上有数据,于是你只能自己一个一个的找,10几个sock可能还好,要是几万的sock每次</li>
<li>select 不是线程安全的,如果你把一个sock加入到select, 然后突然另外一个线程发现,尼玛,这
个sock不用,要收回。对不起,这个select 不支持的,如果你丧心病狂的竟然关掉这个sock,
select的标准行为是。。呃。。不可预测的, 这个可是写在文档中的哦.</li>
</ul>
<blockquote>
<p>“If a file descriptor being monitored by select() is closed in another thread, the result is
unspecified.”</p>
</blockquote>
<p>于是14年以后(1997年)一帮人又实现了poll, poll 修复了select的很多问题,比如:</p>
<ul>
<li>poll 去掉了1024个链接的限制,于是要多少链接呢, 主人你开心就好。</li>
<li>poll 从设计上来说,不再修改传入数组,不过这个要看你的平台了,所以行走江湖,还是小心为
妙.</li>
</ul>
<p><strong>其实拖14年那么久也不是效率问题, 而是那个时代的硬件实在太弱,一台服务器处理1千多个链接
简直就是神一样的存在了,select很长段时间已经满足需求。</strong></p>
<hr>
<p>于是5年以后, 在2002, 大神 Davide Libenzi 实现了epoll.</p>
<p>epoll 可以说是I/O 多路复用最新的一个实现,epoll 修复了poll 和select绝大部分问题, 比如:</p>
<ul>
<li>epoll 现在是线程安全的。</li>
<li>epoll 现在不仅告诉你sock组里面数据,还会告诉你具体哪个sock有数据,你不用自己去找了。</li>
</ul>
<p>可是epoll 有个致命的缺点。。只有linux支持。比如BSD上面对应的实现是kqueue。</p>
<p>其实有些国内知名厂商把epoll从安卓里面裁掉这种脑残的事情我会主动告诉你嘛。什么,你说没人
用安卓做服务器,尼玛你是看不起p2p软件了啦。</p>
<p>而ngnix 的设计原则里面, 它会使用目标平台上面最高效的I/O多路复用模型咯,所以才会有这个
设置。一般情况下,如果可能的话,尽量都用epoll/kqueue吧。</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pad">
<div class="date">
    <time pubdate="2020-04-03">April 3, 2020</time>
    <span class="author">by </span>
</div>

<article>
    <h1><a href="https://sdttttt.github.io/post/domain-logic-org-mode/">领域逻辑的组织模式</a></h1>
    <div class="tags">
        
        
        <a href="/tags/design" class="pure-button">Design</a>
        
    </div>
    <p>目前领域逻辑的组织模式分为三种，“事务脚本”，“领域模型” 以及 “表模块”。</p>
<p><code>事务脚本</code>类似于<code>面向过程</code>编程，事务脚本有以下优点：</p>
<ul>
<li>它是一种大多数软件工程师都能理解的简单过程模型。</li>
<li>它能和一个行数据入口或表数据入口简单的数据源很好的协作。</li>
<li>非常容易设定事务的边界。</li>
</ul>
<p>一个组数据源操作便是一个独立的事务脚本。
当然事务脚本也存在很大的缺陷，当领域逻辑开始变得复杂时，这些缺点就开始暴露出来。
当几个事务要执行类似的逻辑时，通常几个脚本中会含有某些相同的代码。
通过将这些代码提取出来，来形成公共的子例程，来消除这种情况。
但是，很多时候消除副本会变得棘手，而检测副本则更困难，倒是消除副本后的程序反而比以前还要杂乱无章，难以维护。</p>
<p>复杂的领域逻辑，必然要引入对象，解决前面描述问题的面向对象方法就是<code>领域模型</code>。
一个内容管理系统会有用户，文章等类，进行鉴权，以及写入等逻辑均置于领域模型中。
因此，发布对象调用一次写入方法。
可能还会有其他例程来完成一些读取功能，但它其实都是调用领域模型中已有打方法实现的。</p>
<blockquote>
<p>领域模型的控制不再是由一个过程来控制用户某一个动作的逻辑，而是由每个对象都承担一部分相关逻辑。</p>
</blockquote>
<p>领域模型的开销来自于数据源的复杂度和使用上的复杂性，刚刚接触领域模型的人会需要时间来适应这种思维方式。一旦习惯了，你就会很爽！
另一方面你需要将数据源映射到领域模型上，数据源越是复杂，领域模型的效果就越是显著。</p>
<p><img src="/shiwujiaoben.png" alt=""></p>
<p>上为事务脚本</p>
<p><img src="/lingyumoxing.png" alt=""></p>
<p>上为领域模型</p>
<p>第三中为领域逻辑的组织模式为<code>表模块</code>，它处于<code>事务脚本</code>和<code>领域模型</code>的一个中间地带。
和领域模型最大的区别就是在表模块中一个表只对应一个实例，而领域模型一行数据便能对应一个实例。</p>
<p>表模块的优点在于可以很容易的和软件架构中已经存在的部分衔接，很多GUI应用都是假定将其与SQL查询结果的记录集结果协同工作的。表模块就工作在记录集之上。你可以很容易的使用。</p>
<p><img src="/tablemodule.png" alt=""></p>
<h2 id="抉择">抉择</h2>
<p><img src="/modelfuzadu.png" alt=""></p>
<p>别问，问就，直接使用领域模型。</p>
<p>接下来我稍微介绍一下目前各个框架/库在领域逻辑的组织模式上的选择（只列出我用）：</p>
<ul>
<li>
<p>PHP</p>
<ul>
<li>PHP 原生 &lt;事务脚本&gt;</li>
<li>ThinkPHP &lt;领域模型&gt;</li>
<li>Laravel &lt;领域模型&gt;</li>
<li>YII &lt;领域模型&gt;</li>
</ul>
</li>
<li>
<p>Java</p>
<ul>
<li>java.sql.* &lt;事务脚本&gt;</li>
<li>MyBatis &lt;表模块&gt;</li>
<li>JPA &lt;领域模型&gt;</li>
</ul>
</li>
<li>
<p>Go</p>
<ul>
<li>gorm &lt;表模块 | 领域模型&gt; （这个比较神奇）</li>
</ul>
</li>
</ul>
<p>现在用表模块的人普遍比较多，我曾遇到好几个J2EE工程师都并不喜欢<code>JPA</code>的思维模式。</p>

</article>
</div>
    <div class="pad"></div>

    

    <div class="pagination">
        
        <a class="pure-button pagination-item older" href="/page/3/">Older</a>
        

        
        <a class="pure-button pagination-item newer" href="/">Newer</a>
        
    </div>
</div>


                
<div id="sidebar" class="pure-u-1 pure-u-md-1-4 pure-u-sm-1">
    <div class="pad">
        <a name="about"></a>
        <h3>About Me</h3>
        <div style="text-align: center;">
            <img src="/me.png" alt="Sdttttt" class="pure-img" />
            <p><em>突如其来的变故使得本就不富裕的晦气小伙雪上加霜.</em></p>
        </div>

        <h3>Latest Articles</h3>
        <div class="pure-menu pure-menu-open">
            <ul class="pure-menu-list">
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/gosyncpool/" class="pure-menu-link">GoSyncPool<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/btree/" class="pure-menu-link">B Tree<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/blogupgrade/" class="pure-menu-link">Blog Upgrade<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/thread_pool_executor/" class="pure-menu-link">Thread Pool Executor 运行细节<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/raft_impl/" class="pure-menu-link">Raft实现的思考<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/kanon/" class="pure-menu-link">Kanon<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/database_storage/" class="pure-menu-link">Database Storage<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/red-black-tree/" class="pure-menu-link">Red Black Tree<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/tree_rust/" class="pure-menu-link">Tree by Rust implement<br>
                        <small></small>
                    </a>
                </li>
                
                <li class="pure-menu-item">
                    <a href="https://sdttttt.github.io/post/stack_rust/" class="pure-menu-link">Stack by Rust implement<br>
                        <small></small>
                    </a>
                </li>
                
            </ul>
        </div>

        <h3>Categories</h3>
        <div style="text-align:center" class="tags">
            
            
            <a href="/tags/data-structure" class="pure-button"> data-structure
                <small>(4)</small></a>
            
            
            
            <a href="/tags/penetration-test" class="pure-button"> penetration-test
                <small>(3)</small></a>
            
            
            
            <a href="/tags/assembly" class="pure-button"> assembly
                <small>(2)</small></a>
            
            
            
            <a href="/tags/blog" class="pure-button"> blog
                <small>(2)</small></a>
            
            
            
            <a href="/tags/cicd" class="pure-button"> cicd
                <small>(2)</small></a>
            
            
            
            <a href="/tags/design" class="pure-button"> design
                <small>(2)</small></a>
            
            
            
            <a href="/tags/microservice" class="pure-button"> microservice
                <small>(2)</small></a>
            
            
            
            <a href="/tags/rust" class="pure-button"> rust
                <small>(2)</small></a>
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
        </div>
    </div> 
</div> 

                
            </div><div class="pure-g">
	<footer class="pure-u-1 pure-u-md-1 pure-u-sm-1">
		<p>This page and its contents are copyright &copy; 2020,
			<a href="">Sdttttt</a>.</p>
		<p><a href="https://github.com/pravin/hugo-theme-prav">Theme Prav</a> by <a href="https://cto.me.uk">Pravin
				Paratey</a></p>
	</footer>

	<script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"
		integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl"
		crossorigin="anonymous"></script>
</div></div></body>
</html>
